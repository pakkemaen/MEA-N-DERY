<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEA(N)DERY - AI Mead Recipe Creator</title>
    
    <meta name="theme-color" content="#a89a87"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --bg-primary: #f3f0e9;
            --bg-secondary: #fdfaf2;
            --bg-tertiary: #ffffff;
            --text-primary: #4a3c2c;
            --text-secondary: #5a4a3a;
            --border-color: #dcd0c0;
            --accent-color: #a89a87;
            --header-color: #4a3c2c;
            --brand-color: #8F8C79;
            --action-color: #b45309;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --info-color: #3b82f6;
        }

        .dark {
            --bg-primary: #000000;        /* ECHT ZWART: voor de hoofdachtergrond */
            --bg-secondary: #121212;      /* BIJNA ZWART: voor panelen en achtergronden */
            --bg-tertiary: #1e1e1e;       /* DONKERGRIJS: voor kaarten en knoppen */
            --text-primary: #e0e0e0;      /* Iets zachter wit voor minder hard contrast */
            --text-secondary: #b3b3b3;    /* Leesbaar secundair grijs */
            --border-color: #2e2e2e;      /* Subtiele randen */
            --accent-color: #c7c4b6; 
            --header-color: #ffffff;
            --brand-color: #adaa9a; 
            --action-color: #f59e0b; 
            --danger-color: #f87171;
            --success-color: #4ade80;
            --info-color: #60a5fa;
        }

        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .dark .bg-app-primary input, .dark .bg-app-primary select {
            background-color: var(--bg-tertiary);
        }

        .orientation-btn.active {
            border-color: var(--color-app-brand);
            border-width: 2px;
            color: var(--color-app-brand);
        }

        #label-preview.horizontal {
            transform-origin: center;
            transform: rotate(90deg) scale(0.7);
        }
        #label-preview.horizontal > * {
            transform: rotate(-90deg);
            width: 250px;
        }
        #label-preview.horizontal h3 {
            font-size: 1.4rem;
        }
        #label-preview.horizontal p {
            font-size: 0.7rem;
        }
        #label-preview.horizontal #label-details-container,
        #label-preview.horizontal #label-allergens-container {
            font-size: 0.6rem;
        }

        // Roteer de inhoud van het label mee
        #label-preview.horizontal > * {
            transform: rotate(-90deg);
        }

        body {
            font-family: 'Barlow Semi Condensed', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-app-primary { background-color: var(--bg-primary); }
        .bg-app-secondary { background-color: var(--bg-secondary); }
        .bg-app-tertiary { background-color: var(--bg-tertiary); }
        .text-app-primary { color: var(--text-primary); }
        .text-app-secondary { color: var(--text-secondary); }
        .border-app { border-color: var(--border-color); }
        .text-app-header { color: var(--header-color); }
        .text-app-brand { color: var(--brand-color); }
        .bg-app-action { background-color: var(--action-color); }
        .tab.active { border-bottom-color: var(--brand-color); color: var(--brand-color); }
        .sub-tab.active { background-color: var(--brand-color); color: var(--bg-secondary); }


        .font-header {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        .control-panel::-webkit-scrollbar, main::-webkit-scrollbar, .inventory-panel::-webkit-scrollbar, .calculator-panel::-webkit-scrollbar, .settings-panel::-webkit-scrollbar {
            width: 8px;
        }
        .control-panel::-webkit-scrollbar-track, main::-webkit-scrollbar-track, .inventory-panel::-webkit-scrollbar-track, .calculator-panel::-webkit-scrollbar-track, .settings-panel::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .control-panel::-webkit-scrollbar-thumb, main::-webkit-scrollbar-thumb, .inventory-panel::-webkit-scrollbar-thumb, .calculator-panel::-webkit-scrollbar-thumb, .settings-panel::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }
        .recipe-content h1, .recipe-content h2, .recipe-content h3 {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.25rem;
        }
        .recipe-content h2 { font-size: 1.5rem; }
        .recipe-content h3 { font-size: 1.25rem; }
        .recipe-content ul, .recipe-content ol {
            padding-left: 20px;
            margin-bottom: 1rem;
        }
        .recipe-content p { line-height: 1.7; margin-bottom: 1.25rem; }
        .recipe-content li { margin-bottom: 0.75rem; line-height: 1.6; }
        .recipe-content strong { font-weight: 600; color: var(--text-primary); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .brew-log-section { padding-top: 1rem; }
        .brew-log-section h3 {
             font-family: 'Barlow Semi Condensed', sans-serif;
             font-weight: 600;
             font-size: 1.5rem;
             text-align: center;
             border-bottom: 2px solid var(--text-primary);
             padding-bottom: 0.5rem;
             margin-bottom: 1rem;
        }
        .brew-log-section .log-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
         .brew-log-section .log-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .brew-log-section .log-item input, .brew-log-section .log-item textarea {
            width: 100%; padding: 8px; border: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0; background-color: transparent;
            font-family: 'Barlow Semi Condensed', sans-serif;
            transition: border-color 0.3s;
            color: var(--text-primary);
        }
        .brew-log-section .log-item input:focus, .brew-log-section .log-item textarea:focus {
            outline: none; border-bottom: 1px solid var(--accent-color);
        }
        .fermentation-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .fermentation-table th, .fermentation-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .fermentation-table th { background-color: var(--bg-primary); }
        .fermentation-table input { width: 100%; border: none; background: transparent; padding: 4px; color: var(--text-primary); }
        
        .tab {
            transition: color 0.2s, border-color 0.2s;
            padding: 10px 16px; /* Added padding for spacing */
        }
        
        .btn {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .dark .btn:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        /* Theme Toggle Slider */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
        }
        input:checked + .slider {
            background-color: var(--brand-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        #social-content-container, 
        #social-content-container code, 
        #social-content-container pre {
            font-family: 'Barlow Semi Condensed', sans-serif;
        }
        #social-content-container h1, 
        #social-content-container h2, 
        #social-content-container h3 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        #social-content-container h2 { font-size: 1.5rem; }
        #social-content-container h3 { font-size: 1.25rem; }
        #social-content-container p { line-height: 1.6; margin-bottom: 1rem; }
        #social-content-container strong { font-weight: 700; color: var(--text-primary); }
        #social-content-container ul, #social-content-container ol {
            padding-left: 20px;
            margin-bottom: 1rem;
        }
        #social-content-container li { 
            margin-bottom: 0.5rem; 
            line-height: 1.6; 
        }
        #social-content-container code, #social-content-container pre {
             background-color: transparent;
             padding: 0;
             white-space: pre-wrap;
        }

        #label-preview { border: 2px dashed var(--border-color); transition: all 0.3s; }
        /* --- LABEL STIJLEN --- */

        /* Stijl 1: Minimalist (Standaard) */
        .label-minimalist {
            background-color: #ffffff !important; color: #121212 !important;
            font-family: 'Barlow Semi Condensed', sans-serif; border: 1px solid #e0e0e0;
        }
        .label-minimalist h3 { font-weight: 300; font-size: 2rem; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 0.5rem; }
        .label-minimalist p { font-weight: 600; color: #8F8C79; font-size: 0.9rem; letter-spacing: 2px; }
        .label-minimalist #label-details-container { border-top: 1px solid #e0e0e0; font-size: 0.8rem; color: #888; }

        /* Stijl 2: Industrial */
        .label-industrial {
            background: #FFF !important; color: #121212 !important;
            font-family: monospace; border: 1px solid #121212; text-align: left;
        }
        .label-industrial h3 { font-weight: bold; font-size: 1.5rem; background-color: #121212; color: #ffffff; padding: 0.25rem 0.5rem; display: inline-block; margin-bottom: 0.5rem; }
        .label-industrial p { font-size: 0.8rem; text-transform: uppercase; color: #555; }
        .label-industrial #label-details-container { border-top: 2px solid #121212; color: #333; font-weight: bold; font-size: 0.9rem; }
        
        /* Stijl 3: Professional */
        .label-professional {
            background-color: #ffffff !important; color: #2b2118 !important;
            font-family: serif; border: 4px double #2b2118;
        }
        .label-professional h3 { font-size: 2.2rem; font-weight: bold; }
        .label-professional p { font-style: italic; font-size: 1.1rem; }
        .label-professional #label-details-container { border-top: 1px solid #dcd0c0; font-size: 0.85rem; }
        .label-professional .professional-only { display: flex !important; justify-content: space-between; margin-top: 0.25rem;}
        
        /* Algemene styling voor details */
        .professional-only { display: none; }
        #label-allergens-container { font-style: normal; font-size: 0.7rem; color: #666; }

        .timeline-container {
            position: relative;
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
        }
        .timeline-connector {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--border-color);
            transform: translateY(-50%);
            z-index: 1;
        }
        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--brand-color);
            transition: width 0.5s ease-in-out;
        }
        .timeline-item {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 25%; /* 4 items */
        }
        .timeline-node {
            width: 20px;
            height: 20px;
            background-color: var(--bg-tertiary);
            border: 4px solid var(--border-color);
            border-radius: 50%;
            transition: all 0.3s;
        }
        .timeline-item.active .timeline-node {
            background-color: var(--brand-color);
            border-color: var(--brand-color);
        }
        .timeline-label {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 600;
        }
        .timeline-item.active .timeline-label {
            color: var(--text-primary);
        }
        .timeline-item .timeline-label {
            color: var(--text-secondary);
        }

        .step-item {
            border-left: 3px solid var(--border-color);
            transition: all 0.3s;
        }
        .step-item.active {
            border-left-color: var(--brand-color);
            background-color: var(--bg-primary);
        }
        .step-item.completed {
            border-left-color: var(--success-color);
            opacity: 0.6;
        }
        .step-item.completed .step-title {
            text-decoration: line-through;
        }
        .step-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        .progress-bar-bg {
            background-color: var(--border-color);
        }
        .progress-bar-fg {
            background-color: var(--brand-color);
            transition: width 0.5s ease-in-out;
        }
        /* EINDE: STYLES FOR BREW DAY TIMER */
  
</style>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</head>
<body class="bg-app-primary text-app-primary">

    <div id="login-view" class="fixed inset-0 bg-app-primary flex items-center justify-center z-50">
        <div class="text-center p-8 max-w-md mx-auto">
            <h1 class="text-6xl font-header text-app-header">MEA<span class="text-app-brand">(N)</span>DERY</h1>
            <p class="text-app-secondary mt-2 mb-8">Brewbuddy</p>
            <div class="card p-8 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">Welcome</h2>
                <p class="text-app-secondary mb-6">Please sign in to access your brewing data.</p>
                <button id="google-login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 btn flex items-center justify-center">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-4 no-print">
            <h1 class="text-5xl font-header text-app-header">MEA<span class="text-app-brand">(N)</span>DERY</h1>
            <p class="text-app-secondary mt-2">Brewbuddy</p>
        </header>

        <!-- Main Content Area -->
        <div id="dashboard-main-view">
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
                
                <div id="current-brew-card" class="card p-6 rounded-lg mb-6 hidden">
                    <!-- Content injected by JS -->
                </div>

               <div id="next-action-widget" class="card p-6 rounded-lg mb-6 hidden bg-app-tertiary border-app">
                    <h3 class="text-xl font-header font-bold mb-3 text-app-header">What's next?</h3>
                    <ul id="next-action-list" class="list-disc pl-5 space-y-2 text-app-secondary">
                        </ul>
               </div>

               <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <button data-view="brewing" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <path d="M10 2v7.31"></path><path d="M14 9.31V2"></path><path d="M8.5 2h7"></path><path d="M14 9.31C16.57 10.92 18 14.11 18 17.69V20a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-2.31C6 14.11 7.43 10.92 10 9.31Z"></path>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Brewing</h3>
                        <p class="text-app-secondary/80 text-sm">Creator, Brew Day, History</p>
                    </button>
                    <button data-view="management" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <rect width="20" height="5" x="2" y="3" rx="1"></rect><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path><path d="M10 12h4"></path>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Management</h3>
                        <p class="text-app-secondary/80 text-sm">Inventory, Planning, Financials</p>
                    </button>
                    <button data-view="tools" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Tools</h3>
                        <p class="text-app-secondary/80 text-sm">Calculators, Water, Social</p>
                    </button>
                    <button data-view="settings" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.4l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Settings</h3>
                        <p class="text-app-secondary/80 text-sm">Configure your app</p>
                    </button>
                </div>

                <div id="low-stock-card" class="card p-6 rounded-lg mb-6 hidden">
                     <h3 class="text-xl font-header font-bold mb-2 text-red-500">Low Stock Alerts</h3>
                     <ul id="low-stock-list" class="list-disc pl-5 text-app-secondary">
                        <!-- Content injected by JS -->
                     </ul>
                </div>

            </div>
        </div>

        <div id="brewing-main-view" class="hidden">
    <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
    <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
        <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap">
            <button id="creator-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Creator</button>
            <button id="shopping-list-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Shopping List</button>
            <button id="brew-day-1-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day 1</button>
            <button id="brew-day-2-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day 2</button>
            <button id="history-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">History</button>
        </nav>
    </div>
            <div id="creator-view">
                <div class="flex flex-col lg:flex-row gap-8 mt-4">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg control-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Craft Your Mead</h2>
                        
                        <div class="mb-6">
                            <label for="customDescription" class="block text-sm font-bold mb-2">Describe Your Dream Mead</label>
                            <textarea id="customDescription" rows="4" placeholder="Be descriptive! e.g., 'A dry, sparkling mead with lavender and lemon, around 8% ABV, perfect for summer.'" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary"></textarea>
                            <p id="description-priority-warning" class="hidden text-xs text-center text-amber-600 dark:text-amber-400 mt-2">U gebruikt de vrije beschrijving. De onderstaande opties worden genegeerd.</p>
                            <p class="text-xs text-center text-app-secondary/80 mt-2">Or, use the options below for a more structured recipe.</p>
                        </div>

                        <div id="structured-options-container" class="space-y-6 pt-6 border-t border-app">
                            <div>
                                <label for="batchSize" class="block text-sm font-bold mb-2">Batch Size (Liters)</label>
                                <input type="number" id="batchSize" value="5" min="1" max="100" step="0.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="equipmentProfileSelect" class="block text-sm font-bold mb-2">Equipment Profile</label>
                                <select id="equipmentProfileSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="">None (Use default values)</option>
                                    </select>
                            </div>
                            <div>
                                <label for="abv" class="block text-sm font-bold mb-2">Target ABV (%)</label>
                                <input type="number" id="abv" value="12" min="5" max="18" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="sweetness" class="block text-sm font-bold mb-2">Final Sweetness</label>
                                <select id="sweetness" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="dry">Dry (FG ~1.000)</option>
                                    <option value="semi-sweet" selected>Semi-Sweet (FG ~1.015)</option>
                                    <option value="sweet">Sweet (FG ~1.030)</option>
                                </select>
                            </div>
                            <div>
                                <label for="style" class="block text-sm font-bold mb-2">Base Style</label>
                                <select id="style" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <optgroup label="Standard Styles">
                                        <option value="bochet">Bochet (Caramelized Honey)</option>
                                        <option value="braggot">Braggot (Beer/Mead Hybrid)</option>
                                        <option value="capsicumel">Capsicumel (Chili Mead)</option>
                                        <option value="cyser">Cyser (Apple Mead)</option>
                                        <option value="melomel">Melomel (Fruit Mead)</option>
                                        <option value="metheglin">Metheglin (Spiced Mead)</option>
                                        <option value="pyment">Pyment (Grape Mead)</option>
                                        <option value="rhodomel">Rhodomel (Rose Mead)</option>
                                        <option value="traditional">Traditional</option>
                                    </optgroup>
                                    <optgroup label="Belgian Specials">
                                        <option value="belgian_dubbel">Dubbel Style</option>
                                        <option value="belgian_gruit">Gruit (Hopless Herb Mead)</option>
                                        <option value="belgian_kriek">Kriek Style</option>
                                        <option value="lambic">Lambic Style</option>
                                        <option value="oud_bruin">Oud Bruin Style</option>
                                        <option value="belgian_quad">Quadrupel (Westvleteren 12 Inspired)</option>
                                        <option value="belgian_saison">Saison de Pipaix Style</option>
                                        <option value="belgian_tripel">Tripel Style</option>
                                        <option value="belgian_wit">Wit Style</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label for="honeyVariety" class="block text-sm font-bold mb-2">Honey Variety</label>
                                <select id="honeyVariety" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="Acacia">Acacia</option>
                                    <option value="Buckwheat">Buckwheat</option>
                                    <option value="Clover">Clover</option>
                                    <option value="Forest/Boshoning">Forest Honey (Boshoning)</option>
                                    <option value="Linden/Linde">Linden Honey (Lindehoning)</option>
                                    <option value="Orange Blossom">Orange Blossom</option>
                                    <option value="Wildflower" selected>Wildflower (Default)</option>
                                    <option value="other">Other...</option>
                                 </select>
                                 <input type="text" id="honeyVarietyOther" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary mt-2 hidden" placeholder="Specify other honey">
                            </div>
                            <div id="fruit-section" class="hidden space-y-2">
                                <label class="block text-sm font-bold">Choose Fruits (for Melomel)</label>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_apples" class="mr-2"><label for="fruit_apples">Apples</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_apricots" class="mr-2"><label for="fruit_apricots">Apricots</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blackberries" class="mr-2"><label for="fruit_blackberries">Blackberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blackcurrants" class="mr-2"><label for="fruit_blackcurrants">Blackcurrants</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blueberries" class="mr-2"><label for="fruit_blueberries">Blueberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_cherries" class="mr-2"><label for="fruit_cherries">Cherries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_gooseberries" class="mr-2"><label for="fruit_gooseberries">Gooseberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_peaches" class="mr-2"><label for="fruit_peaches">Peaches</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_pears" class="mr-2"><label for="fruit_pears">Pears</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_plums" class="mr-2"><label for="fruit_plums">Plums</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_raspberries" class="mr-2"><label for="fruit_raspberries">Raspberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_redcurrants" class="mr-2"><label for="fruit_redcurrants">Redcurrants</label></div>
                                </div>
                                <div class="pt-2">
                                    <label for="fruitOther" class="block text-xs font-bold text-app-secondary">Other Fruits (comma-separated)</label>
                                    <input type="text" id="fruitOther" placeholder="e.g., Mango, Passion Fruit" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div> 
                            </div>
                             <div id="spice-section" class="hidden space-y-2">
                                <label class="block text-sm font-bold">Choose Spices (for Metheglin)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_cinnamon" class="mr-2"><label for="spice_cinnamon">Cinnamon</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_cloves" class="mr-2"><label for="spice_cloves">Cloves</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_coriander" class="mr-2"><label for="spice_coriander">Coriander</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_nutmeg" class="mr-2"><label for="spice_nutmeg">Nutmeg</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_orange" class="mr-2"><label for="spice_orange">Orange Peel</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_vanilla" class="mr-2"><label for="spice_vanilla">Vanilla</label></div>
                                </div>
                                <div class="pt-2">
                                    <label for="spiceOther" class="block text-xs font-bold text-app-secondary">Other Spices (comma-separated)</label>
                                    <input type="text" id="spiceOther" placeholder="e.g., Star Anise, Grains of Paradise" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            <div id="braggot-section" class="hidden">
                                <label for="braggotStyle" class="block text-sm font-bold mb-2">Braggot Base Style</label>
                                <select id="braggotStyle" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="belgian_blond">Belgian Blond</option>
                                    <option value="dubbel">Belgian Dubbel</option>
                                    <option value="ipa">IPA</option>
                                    <option value="old_ale">Old Ale / Barleywine</option>
                                    <option value="saison">Saison</option>
                                    <option value="scotch_ale">Scotch Ale / Wee Heavy</option>
                                    <option value="stout">Stout</option>
                                </select>
                            </div>
                            <div class="space-y-4 pt-4 border-t border-app">
                                <div class="flex items-center">
                                    <input type="checkbox" id="addOak" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                    <label for="addOak" class="ml-3 block text-sm font-bold">Include Oak Aging?</label>
                                </div>
                                <div>
                                    <label for="specialIngredients" class="block text-sm font-bold mb-2">Special Ingredients (optional)</label>
                                    <input type="text" id="specialIngredients" placeholder="e.g., Rose petals, Lapsang tea..." class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t-2 border-app-brand mt-6">
                             <div class="flex items-center">
                                <input type="checkbox" id="useInventory" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                <label for="useInventory" class="ml-3 block text-sm font-bold text-app-brand">Create recipe from my inventory</label>
                                <span id="inventory-helper-text" class="hidden ml-3 text-xs text-amber-600 dark:text-amber-400">De app gebruikt uw inventaris als basis en de andere opties als richtlijn.</span>
                            </div>
                            
                            <div id="budget-section" class="hidden pl-7 space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="useBudget" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                    <label for="useBudget" class="ml-3 block text-sm font-bold">Generate within budget?</label>
                                </div>
                                <div id="budget-input-container" class="hidden">
                                    <label for="maxBudget" class="block text-sm font-bold mb-1">Max Budget</label>
                                    <input type="number" id="maxBudget" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button id="generateBtn" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">
                                Generate Recipe
                            </button>
                        </div>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                        <div id="recipe-output" class="prose max-w-none text-app-primary">
                        </div>
                    </main>
                </div>
            </div>

            <div id="brew-day-1-view" class="hidden mt-4">
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
            <div id="brew-day-content">
                <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 1 - Primary Fermentation</h2>
                <p class="text-center text-app-secondary/80">Generate a recipe, click "Start New Batch", and the relevant steps will appear here.</p>
            </div>
        </div>
    </div>

    <div id="brew-day-2-view" class="hidden mt-4">
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
            <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 2 - Secondary / Aging</h2>
            <p class="text-center text-app-secondary/80">This section will show your batches that are in the secondary fermentation or aging phase.</p>
        </div>
    </div>
            <div id="history-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <div id="history-list-container">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew History</h2>                        
                        <div class="mb-4">
                            <input type="text" id="history-search-input" placeholder="Search recipes by name..." class="w-full p-3 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                        </div>                        
                        <div id="history-list" class="space-y-4">
                            </div>
                    </div>
                    <div id="history-detail-container" class="hidden">
                        </div>
                 </div>
            </div>
            <div id="shopping-list-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg ...">
                      <h2 class="text-3xl font-header font-bold mb-6 text-center">Shopping List</h2>
                      <div id="shopping-list-container" class="mb-8">
                         <div id="shopping-list-content" class="p-4 card rounded-lg">
                             <p class="text-app-secondary text-center">Click "Start New Batch" on a saved recipe to generate a shopping list here.</p>
                         </div>
                      </div>
                </div>
            </div>
        </div>

        <div id="management-main-view" class="hidden">
             <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
             <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap">
                    <button id="inventory-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Inventory</button>
                    <button id="equipment-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Equipment</button>
                    <button id="packaging-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Packaging</button>
                    <button id="cellar-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Cellar</button>
                    <button id="financials-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Financials</button>
                </nav>
            </div>
            <div id="inventory-view" class="mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <div id="barcode-scanner-container" class="relative hidden mb-4">
                            <div id="barcode-reader" class="w-full rounded-lg"></div>
                            <button id="close-scanner-btn" class="absolute top-2 right-2 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold btn">&times;</button>
                        </div>
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add to Inventory</h2>
                        <button id="scan-barcode-btn" class="w-full mb-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><path d="M7 12h10"></path></svg>
                            Scan Barcode
                        </button>
                        <p class="text-xs text-center text-app-secondary/80 mb-4">- OR -</p>
                        <form id="inventory-form" class="space-y-4">
                            <div>
                                <label for="itemName" class="block text-sm font-bold mb-2">Ingredient Name</label>
                                <input type="text" id="itemName" placeholder="e.g., Acacia Honey" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="itemQty" class="block text-sm font-bold mb-2">Quantity</label>
                                    <input type="number" id="itemQty" step="0.01" placeholder="e.g., 1.5" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                                <div>
                                    <label for="itemUnit" class="block text-sm font-bold mb-2">Unit</label>
                                    <select id="itemUnit" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                        <option>kg</option><option>g</option><option>L</option><option>ml</option><option>packets</option><option>items</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label for="itemPrice" class="block text-sm font-bold mb-2">Price (€)</label>
                                <input type="number" id="itemPrice" step="0.01" placeholder="e.g., 12.50" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="itemCategory" class="block text-sm font-bold mb-2">Category</label>
                                <select id="itemCategory" class="w-full p-2 ...">
                                       <option>Honey</option><option>Yeast</option><option>Nutrient</option><option>Malt Extract</option><option>Fruit</option><option>Spice</option><option>Adjunct</option><option>Chemical</option>                  <option>Water</option>
                                </select>
                            </div>
                            <div>
                                <label for="itemExpirationDate" class="block text-sm font-bold mb-2">Expiration Date (Optional)</label>
                                <input type="date" id="itemExpirationDate" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">Add Ingredient</button>
                        </form>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Current Stock</h2>
                        <div id="inventory-list"></div>
                    </main>
                </div>
            </div>
            <div id="packaging-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
        
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Packaging Stock</h2>
                        <form id="packaging-add-form" class="space-y-4">
                            <div>
                                <label for="packaging-item-select" class="block text-sm font-bold mb-2">Packaging Material</label>
                                <select id="packaging-item-select" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="packaging-item-qty" class="block text-sm font-bold mb-2">Quantity Added</label>
                                    <input type="number" id="packaging-item-qty" step="1" min="0" placeholder="e.g., 24" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                               <div>
                                   <label for="packaging-item-price" class="block text-sm font-bold mb-2">Total Price Paid (€)</label>
                                   <input type="number" id="packaging-item-price" step="0.01" min="0" placeholder="e.g., 18.50" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                               </div>
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">
                                Add to Stock
                            </button>
                        </form>
                    </aside>
        
                    <main id="packaging-stock-container" class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel lg:overflow-y-auto lg:max-h-[70vh]">
                       <h2 class="text-3xl font-header font-bold mb-4 text-center">Current Packaging Stock</h2>
                       <div id="packaging-list" class="space-y-2">
                           </div>
                    </main>
                </div>
            </div>             
            <div id="equipment-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Equipment Profile</h2>
                        <form id="equipment-profile-form" class="space-y-4">
                            <div>
                                <label for="equipProfileName" class="block text-sm font-bold mb-2">Profile Name</label>
                                <input type="text" id="equipProfileName" placeholder="e.g., My 30L Fermenter" required class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary focus:ring-2 focus:ring-app-brand">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="equipProfileType" class="block text-sm font-bold mb-2">Equipment Type</label>
                                    <select id="equipProfileType" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                                        <option value="Fermenter">Fermenter</option>
                                        <option value="Kettle">Kettle / Boil Pot</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="equipProfileQuantity" class="block text-sm font-bold mb-2">Aantal</label>
                                    <input type="number" id="equipProfileQuantity" value="1" min="1" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="equipCapacityLiters" class="block text-sm font-bold mb-2">Total Capacity (L)</label>
                                    <input type="number" id="equipCapacityLiters" step="0.1" placeholder="30" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                                </div>
                                <div>
                                    <label for="trubLossLiters" class="block text-sm font-bold mb-2">Trub/Yeast Loss (L)</label>
                                    <input type="number" id="trubLossLiters" step="0.1" placeholder="0.75" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                                </div>
                            </div>
                            <div id="boil-off-rate-container" class="hidden">
                                <label for="boilOffRateLitersPerHour" class="block text-sm font-bold mb-2">Boil-Off Rate (Liters/Hour)</label>
                                <input type="number" id="boilOffRateLitersPerHour" step="0.1" placeholder="2.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">Add Profile</button>
                        </form>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Saved Equipment Profiles</h2>
                        <div id="equipment-profiles-list">
                        </div>
                    </main>
                </div>
            </div>
            <div id="cellar-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">My Cellar</h2>
                    <div id="cellar-list" class="space-y-4">
                    </div>
                </div>
            </div>
            <div id="financials-view" class="hidden mt-4">
    <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
         <h2 class="text-3xl font-header font-bold mb-6 text-center">Financials</h2>
         <div id="cost-analysis-container">
            <h3 class="text-2xl font-header mb-4">Cost Analysis</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-4 rounded-lg text-center">
                    <h4 class="text-lg font-bold text-app-secondary">Total Inventory Value</h4>
                    <p id="total-spend" class="text-3xl font-bold text-app-brand">€0.00</p>
                </div>
                <div class="card p-4 rounded-lg text-center">
                    <h4 class="text-lg font-bold text-app-secondary">Total Cellar Value</h4>
                    <p id="total-cellar-value" class="text-3xl font-bold text-app-brand">€0.00</p>
                </div>
            </div>
            <div class="card p-4 rounded-lg mt-6">
                <h4 class="text-lg font-bold text-app-secondary text-center mb-4">Spend by Category</h4>
                <canvas id="cost-chart"></canvas>
            </div>
         </div>
    </div>
</div>
        </div>
        <div id="tools-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap">
                    <button id="calculators-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Calculators</button>
                    <button id="labels-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Labels</button>
                    <button id="water-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Water</button>
                    <button id="troubleshoot-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Troubleshoot</button>
                    <button id="social-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Social</button>
                </nav>
            </div>
            
            <div id="calculators-view" class="mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg calculator-panel overflow-y-auto" style="max-height: 80vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">Brewing Calculators</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">ABV Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="og" class="block text-sm font-bold mb-1">Original Gravity (OG)</label><input type="number" id="og" step="0.001" placeholder="e.g., 1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="fg" class="block text-sm font-bold mb-1">Final Gravity (FG)</label><input type="number" id="fg" step="0.001" placeholder="e.g., 1.015" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcAbvBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate ABV</button>
                                <div id="abvResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Hydrometer Correction</h3>
                            <div class="space-y-4">
                                <div><label for="sgReading" class="block text-sm font-bold mb-1">Hydrometer Reading</label><input type="number" id="sgReading" step="0.001" placeholder="e.g., 1.052" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="tempReading" class="block text-sm font-bold mb-1">Liquid Temperature (°C)</label><input type="number" id="tempReading" placeholder="e.g., 25" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="calTemp" class="block text-sm font-bold mb-1">Hydrometer Calibration Temp (°C)</label><input type="number" id="calTemp" value="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="correctSgBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Correct Gravity</button>
                                <div id="sgResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Backsweetening Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="bs_current_vol" class="block text-sm font-bold mb-1">Current Volume (L)</label><input type="number" id="bs_current_vol" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="bs_current_sg" class="block text-sm font-bold mb-1">Current SG</label><input type="number" id="bs_current_sg" step="0.001" placeholder="0.998" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="bs_target_sg" class="block text-sm font-bold mb-1">Target SG</label><input type="number" id="bs_target_sg" step="0.001" placeholder="1.015" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcBacksweetenBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Honey</button>
                                <div id="backsweetenResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg md:col-span-2 lg:col-span-3">
                             <h3 class="text-xl font-header mb-4">TOSNA Nutrient Calculator</h3>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="tosna_og" class="block text-sm font-bold mb-1">Original Gravity (OG)</label><input type="number" id="tosna_og" step="0.001" placeholder="1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="tosna_vol" class="block text-sm font-bold mb-1">Batch Volume (L)</label><input type="number" id="tosna_vol" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="tosna_yeast" class="block text-sm font-bold mb-1">Yeast Nutrient Need</label><select id="tosna_yeast" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
                             </div>
                             <button id="calcTosnaBtn" class="w-full mt-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Schedule</button>
                             <div id="tosnaResult" class="prose max-w-none text-app-primary mt-4"></div>
                        </div>
                        
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Dilution Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="dil_start_vol" class="block text-sm font-bold mb-1">Starting Volume (L)</label><input type="number" id="dil_start_vol" placeholder="18" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="dil_start_sg" class="block text-sm font-bold mb-1">Starting SG</label><input type="number" id="dil_start_sg" step="0.001" placeholder="1.120" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="dil_target_sg" class="block text-sm font-bold mb-1">Target SG</label><input type="number" id="dil_target_sg" step="0.001" placeholder="1.100" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcDilutionBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Dilution</button>
                                <div id="dilutionResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Priming Sugar Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="carbVol" class="block text-sm font-bold mb-1">Target CO2 Volume</label><input type="number" id="carbVol" step="0.1" placeholder="e.g., 2.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="carbTemp" class="block text-sm font-bold mb-1">Mead Temperature (°C)</label><input type="number" id="carbTemp" placeholder="e.g., 20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="carbBatchSize" class="block text-sm font-bold mb-1">Batch Size (L)</label><input type="number" id="carbBatchSize" step="0.1" placeholder="e.g., 19" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcSugarBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Sugar</button>
                                <div id="sugarResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Blending Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="vol1" class="block text-sm font-bold mb-1">Volume 1 (L)</label><input type="number" id="vol1" step="0.1" placeholder="10" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="sg1" class="block text-sm font-bold mb-1">SG 1</label><input type="number" id="sg1" step="0.001" placeholder="1.020" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="vol2" class="block text-sm font-bold mb-1">Volume 2 (L)</label><input type="number" id="vol2" step="0.1" placeholder="5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="sg2" class="block text-sm font-bold mb-1">SG 2</label><input type="number" id="sg2" step="0.001" placeholder="0.998" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcBlendBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Blend</button>
                                <div id="blendResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg md:col-span-2 lg:col-span-3">
                            <h3 class="text-xl font-header mb-4">AI Yeast Starter Calculator</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="starterOG" class="block text-sm font-bold mb-1">Starting Gravity of Mead</label><input type="number" id="starterOG" step="0.001" placeholder="1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="yeastDate" class="block text-sm font-bold mb-1">Yeast Production Date</label><input type="date" id="yeastDate" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="yeastType" class="block text-sm font-bold mb-1">Yeast Type</label><select id="yeastType" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"><option>Liquid</option><option>Dry</option></select></div>
                            </div>
                            <button id="getYeastAdviceBtn" class="w-full mt-4 bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">Get AI Starter Advice</button>
                            <div id="yeast-advice-output" class="prose max-w-none text-app-primary mt-4"></div>
                        </div>

                    </div>
                </div>
            </div>
            <div id="labels-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Label Designer</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="labelRecipeSelect" class="block text-sm font-bold mb-1">Select Recipe</label>
                                <select id="labelRecipeSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    <option value="">-- Choose a Saved Recipe --</option>
                                </select>
                            </div>
                            <div>
                                <label for="labelStyle" class="block text-sm font-bold mb-1">Style / Subtitle</label>
                                <input type="text" id="labelStyle" placeholder="e.g., Lavender & Lemon Melomel" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="labelAbv" class="block text-sm font-bold mb-1">ABV (%)</label>
                                    <input type="text" id="labelAbv" placeholder="12.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="labelVol" class="block text-sm font-bold mb-1">Volume (ml)</label>
                                    <input type="text" id="labelVol" placeholder="750" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            <div>
                                <label for="labelDate" class="block text-sm font-bold mb-1">Bottling Date</label>
                                <input type="text" id="labelDate" placeholder="August 2025" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <div>
                                <label for="logoUpload" class="block text-sm font-bold mb-1">Upload Your Logo</label>
                                <input type="file" id="logoUpload" accept="image/*" class="w-full text-sm text-app-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-app-primary file:text-app-brand hover:file:bg-app-tertiary">
                                <button id="removeLogoBtn" class="hidden text-xs text-red-500 hover:underline mt-2">Remove logo</button>
                            </div>
                            <div class="pt-4 border-t border-app space-y-4">
                                <div>
                                    <label for="labelFormatSelect" class="block text-sm font-bold mb-2">Label Format</label>
                                    <select id="labelFormatSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                        <option value="herma_4453">Herma 4453 (99.1 x 139 mm) - 4/pagina</option>
                                        <option value="avery_l7165">Avery L7165 (99.1 x 67.7 mm) - 8/pagina</option>
                                        <option value="herma_10730">Herma 10730 (99.1 x 33.8 mm) - 16/pagina</option>
                                        <option value="custom">Custom Format...</option>
                                    </select>
                                </div>
                                <div id="custom-format-inputs" class="hidden space-y-2 p-3 border rounded-md border-app">
                                     <h4 class="text-sm font-bold text-center">Custom Page Layout</h4>
                                     <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div><label>Label Width (mm)</label><input type="number" id="customWidth" value="99.1" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Label Height (mm)</label><input type="number" id="customHeight" value="67.7" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Columns</label><input type="number" id="customCols" value="2" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Rows</label><input type="number" id="customRows" value="4" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Top Margin (mm)</label><input type="number" id="customMarginTop" value="11.1" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Left Margin (mm)</label><input type="number" id="customMarginLeft" value="5.45" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                     </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Choose a Style</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button class="label-style-btn p-2 border-2 border-app-brand rounded-lg text-app-brand btn" data-style="minimalist">Minimalist</button>
                                        <button class="label-style-btn p-2 border rounded-lg btn" data-style="industrial">Industrial</button>
                                        <button class="label-style-btn p-2 border rounded-lg btn" data-style="professional">Professional</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Orientation</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="orientation-btn active p-2 border-2 border-app-brand rounded-lg text-app-brand btn" data-orientation="vertical">Vertical</button>
                                        <button class="orientation-btn p-2 border rounded-lg btn" data-orientation="horizontal">Horizontal</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-2 text-center">Live Preview</h2>
                        <p class="text-center text-sm text-app-secondary mb-6">Dit is hoe één etiket eruit zal zien.</p>
                        <div class="max-w-xs mx-auto">
                            <div id="label-preview" class="label-minimalist aspect-[3/4] p-4 flex flex-col">
                                <img id="label-logo-preview" src="" class="hidden h-1/3 w-auto mb-4 mx-auto"/>
                                
                                <div class="flex-grow flex flex-col justify-center text-center">
                                    <h3 id="label-name-preview" class="text-2xl font-bold font-header">Mead Name</h3>
                                    <p id="label-style-preview" class="text-sm">Style / Subtitle</p>
                                </div>
                                
                                <div class="mt-auto">
                                    <div id="label-details-container" class="w-full border-t pt-2 text-xs">
                                        <div class="detail-row flex justify-between">
                                            <span id="label-date-preview">Bottling Date</span>
                                            <span><span id="label-abv-preview">ABV</span>% ABV</span>
                                            <span><span id="label-vol-preview">VOL</span></span>
                                        </div>
                                        <div class="detail-row professional-only hidden">
                                            <span id="label-og-container">OG: <span id="label-og-preview">OG</span></span>
                                            <span id="label-fg-container">FG: <span id="label-fg-preview">FG</span></span>
                                            <span id="label-yeast-container">Yeast: <span id="label-yeast-preview">Yeast</span></span>
                                        </div>
                                    </div>
                                    <div id="label-allergens-container" class="w-full text-xs mt-1 text-center hidden">
                                         </div>
                                </div>
                            </div>
                        <div class="text-center mt-8">
                            <button id="generate-print-btn" class="w-full max-w-xs bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                                Generate Printable Page
                            </button>
                        </div>
                    </main>
                </div>
            </div>
            <div id="water-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8 lg:items-start">
        
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg flex flex-col lg:overflow-y-auto lg:max-h-[80vh]">
                       <h2 class="text-2xl font-header font-bold mb-4 border-b pb-4 border-app">Water Management</h2>
    
                       <div class="mb-4">
                           <label for="waterSource" class="block text-sm font-bold mb-2">Select Water Profile</label>
                           <select id="waterSource" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></select>
                      </div>
                      <div id="waterProfileDisplay" class="mb-4 p-4 card rounded-lg">
                          <h4 class="font-bold font-header text-lg mb-2">Active Mineral Profile (mg/L)</h4>
                          <ul class="space-y-1 text-sm text-app-primary">
                              <li><strong>Ca:</strong> <span id="val-ca">--</span></li>
                              <li><strong>Mg:</strong> <span id="val-mg">--</span></li>
                              <li><strong>Na:</strong> <span id="val-na">--</span></li>
                              <li><strong>SO4:</strong> <span id="val-so4">--</span></li>
                              <li><strong>Cl:</strong> <span id="val-cl">--</span></li>
                              <li><strong>HCO3:</strong> <span id="val-hco3">--</span></li>
                          </ul>
                      </div>
            
                      <hr class="border-app my-4">

                      <div id="ai-water-search-section" class="mb-4">
                          <h3 class="text-xl font-header font-bold mb-4">Find Profile with AI</h3>
                          <div class="flex gap-2">
                              <input type="text" id="ai-water-search-name" placeholder="e.g., Orval, Mont Roucous" class="flex-grow p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                              <button id="ai-water-search-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 btn">Find</button>
                          </div>
                      </div>
            
                      <form id="water-profile-form" class="space-y-2 pt-4 border-t border-app">
                          <input type="hidden" id="water-profile-id">
                          <h4 class="font-bold text-center">Add or Edit a Profile</h4>
                          <div>
                              <label for="water-profile-name">Profile Name</label>
                              <input type="text" id="water-profile-name" required placeholder="e.g., My Tap Water" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary">
                          </div>
                          <div class="grid grid-cols-3 gap-2">
                              <div><label for="manual_ca">Ca</label><input type="number" id="manual_ca" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_mg">Mg</label><input type="number" id="manual_mg" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_na">Na</label><input type="number" id="manual_na" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_so4">SO4</label><input type="number" id="manual_so4" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_cl">Cl</label><input type="number" id="manual_cl" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_hco3">HCO3</label><input type="number" id="manual_hco3" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                          </div>
                          <button type="submit" class="w-full mt-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Save Custom Profile</button>
                      </form>
            
                      <div class="mt-auto pt-4 flex-grow">
                          <h3 class="text-xl font-header font-bold mt-4 mb-2">My Saved Profiles</h3>
                          <div id="user-water-profiles-list" class="space-y-2"></div>
                      </div>
                  </aside>
        
                  <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg lg:overflow-y-auto lg:max-h-[80vh]">
                      <h2 class="text-3xl font-header font-bold mb-4 text-center">AI Adjustment Recommendations</h2>
                      <div class="space-y-4 mb-6">
                          <div>
                              <label for="meadTargetProfile" class="block text-sm font-bold mb-2">Desired Mead Character</label>
                              <select id="meadTargetProfile" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                  <option value="balanced">Balanced / All-Purpose</option>
                                  <option value="dry_crisp">Dry & Crisp (e.g., Traditional, Saison)</option>
                                  <option value="rich_full">Rich & Full-bodied (e.g., Sweet Melomel, Quad)</option>
                                  <option value="hoppy_braggot">Hoppy Braggot (IPA style)</option>
                              </select>
                          </div>
                          <button id="getWaterAdviceBtn" class="w-full bg-purple-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-800 btn">Get Brewing Advice</button>
                      </div>
                      <div id="water-advice-output" class="prose max-w-none text-app-primary">
                          <p class="text-center text-app-secondary/80">Select a water source and a desired mead character, then ask the Alchemist for advice.</p>
                      </div>
                  </main>
               </div>
            </div>
            <div id="troubleshoot-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">AI Troubleshooter</h2>
                    <div class="max-w-xl mx-auto">
                        <div class="card p-6 rounded-lg">
                            <label for="troubleshoot-description" class="block text-lg font-bold mb-2">Describe your brewing problem:</label>
                            <textarea id="troubleshoot-description" rows="5" placeholder="e.g., My fermentation seems to have stopped after only 3 days. The airlock isn't bubbling anymore." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
                            <button id="troubleshoot-btn" class="w-full mt-4 bg-purple-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-800 btn">Get Advice</button>
                        </div>
                        <div id="troubleshoot-output" class="mt-6 prose max-w-none text-app-primary"></div>
                    </div>
                 </div>
            </div>
<div id="social-view" class="hidden mt-4">
    <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
        <h2 class="text-3xl font-header font-bold mb-6 text-center">Social Media Assistant</h2>
        
        <!-- Recept Selecteren -->
        <div class="card p-4 rounded-lg mb-6">
            <label for="social-recipe-select" class="block text-sm font-bold mb-2">Select a Recipe from your History</label>
            <select id="social-recipe-select" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                <option value="">-- Choose a Recipe --</option>
                <!-- Recepten worden hier geladen door JS -->
            </select>
        </div>
        <div class="card p-4 rounded-lg mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="social-persona" class="block text-sm font-bold mb-2">AI Persona</label>
                    <select id="social-persona" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        <option value="homebrewer">Enthusiastic Homebrewer</option>
                        <option value="pro_brewery">Professional Brewery</option>
                        <option value="sommelier">Mead Sommelier</option>
                    </select>
                </div>
                <div>
                    <label for="social-platform" class="block text-sm font-bold mb-2">Platform</label>
                    <select id="social-platform" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        <option value="instagram">Instagram Post</option>
                        <option value="untappd_checkin">Untappd Check-in</option>
                        <option value="untappd_description">Untappd Mead Description</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                 <label for="social-tweak" class="block text-sm font-bold mb-2">Tweak / Extra Instruction</label>
                 <textarea id="social-tweak" rows="2" placeholder="e.g., 'Make it funny', 'Focus on the honey used', etc." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
            </div>
        </div>
        <div id="social-from-recipe-container">
            <button id="generate-social-from-recipe-btn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Generate Post from Selected Recipe</button>
        </div>
        <hr class="my-8 border-app">
        <div id="social-from-manual-container">
             <label for="manual-social-input" class="block text-sm font-bold mb-2">Or, generate from your own text:</label>
             <textarea id="manual-social-input" rows="4" placeholder="Type your topic here. e.g., 'Just bottled my cherry mead. It's beautifully clear with a deep red color and smells amazing!'" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
             <button id="generate-manual-social-btn" class="w-full mt-4 bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">Generate Post from Manual Input</button>
        </div>
        <div id="social-output-container" class="mt-8 border-t border-app pt-6 hidden">
            <h3 class="text-2xl font-header font-bold mb-4">Generated Content</h3>
            <div id="social-content-container" class="mb-6"></div>
            <h3 class="text-2xl font-header font-bold mb-4">Generated Image</h3>
            <div id="social-image-container" class="p-4 card rounded-lg text-center"></div>
        </div>
    </div>
</div>
</div>
          <div id="settings-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg settings-panel overflow-y-auto" style="max-height: 80vh;">
                <h2 class="text-3xl font-header font-bold mb-6 text-center">Settings</h2>
                <div class="max-w-xl mx-auto">
                    <div class="mb-6 card p-6 rounded-lg">
    <h3 class="text-xl font-header font-bold mb-4">API Keys</h3>
    
    <div class="mb-4">
        <label for="apiKeyInput" class="block text-lg font-bold mb-2">Google AI API Key (for Text)</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your Google AI API key" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
        <p class="text-sm text-app-secondary mt-2">
            Required for recipe creation, analysis, etc. Get one from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>.
        </p>
    </div>
    
    <div class="pt-4 border-t border-app">
        <label for="imageApiKeyInput" class="block text-lg font-bold mb-2">Image Generation API Key (for Images)</label>
        <input type="password" id="imageApiKeyInput" placeholder="Enter your Stability AI API key" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
        <p class="text-sm text-app-secondary mt-2">
            Optional, for generating images on the Social tab. Get free credits from <a href="https://platform.stability.ai/" target="_blank" class="text-blue-600 hover:underline">Stability AI</a>.
        </p>
    </div>
</div>

                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">Personalization & Defaults</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="defaultBatchSizeInput" class="block text-lg font-bold mb-2">Default Batch Size (Liters)</label>
                                <input type="number" id="defaultBatchSizeInput" placeholder="e.g., 20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                <p class="text-sm text-app-secondary mt-2">Set the default batch size that appears on the Creator tab.</p>
                            </div>
                            <div>
                                <label for="defaultCurrencyInput" class="block text-lg font-bold mb-2">Currency Symbol</label>
                                <input type="text" id="defaultCurrencyInput" placeholder="e.g., $" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                 <p class="text-sm text-app-secondary mt-2">Set the currency symbol used for cost calculations.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">User Interface</h3>
                        <div class="flex items-center justify-between">
                            <label class="text-lg font-bold">Theme</label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch" for="theme-toggle-checkbox">
                                    <input type="checkbox" id="theme-toggle-checkbox" />
                                    <div class="slider round"></div>
                                </label>
                            </div>
                        </div>
                    </div>
              
                    <button id="saveSettingsBtn" class="w-full mt-4 bg-blue-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 btn">Save Settings</button>

                    <div class="mt-10 p-6 rounded-lg border-2 border-red-400">
                        <h3 class="text-xl font-header font-bold mb-4 text-red-600">Data Management</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="exportHistoryBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 btn">Export Brew History</button>
                            <button id="exportInventoryBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 btn">Export Inventory</button>
                            <div>
                                <label for="importHistoryFile" class="w-full text-center block bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 cursor-pointer btn">Import Brew History</label>
                                <input type="file" id="importHistoryFile" class="hidden" accept=".json">
                            </div>
                             <div>
                                <label for="importInventoryFile" class="w-full text-center block bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 cursor-pointer btn">Import Inventory</label>
                                <input type="file" id="importInventoryFile" class="hidden" accept=".json">
                            </div>
                        </div>
                        <div class="space-y-4 mt-8 border-t-2 border-red-400 pt-4">
                            <p class="text-sm text-red-500 text-center">Warning: The following actions cannot be undone.</p>
                            <button id="clearHistoryBtn" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 btn">Delete All Brew History</button>
                            <button id="clearInventoryBtn" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 btn">Delete All Inventory</button>
                        </div>
                    </div>
                    <p class="text-center text-sm text-app-secondary/60 mt-8">MEA(N)DERY v1.9.6 - 15/10/2025 - © 2025</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, deleteDoc, getDoc, setDoc, writeBatch, getDocs, arrayUnion,  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IIFE to create a private scope and avoid polluting the global namespace
        (function() {
            // --- App State ---
            let db, auth, userId;
            let lastGeneratedPrompt = '';
            let brews = []; // Local cache of brews
            let inventory = []; // Local cache of inventory
            let equipmentProfiles = []; // Local cache of equipment profiles
            let cellar = [];    // Local cache of bottled batches
            let userSettings = {}; // Holds settings from Firestore
            let currentBrewDay = { brewId: null, checklist: {} }; // Holds the state for the current brew day
            let currentRecipeMarkdown = ''; // To hold the latest generated recipe markdown
            let currentWaterProfile = null; // To hold the fetched water data
            let costChart = null; // To hold the chart instance
            let fermChartInstance = null;
            let html5QrcodeScanner = null;
            let customBottles = []; // Houdt de lijst met custom flessen bij
            let currentPredictedProfile = null;

// Functie om de lijst met custom flessen op het scherm te tekenen
window.renderCustomBottlesList = function() {
    const listDiv = document.getElementById('custom-bottles-list');
    if (!listDiv) return;

    if (customBottles.length === 0) {
        listDiv.innerHTML = '';
        return;
    }

    listDiv.innerHTML = customBottles.map((bottle, index) => `
        <div class="flex justify-between items-center p-2 bg-app-primary rounded-md text-sm">
            <span><strong>${bottle.quantity}x</strong> ${bottle.size}ml (at ${userSettings.currencySymbol || '€'}${bottle.price.toFixed(2)} each)</span>
            <button type="button" onclick="window.removeCustomBottleFromList(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
        </div>
    `).join('');
}

// Functie die wordt aangeroepen door de '+ Add' knop
window.addCustomBottleToList = function() {
    const size = parseInt(document.getElementById('customSize').value) || 0;
    const quantity = parseInt(document.getElementById('customQty').value) || 0;
    const price = parseFloat(document.getElementById('customPrice').value) || 0;

    if (size <= 0 || quantity <= 0) {
        showToast("Please enter a valid size and quantity for the custom bottle.", "error");
        return;
    }

    customBottles.push({ size, quantity, price });
    renderCustomBottlesList();

    // Maak de input velden leeg voor de volgende invoer
    document.getElementById('customSize').value = '';
    document.getElementById('customQty').value = '';
    document.getElementById('customPrice').value = '';
    document.getElementById('customSize').focus();
}

// Functie om een fles uit de lijst te verwijderen
window.removeCustomBottleFromList = function(index) {
    customBottles.splice(index, 1);
    renderCustomBottlesList();
}

            let packagingCosts = {}; // Houdt de geladen kosten vast
            const PACKAGING_ITEMS = [
                { id: 'bottle_750', name: '750ml Bottle' },
                { id: 'bottle_500', name: '500ml Bottle' },
                { id: 'bottle_330', name: '330ml Bottle' },
                { id: 'bottle_250', name: '250ml Bottle' },
                { id: 'cork', name: 'Cork' },
                { id: 'crown_cap_26', name: 'Crown Cap 26mm' },
                { id: 'crown_cap_29', name: 'Crown Cap 29mm' },
                { id: 'label', name: 'Label' }
            ]; 
            
            const labelFormats = {
                'herma_4453': { name: 'Herma 4453', width_mm: 99.1, height_mm: 139, cols: 2, rows: 2, top_margin_mm: 10, left_margin_mm: 5.45 },
                'avery_l7165': { name: 'Avery L7165', width_mm: 99.1, height_mm: 67.7, cols: 2, rows: 4, top_margin_mm: 11.1, left_margin_mm: 5.45 },
                'herma_10730': { name: 'Herma 10730', width_mm: 99.1, height_mm: 33.8, cols: 2, rows: 8, top_margin_mm: 10, left_margin_mm: 5.45 },
            };

            let userWaterProfiles = []; // Voor de opgeslagen waterprofielen
            const BUILT_IN_WATER_PROFILES = { // Hernoemd van waterData
                spa: { name: 'Spa Reine', ca: 5, mg: 2, na: 3, so4: 4, cl: 5, hco3: 17 },
                chaudfontaine: { name: 'Chaudfontaine', ca: 65, mg: 18, na: 44, so4: 40, cl: 35, hco3: 305 },
                // ... voeg hier de andere ingebouwde waters toe met een 'name' eigenschap
            };

            // --- Toast Notification Helper ---
            function showToast(message, type = 'info', duration = 4000) {
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = "linear-gradient(to right, #22c55e, #16a34a)";
            break;
        case 'error':
            backgroundColor = "linear-gradient(to right, #ef4444, #dc2626)";
            break;
        default: // 'info' or any other type
            backgroundColor = "linear-gradient(to right, #3b82f6, #2563eb)";
    }
    Toastify({
        text: message.replace(/\n/g, '<br>'), // Vervang newlines met <br> voor leesbaarheid
        duration: duration, // Gebruik de meegegeven duur
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        escapeMarkup: false, // Sta HTML toe (voor de <br>)
        style: { background: backgroundColor, borderRadius: "8px" }
    }).showToast();
}

            // --- UI Elements ---
            let dashboardMainView, creatorView, brewingView, historyView, inventoryView, 
                planningView, financialsView, socialView, troubleshootView, calculatorsView, 
                waterView, settingsView, brewingMainView, managementMainView, toolsMainView,
                styleSelect, fruitSection, spiceSection, braggotSection, generateBtn, 
                recipeOutput, brewDayContent, historyList, historyDetailContainer, 
                historyListContainer, inventoryForm, inventoryList, fetchWaterProfileBtn, 
                getWaterAdviceBtn, getYeastAdviceBtn, waterSourceSelect, manualWaterProfileDiv,
                troubleshootBtn, apiKeyInput, defaultBatchSizeInput, defaultCurrencyInput, 
                saveSettingsBtn, settingsMessage, themeToggle, exportHistoryBtn, 
                exportInventoryBtn, importHistoryFile, importInventoryFile, 
                clearHistoryBtn, clearInventoryBtn, labelsView, logoUploadInput, labelPreview;

            function handleStyleChange() {
    const style = styleSelect.value.toLowerCase(); // Gebruik toLowerCase() voor zekerheid
    const isMelomel = style.includes('melomel');
    const isMetheglin = style.includes('metheglin');
    const isBraggot = style.includes('braggot');

    fruitSection.classList.toggle('hidden', !isMelomel);
    spiceSection.classList.toggle('hidden', !isMetheglin);
    braggotSection.classList.toggle('hidden', !isBraggot);

    // Reset de vinkjes en velden als de sectie verborgen wordt
    if (!isMelomel) {
        document.querySelectorAll('#fruit-section input:checked').forEach(cb => cb.checked = false);
        const fruitOther = document.getElementById('fruitOther');
        if(fruitOther) fruitOther.value = ''; // Maak ook het 'other' veld leeg
    }
    if (!isMetheglin) {
        document.querySelectorAll('#spice-section input:checked').forEach(cb => cb.checked = false);
        const spiceOther = document.getElementById('spiceOther');
        if(spiceOther) spiceOther.value = ''; // Maak ook het 'other' veld leeg
    }
}

            function handleDescriptionInput() {
                const descriptionInput = document.getElementById('customDescription');
                const optionsContainer = document.getElementById('structured-options-container');
                const warningMessage = document.getElementById('description-priority-warning');
                
                const hasText = descriptionInput.value.trim() !== '';

                // Schakel de container visueel uit of in
                optionsContainer.classList.toggle('opacity-50', hasText);
                optionsContainer.classList.toggle('pointer-events-none', hasText);
                
                // Maak de waarschuwing zichtbaar of onzichtbaar
                warningMessage.classList.toggle('hidden', !hasText);

                // Schakel alle invoervelden in de container daadwerkelijk uit of in
                optionsContainer.querySelectorAll('input, select, checkbox').forEach(el => {
                    // Schakel alles uit, BEHALVE het "useInventory" vinkje
                    if (el.id !== 'useInventory') {
                        el.disabled = hasText;
                    }
                });
            }

            function handleInventoryToggle(e) {
                const useInventory = e.target.checked;
                const helperText = document.getElementById('inventory-helper-text');
                
                // Definieer de velden die we willen uitschakelen
                const fieldsToDisable = [
                    'honeyVariety', 
                    ...document.querySelectorAll('#fruit-section input, #spice-section input')
                ];

                fieldsToDisable.forEach(el => {
                    const element = typeof el === 'string' ? document.getElementById(el) : el;
                    if (element) {
                        element.disabled = useInventory;
                        element.closest('div').classList.toggle('opacity-50', useInventory);
                    }
                });
                
                // Toon of verberg de hulptekst
                helperText.classList.toggle('hidden', !useInventory);
            }

            // --- Functies voor de AI Prompt Modal ---
            window.showLastPrompt = function() {
                const modal = document.getElementById('prompt-modal');
                const content = document.getElementById('prompt-modal-content');
                content.textContent = lastGeneratedPrompt;
                modal.classList.remove('hidden');
            }

            function hidePromptModal() {
                document.getElementById('prompt-modal').classList.add('hidden');
            }

            let dangerAction = null; // Holds the function to execute on confirmation

function showDangerModal(action, confirmationText) {
    dangerAction = action;
    document.getElementById('danger-confirm-text').textContent = confirmationText;
    document.getElementById('danger-confirm-input').value = '';
    document.getElementById('danger-modal').classList.remove('hidden');
    checkDangerConfirmation(); // Initial check
}

function hideDangerModal() {
    document.getElementById('danger-modal').classList.add('hidden');
    dangerAction = null;
}

function checkDangerConfirmation() {
    const input = document.getElementById('danger-confirm-input').value;
    const requiredText = document.getElementById('danger-confirm-text').textContent;
    const confirmBtn = document.getElementById('danger-confirm-btn');

    if (input === requiredText) {
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        confirmBtn.disabled = true;
        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function executeDangerAction() {
    if (typeof dangerAction === 'function') {
        dangerAction();
    }
    hideDangerModal();
}

            async function signInWithGoogle() {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
        // De onAuthStateChanged listener zal de rest afhandelen.
    } catch (error) {
        // Log de volledige fout naar de console voor debugging.
        console.error("Google Sign-In failed:", error);

        // Gebruik een simpele alert() als fallback om zeker te weten dat de gebruiker de fout ziet.
        // Dit is handig als de Toastify-bibliotheek niet laadt of een ander probleem heeft.
        alert("Login Mislukt: " + error.message);

        // Probeer de toast-notificatie nog steeds te gebruiken.
        if (typeof showToast === 'function') {
            showToast(`Login failed: ${error.message}`, "error");
        }
    }
}


            function populatePackagingDropdown() {
                const select = document.getElementById('packaging-item-select');
                if (!select) return;

                select.innerHTML = PACKAGING_ITEMS.map(item => 
                   `<option value="${item.id}">${item.name}</option>`
                ).join('');
            }

            window.renderPackagingUI = function() {
                const listContainer = document.getElementById('packaging-list');
                const stockContainer = document.getElementById('packaging-stock-container');
                if (!listContainer || !stockContainer) return;

                // Controleer of er voorraad is
                const hasStock = PACKAGING_ITEMS.some(item => packagingCosts[item.id] && packagingCosts[item.id].qty > 0);

                // Verberg de hele sectie als er geen voorraad is
                stockContainer.classList.toggle('hidden', !hasStock);

                if (hasStock) {
                    // Als er wel voorraad is, bouw dan de lijst op zoals voorheen
                    const currency = userSettings.currencySymbol || '€';
                    listContainer.innerHTML = PACKAGING_ITEMS
                        .filter(item => packagingCosts[item.id] && packagingCosts[item.id].qty > 0)
                        .map(item => {
                            const itemData = packagingCosts[item.id]; // We weten nu zeker dat deze data bestaat
                            const costPerUnit = (itemData.qty > 0 && itemData.price > 0) ? (itemData.price / itemData.qty).toFixed(2) : '0.00';

                            return `
                               <div id="pkg-item-${item.id}" class="p-3 card rounded-md">
                                   <div class="flex justify-between items-center">
                                       <div>
                                           <p class="font-bold">${item.name}</p>
                                           <p class="text-sm text-app-secondary/80">Cost per unit: ${currency}${costPerUnit}</p>
                                       </div>
                                       <div class="flex items-center gap-4">
                                           <span class="font-semibold">${itemData.qty} items - ${currency}${itemData.price.toFixed(2)} total</span>
                                           <div class="flex gap-2">
                                               <button onclick="window.editPackagingItem('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                               <button onclick="window.clearPackagingItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           `;
                       }).join('');
               } else {
                  listContainer.innerHTML = '';
               }
           }

async function addPackagingStock(e) {
    e.preventDefault();
    if (!userId) return;

    const itemId = document.getElementById('packaging-item-select').value;
    const qtyAdded = parseFloat(document.getElementById('packaging-item-qty').value) || 0;
    const priceAdded = parseFloat(document.getElementById('packaging-item-price').value) || 0;

    if (!itemId || qtyAdded <= 0) {
        showToast("Please fill in a valid material and quantity.", "error");
        return;
    }

    const currentQty = packagingCosts[itemId]?.qty || 0;
    const currentPrice = packagingCosts[itemId]?.price || 0;

    const newQty = currentQty + qtyAdded;
    const newPrice = currentPrice + priceAdded;
    
    packagingCosts[itemId] = { qty: newQty, price: newPrice };
    
    await savePackagingCosts(); 
    
    document.getElementById('packaging-add-form').reset();
}

async function loadPackagingCosts() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'packaging');
    try {
        const docSnap = await getDoc(settingsDocRef);
        if (docSnap.exists()) {
            packagingCosts = docSnap.data();
        } else {
            // Maak een leeg object als er nog geen data is
            packagingCosts = {};
        }
        renderPackagingUI(); // Bouw de UI op met de geladen data
        populatePackagingDropdown();
    } catch (error) {
        console.error("Error loading packaging costs:", error);
    }
}

            // SavePackagingCosts FUNCTIE
async function savePackagingCosts() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'packaging');
    
    try {
        await setDoc(settingsDocRef, packagingCosts);
        showToast('Packaging stock updated successfully!', 'success');
        await loadPackagingCosts();
    } catch (error) {
        console.error("Error saving packaging costs:", error);
        showToast('Failed to save packaging costs.', 'error');
    }
}

// --- NIEUWE FUNCTIES VOOR WATERPROFIELBEHEER ---

// Laadt de profielen van de gebruiker uit Firestore
async function loadUserWaterProfiles() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const profilesCol = collection(db, 'artifacts', appId, 'users', userId, 'waterProfiles');
    
    onSnapshot(query(profilesCol), (snapshot) => {
        userWaterProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateWaterDropdown();
        renderUserWaterProfilesList();
    });
}

// Vult de dropdown met ingebouwde en eigen profielen
function populateWaterDropdown() {
    const select = document.getElementById('waterSource');
    if (!select) return;
    
    select.innerHTML = `
        <optgroup label="Built-in Profiles">
            ${Object.entries(BUILT_IN_WATER_PROFILES).map(([id, profile]) => `<option value="builtin_${id}">${profile.name}</option>`).join('')}
        </optgroup>
        <optgroup label="My Profiles">
            ${userWaterProfiles.map(profile => `<option value="user_${profile.id}">${profile.name}</option>`).join('')}
        </optgroup>
    `;
}

// Toont de lijst met eigen profielen
function renderUserWaterProfilesList() {
    const listDiv = document.getElementById('user-water-profiles-list');
    if (!listDiv) return;
    if (userWaterProfiles.length === 0) {
        listDiv.innerHTML = `<p class="text-sm text-app-secondary/80 text-center">You have no saved profiles.</p>`;
        return;
    }
    listDiv.innerHTML = userWaterProfiles.map(p => `
        <div class="flex justify-between items-center p-2 card rounded-md text-sm">
            <span>${p.name}</span>
            <div>
                <button onclick="window.editWaterProfile('${p.id}')" class="text-blue-600 hover:text-blue-800">Edit</button>
                <button onclick="window.deleteWaterProfile('${p.id}')" class="text-red-600 hover:text-red-800 ml-2">Delete</button>
            </div>
        </div>
    `).join('');
}

// Slaat een nieuw of bewerkt profiel op
async function saveWaterProfile(e) {
    e.preventDefault();
    if (!userId) return;
    
    const profileId = document.getElementById('water-profile-id').value;
    const profileData = {
        name: document.getElementById('water-profile-name').value,
        ca: parseFloat(document.getElementById('manual_ca').value) || 0,
        mg: parseFloat(document.getElementById('manual_mg').value) || 0,
        na: parseFloat(document.getElementById('manual_na').value) || 0,
        so4: parseFloat(document.getElementById('manual_so4').value) || 0,
        cl: parseFloat(document.getElementById('manual_cl').value) || 0,
        hco3: parseFloat(document.getElementById('manual_hco3').value) || 0,
    };
    if (!profileData.name) {
        showToast("Profile name is required.", "error");
        return;
    }
    
    const appId = 'meandery-aa05e';
    const profilesCol = collection(db, 'artifacts', appId, 'users', userId, 'waterProfiles');
    
    try {
        if (profileId) { // Update
            await setDoc(doc(profilesCol, profileId), profileData);
        } else { // Nieuw
            await addDoc(profilesCol, profileData);
        }
        showToast("Water profile saved!", "success");
        document.getElementById('water-profile-form').reset();
        document.getElementById('water-profile-id').value = '';
    } catch (error) {
        showToast("Error saving profile.", "error");
        console.error(error);
    }
}

// Vult het formulier om een profiel te bewerken
window.editWaterProfile = function(profileId) {
    const profile = userWaterProfiles.find(p => p.id === profileId);
    if (!profile) return;
    document.getElementById('water-profile-id').value = profile.id;
    document.getElementById('water-profile-name').value = profile.name;
    document.getElementById('manual_ca').value = profile.ca;
    document.getElementById('manual_mg').value = profile.mg;
    document.getElementById('manual_na').value = profile.na;
    document.getElementById('manual_so4').value = profile.so4;
    document.getElementById('manual_cl').value = profile.cl;
    document.getElementById('manual_hco3').value = profile.hco3;
    document.getElementById('water-profile-name').focus();
}

// Verwijdert een profiel
window.deleteWaterProfile = async function(profileId) {
    if (!userId || !confirm("Are you sure you want to delete this water profile?")) return;
    try {
        const appId = 'meandery-aa05e';
        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'waterProfiles', profileId));
        showToast("Profile deleted.", "success");
    } catch (error) {
        showToast("Error deleting profile.", "error");
    }
}

// Vind water profielen
async function findWaterProfileWithAI() {
    const searchBtn = document.getElementById('ai-water-search-btn');
    const searchInput = document.getElementById('ai-water-search-name');
    const brandName = searchInput.value;

    if (!brandName.trim()) {
        showToast("Please enter a brand name to search.", "error");
        return;
    }

    searchBtn.disabled = true;
    searchBtn.textContent = '...';

    const prompt = `Find the typical mineral water profile for a brand named "${brandName}". Provide the results for Calcium (ca), Magnesium (mg), Sodium (na), Sulfate (so4), Chloride (cl), and Bicarbonate (hco3) in mg/L. Respond ONLY with a valid JSON object matching the specified schema. If you cannot find the profile, respond with a JSON object where all values are 0.`;
    const schema = {
        type: "OBJECT",
        properties: {
            "ca": { "type": "NUMBER" }, "mg": { "type": "NUMBER" },
            "na": { "type": "NUMBER" }, "so4": { "type": "NUMBER" },
            "cl": { "type": "NUMBER" }, "hco3": { "type": "NUMBER" }
        },
        required: ["ca", "mg", "na", "so4", "cl", "hco3"]
    };

    try {
        const jsonResponse = await performApiCall(prompt, schema);
        const profile = JSON.parse(jsonResponse);

        if (profile.ca === 0 && profile.mg === 0) {
            showToast(`Could not find a profile for "${brandName}".`, 'info');
        } else {
            // Vul het formulier in met de gevonden data
            document.getElementById('water-profile-name').value = brandName;
            document.getElementById('manual_ca').value = profile.ca;
            document.getElementById('manual_mg').value = profile.mg;
            document.getElementById('manual_na').value = profile.na;
            document.getElementById('manual_so4').value = profile.so4;
            document.getElementById('manual_cl').value = profile.cl;
            document.getElementById('manual_hco3').value = profile.hco3;
            showToast(`Profile for "${brandName}" found! Review and save.`, 'success');
        }
    } catch (error) {
        showToast("AI search failed. Please try again.", "error");
        console.error(error);
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Find';
    }
}

window.showBrewPrompt = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew || !brew.prompt) {
        showToast("No prompt was saved for this recipe.", "info");
        return;
    }
    const modal = document.getElementById('prompt-modal');
    const content = document.getElementById('prompt-modal-content');
    content.textContent = brew.prompt;
    modal.classList.remove('hidden');
}

function refreshCurrentChecklistView() {
    // Controleer welke view momenteel zichtbaar is
    const brewDay1View = document.getElementById('brew-day-1-view');
    const brewDay2View = document.getElementById('brew-day-2-view');

    if (brewDay1View && !brewDay1View.classList.contains('hidden')) {
        // We zijn op Brew Day 1, update de UI met de progressiebalk
        currentStepIndex = Object.keys(currentBrewDay.checklist).length;
        updateUI();
    } else if (brewDay2View && !brewDay2View.classList.contains('hidden')) {
        // We zijn op Brew Day 2, herlaad de volledige detailweergave
        window.showBrewDay2Detail(currentBrewDay.brewId);
    }
}

            // --- Initialization ---
            function initApp() {

            // --- Assign UI Elements now that the DOM is loaded ---
            dashboardMainView = document.getElementById('dashboard-main-view');
            creatorView = document.getElementById('creator-view');
            brewingView = document.getElementById('brewing-view');
            historyView = document.getElementById('history-view');
            inventoryView = document.getElementById('inventory-view');
            planningView = document.getElementById('planning-view');
            financialsView = document.getElementById('financials-view');
            socialView = document.getElementById('social-view');
            troubleshootView = document.getElementById('troubleshoot-view');
            calculatorsView = document.getElementById('calculators-view');
            waterView = document.getElementById('water-view');
            settingsView = document.getElementById('settings-main-view');
            brewingMainView = document.getElementById('brewing-main-view');
            managementMainView = document.getElementById('management-main-view');
            toolsMainView = document.getElementById('tools-main-view');
            styleSelect = document.getElementById('style');
            fruitSection = document.getElementById('fruit-section');
            spiceSection = document.getElementById('spice-section');
            braggotSection = document.getElementById('braggot-section');
            generateBtn = document.getElementById('generateBtn');
            recipeOutput = document.getElementById('recipe-output');
            brewDayContent = document.getElementById('brew-day-content');
            historyList = document.getElementById('history-list');
            historyDetailContainer = document.getElementById('history-detail-container');
            historyListContainer = document.getElementById('history-list-container');
            inventoryForm = document.getElementById('inventory-form');
            inventoryList = document.getElementById('inventory-list');
            getWaterAdviceBtn = document.getElementById('getWaterAdviceBtn');
            getYeastAdviceBtn = document.getElementById('getYeastAdviceBtn');
            waterSourceSelect = document.getElementById('waterSource');
            manualWaterProfileDiv = document.getElementById('manualWaterProfile');
            troubleshootBtn = document.getElementById('troubleshoot-btn');
            apiKeyInput = document.getElementById('apiKeyInput');
            defaultBatchSizeInput = document.getElementById('defaultBatchSizeInput');
            defaultCurrencyInput = document.getElementById('defaultCurrencyInput');
            saveSettingsBtn = document.getElementById('saveSettingsBtn');
            settingsMessage = document.getElementById('settingsMessage');
            themeToggle = document.getElementById('theme-toggle-checkbox');
            exportHistoryBtn = document.getElementById('exportHistoryBtn');
            exportInventoryBtn = document.getElementById('exportInventoryBtn');
            importHistoryFile = document.getElementById('importHistoryFile');
            importInventoryFile = document.getElementById('importInventoryFile');
            clearHistoryBtn = document.getElementById('clearHistoryBtn');
            clearInventoryBtn = document.getElementById('clearInventoryBtn');
            labelsView = document.getElementById('labels-view');
            logoUploadInput = document.getElementById('logoUpload');
            labelPreview = document.getElementById('label-preview');

            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyAhOOrwJCYve5XTGS6oXvhCg_l3_LcK00I",
              authDomain: "meandery-aa05e.firebaseapp.com",
              projectId: "meandery-aa05e",
              storageBucket: "meandery-aa05e.appspot.com",
              messagingSenderId: "388311971225",
              appId: "1:388311971225:web:e5b0e81ce18d96b4a88f08",
              measurementId: "G-S5CPLP80XT"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);

                onAuthStateChanged(auth, async (user) => {
    const loginView = document.getElementById('login-view');
    // AANGEPAST: We verwijzen naar de container van de hele app, niet alleen het dashboard.
    // Dit zorgt ervoor dat de header en andere elementen ook correct getoond/verborgen worden.
    const appContainer = document.querySelector('.container.mx-auto'); 

    if (user && !user.isAnonymous) {
        // Gebruiker is succesvol ingelogd met Google
        userId = user.uid;

        // 1. VERBERG HET LOGIN-SCHERM ONMIDDELLIJK en toon de app
        loginView.classList.add('hidden');
        if (appContainer) appContainer.classList.remove('hidden'); // Toon de app

        // 2. LAAD VERVOLGENS VEILIG DE DATA
        // Een try...catch blok vangt fouten op zonder de hele app te laten crashen.
        // Promise.all() laadt alles tegelijk voor betere prestaties.
        try {
            await Promise.all([
                loadHistory(),
                loadInventory(),
                loadEquipmentProfiles(),
                loadCellar(),
                loadUserSettings(),
                loadPackagingCosts(),
                loadUserWaterProfiles()
            ]);
        } catch (error) {
            console.error("Fout bij het laden van de gebruikersdata:", error);
            // Toon een duidelijke foutmelding aan de gebruiker
            showToast("Kon niet alle gegevens laden. Probeer de pagina te vernieuwen.", "error", 6000);
        }

    } else {
        // Geen gebruiker of anonieme gebruiker -> toon login-scherm
        loginView.classList.remove('hidden');
        if (appContainer) appContainer.classList.add('hidden'); // Verberg de app

        // Log eventuele anonieme of onbekende gebruikers uit
        if (user && user.isAnonymous) {
            auth.signOut();
        }
    }
});
    } catch (e) {
        console.error("Firebase initialization failed. App will run in offline mode.", e);
        recipeOutput.innerHTML = `<p class="text-orange-600 font-bold">Running in offline mode. History and Inventory are disabled.</p>`;
    }


    // --- Event Listeners ---
    document.getElementById('history-search-input').addEventListener('input', renderHistoryList);
    document.getElementById('packaging-add-form').addEventListener('submit', addPackagingStock);
    document.getElementById('danger-cancel-btn').addEventListener('click', hideDangerModal);
    document.getElementById('danger-confirm-btn').addEventListener('click', executeDangerAction);
    document.getElementById('danger-confirm-input').addEventListener('input', checkDangerConfirmation);
    document.getElementById('customDescription').addEventListener('input', handleDescriptionInput);
    document.getElementById('close-prompt-modal-btn').addEventListener('click', hidePromptModal);
    document.getElementById('water-profile-form').addEventListener('submit', saveWaterProfile);
    document.getElementById('waterSource').addEventListener('change', handleWaterSourceChange);
    document.getElementById('ai-water-search-btn').addEventListener('click', findWaterProfileWithAI);
    document.getElementById('prompt-modal').addEventListener('click', function(e) {
        if (e.target.id === 'prompt-modal') {
            hidePromptModal();
        }
    });
    document.querySelectorAll('.main-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => switchMainView(btn.dataset.view));
    });
    document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => {
        btn.addEventListener('click', () => switchMainView('dashboard'));
    });
    document.querySelectorAll('.sub-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const parentId = e.target.closest('[id$="-main-view"]').id;
            switchSubView(e.target.id.replace('-sub-tab', ''), parentId);
        });
    });
    document.getElementById('honeyVariety').addEventListener('change', (e) => {
    document.getElementById('honeyVarietyOther').classList.toggle('hidden', e.target.value !== 'other');
    });

    setupBrewDayEventListeners();
    styleSelect.addEventListener('change', handleStyleChange);
    generateBtn.addEventListener('click', generateRecipe);
    inventoryForm.addEventListener('submit', addInventoryItem);
    document.getElementById('equipment-profile-form').addEventListener('submit', addEquipmentProfile);
    document.getElementById('equipProfileType').addEventListener('change', handleEquipmentTypeChange);
    document.getElementById('bottling-form').addEventListener('submit', bottleBatch);
    document.getElementById('scan-barcode-btn').addEventListener('click', startScanner);
    document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
    document.getElementById('useInventory').addEventListener('change', (e) => {
                document.getElementById('budget-section').classList.toggle('hidden', !e.target.checked);
                handleInventoryToggle(e);
            });
    document.getElementById('useBudget').addEventListener('change', (e) => {
        document.getElementById('budget-input-container').classList.toggle('hidden', !e.target.checked);
    });

    // Calculator buttons
    document.getElementById('calcAbvBtn').addEventListener('click', calculateABV);
    document.getElementById('correctSgBtn').addEventListener('click', correctHydrometer);
    document.getElementById('calcSugarBtn').addEventListener('click', calculatePrimingSugar);
    document.getElementById('calcBlendBtn').addEventListener('click', calculateBlend);
    document.getElementById('calcBacksweetenBtn').addEventListener('click', calculateBacksweetening);
    document.getElementById('calcDilutionBtn').addEventListener('click', calculateDilution);
    document.getElementById('calcTosnaBtn').addEventListener('click', calculateTOSNA);
    getYeastAdviceBtn.addEventListener('click', getYeastAdvice);

    // Manual social post button
    document.getElementById('generate-manual-social-btn').addEventListener('click', runManualSocialMediaGenerator);
    document.getElementById('generate-social-from-recipe-btn').addEventListener('click', runSocialMediaGenerator);
    
    // Water tab buttons
    waterSourceSelect.addEventListener('change', handleWaterSourceChange);
    getWaterAdviceBtn.addEventListener('click', getWaterAdvice);

    // Settings
    saveSettingsBtn.addEventListener('click', saveUserSettings);
    themeToggle.addEventListener('change', (e) => applyTheme(e.target.checked ? 'dark' : 'light'));
    exportHistoryBtn.addEventListener('click', exportHistory);
    exportInventoryBtn.addEventListener('click', exportInventory);
    importHistoryFile.addEventListener('change', importHistory);
    importInventoryFile.addEventListener('change', importInventory);
    clearHistoryBtn.addEventListener('click', clearHistory);
    clearInventoryBtn.addEventListener('click', clearInventory);
    
    // Troubleshoot
    troubleshootBtn.addEventListener('click', getTroubleshootingAdvice);
    
            // Label Generator Listeners
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            document.getElementById('removeLogoBtn').addEventListener('click', removeLogo);
            document.getElementById('labelRecipeSelect').addEventListener('change', handleLabelRecipeSelect);
            document.querySelectorAll('.label-style-btn').forEach(btn => btn.addEventListener('click', () => switchLabelStyle(btn.dataset.style)));
            document.getElementById('generate-print-btn').addEventListener('click', generatePrintPage);
            document.querySelectorAll('.orientation-btn').forEach(btn => {
                btn.addEventListener('click', () => setLabelOrientation(btn.dataset.orientation));
            });
            
            ['labelStyle', 'labelAbv', 'labelVol', 'labelDate'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keyup', updateLabelPreview);
                }
            });

            const formatSelect = document.getElementById('labelFormatSelect');
            if (formatSelect) {
                formatSelect.addEventListener('change', (e) => {
                    document.getElementById('custom-format-inputs').classList.toggle('hidden', e.target.value !== 'custom');
                    updatePreviewAspectRatio(); // Update aspect ratio bij wijziging
                });
            }

            // Listeners voor custom formaat inputs
            ['customWidth', 'customHeight', 'customCols', 'customRows', 'customMarginTop', 'customMarginLeft'].forEach(id => {
                const input = document.getElementById(id);
                if(input) {
                    input.addEventListener('input', updatePreviewAspectRatio);
                }
            });

    handleStyleChange();
    }

            // --- View Management ---
            function switchMainView(viewName) {
                if (window.hideBottlingModal) hideBottlingModal();
                
                [dashboardMainView, brewingMainView, managementMainView, toolsMainView, settingsView].forEach(v => v.classList.add('hidden'));
                
                const viewToShow = document.getElementById(`${viewName}-main-view`);

                if (viewToShow) {
                    viewToShow.classList.remove('hidden');

                    if (viewName === 'brewing') {
                        populateEquipmentProfilesDropdown();
                    }
                }
            }

            window.switchSubView = function(viewName, parentViewId) {
    const parentView = document.getElementById(parentViewId);
    parentView.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
    parentView.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));

    const viewId = `${viewName}-view`;
    const tabId = `${viewName}-sub-tab`;

    const viewToShow = document.getElementById(viewId);
    const tabToActivate = document.getElementById(tabId);

    if (viewToShow) viewToShow.classList.remove('hidden');
    if (tabToActivate) tabToActivate.classList.add('active');

    if (viewName === 'brew-day-2') {
        renderBrewDay2();
    }

    if (viewName === 'creator') {
        populateEquipmentProfilesDropdown();
    } 
    if (viewName === 'social') {
        populateSocialRecipeDropdown();
    }
    if (viewName === 'labels') {
        populateLabelRecipeDropdown();
        updatePreviewAspectRatio();
    }
}

            // --- Settings Management (Firebase) ---
            async function loadUserSettings() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
    
    try {
        const docSnap = await getDoc(settingsDocRef);
        if (docSnap.exists()) {
            userSettings = docSnap.data();
            currentBrewDay = userSettings.currentBrewDay || { brewId: null, checklist: {} };
            if(currentBrewDay.brewId) {
               renderBrewDay(currentBrewDay.brewId);
            }
        } else {
            // Voeg de nieuwe imageApiKey toe aan de standaardinstellingen
            userSettings = { apiKey: '', imageApiKey: '', defaultBatchSize: 5, currencySymbol: '€', theme: 'light' };
        }
        applySettings();
    } catch (error) {
        console.error("Error loading user settings:", error);
    }
}
            
            function applySettings() {
    apiKeyInput.value = userSettings.apiKey || '';
    document.getElementById('imageApiKeyInput').value = userSettings.imageApiKey || '';
    
    const batchSizeInput = document.getElementById('batchSize');
    if (batchSizeInput) {
        batchSizeInput.value = userSettings.defaultBatchSize || 5;
    }
    
    defaultBatchSizeInput.value = userSettings.defaultBatchSize || 5;
    defaultCurrencyInput.value = userSettings.currencySymbol || '€';
    themeToggle.checked = (userSettings.theme === 'dark');
                
                const priceLabel = document.querySelector('label[for="itemPrice"]');
                if(priceLabel) {
                    priceLabel.textContent = `Price (${userSettings.currencySymbol || '€'})`;
                }
                
                applyTheme(userSettings.theme);
            }

            async function saveUserSettings() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
    
    // Voeg de nieuwe imageApiKey toe aan de op te slagen data
    const newSettings = {
        apiKey: document.getElementById('apiKeyInput').value.trim(),
        imageApiKey: document.getElementById('imageApiKeyInput').value.trim(), // NIEUW
        defaultBatchSize: parseFloat(defaultBatchSizeInput.value) || 5,
        currencySymbol: defaultCurrencyInput.value.trim() || '€',
        theme: themeToggle.checked ? 'dark' : 'light',
        currentBrewDay: currentBrewDay
    };
    try {
        await setDoc(settingsDocRef, newSettings, { merge: true });
        userSettings = newSettings;
        applySettings();
        showToast('Settings saved successfully!', 'success');
    } catch (error) {
        console.error("Error saving settings:", error);
        showToast('Failed to save settings.', 'error');
    }
}

// Slaat enkel de voortgang van de checklist op, zonder de verkeerde toast-melding.
async function saveChecklistState() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
    try {
        // Update enkel het currentBrewDay veld, en laat de rest van de settings met rust.
        await updateDoc(settingsDocRef, { currentBrewDay: currentBrewDay });
    } catch (error) {
        console.error("Error saving checklist state:", error);
        showToast('Failed to save progress.', 'error');
    }
}

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // --- Data Management Functions ---
            function exportData(data, filename) {
                const dataToExport = data.map(item => {
                    const newItem = {...item};
                    // Convert Firestore Timestamps to a serializable format
                    if (newItem.createdAt && typeof newItem.createdAt.toDate === 'function') {
                        newItem.createdAt = newItem.createdAt.toDate().toISOString();
                    }
                    return newItem;
                });
                const jsonStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportHistory() {
                exportData(brews, 'meandery_history_export.json');
            }

            function exportInventory() {
                exportData(inventory, 'meandery_inventory_export.json');
            }

            function importData(event, collectionName) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error("Invalid JSON format. Expected an array.");

                        if (!confirm(`This will OVERWRITE your current ${collectionName}. This cannot be undone. Are you sure?`)) return;

                        showToast(`Importing ${collectionName}...`);
                        const appId = 'meandery-aa05e';
                        const collectionRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
                        
                        await clearCollection(collectionName, false);

                        const batch = writeBatch(db);
                        data.forEach(item => {
                            const { id, ...itemData } = item;
                            if (itemData.createdAt && typeof itemData.createdAt === 'string') {
                                itemData.createdAt = new Date(itemData.createdAt);
                            }
                            const newDocRef = doc(collectionRef);
                            batch.set(newDocRef, itemData);
                        });
                        await batch.commit();
                        showToast(`${collectionName} imported successfully!`, 'success');
                    } catch (error) {
                        console.error(`Error importing ${collectionName}:`, error);
                        showToast(`Error: ${error.message}`, 'error');
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            }

            function importHistory(e) {
                importData(e, 'brews');
            }

            function importInventory(e) {
                importData(e, 'inventory');
            }

            async function clearCollection(collectionName, confirmFirst = true) {
    if (confirmFirst && !confirm(`DANGER: This will permanently delete all your ${collectionName}. This cannot be undone. Are you sure?`)) {
        return false;
                }
                if (!userId) return false;
                const appId = 'meandery-aa05e';
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
                const snapshot = await getDocs(collectionRef);
                if (snapshot.empty) return true; // Nothing to delete
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                return true;
            }

            async function clearHistory() {
    const action = async () => {
        if (await clearCollection('brews', false)) { // 'false' to skip the old confirm
            showToast('Brew history cleared.', 'success');
        }
    };
    showDangerModal(action, "DELETE HISTORY");
}

async function clearInventory() {
    const action = async () => {
        if (await clearCollection('inventory', false)) { // 'false' to skip the old confirm
            showToast('Inventory cleared.', 'success');
        }
    };
    showDangerModal(action, "DELETE INVENTORY");
}

            // --- Core AI Functions ---
            async function performApiCall(prompt, schema = null) {
    const apiKey = userSettings.apiKey;
    if (!apiKey) {
        throw new Error("Please enter your Google AI API key in the Settings page first.");
    }
    
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
    const payload = { contents: chatHistory };

    if (schema) {
        payload.generationConfig = {
            responseMimeType: "application/json",
            responseSchema: schema
        };
    }

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const errorBody = await response.json();
        const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
        throw new Error(errorMessage);
    }
    
    const result = await response.json();

    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
        return result.candidates[0].content.parts[0].text;
    } else {
        throw new Error("Invalid response structure from API.");
    }
}

            // DEFINITIEVE FUNCTIE OM RECEPTGEGEVENS TE PARSEN
            function parseRecipeData(markdown) {
                // Deze regel is voor debuggen. Het toont de volledige tekst van de AI in de browser console.
                console.log("AI Recipe Output:", markdown);

                const data = {};

                // Zoek de titel
                const titleMatch = markdown.match(/^#\s*(.*)/m);
                if (titleMatch && titleMatch[1]) {
                    data.recipeName = titleMatch[1].trim();
                }

                // Zoek Target OG
                const ogMatch = markdown.match(/(?:Target OG|Original Gravity|Start SG|O\.G\.)[\s\w:]*(\d\.\d{3})/i);
                if (ogMatch && ogMatch[1]) {
                    data.targetOG = ogMatch[1];
                }

                // Zoek Target FG
                const fgMatch = markdown.match(/(?:Target FG|Final Gravity|Eind SG|F\.G\.)[\s\w:]*(\d\.\d{3})/i);
                if (fgMatch && fgMatch[1]) {
                    data.targetFG = fgMatch[1];
                }

                // DEFINITIEVE, VEREENVOUDIGDE ZOEKTOCHT NAAR TARGET ABV
                // Dit patroon zoekt nu heel direct naar "keyword: getal".
                const abvMatch = markdown.match(/(?:Target ABV|ABV|Alcoholpercentage):\s*([\d.,]+)/i);
                if (abvMatch && abvMatch[1]) {
                    // Stap 1: Pak het getal (bv. "12.5")
                    const abvValue = abvMatch[1];
                    // Stap 2: Voeg het '%' symbool toe en vul het in
                    data.targetABV = `${abvValue}%`;
                }

                return data;
            }

async function generateRecipe() {
    recipeOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Consulting the Alchemist... your custom recipe is being crafted.</p>';
    generateBtn.disabled = true;
    generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
    currentPredictedProfile = null; // Reset bij elke nieuwe generatie

    try {
        const prompt = buildPrompt();
        lastGeneratedPrompt = prompt;
        currentRecipeMarkdown = await performApiCall(prompt);
        
        // Genereer het smaakprofiel onmiddellijk
        currentPredictedProfile = await getPredictedFlavorProfile(currentRecipeMarkdown);
        let flavorProfileHtml = '';
        if (currentPredictedProfile) {
            flavorProfileHtml = `
                <div class="mt-8 pt-6 border-t border-app">
                    <h3 class="text-2xl font-header font-bold text-center mb-4">Predicted Flavor Profile</h3>
                    <div class="card p-4 rounded-lg max-w-sm mx-auto">
                        <canvas id="generated-flavor-wheel"></canvas>
                    </div>
                </div>
            `;
        }
        
        let finalMarkdown = currentRecipeMarkdown;
        
        // CORRECTIE: De jsonRegex en jsonMatch declaraties waren hier vergeten
        const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
        const jsonMatch = currentRecipeMarkdown.match(jsonRegex);

        if (jsonMatch && jsonMatch[1]) {
            try {
                const ingredientsArray = JSON.parse(jsonMatch[1]);
                let tableMarkdown = '| Ingredient | Quantity | Unit |\n';
                tableMarkdown += '|---|---|---|\n';
                ingredientsArray.forEach(item => {
                    tableMarkdown += `| ${item.ingredient} | ${item.quantity} | ${item.unit} |\n`;
                });
                finalMarkdown = currentRecipeMarkdown.replace(jsonRegex, tableMarkdown);
            } catch (e) {
                console.error("Failed to parse ingredients JSON from AI response:", e);
                // finalMarkdown blijft de originele markdown bij een fout
            }
        }

        finalMarkdown = finalMarkdown.replace(/\[d:[\d:]+\]/g, '');
        const recipeHtml = marked.parse(finalMarkdown);
        
        // CORRECTIE: De flavorProfileHtml wordt nu hier toegevoegd
        const fullHtml = `
            <div class="print-button-container text-right mb-4 flex justify-end flex-wrap gap-2 no-print">
                <button onclick="window.showLastPrompt()" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn text-sm">
                    Show AI Prompt
                </button>
                <button onclick="window.print()" class="bg-stone-600 text-white py-2 px-4 rounded-lg hover:bg-stone-700 transition-colors btn">
                    Print Recipe
                </button>
            </div>
            <div class="recipe-content">${recipeHtml}</div>
            ${flavorProfileHtml}
            <div class="mt-6 no-print">
                <button id="saveBtn" class="w-full bg-green-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-800 transition-colors btn">
                    Save to Brew History
                </button>
            </div>
        `;
        recipeOutput.innerHTML = fullHtml;

        if (currentPredictedProfile) {
            renderGeneratedFlavorWheel(currentPredictedProfile);
        }

        document.getElementById('saveBtn').addEventListener('click', saveBrewToHistory);

    } catch (error) {
        console.error("Error calling Gemini API:", error);
        recipeOutput.innerHTML = `<p class="text-center text-red-600 font-bold">Sorry, the Alchemist is busy. Please try again.</p><p class="text-center text-sm text-app-secondary/80">${error.message}</p>`;
    } finally {
        generateBtn.disabled = false;
        generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}          

function buildPrompt() {
    try {
        const batchSize = document.getElementById('batchSize').value || '5';
        const yeastInInventory = inventory.filter(i => i.category === 'Yeast').map(i => i.name).join(', ') || 'None available';
        const nutrientsInInventory = inventory.filter(i => i.category === 'Nutrient').map(i => i.name).join(', ') || 'None available';
        
        const availableFermenters = equipmentProfiles
            .filter(p => p.type === 'Fermenter' && p.capacityLiters)
            .map(p => `${p.name} (${p.capacityLiters}L total capacity, ${p.trubLossLiters || 0}L loss)`)
            .join('; ');

        let basePrompt = `You are an expert mead maker named "MEA(N)DERY" and a logistics expert. Your primary goal is to create a practical, feasible recipe that fits the user's equipment.

**CRUCIAL EQUIPMENT & VOLUME LOGIC (MUST FOLLOW IN ORDER):**
1.  **Design Initial Recipe:** Mentally design the best recipe for the user's requested final batch size of **${batchSize} liters**.
2.  **Calculate Total Volume:** Calculate the **Total Required Fermenter Volume**. This is the sum of all liquids PLUS the volume displaced by solids. Use these strict estimations:
    -   1 kg of fruit/solids displaces **0.7 liters**.
    -   1.3 kg of honey displaces approximately **1 liter**.
    -   Account for any specified 'Trub/Yeast Loss'.
3.  **Select Best Fermenter:** Look at the user's available fermenters: [${availableFermenters}].
    -   **A) Fruit Priority:** If the recipe contains a significant amount of fruit (>1kg), you **MUST** prioritize selecting a fermenter with 'wide mouth', 'bucket', or 'Speidel' in its name over one named 'carboy' or 'demijohn', if a suitable size is available. This is for practical reasons.
    -   **B) Size Priority:** Select the **smallest** suitable fermenter that can hold the 'Total Required Fermenter Volume' while leaving at least 20% headspace for safety.
4.  **HARD CHECK & FINAL ACTION:**
    -   **If a suitable fermenter is found:** Finalize the recipe with the initial ingredient quantities.
    -   **If NO fermenter is large enough:** Your final, most important task is to **SCALE DOWN THE ENTIRE RECIPE**. You must proportionally reduce all ingredients (liquids and solids) until the new 'Total Required Fermenter Volume' fits into the largest available fermenter with 20% headspace.
5.  **Communicate & Generate:** In the "Brewer's Notes", add a "Volume & Equipment" note explaining your choice of fermenter and if/why you scaled the recipe down. **The final ## Ingredients list you generate MUST reflect the scaled-down quantities if a scale-down was necessary.**

**CRUCIAL TITLE RULE: You are not a recipe assistant, you are a branding expert and storyteller.**
Your primary task is to invent a captivating and memorable name for this mead. Follow this exact thought process:
1.  **Find a Concept:** First, look at the core ingredients and style (e.g., dark fruit, spices, bochet). Find a creative theme or concept inspired by mythology, history, literature, a specific feeling, or a clever pun.
2.  **Invent a Name:** THEN, and only then, create a unique name based on that concept.

**HARD CONSTRAINTS:**
-   The title **MUST NOT** start with a list of its main ingredients (e.g., "Plum & Almond...").
-   The title **MUST NOT** use generic, cheesy words like 'Delight', 'Embrace', 'Kiss', 'Symphony', or 'Elixir'.

**Examples of EXCELLENT Titles:**
-   For a red fruit melomel: '# The Burning of Troy: An Opal and Red Currant Melomel'
-   For a spiced mead: '# The Alchemist's Folly: A Spiced Winter Metheglin'
-   For a traditional mead: '# Valkyrie's Veil: A Classic Wildflower Mead'

**Examples of BAD, BORING Titles (AVOID THESE):**
-   'Plum & Redcurrant Delight'
-   'Sweet Honey Kiss'
-   'My First Melomel'

**FORMAT:** The title MUST be the very first line, formatted as a Markdown H1 heading (e.g., '# Invented Name: A Brief Description'). Do NOT use square brackets [].

Your response MUST be structured with the following headings in this exact order:
## Description
## Key Stats
## Ingredients
## Instructions
## Brewer's Notes
## Recommended Water

**ADVANCED LOGIC & SUBSTITUTION RULES (YOU MUST FOLLOW THESE):**
1.  **Yeast Logic:** First, determine the ideal yeast. Then, check the user's inventory: [${yeastInInventory}]. If a suitable substitute is found, use it and explain in "Brewer's Notes". Otherwise, recommend a common dry yeast and explain why the inventory yeasts aren't a good match.
2.  **Nutrient Logic:** First, as an expert, determine the **best nutrient schedule** for this specific recipe. This could be a single dose upfront or a full Staggered Nutrient Addition (SNA) schedule, depending on the Original Gravity and yeast needs. You MUST use the user's nutrient from their inventory: [${nutrientsInInventory}]. **If, and only if, you decide an SNA is the best approach,** you MUST then follow these strict formatting rules:
    - Create a separate, numbered list item for EACH addition.
    - The timer tag \`[d:HH:MM:SS]\` for each step **MUST** represent the waiting time **since the previous addition**.
    - **Example:** For additions at 24h, 48h, and 72h, all three steps must have a \`[d:24:00:00]\` tag.
3.  **Water Choice:** In "Recommended Water", recommend a specific Belgian bottled water (e.g., Spa Reine, Chaudfontaine) and explain your choice based on the mead style.
4.  **Key Stats Section:** The "## Key Stats" section is MANDATORY. It MUST be placed directly after "## Description" and before "## Ingredients". It MUST contain a list with the following three values, formatted exactly like this:
    - Target OG: 1.XXX
    - Target FG: 1.XXX
    - Target ABV: XX.X%
5.  **Brewer's Notes Structure:** The "## Brewer's Notes" section MUST be well-structured. Each distinct topic (Yeast, Nutrients, Volume & Equipment, etc.) MUST be introduced on a new line with a bolded title followed by a colon. For example:
    - **Yeast:** I selected Oenoferm BOUQUET because...
    - **Nutrients:** The schedule uses VitaFerm to...
    - **Volume & Equipment:** I chose the 20L Speidel because...

Now, generate the recipe based on the following user request:
---`;
        
        let creativeBrief = ''; 
        const inventoryString = inventory.map(item => `${item.name}: ${item.qty} ${item.unit}`).join('; ');
        
        const customDescription = document.getElementById('customDescription').value;
        const useInventory = document.getElementById('useInventory').checked;

        if (customDescription.trim() !== '') {
            creativeBrief += `The user's request is a free-text description: "${customDescription}". Prioritize using ingredients from their inventory if suitable: [${inventoryString}].`;
        } else if (useInventory) {
            const currency = userSettings.currencySymbol || '€';
            const useBudget = document.getElementById('useBudget').checked;
            const maxBudget = document.getElementById('maxBudget').value;
            const richInventoryString = inventory.map(item => {
                let costPerUnit = 0; let baseUnit = item.unit; if (item.qty > 0 && item.price > 0) { costPerUnit = item.price / item.qty; } if (item.unit === 'kg') { costPerUnit /= 1000; baseUnit = 'g'; } else if (item.unit === 'L') { costPerUnit /= 1000; baseUnit = 'ml'; }
                return `${item.name}: ${item.qty} ${item.unit} available (Cost: ${costPerUnit.toFixed(2)} ${currency}/${baseUnit})`;
            }).join('; ');
            
            creativeBrief += `The user wants a recipe created from their inventory: [${richInventoryString}]. Use these parameters as guidelines:\n- Target ABV: Approximately ${document.getElementById('abv').value || '12'}%\n- Final Sweetness: ${document.getElementById('sweetness').selectedOptions[0].text}\n- Style Inspiration: ${document.getElementById('style').selectedOptions[0].text}`;
            
            if (useBudget && maxBudget) {
                creativeBrief += `\n\nCRUCIAL CONSTRAINT: The total cost of the ingredients for this recipe MUST NOT EXCEED ${maxBudget} ${currency}. You must use the provided ingredient costs to calculate this and stay within budget. In the Brewer's Notes, state the calculated total cost.`;
            }

        } else {
            const style = document.getElementById('style').selectedOptions[0].text;
            let honeyValue = document.getElementById('honeyVariety').options[document.getElementById('honeyVariety').selectedIndex].text;
            const honeySelectValue = document.getElementById('honeyVariety').value;
            if (honeySelectValue === 'other') { const otherHoney = document.getElementById('honeyVarietyOther').value; if(otherHoney) honeyValue = otherHoney; }

            creativeBrief += `The user wants a recipe from scratch with these options:\n- Target ABV: Approximately ${document.getElementById('abv').value || '12'}%\n- Final Sweetness: ${document.getElementById('sweetness').selectedOptions[0].text}\n- Style Inspiration: ${style}\n- Primary Honey: ${honeyValue}`;
            if (style.includes('Melomel')) {
                const fruits = Array.from(document.querySelectorAll('#fruit-section input[type=checkbox]:checked')).map(el => el.labels[0].innerText);
                const otherFruits = document.getElementById('fruitOther').value.split(',').map(f => f.trim()).filter(f => f);
                creativeBrief += `\n- Featured Fruits: ${[...fruits, ...otherFruits].join(', ') || 'Suggest a classic combination.'}`;
            } else if (style.includes('Metheglin')) {
                const spices = Array.from(document.querySelectorAll('#spice-section input[type=checkbox]:checked')).map(el => el.labels[0].innerText);
                const otherSpices = document.getElementById('spiceOther').value.split(',').map(s => s.trim()).filter(s => s);
                creativeBrief += `\n- Featured Spices: ${[...spices, ...otherSpices].join(', ') || 'Suggest a classic blend.'}`;
            }
             if (style.toLowerCase().includes('bochet')) {
                creativeBrief += `\n- Bochet Method: You MUST recommend the best method for caramelizing the honey and provide detailed, safe instructions.`;
            }
            if (style.includes('Braggot')) {
                creativeBrief += `\n- Braggot Base: Based on a ${document.getElementById('braggotStyle').value} style. Provide an extract-based recipe.`;
            }
            if (document.getElementById('addOak').checked) {
                creativeBrief += '\n- Oak Aging: The recipe must include a step for aging with oak.';
            }
            const specialIngredients = document.getElementById('specialIngredients').value;
            if (specialIngredients && specialIngredients.trim() !== '') {
                creativeBrief += `\n- Special Ingredients: The recipe must creatively incorporate: ${specialIngredients}.`;
            }
        }
        
        const formattingRules = `
---
**FINAL AND MOST IMPORTANT INSTRUCTIONS - YOUR ENTIRE RESPONSE MUST CONFORM TO THESE RULES:**
Your response must be a single, valid Markdown document.

1.  **INGREDIENTS MUST BE A JSON CODE BLOCK:** The "## Ingredients" section MUST contain ONLY a valid JSON code block. This is not optional. The block must be an array of objects, with each object having "ingredient" (string), "quantity" (number), and "unit" (string) keys.
    Example of the required format:
    \`\`\`json
    [
      {"ingredient": "Wildflower Honey", "quantity": 1.5, "unit": "kg"},
      {"ingredient": "Spa Reine", "quantity": 4, "unit": "L"}
    ]
    \`\`\`
2.  **STRUCTURED INSTRUCTIONS:** The "## Instructions" section MUST be structured with two specific subheadings: "### Primary Fermentation" and "### Secondary & Aging". All steps must be listed under one of these.
3.  **CRUCIAL TIMER RULE:** You MUST add a timer tag \`[d:HH:MM:SS]\` for any step that requires a specific waiting period. This is mandatory for yeast rehydration, staggered nutrient additions, and timed boils. **For example, a step like "let the yeast rehydrate for 15 minutes" MUST end with the tag \`[d:00:15:00]\`. A nutrient addition at 24 hours MUST end with \`[d:24:00:00]\`.** Do NOT add a timer for general active tasks like 'mixing'.`;

        return basePrompt + creativeBrief + formattingRules;

    } catch (error) {
        console.error("Error building prompt:", error);
        throw new Error(`Failed to build the prompt. (Details: ${error.message})`);
    }
}

window.freeformTweakRecipe = async function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;
    
    const tweakRequest = document.getElementById(`tweak-request-${brew.id}`).value;
    if (!tweakRequest.trim()) {
        alert("Please enter your tweak request in the text box.");
        return;
    }
    
    const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
    tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">The Alchemist is tweaking your recipe...</p>';

    const prompt = `You are an expert mead maker. A user wants to tweak the following original recipe based on their request.

Original Recipe Markdown:
---
${brew.recipeMarkdown}
---

User's Tweak Request: "${tweakRequest}"

Generate the complete, new, and improved recipe that incorporates the user's request. Ensure the output is fully formatted in Markdown, including a new creative title in 'Name: Subtitle' format, and a complete ingredient table.`;

    try {
        const tweakedMarkdown = await performApiCall(prompt);
        tweakOutput.innerHTML = `<div class="mt-4 p-4 border-t-2 border-purple-700">${marked.parse(tweakedMarkdown)}</div>`;
    } catch (error) {
        console.error("Error tweaking recipe:", error);
        tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not get a tweaked recipe: ${error.message}</p>`;
    }
}

            function loadHistory() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
                const q = query(brewsCol);

                onSnapshot(q, (snapshot) => {
                    brews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    brews.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()); // Sort newest first
                    renderHistoryList();
                    populateSocialRecipeDropdown();
                    updateCostAnalysis();
                    renderActiveBrewTimeline();
                    updateNextActionWidget();
                }, (error) => {
                    console.error("Error loading history: ", error);
                    historyList.innerHTML = `<p class="text-red-500">Could not load brew history.</p>`;
                });
            }

function renderHistoryList() {
    const searchTerm = document.getElementById('history-search-input').value.toLowerCase();
    
    // Toon alle opgeslagen recepten, en filter enkel op basis van de zoekterm
    const filteredBrews = brews.filter(brew => 
         (brew.recipeName || 'Untitled Brew').toLowerCase().includes(searchTerm)
    );

    if (brews.length === 0) { // Controleer de ongefilterde lijst voor de "leeg" melding
        historyList.innerHTML = `<p class="text-center text-app-secondary/80">You have no brews in your history yet. Go to the Creator to make one!</p>`;
        return;
    }
    
    if (filteredBrews.length === 0) {
        historyList.innerHTML = `<p class="text-center text-app-secondary/80">No recipes found matching your search.</p>`;
        return;
    }

    historyList.innerHTML = filteredBrews.map(brew => `
        <div class="p-4 card rounded-lg cursor-pointer hover:bg-app-primary" onclick="window.showBrewDetail('${brew.id}')">
            <h4 class="font-bold text-lg font-header">${brew.recipeName || 'Untitled Brew'}</h4>
            <p class="text-sm text-app-secondary/80">Saved on: ${brew.createdAt.toDate().toLocaleDateString()}</p>
        </div>
    `).join('');
}

window.showBrewDetail = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    let finalMarkdown = brew.recipeMarkdown;
    const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
    const jsonMatch = brew.recipeMarkdown.match(jsonRegex);

    if (jsonMatch && jsonMatch[1]) {
        try {
            const ingredientsArray = JSON.parse(jsonMatch[1]);
            let tableMarkdown = '| Ingredient | Quantity | Unit |\n';
            tableMarkdown += '|---|---|---|\n';
            ingredientsArray.forEach(item => {
                const ing = item.ingredient || 'N/A';
                const qty = item.quantity || 0;
                const unit = item.unit || 'N/A';
                tableMarkdown += `| ${ing} | ${qty} | ${unit} |\n`;
            });
            finalMarkdown = brew.recipeMarkdown.replace(jsonRegex, tableMarkdown);
        } catch (e) {
            console.error("Failed to parse ingredients JSON from saved recipe:", e);
            finalMarkdown = brew.recipeMarkdown;
        }
    }

    finalMarkdown = finalMarkdown.replace(/\[d:[\d:]+\]/g, '');

    const recipeHtmlWithoutTitle = marked.parse(finalMarkdown.replace(/^#\s.*$/m, ''));
    const logHtml = getBrewLogHtml(brew.logData, brew.id);
    const currency = userSettings.currencySymbol || '€';

    let costHtml = '';
    if (brew.totalCost !== undefined && brew.totalCost > 0) {
        const costPerLiter = brew.batchSize > 0 ? brew.totalCost / brew.batchSize : 0;
        costHtml = `
            <div class="mt-6 p-4 bg-amber-100 rounded-lg dark:bg-amber-900/20">
                <h3 class="font-header text-lg text-amber-900 dark:text-amber-200">Batch Cost Analysis</h3>
                <p class="text-amber-800 dark:text-amber-200"><strong>Total Ingredient Cost:</strong> ${currency}${brew.totalCost.toFixed(2)}</p>
                <p class="text-amber-800 dark:text-amber-200"><strong>Cost Per Liter:</strong> ${currency}${costPerLiter.toFixed(2)}</p>
            </div>
        `;
    }

    const flavorWheelTitle = brew.predictedFlavorProfile ? 'Predicted Flavor Profile' : 'Flavor Profile Analysis';
    const flavorWheelDescription = brew.predictedFlavorProfile
        ? 'This is the AI-predicted flavor profile based on the recipe.'
        : 'Enter your tasting notes in the log above, save them, and then click the button below to generate a flavor profile.';

    historyDetailContainer.innerHTML = `
        <button onclick="window.goBackToHistoryList()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to History</button>

        <div class="mb-4">
            <div id="title-display-${brew.id}">
                <h2 class="text-3xl font-header font-bold w-full">${brew.recipeName}</h2>
                <div class="text-right w-full mt-1">
                     <button onclick="window.showTitleEditor('${brew.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold no-print">Edit Title</button>
                </div>
            </div>
            <div id="title-editor-${brew.id}" class="hidden">
                <input type="text" id="title-input-${brew.id}" value="${brew.recipeName}" class="w-full text-2xl font-bold p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                <div class="flex gap-2 mt-2">
                    <button onclick="window.saveNewTitle('${brew.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm btn">Save</button>
                    <button onclick="window.hideTitleEditor('${brew.id}')" class="bg-gray-500 text-white px-3 py-1 rounded text-sm btn">Cancel</button>
                </div>
            </div>
        </div>
        <div class="print-button-container mb-4 grid grid-cols-2 gap-2 no-print">
            <button onclick="window.cloneBrew('${brew.id}')" class="bg-blue-700 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition-colors btn flex items-center justify-center"> Clone Recipe </button>
            <button onclick="window.startBrewDay('${brew.id}')" class="bg-app-action text-white py-2 px-4 rounded-lg hover:opacity-90 transition-colors btn">Start New Batch</button>
            <button onclick="window.recalculateBatchCost('${brew.id}')" class="bg-purple-700 text-white py-2 px-4 rounded-lg hover:bg-purple-800 transition-colors btn">Recalculate Cost</button>
            <button onclick="window.deleteBrew('${brew.id}')" class="bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800 transition-colors btn flex items-center justify-center"> Delete Recipe </button>
        </div>

        <div class="recipe-content">${recipeHtmlWithoutTitle}</div>
        ${costHtml}
        <div class="mt-6 card p-4 rounded-lg"><h3 class="font-header text-lg text-center">Fermentation Progress</h3><canvas id="fermChart-${brew.id}"></canvas></div>
        ${logHtml}

        <div class="mt-4 no-print">
            <button onclick="window.updateBrewLog('${brew.id}')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>
        </div>

        <div class="mt-6 pt-4 border-t-2 border-app-brand no-print">
            <h3 class="text-2xl font-header font-bold text-center mb-4">${flavorWheelTitle}</h3>
            <div class="card p-4 rounded-lg text-center">
                <p class="text-app-secondary mb-4">${flavorWheelDescription}</p>
                <button onclick="window.generateFlavorWheel('${brew.id}')" class="bg-purple-600 ... btn"> Analyze My Tasting Notes </button>
                <div id="flavor-wheel-container-${brew.id}" class="mt-4" style="max-width: 400px; margin: auto;"></div>
            </div>
        </div>

        <div class="mt-6 pt-4 border-t-2 border-app no-print">
             <h3 class="text-2xl font-header font-bold text-center mb-4">Tweak Recipe with AI</h3>
             <div class="card p-4 rounded-lg">
                <label for="tweak-request-${brew.id}" class="block text-sm font-bold mb-2">Describe what you want to change:</label>
                <textarea id="tweak-request-${brew.id}" rows="3" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary" placeholder="e.g., 'Make this recipe for 20 liters', or 'Replace the apples with pears and add cinnamon'"></textarea>
                <button onclick="window.freeformTweakRecipe('${brew.id}')" class="w-full mt-3 bg-purple-700 text-white py-3 px-4 rounded-lg hover:bg-purple-800 btn">Generate Tweaked Recipe</button>
             </div>
        </div>

        <div id="tweak-output-${brew.id}" class="mt-6"></div>
    `;
    historyListContainer.classList.add('hidden');
    historyDetailContainer.classList.remove('hidden');
    renderFermentationGraph(brew.id);

    if (brew.predictedFlavorProfile) {
        const container = document.getElementById(`flavor-wheel-container-${brewId}`);
        container.style.display = 'block';
        const labels = ['Sweetness', 'Acidity', 'Fruity/Floral', 'Spiciness', 'Earthy/Woody', 'Body'];
        const data = [
            brew.predictedFlavorProfile.sweetness,
            brew.predictedFlavorProfile.acidity,
            brew.predictedFlavorProfile.fruity_floral,
            brew.predictedFlavorProfile.spiciness,
            brew.predictedFlavorProfile.earthy_woody,
            brew.predictedFlavorProfile.body_mouthfeel
        ];
        renderFlavorWheel(brewId, labels, data);
    }
}

window.recalculateBatchCost = async function(brewId) {
    if (!userId) return;
    const brew = brews.find(b => b.id === brewId);
    if (!brew) {
        showToast("Could not find brew to recalculate.", "error");
        return;
    }

    // Roep de globale, correcte parseerfunctie aan
    const newTotalCost = parseIngredientsAndCalculateCost(brew.recipeMarkdown, inventory, brew.batchSize);
    const oldTotalCost = brew.totalCost || 0;

    if (confirm(`The new calculated total ingredient cost is ${userSettings.currencySymbol || '€'}${newTotalCost.toFixed(2)} (was ${oldTotalCost.toFixed(2)}). Do you want to update?`)) {
        try {
            const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
            await updateDoc(brewDocRef, { totalCost: newTotalCost });

            // Update ook de cellar entry als die bestaat
            const cellarEntry = cellar.find(c => c.brewId === brewId);
            if (cellarEntry) {
                const cellarDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar', cellarEntry.id);
                // De 'totalBatchCost' in de kelder is de som van ingrediënten en verpakking. 
                // We kunnen hier enkel de 'ingredientCost' veilig updaten.
                await updateDoc(cellarDocRef, { ingredientCost: newTotalCost });
            }

            showToast("Batch cost updated successfully!", "success");
            // De onSnapshot-listener zal de UI automatisch verversen, inclusief de detailweergave
            goBackToHistoryList();
        } catch (error) {
            console.error("Error recalculating cost:", error);
            showToast("Failed to update cost.", "error");
        }
    }
}

            window.editPackagingItem = function(itemId) {
                const item = PACKAGING_ITEMS.find(i => i.id === itemId);
                const itemData = packagingCosts[itemId] || {};
                const itemDiv = document.getElementById(`pkg-item-${itemId}`);

                const qtyValue = itemData.qty > 0 ? itemData.qty : '';
                const priceValue = itemData.price > 0 ? itemData.price : '';

                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <p class="font-bold">${item.name}</p>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="edit-qty-${itemId}" value="${qtyValue}" placeholder="Quantity" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-price-${itemId}" value="${priceValue}" step="0.01" placeholder="Total Price (${userSettings.currencySymbol || '€'})" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.updatePackagingItem('${itemId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                            <button onclick="renderPackagingUI()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                       </div>
                   </div>
                `;
            }

            window.updatePackagingItem = function(itemId) {
                const qty = parseFloat(document.getElementById(`edit-qty-${itemId}`).value) || 0;
                const price = parseFloat(document.getElementById(`edit-price-${itemId}`).value) || 0;

                packagingCosts[itemId] = { qty, price };
                savePackagingCosts(); // Sla de volledige set van kosten op
            }

            window.clearPackagingItem = function(itemId) {
                if (confirm("Are you sure you want to delete the data for this item? This will set quantity and price to 0.")) {
                   packagingCosts[itemId] = { qty: 0, price: 0 };
                   savePackagingCosts();
                }
            }

            // --- VERVANG JE VOLLEDIGE cloneBrew FUNCTIE MET DEZE ---
window.cloneBrew = async function(brewId) {
    const originalBrew = brews.find(b => b.id === brewId);
    if (!originalBrew) {
        showToast("Could not find the original recipe to clone.", "error");
        return;
    }
    // Maak een diepe kopie van de log data en reset de waarden
    const newLogData = JSON.parse(JSON.stringify(originalBrew.logData || {}));
    newLogData.brewDate = ''; 
    newLogData.actualOG = ''; 
    newLogData.actualFG = ''; 
    newLogData.finalABV = '';
    newLogData.fermentationLog = Array.from({ length: 8 }, () => ({ date: '', temp: '', sg: '', notes: '' }));
    newLogData.agingNotes = ''; 
    newLogData.bottlingNotes = ''; 
    newLogData.tastingNotes = '';

    const newBrewData = {
        userId: userId,
        recipeName: `Clone of ${originalBrew.recipeName}`,
        recipeMarkdown: originalBrew.recipeMarkdown,
        logData: newLogData,
        createdAt: new Date(),
        batchSize: originalBrew.batchSize,
        totalCost: originalBrew.totalCost,
        isBottled: false,
        primaryComplete: false, // Belangrijk: reset deze status
        predictedFlavorProfile: originalBrew.predictedFlavorProfile || null,
        
        brewDaySteps: originalBrew.brewDaySteps || [],     // Kopieer de primaire stappen
        secondarySteps: originalBrew.secondarySteps || []  // Kopieer de secundaire stappen
    };

    try {
        const appId = 'meandery-aa05e';
        const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
        await addDoc(brewsCol, newBrewData);
        showToast(`'${newBrewData.recipeName}' has been created! You can now start a new batch from it.`, 'success');
        goBackToHistoryList(); // Ga terug naar de lijst zodat de gebruiker de nieuwe kloon kan zien
    } catch (error) {
        console.error("Error cloning brew:", error);
        showToast("An error occurred while cloning the recipe.", "error");
    }
}

            window.goBackToHistoryList = function() {
                historyDetailContainer.classList.add('hidden');
                historyListContainer.classList.remove('hidden');
            }
            
            window.updateBrewLog = async function(brewId) {
                 if (!userId || !brewId) return;
                 const logData = getLogDataFromDOM(`history-detail-container`);
                 try {
                    const appId = 'meandery-aa05e';
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, { logData: logData });
                    showToast('Log updated successfully!', 'success');
        
                    // Ververs de detailweergave om de grafiek te tonen
                    showBrewDetail(brewId);

                 } catch(error) {
                    console.error("Error updating log:", error);
                    showToast('Failed to update log.', 'error');
                 }
            }

            window.saveSocialPost = async function() {
                const saveBtn = document.getElementById('save-social-post-btn');
                if (!saveBtn || saveBtn.disabled) return;
                
                const brewId = document.getElementById('social-recipe-select').value;
                if (!brewId) {
                    showToast("You must select a recipe to save the post to.", "error");
                    return;
                }

                const contentDiv = document.getElementById('social-content-container').querySelector('div');
                const platform = document.getElementById('social-platform').options[document.getElementById('social-platform').selectedIndex].text;
                const persona = document.getElementById('social-persona').options[document.getElementById('social-persona').selectedIndex].text;

                if (!contentDiv || !contentDiv.innerText.trim()) {
                    showToast("No content to save.", "error");
                    return;
                }

                const newPost = {
                    platform: platform,
                    persona: persona,
                    content: contentDiv.innerText,
                    createdAt: new Date().toISOString()
                };

                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                try {
                    const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, {
                        socialMediaPosts: arrayUnion(newPost)
                    });
                    showToast("Post saved to recipe notes!", "success");
                    saveBtn.textContent = 'Saved!';
                } catch (error) {
                    console.error("Error saving social post:", error);
                    showToast("Could not save post.", "error");
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Post to Recipe Notes';
                }
            } 

window.generateFlavorWheel = async function(brewId) {
    const container = document.getElementById(`flavor-wheel-container-${brewId}`);
    const tastingNotes = document.getElementById(`tastingNotes-${brewId}`).value;

    if (!tastingNotes.trim()) {
        alert("Please enter some tasting notes before analyzing the flavor.");
        return;
    }

    container.style.display = 'block';
    container.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Analyzing flavor profile...</p>';

    const prompt = `You are a professional mead sommelier. Analyze the following tasting notes and assign a score from 0 to 5 for each of the following categories: Sweetness, Acidity, Fruity/Floral, Spiciness, Earthy/Woody, and Body/Mouthfeel. Provide your output ONLY in a valid JSON format according to the specified schema. Tasting notes: "${tastingNotes}"`;

    const schema = {
        type: "OBJECT",
        properties: {
            "sweetness": { "type": "NUMBER" },
            "acidity": { "type": "NUMBER" },
            "fruity_floral": { "type": "NUMBER" },
            "spiciness": { "type": "NUMBER" },
            "earthy_woody": { "type": "NUMBER" },
            "body_mouthfeel": { "type": "NUMBER" }
        },
        required: ["sweetness", "acidity", "fruity_floral", "spiciness", "earthy_woody", "body_mouthfeel"]
    };

    try {
        const jsonResponse = await performApiCall(prompt, schema);
        const flavorData = JSON.parse(jsonResponse);
        
        const labels = ['Sweetness', 'Acidity', 'Fruity/Floral', 'Spiciness', 'Earthy/Woody', 'Body'];
        const data = [
            flavorData.sweetness,
            flavorData.acidity,
            flavorData.fruity_floral,
            flavorData.spiciness,
            flavorData.earthy_woody,
            flavorData.body_mouthfeel
        ];
        
        renderFlavorWheel(brewId, labels, data);

    } catch (error) {
        console.error("Error generating flavor wheel:", error);
        container.innerHTML = `<p class="text-center text-red-500">Could not analyze flavor profile: ${error.message}</p>`;
    }
}

function renderFlavorWheel(brewId, labels, data) {
    const container = document.getElementById(`flavor-wheel-container-${brewId}`);
    container.innerHTML = `<canvas id="flavorWheelChart-${brewId}"></canvas>`;
    const ctx = document.getElementById(`flavorWheelChart-${brewId}`).getContext('2d');

    if (window.flavorChartInstances && window.flavorChartInstances[brewId]) {
        window.flavorChartInstances[brewId].destroy();
    }
    if (!window.flavorChartInstances) {
        window.flavorChartInstances = {};
    }
    
    const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');
    
    // Bepaal de kleuren expliciet op basis van het thema voor perfect contrast.
    const isDarkMode = document.documentElement.classList.contains('dark');
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#e0e0e0' : '#4a3c2c'; // Gebruik de expliciete kleurcodes

    window.flavorChartInstances[brewId] = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Flavor Profile',
                data: data,
                backgroundColor: brandColor + '4D',
                borderColor: brandColor,
                borderWidth: 2,
                pointBackgroundColor: brandColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true, // Maak de legende zichtbaar
                    labels: { color: textColor } // Gebruik de correcte tekstkleur
                }
            },
            scales: {
                r: {
                    angleLines: { color: gridColor },
                    grid: { color: gridColor },
                    pointLabels: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        font: { size: 12, family: "'Barlow Semi Condensed', sans-serif" }
                    },
                    ticks: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        backdropColor: 'transparent',
                        stepSize: 1
                    },
                    suggestedMin: 0,
                    suggestedMax: 5
                }
            }
        }
    });
}

async function getPredictedFlavorProfile(markdown) {
    console.log("Generating predicted flavor profile...");
    const prompt = `You are a professional mead sommelier. Analyze the following mead recipe and PREDICT its final flavor profile. Assign a score from 0 to 5 for each of the following categories: Sweetness, Acidity, Fruity/Floral, Spiciness, Earthy/Woody, and Body/Mouthfeel. Provide your output ONLY in a valid JSON format according to the specified schema. Recipe: "${markdown}"`;

    const schema = {
        type: "OBJECT",
        properties: {
            "sweetness": { "type": "NUMBER" },
            "acidity": { "type": "NUMBER" },
            "fruity_floral": { "type": "NUMBER" },
            "spiciness": { "type": "NUMBER" },
            "earthy_woody": { "type": "NUMBER" },
            "body_mouthfeel": { "type": "NUMBER" }
        },
        required: ["sweetness", "acidity", "fruity_floral", "spiciness", "earthy_woody", "body_mouthfeel"]
    };

    try {
        const jsonResponse = await performApiCall(prompt, schema);
        return JSON.parse(jsonResponse);
    } catch (error) {
        console.error("Could not generate predicted flavor profile:", error);
        return null; // Geef null terug bij een fout
    }
}

function renderGeneratedFlavorWheel(flavorData) {
    const ctx = document.getElementById('generated-flavor-wheel');
    if (!ctx) return;

    const labels = ['Sweetness', 'Acidity', 'Fruity/Floral', 'Spiciness', 'Earthy/Woody', 'Body'];
    const data = [
        flavorData.sweetness,
        flavorData.acidity,
        flavorData.fruity_floral,
        flavorData.spiciness,
        flavorData.earthy_woody,
        flavorData.body_mouthfeel
    ];

    const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');

    // Bepaal de kleuren expliciet op basis van het thema voor perfect contrast.
    const isDarkMode = document.documentElement.classList.contains('dark');
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#e0e0e0' : '#4a3c2c'; // Gebruik de expliciete kleurcodes

    new Chart(ctx.getContext('2d'), {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Predicted Profile',
                data: data,
                backgroundColor: brandColor + '4D',
                borderColor: brandColor,
                borderWidth: 2,
                pointBackgroundColor: brandColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true, // Maak de legende zichtbaar
                    labels: { color: textColor } // Gebruik de correcte tekstkleur
                }
            },
            scales: {
                r: {
                    angleLines: { color: gridColor },
                    grid: { color: gridColor },
                    pointLabels: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        font: { size: 12, family: "'Barlow Semi Condensed', sans-serif" }
                    },
                    ticks: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        backdropColor: 'transparent',
                        stepSize: 1
                    },
                    suggestedMin: 0,
                    suggestedMax: 5
                }
            }
        }
    });
}

            window.quickTweakRecipe = async function(brewId, tweakType) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Applying quick tweak...</p>';

                let tweakInstruction = '';
                switch (tweakType) {
                    case 'make_dryer':
                        tweakInstruction = "make the final mead dryer by adjusting the honey quantity or yeast choice to achieve a lower final gravity.";
                        break;
                    case 'increase_abv':
                        tweakInstruction = "increase the final ABV by approximately 2%. You must adjust the initial honey quantity to provide more fermentable sugar.";
                        break;
                    case 'add_oak':
                        tweakInstruction = "add a step for aging with a light touch of oak cubes or chips. Specify the type, amount, and contact time.";
                        break;
                    default:
                        tweakOutput.innerHTML = `<p class="text-center text-red-500">Unknown tweak type.</p>`;
                        return;
                }

                const prompt = `You are an expert mead maker. Take the following mead recipe and apply this specific modification: ${tweakInstruction}. You must generate the complete, updated recipe, including a regenerated ingredient table and instructions. Explain your changes briefly in the 'Brewer's Notes'. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;

                try {
                    const tweakedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 card rounded-lg">${marked.parse(tweakedMarkdown)}</div>`;
                } catch (error) {
                    console.error("Error during quick tweak:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not perform tweak: ${error.message}</p>`;
                }
            }

            window.swapIngredient = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const swapInput = document.getElementById(`ingredient-swap-input-${brew.id}`);
                const swapRequest = swapInput.value;
                if (!swapRequest.trim()) {
                    alert("Please describe the ingredient swap you want to make.");
                    return;
                }

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Calculating ingredient swap...</p>';

                const prompt = `You are an expert mead maker. Take the following mead recipe. A user wants to make an ingredient substitution. Their request is: "${swapRequest}". 
                
                Please analyze this request. Adjust ingredient quantities if necessary (e.g., accounting for different sugar content in a new honey type). Modify the instructions where needed. In the 'Brewer's Notes', you MUST explain the likely impact of this swap on the final flavor profile. 
                
                Generate the complete, updated recipe with the swap integrated. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;
                
                try {
                    const swappedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 card rounded-lg">${marked.parse(swappedMarkdown)}</div>`;
                    swapInput.value = ''; // Clear input after successful swap
                } catch (error) {
                    console.error("Error swapping ingredient:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not perform swap: ${error.message}</p>`;
                }
            }
            
            // --- Inventory Functions ---
            async function addInventoryItem(e) {
                e.preventDefault();
                if (!userId) return;
                const name = document.getElementById('itemName').value;
                const qty = parseFloat(document.getElementById('itemQty').value);
                const unit = document.getElementById('itemUnit').value;
                const price = parseFloat(document.getElementById('itemPrice').value);
                const category = document.getElementById('itemCategory').value;
                const expirationDate = document.getElementById('itemExpirationDate').value || null;
                if (!name || isNaN(qty) || isNaN(price)) return;
                const itemData = { userId, name, qty, unit, price, category, expirationDate };
                try {
                    const appId = 'meandery-aa05e';
                    const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
                    await addDoc(invCol, itemData);
                    inventoryForm.reset();
                    showToast("Ingredient added to inventory!", "success");
                } catch (error) {
                    console.error("Error adding inventory item:", error);
                    showToast("Could not add ingredient.", "error");
                }
            }

            function loadInventory() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
    const q = query(invCol);

    onSnapshot(q, (snapshot) => {
        inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderInventory();
        updateCostAnalysis();
        updateNextActionWidget(); // Update dashboard with potential expiry warnings
    }, (error) => {
        console.error("Error loading inventory: ", error);
        inventoryList.innerHTML = `<p class="text-red-500">Could not load inventory.</p>`;
    });
}

window.renderInventory = function() {
    const grouped = inventory.reduce((acc, item) => {
        (acc[item.category] = acc[item.category] || []).push(item);
        return acc;
    }, {});

    const categories = ['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical', 'Water'];
    const currency = userSettings.currencySymbol || '€';
    let html = '';

    for (const category of categories) {
        if (grouped[category]) {
            html += `<h3 class="text-xl font-header mt-4 mb-2">${category}</h3>`;
            html += `<div class="space-y-2">`;
            grouped[category].forEach(item => {
                const expDateStr = item.expirationDate ? new Date(item.expirationDate).toLocaleDateString() : 'N/A';
                let dateClass = 'text-app-secondary/80';
                if (item.expirationDate) {
                    const expDate = new Date(item.expirationDate);
                    const now = new Date();
                    now.setHours(0,0,0,0);
                    const daysUntilExp = (expDate - now) / (1000 * 60 * 60 * 24);
                    if (daysUntilExp < 0) {
                        dateClass = 'text-red-500 font-bold';
                    } else if (daysUntilExp <= 30) {
                        dateClass = 'text-amber-500 font-semibold';
                    }
                }

                html += `<div id="item-${item.id}" class="p-3 card rounded-md">
                    <div class="flex justify-between items-center">
                        <span>${item.name}</span>
                        <div class="flex items-center gap-4">
                            <span class="font-semibold">${item.qty} ${item.unit} - ${currency}${(item.price || 0).toFixed(2)}</span>
                            <div class="flex gap-2">
                                <button onclick="window.editInventoryItem('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                <button onclick="window.deleteInventoryItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs ${dateClass}">Exp: ${expDateStr}</p>
                </div>`;
            });
            html += `</div>`;
        }
    }
    
    if (inventory.length === 0) {
        html = `<p class="text-center text-app-secondary/80">Your inventory is empty. Add your first ingredient!</p>`;
    }

    inventoryList.innerHTML = html;
}

            window.deleteInventoryItem = async function(itemId) {
                if (!userId) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemId);
                    await deleteDoc(itemDocRef);
                    showToast("Item deleted.", "success");
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast("Could not delete item.", "error");
                }
            }

            window.editInventoryItem = function(itemId) {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;

                const itemDiv = document.getElementById(`item-${itemId}`);
                const currency = userSettings.currencySymbol || '€';
                
                // Bouw de opties voor de 'unit' dropdown
                const unitOptions = ['kg', 'g', 'L', 'ml', 'packets', 'items'];
                const unitSelectHtml = unitOptions.map(unit => 
                    `<option value="${unit}" ${item.unit === unit ? 'selected' : ''}>${unit}</option>`
                ).join('');

                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <input type="text" id="edit-name-${itemId}" value="${item.name}" placeholder="Name" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        <div>
                            <select id="edit-category-${itemId}" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                                ${['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical', 'Water'].map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="number" id="edit-qty-${itemId}" value="${item.qty}" step="0.01" placeholder="Quantity" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <select id="edit-unit-${itemId}" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">${unitSelectHtml}</select>
                            <input type="number" id="edit-price-${itemId}" value="${item.price}" step="0.01" placeholder="Price (${userSettings.currencySymbol || '€'})" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div>
                             <label for="edit-date-${itemId}" class="text-xs text-app-secondary">Exp. Date</label>
                             <input type="date" id="edit-date-${itemId}" value="${item.expirationDate || ''}" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.updateInventoryItem('${itemId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                            <button onclick="renderInventory()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                        </div>
                    </div>
                `;
            }

            window.updateInventoryItem = async function(itemId) {
                if (!userId) return;
                const updatedData = {
                    name: document.getElementById(`edit-name-${itemId}`).value,
                    qty: parseFloat(document.getElementById(`edit-qty-${itemId}`).value),
                    unit: document.getElementById(`edit-unit-${itemId}`).value,
                    price: parseFloat(document.getElementById(`edit-price-${itemId}`).value),
                    expirationDate: document.getElementById(`edit-date-${itemId}`).value || null,
                    category: document.getElementById(`edit-category-${itemId}`).value
                };
                if (!updatedData.name || isNaN(updatedData.qty) || isNaN(updatedData.price)) {
                    showToast("Invalid input. Please check all fields.", "error");
                    return;
                }
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemId);
                    await updateDoc(itemDocRef, updatedData);
                    showToast("Item updated!", "success");
                    renderInventory(); // Belangrijk: vernieuw de lijst na het opslaan
                } catch (error) {
                    console.error("Error updating item:", error);
                    showToast("Could not update item.", "error");
                }
            }


            // --- Automatische Inventaris Update Functies ---
            function promptToUpdateInventory(markdown) {
                if (confirm("Recipe saved! Do you want to automatically deduct the used ingredients from your inventory?")) {
                    updateInventoryFromRecipe(markdown);
                }
            }

            async function updateInventoryFromRecipe(markdown) {
                const requiredIngredients = parseIngredientsFromMarkdown(markdown);
                if (requiredIngredients.length === 0) return;

                const batch = writeBatch(db);
                let updatesMade = 0;
                let notFound = [];

                requiredIngredients.forEach(req => {
                    const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
                    if (invItem) {
                        const newQty = invItem.qty - req.quantity;
                        if (newQty >= 0) {
                            const itemDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'inventory', invItem.id);
                            batch.update(itemDocRef, { qty: newQty });
                            updatesMade++;
                        } else {
                            notFound.push(`${req.name} (not enough stock)`);
                        }
                    } else {
                        notFound.push(req.name);
                    }
                });

                if (updatesMade > 0) {
                    try {
                        await batch.commit();
                        let message = `${updatesMade} ingredient(s) updated in your inventory.`;
                        if (notFound.length > 0) {
                            message += ` Not found or insufficient stock: ${notFound.join(', ')}.`;
                        }
                        showToast(message, 'success');
                    } catch (error) {
                        console.error("Error updating inventory from recipe:", error);
                        showToast("An error occurred while updating the inventory.", 'error');
                    }
                } else if (notFound.length > 0) {
                    showToast(`No matching ingredients found in inventory to update.`, 'error');
                }
            }

            // --- Equipment Profile Functions ---
            async function addEquipmentProfile(e) {
                e.preventDefault();
                if (!userId) return;
                const name = document.getElementById('equipProfileName').value;
                const type = document.getElementById('equipProfileType').value;
                const quantity = parseInt(document.getElementById('equipProfileQuantity').value) || 1;
                const capacityLiters = parseFloat(document.getElementById('equipCapacityLiters').value) || null;
                const trubLossLiters = parseFloat(document.getElementById('trubLossLiters').value) || 0;
                const boilOffRateLitersPerHour = (type === 'Kettle') ? parseFloat(document.getElementById('boilOffRateLitersPerHour').value) || 0 : 0;
                if (!name) {
                    showToast("Profile Name is required.", "error");
                    return;
                }
                const profileData = { userId, name, type, quantity, capacityLiters, trubLossLiters, boilOffRateLitersPerHour };
                try {
                    const appId = 'meandery-aa05e';
                    const equipCol = collection(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles');
                    await addDoc(equipCol, profileData);
                    document.getElementById('equipment-profile-form').reset();
                    document.getElementById('equipProfileQuantity').value = 1;
                    handleEquipmentTypeChange();
                    showToast("Equipment profile added!", "success");
                } catch (error) {
                    console.error("Error adding equipment profile:", error);
                    showToast("Could not add profile.", "error");
                }
            }

            function loadEquipmentProfiles() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const equipCol = collection(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles');
                const q = query(equipCol);

                onSnapshot(q, (snapshot) => {
                    equipmentProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEquipmentProfiles();
                    populateEquipmentProfilesDropdown();
                }, (error) => {
                    console.error("Error loading equipment profiles: ", error);
                    document.getElementById('equipment-profiles-list').innerHTML = `<p class="text-red-500">Could not load equipment profiles.</p>`;
                });
            }

            window.renderEquipmentProfiles = function() {
                const listDiv = document.getElementById('equipment-profiles-list');
                if (equipmentProfiles.length === 0) {
                    listDiv.innerHTML = `<p class="text-center text-app-secondary/80">You have no saved equipment profiles. Add one to get started!</p>`;
                    return;
                }
                
                listDiv.innerHTML = equipmentProfiles.map(p => `
                    <div id="equip-item-${p.id}" class="p-3 card rounded-md mb-2">
                        <div class="flex justify-between items-center">
                             <div class="flex-grow">
                                <p class="font-bold">${p.name} <span class="text-sm font-normal text-app-secondary/80">(${p.type})</span></p>
                                <p class="text-sm text-app-secondary">Capacity: ${p.capacityLiters || 'N/A'}L | Trub Loss: ${p.trubLossLiters || 0}L ${p.type === 'Kettle' ? `| Boil-off: ${p.boilOffRateLitersPerHour || 0}L/hr` : ''}</p>
                            </div>
                            <div class="flex items-center gap-4 flex-shrink-0 ml-4">
                                <span class="font-semibold">${p.quantity || 1}x in stock</span>
                                <div class="flex gap-2">
                                    <button onclick="window.editEquipmentProfile('${p.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Edit</button>
                                    <button onclick="window.deleteEquipmentProfile('${p.id}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
           window.editEquipmentProfile = function(profileId) {
                const p = equipmentProfiles.find(i => i.id === profileId);
                if (!p) return;

                const itemDiv = document.getElementById(`equip-item-${profileId}`);
                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="text" id="edit-equip-name-${p.id}" value="${p.name}" placeholder="Name" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-quantity-${p.id}" value="${p.quantity || 1}" min="1" placeholder="Aantal" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="number" id="edit-equip-cap-${p.id}" value="${p.capacityLiters || ''}" placeholder="Capacity (L)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-trub-${p.id}" value="${p.trubLossLiters || '0'}" placeholder="Trub Loss (L)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-boiloff-${p.id}" value="${p.boilOffRateLitersPerHour || '0'}" placeholder="Boil-off (L/hr)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary ${p.type !== 'Kettle' ? 'hidden' : ''}">
                            <div class="flex gap-2 col-span-2 md:col-span-1">
                                <button onclick="window.updateEquipmentProfile('${p.id}', '${p.type}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                                <button onclick="renderEquipmentProfiles()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            window.updateEquipmentProfile = async function(profileId, type) {
                if (!userId) return;
                const updatedData = {
                    name: document.getElementById(`edit-equip-name-${profileId}`).value,
                    quantity: parseInt(document.getElementById(`edit-equip-quantity-${profileId}`).value) || 1,
                    capacityLiters: parseFloat(document.getElementById(`edit-equip-cap-${profileId}`).value) || null,
                    trubLossLiters: parseFloat(document.getElementById(`edit-equip-trub-${profileId}`).value) || 0,
                    boilOffRateLitersPerHour: (type === 'Kettle') ? parseFloat(document.getElementById(`edit-equip-boiloff-${profileId}`).value) || 0 : 0
                };

                if (!updatedData.name) {
                    showToast("Profile name cannot be empty.", "error");
                    return;
                }

                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles', profileId);
                    await updateDoc(itemDocRef, updatedData);
                    showToast("Equipment profile updated!", "success");
                    renderEquipmentProfiles(); // Belangrijk: vernieuw de lijst
                } catch (error) {
                    console.error("Error updating equipment profile:", error);
                    showToast("Could not update profile.", "error");
                }
            }

            window.deleteEquipmentProfile = async function(profileId) {
                if (!userId) return;
                if (!confirm('Are you sure you want to delete this equipment profile?')) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles', profileId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting equipment profile:", error);
                }
            }
            
            function handleEquipmentTypeChange() {
                 const type = document.getElementById('equipProfileType').value;
                 document.getElementById('boil-off-rate-container').classList.toggle('hidden', type !== 'Kettle');
            }

            function populateEquipmentProfilesDropdown() {
                const select = document.getElementById('equipmentProfileSelect');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">None (Use default values)</option>'; // Reset
                
                equipmentProfiles.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
                select.value = currentValue; // Probeer de selectie te behouden
            }

            // --- Cellar Functions ---

            function loadCellar() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const cellarCol = collection(db, 'artifacts', appId, 'users', userId, 'cellar');
                const q = query(cellarCol);

                onSnapshot(q, (snapshot) => {
                    cellar = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sorteer op botteldatum, nieuwste eerst
                    if (cellar.length > 0 && cellar[0].bottlingDate) {
                        cellar.sort((a, b) => b.bottlingDate.toDate() - a.bottlingDate.toDate());
                    }
                    renderCellar();
                    updateNextActionWidget();
                }, (error) => {
                    console.error("Error loading cellar: ", error);
                    document.getElementById('cellar-list').innerHTML = `<p class="text-red-500">Could not load cellar.</p>`;
                });
            }

            function renderCellar() {
    const listDiv = document.getElementById('cellar-list');
    const currency = userSettings.currencySymbol || '€';

    if (cellar.length === 0) {
        listDiv.innerHTML = `<p class="text-center text-app-secondary/80">Your cellar is empty. Bottle a batch from your history to add it here!</p>`;
        return;
    }
    
    const packagingCostsPerUnit = getPackagingCosts();

    listDiv.innerHTML = cellar.map(item => {
        const originalBrew = brews.find(b => b.id === item.brewId);
        const escapedRecipeName = item.recipeName.replace(/'/g, "\\'");
        const originalBatchSize = originalBrew ? originalBrew.batchSize : 1; // Fallback
        const ingredientCostPerLiter = originalBatchSize > 0 ? (item.ingredientCost || 0) / originalBatchSize : 0;

        const bottlingDateStr = item.bottlingDate ? item.bottlingDate.toDate().toLocaleDateString() : 'No date';

        const bottleDetailsHtml = (item.bottles && Array.isArray(item.bottles)) ? item.bottles.map(b => {
            const meadCostInBottle = ingredientCostPerLiter * (b.size / 1000);
            
            let closureCost = 0;
            if (b.size >= 750) { closureCost = packagingCostsPerUnit.cork || 0; } 
            else if (b.size >= 500) { closureCost = packagingCostsPerUnit.crown_cap_29 || 0; } 
            else { closureCost = packagingCostsPerUnit.crown_cap_26 || 0; }
            
            const bottleCost = packagingCostsPerUnit[b.size.toString()] || 0;
            const labelCost = packagingCostsPerUnit.label || 0;
            const finalCostPerBottle = meadCostInBottle + bottleCost + closureCost + labelCost;
            const costText = finalCostPerBottle > 0 ? `<span class="font-bold">${currency}${finalCostPerBottle.toFixed(2)}/st</span>` : '';

            return `
            <div class="flex items-center justify-between text-sm py-1">
                <span>${b.quantity} x ${b.size}ml</span>
                <div class="flex items-center gap-4">
                    ${costText}
                    <button onclick="window.consumeBottle('${item.id}', ${b.size})" class="text-xs bg-app-action text-white px-2 py-1 rounded hover:opacity-80 btn">-1 Bottle</button>
                </div>
            </div>`;
        }).join('') : `<p class="text-sm">Bottle data not available.</p>`;
        
        const totalBottlesInBatch = item.bottles.reduce((acc, b) => acc + b.quantity, 0);

        const adviceHtml = item.peakFlavorDate ? `
            <div class="mt-3 pt-3 border-t border-app">
                <p class="text-sm font-bold text-app-primary">Aging Advice:</p>
                <p class="text-sm text-app-secondary/90">
                    <span class="font-semibold">Peak Flavor around: ${item.peakFlavorDate}.</span> ${item.peakFlavorJustification || ''}
                </p>
            </div> ` : '';

        return `
        <div class="p-4 card rounded-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-lg font-header">${item.recipeName}</h4>
                    <p class="text-sm text-app-secondary">Bottled on: ${bottlingDateStr}</p>
                </div>
                <div class="text-right flex-shrink-0 ml-4">
                    <p class="text-2xl font-bold text-app-brand">${totalBottlesInBatch} <span class="text-base font-normal">total</span></p>
                </div>
            </div>
            <div class="mt-3 space-y-2">${bottleDetailsHtml}</div>
            ${adviceHtml}
            <div class="text-right mt-3 border-t border-app pt-2 flex justify-end items-center gap-4">
                 <button onclick="window.setTastingReminder('${item.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold">Set Reminder</button>
                 <button onclick="window.deleteCellarItem('${item.id}', '${escapedRecipeName}')" class="text-red-600 hover:text-red-800 text-xs font-semibold">Delete Batch</button>
            </div>
        </div>
        `;
    }).join('');
}

            // --- Kalender Herinnering Functies ---
            window.setTastingReminder = function(cellarItemId) {
                const item = cellar.find(c => c.id === cellarItemId);
                if (!item) return;

                const months = prompt(`Set a tasting reminder for "${item.recipeName}".\n\nIn how many months from today?`, "6");
                if (months === null || isNaN(parseInt(months)) || parseInt(months) <= 0) {
                    return; // Gebruiker annuleert of geeft ongeldige invoer
                }

                const reminderDate = new Date();
                reminderDate.setMonth(reminderDate.getMonth() + parseInt(months));
                
                generateAndDownloadIcs(item, reminderDate);
            }

            function generateAndDownloadIcs(item, date) {
                // Formatteer de datum naar UTC (vereist voor .ics bestanden)
                const toICSFormat = (d) => {
                    return d.getUTCFullYear() + 
                           ('0' + (d.getUTCMonth() + 1)).slice(-2) + 
                           ('0' + d.getUTCDate()).slice(-2) + 'T' +
                           ('0' + d.getUTCHours()).slice(-2) +
                           ('0' + d.getUTCMinutes()).slice(-2) +
                           ('0' + d.getUTCSeconds()).slice(-2) + 'Z';
                }

                const eventStart = toICSFormat(date);
                const eventStamp = toICSFormat(new Date());

                // Bouw de inhoud van het .ics bestand
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'BEGIN:VEVENT',
                    `UID:${Date.now()}@meandery.app`,
                    `DTSTAMP:${eventStamp}`,
                    `DTSTART;VALUE=DATE:${eventStart.substring(0,8)}`, // We maken er een "hele dag" evenement van
                    `SUMMARY:Tasting Reminder: ${item.recipeName}`,
                    'DESCRIPTION:Time to taste your aged mead from the MEA(N)DERY app! Notes: How is the aroma, clarity, and flavor? Has it mellowed out?',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                // Maak en download het bestand
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Tasting_Reminder_${item.recipeName.replace(/\s/g, '_')}.ics`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // --- Barcode Scanner Functies ---
            function startScanner() {
                document.getElementById('barcode-scanner-container').classList.remove('hidden');

                html5QrcodeScanner = new Html5Qrcode("barcode-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 150 } };

                html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
                     .catch(err => {
                         console.error("Unable to start scanning.", err);
                         alert("Could not start camera. Please grant camera permissions.");
                     });
            }

            function stopScanner() {
                if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                    html5QrcodeScanner.stop().then(() => {
                        document.getElementById('barcode-scanner-container').classList.add('hidden');
                    }).catch(err => console.error("Error stopping scanner:", err));
                } else {
                     document.getElementById('barcode-scanner-container').classList.add('hidden');
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                // Stop de scanner onmiddellijk na een succesvolle scan
                stopScanner();

                // Vraag de productinformatie op
                fetchProductInfo(decodedText);
            }

            async function fetchProductInfo(barcode) {
                const itemNameInput = document.getElementById('itemName');
                const originalPlaceholder = itemNameInput.placeholder;
                itemNameInput.value = '';
                itemNameInput.placeholder = 'Looking up barcode...';

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                    if (!response.ok) throw new Error("Product not found in the database.");

                    const data = await response.json();

                    if (data.status === 1 && data.product && data.product.product_name) {
                        itemNameInput.value = data.product.product_name;
                    } else {
                        throw new Error("Product not found in the database.");
                    }
               } catch (error) {
                   console.error("Barcode lookup failed:", error);
                   alert(error.message);
               } finally {
                   itemNameInput.placeholder = originalPlaceholder;
               }
            }

            window.consumeBottle = async function(cellarItemId, bottleSize) {
                if (!userId) return;

                const cellarItemRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar', cellarItemId);
                
                try {
                    // Haal het huidige document op
                    const docSnap = await getDoc(cellarItemRef);
                    if (!docSnap.exists()) {
                        console.error("Cellar item not found!");
                        return;
                    }

                    const itemData = docSnap.data();
                    const bottles = itemData.bottles;

                    // Vind de juiste flesmaat en verminder de hoeveelheid
                    const bottleIndex = bottles.findIndex(b => b.size == bottleSize);
                    if (bottleIndex > -1 && bottles[bottleIndex].quantity > 0) {
                        bottles[bottleIndex].quantity -= 1;

                        // Optioneel: verwijder de flesmaat als de hoeveelheid 0 is
                        const updatedBottles = bottles.filter(b => b.quantity > 0);
                        
                        // Update het document in Firestore
                        await updateDoc(cellarItemRef, { bottles: updatedBottles });
                    } else {
                        alert("Bottle size not found or quantity is already 0.");
                    }
                } catch (error) {
                    console.error("Error consuming bottle: ", error);
                }
            }

            window.deleteCellarItem = async function(itemId, recipeName) {
                if (!userId) return;
                if (!confirm(`Are you sure you want to delete the entire batch of '${recipeName}' from your cellar? This cannot be undone.`)) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'cellar', itemId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting cellar item:", error);
                }
            }


            // --- Functies voor het bottel-proces ---

            let currentBrewToBottleId = null; 

            window.showBottlingModal = function(brewId) {
                customBottles = []; // Reset de lijst
                renderCustomBottlesList(); // Maak de UI leeg
                currentBrewToBottleId = brewId;
                const bottlingForm = document.getElementById('bottling-form');
                bottlingForm.reset();
                document.getElementById('bottlingDate').valueAsDate = new Date();
                document.getElementById('bottling-modal').classList.remove('hidden');
            }

            window.hideBottlingModal = function() {
                document.getElementById('bottling-modal').classList.add('hidden');
                currentBrewToBottleId = null;
            }

async function bottleBatch(e) {
    e.preventDefault();
    if (!currentBrewToBottleId) return;

    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<div class="loader" style="height:20px; width:20px; border-width: 2px; margin: 0 auto;"></div>';
    
    try {
        const originalBrew = brews.find(b => b.id === currentBrewToBottleId);
        if (!originalBrew) throw new Error("Could not find the original recipe to bottle.");

        const bottlesData = [
            { size: 750, quantity: parseInt(document.getElementById('qty750').value) || 0, price: null },
            { size: 500, quantity: parseInt(document.getElementById('qty500').value) || 0, price: null },
            { size: 330, quantity: parseInt(document.getElementById('qty330').value) || 0, price: null },
            { size: 250, quantity: parseInt(document.getElementById('qty250').value) || 0, price: null },
            ...customBottles
        ].filter(b => b.quantity > 0 && b.size > 0);

        if (bottlesData.length === 0) throw new Error("Please enter a quantity for at least one bottle size.");

        const closureType = document.getElementById('closureTypeSelect').value;
        const outOfStockItems = [];
        let totalBottles = 0;
        
        bottlesData.forEach(bottle => {
            totalBottles += bottle.quantity;
            if (bottle.price === null) {
                const stockId = `bottle_${bottle.size}`;
                const currentStock = packagingCosts[stockId]?.qty || 0;
                if (bottle.quantity > currentStock) {
                    outOfStockItems.push(`${bottle.quantity} x ${bottle.size}ml bottle(s) (only ${currentStock} in stock)`);
                }
            }
        })

        if (closureType === 'auto') {
            const closuresNeeded = { cork: 0, crown_cap_26: 0, crown_cap_29: 0 };
            bottlesData.forEach(b => {
                if (b.size >= 750) closuresNeeded.cork += b.quantity;
                else if (b.size >= 500) closuresNeeded.crown_cap_29 += b.quantity;
                else closuresNeeded.crown_cap_26 += b.quantity;
            });
            if (closuresNeeded.cork > (packagingCosts['cork']?.qty || 0)) outOfStockItems.push(`Not enough corks (needed: ${closuresNeeded.cork})`);
            if (closuresNeeded.crown_cap_26 > (packagingCosts['crown_cap_26']?.qty || 0)) outOfStockItems.push(`Not enough 26mm caps (needed: ${closuresNeeded.crown_cap_26})`);
            if (closuresNeeded.crown_cap_29 > (packagingCosts['crown_cap_29']?.qty || 0)) outOfStockItems.push(`Not enough 29mm caps (needed: ${closuresNeeded.crown_cap_29})`);
        } else {
            const needed = totalBottles;
            const inStock = packagingCosts[closureType]?.qty || 0;
            if (needed > inStock) {
                outOfStockItems.push(`${needed} x ${closureType.replace(/_/g, ' ')} (only ${inStock} in stock)`);
            }
        }
        
        const currentLabelStock = packagingCosts['label']?.qty || 0;
        if (totalBottles > currentLabelStock) outOfStockItems.push(`${totalBottles} label(s) (only ${currentLabelStock} in stock)`);
        
        if (outOfStockItems.length > 0) {
            throw new Error(`Not enough stock. Missing:\n- ${outOfStockItems.join('\n- ')}`);
        }
        
        const packagingCostsPerUnit = getPackagingCosts();
        let totalPackagingCost = 0;

        bottlesData.forEach(bottle => {
            const bottleCost = bottle.price !== null ? bottle.price : (packagingCostsPerUnit[bottle.size.toString()] || 0);
            let closureCost = 0;

            if (closureType === 'auto') {
                if (bottle.size >= 750) { closureCost = packagingCostsPerUnit.cork || 0; } 
                else if (bottle.size >= 500) { closureCost = packagingCostsPerUnit.crown_cap_29 || 0; } 
                else { closureCost = packagingCostsPerUnit.crown_cap_26 || 0; }
            } else {
                closureCost = packagingCostsPerUnit[closureType] || 0;
            }

            const labelCost = packagingCostsPerUnit.label || 0;
            totalPackagingCost += bottle.quantity * (bottleCost + closureCost + labelCost);
        });

        const ingredientCost = originalBrew.totalCost || 0;
        if (ingredientCost === 0) {
           showToast("Warning: The ingredient cost for this batch is €0.00. The total cost may be inaccurate. You can try recalculating it from the History view.", "error", 8000);
        }
        let finalTotalCost = ingredientCost + totalPackagingCost;

        if (confirm(`The calculated packaging cost is ${userSettings.currencySymbol || '€'}${totalPackagingCost.toFixed(2)}. The new total batch cost will be ${userSettings.currencySymbol || '€'}${finalTotalCost.toFixed(2)}. Do you want to continue?`)) {
            const updatedPackagingStock = JSON.parse(JSON.stringify(packagingCosts)); // Veilige kopie

            const deductFromStock = (stock, itemId, quantity) => {
                if (stock[itemId] && stock[itemId].qty > 0) {
                    const costPerUnit = stock[itemId].price / stock[itemId].qty;
                    const costToDeduct = costPerUnit * quantity;
                    
                    stock[itemId].qty -= quantity;
                    stock[itemId].price -= costToDeduct;

                    // Voorkom negatieve waarden door afrondingsfouten
                    if (stock[itemId].qty <= 0) {
                        stock[itemId].qty = 0;
                        stock[itemId].price = 0;
                    }
                }
            };

            // Schrijf standaard flessen af
            bottlesData.forEach(bottle => {
                if(bottle.price === null) { 
                    deductFromStock(updatedPackagingStock, `bottle_${bottle.size}`, bottle.quantity);
                }
            });

            // Schrijf sluitingen en etiketten af
            if (closureType === 'auto') {
                 bottlesData.forEach(bottle => {
                    let closureId;
                    if (bottle.size >= 750) { closureId = 'cork'; } 
                    else if (bottle.size >= 500) { closureId = 'crown_cap_29'; } 
                    else { closureId = 'crown_cap_26'; }
                    deductFromStock(updatedPackagingStock, closureId, bottle.quantity);
                 });
            } else {
                deductFromStock(updatedPackagingStock, closureType, totalBottles);
            }
            deductFromStock(updatedPackagingStock, 'label', totalBottles);
            
            const appId = 'meandery-aa05e';
            const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'packaging');
            await setDoc(settingsDocRef, updatedPackagingStock);
            packagingCosts = updatedPackagingStock;
            
            const bottlingDate = new Date(document.getElementById('bottlingDate').value);
            const cellarData = {
                userId: userId, 
                brewId: currentBrewToBottleId, 
                recipeName: originalBrew.recipeName,
                bottlingDate: bottlingDate, 
                bottles: bottlesData.map(({price, ...rest}) => rest),
                totalBatchCost: finalTotalCost,
                ingredientCost: originalBrew.totalCost || 0,
                peakFlavorDate: null,
                peakFlavorJustification: 'Advice could not be generated.'
            };

            try {
                const agingPrompt = `Analyze the following mead recipe. Based on the ingredients and style, determine a recommended 'peak flavor' date, assuming it was bottled on ${bottlingDate.toISOString().split('T')[0]}.

Recipe Markdown:
---
${originalBrew.recipeMarkdown}
---

CRUCIAL: Your response MUST contain two parts:
1. A "Justification:" line with a single sentence explaining your reasoning.
2. A "Peak Date:" line with only the date in YYYY-MM-DD format.
Example:
Justification: Bochets with dark fruit benefit from at least two years of aging to mellow.
Peak Date: 2027-09-24`;

                const agingAdvice = await performApiCall(agingPrompt);
                const dateMatch = agingAdvice.match(/Peak Date:\s*(\d{4}-\d{2}-\d{2})/);
                const justificationMatch = agingAdvice.match(/Justification:\s*(.*)/);
                
                if (dateMatch) cellarData.peakFlavorDate = dateMatch[1];
                if (justificationMatch) cellarData.peakFlavorJustification = justificationMatch[1];

            } catch (aiError) {
                console.error("Aging advice failed, but bottling will continue:", aiError);
            }

            const cellarCol = collection(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar');
            await addDoc(cellarCol, cellarData);
            // Markeer het originele brouwsel als gebotteld
            const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', currentBrewToBottleId);
            await updateDoc(brewDocRef, { isBottled: true });

            // Stap 1: Forceer een directe update van de lokale data.
            const brewIndex = brews.findIndex(b => b.id === currentBrewToBottleId);
            if (brewIndex > -1) {
                brews[brewIndex].isBottled = true;
            }

            // Stap 2: Ruim de actieve 'Brew Day 1' op als dit de actieve batch was.
            if (currentBrewDay.brewId === currentBrewToBottleId) {
                currentBrewDay = { brewId: null, checklist: {} };
                await saveUserSettings(); // Sla de lege status op in de instellingen.
            }

            // Stap 3: Ververs de (momenteel verborgen) UI-lijsten onmiddellijk.
            renderBrewDay2();
            renderHistoryList();
            renderBrewDay('none'); // Leeg de Brew Day 1 weergave
            
            hideBottlingModal();
            showToast("Batch bottled and added to cellar!", "success");
            switchMainView('management');
            switchSubView('cellar', 'management-main-view');
        } else {
             throw new Error("Bottling cancelled by user.");
        }
    } catch (error) {
        console.error("Error during bottling process: ", error);
        showToast(error.message, "error");
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
    }
}

            // --- Calculator Functions ---
            function calculateABV() {
                const og = parseFloat(document.getElementById('og').value);
                const fg = parseFloat(document.getElementById('fg').value);
                const resultDiv = document.getElementById('abvResult');
                if (og && fg && og > fg) {
                    const abv = (og - fg) * 131.25;
                    resultDiv.textContent = `ABV: ${abv.toFixed(2)}%`;
                } else {
                    resultDiv.textContent = 'Invalid Input';
                }
            }

            function correctHydrometer() {
                const sg = parseFloat(document.getElementById('sgReading').value);
                const t = parseFloat(document.getElementById('tempReading').value);
                const c = parseFloat(document.getElementById('calTemp').value);
                const resultDiv = document.getElementById('sgResult');

                if (isNaN(sg) || isNaN(t) || isNaN(c)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // Formula for hydrometer correction
                const correctedSg = sg * ((1.00130346 - 0.000134722124 * t + 0.00000204052596 * t**2 - 0.00000000232820948 * t**3) / (1.00130346 - 0.000134722124 * c + 0.00000204052596 * c**2 - 0.00000000232820948 * c**3));
                resultDiv.textContent = `Corrected: ${correctedSg.toFixed(3)}`;
            }

            function calculatePrimingSugar() {
                const vol = parseFloat(document.getElementById('carbVol').value);
                const temp = parseFloat(document.getElementById('carbTemp').value);
                const size = parseFloat(document.getElementById('carbBatchSize').value);
                const resultDiv = document.getElementById('sugarResult');

                if (isNaN(vol) || isNaN(temp) || isNaN(size)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // Formula for priming sugar (sucrose)
                const sugarGrams = (vol - (3.0378 - 0.050062 * temp + 0.00026555 * temp**2)) * 4 * size;
                resultDiv.textContent = `${sugarGrams.toFixed(1)} g sugar`;
            }
            
            function calculateBlend() {
                const vol1 = parseFloat(document.getElementById('vol1').value);
                const sg1 = parseFloat(document.getElementById('sg1').value);
                const vol2 = parseFloat(document.getElementById('vol2').value);
                const sg2 = parseFloat(document.getElementById('sg2').value);
                const resultDiv = document.getElementById('blendResult');

                if (isNaN(vol1) || isNaN(sg1) || isNaN(vol2) || isNaN(sg2)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }

                const totalVolume = vol1 + vol2;
                const finalSG = (((vol1 * (sg1 - 1)) + (vol2 * (sg2 - 1))) / totalVolume) + 1;
                
                resultDiv.textContent = `Final: ${totalVolume.toFixed(2)}L at ${finalSG.toFixed(3)} SG`;
            }

            function calculateBacksweetening() {
                const vol = parseFloat(document.getElementById('bs_current_vol').value);
                const currentSg = parseFloat(document.getElementById('bs_current_sg').value);
                const targetSg = parseFloat(document.getElementById('bs_target_sg').value);
                const resultDiv = document.getElementById('backsweetenResult');

                if (isNaN(vol) || isNaN(currentSg) || isNaN(targetSg) || targetSg <= currentSg) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }

                // Honing voegt ongeveer 35 zwaartekrachtpunten per pond per gallon toe.
                // 1 pond = 453.6g; 1 gallon = 3.785L.
                // Dit komt neer op ongeveer 120g/L voor 35 punten, of 3.4g/L per punt (0.001 SG).
                const pointsToAdd = (targetSg - currentSg) * 1000;
                const honeyGrams = pointsToAdd * 3.4 * vol;
                const honeyKg = honeyGrams / 1000;

                resultDiv.textContent = `Add ${honeyGrams.toFixed(0)}g (${honeyKg.toFixed(2)}kg) honey`;
            }

            function calculateDilution() {
                const startVol = parseFloat(document.getElementById('dil_start_vol').value);
                const startSg = parseFloat(document.getElementById('dil_start_sg').value);
                const targetSg = parseFloat(document.getElementById('dil_target_sg').value);
                const resultDiv = document.getElementById('dilutionResult');

                if (isNaN(startVol) || isNaN(startSg) || isNaN(targetSg) || startSg <= targetSg) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // (V1 * G1) = (V2 * G2) => V_add = V1 * (G1 - G2) / (G2 - 1)
                const startPoints = startSg * 1000 - 1000;
                const targetPoints = targetSg * 1000 - 1000;
                const waterToAdd = startVol * (startPoints / targetPoints - 1);
                
                resultDiv.textContent = `Add ${waterToAdd.toFixed(2)}L water`;
            }

            function calculateTOSNA() {
                const og = parseFloat(document.getElementById('tosna_og').value);
                const vol = parseFloat(document.getElementById('tosna_vol').value);
                const yeastNeed = document.getElementById('tosna_yeast').value;
                const resultDiv = document.getElementById('tosnaResult');

                if (isNaN(og) || isNaN(vol)) {
                    resultDiv.innerHTML = `<p class="text-red-500">Invalid Input</p>`;
                    return;
                }

                // YAN (mg/L or ppm) = (2.7 * Brix) - 13.5  ; Brix = SG_points / 4
                const brix = (og * 1000 - 1000) / 4;
                let targetYAN;
                if (yeastNeed === 'low') targetYAN = 20 * brix;
                else if (yeastNeed === 'medium') targetYAN = 25 * brix;
                else targetYAN = 35 * brix;
                
                // Fermaid-O is ~40mg YAN/gram.
                const totalFermaidO = (targetYAN / 40) * vol;
                const addition = totalFermaidO / 4;

                resultDiv.innerHTML = `
                    <h4 class="font-bold text-lg">TOSNA 2.0 Schedule</h4>
                    <p><strong>Total Fermaid-O needed:</strong> ${totalFermaidO.toFixed(2)} grams.</p>
                    <ul class="list-disc pl-5 mt-2">
                        <li><strong>24 Hours:</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                        <li><strong>48 Hours:</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                        <li><strong>72 Hours:</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                        <li><strong>1/3 Sugar Break (or Day 7):</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                    </ul>
                `;
            }

            window.linkToBacksweetenCalc = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew || !brew.logData) return;

                // Navigeer naar de calculators tab
                switchMainView('tools');
                switchSubView('calculators', 'tools-main-view');

                // Vul de waarden in
                document.getElementById('bs_current_vol').value = brew.batchSize || '';
                document.getElementById('bs_current_sg').value = brew.logData.actualFG || brew.logData.targetFG || '';
                
                // Scroll naar de calculator
                document.getElementById('bs_current_vol').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            window.linkToDilutionCalc = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew || !brew.logData) return;

                // Navigeer naar de calculators tab
                switchMainView('tools');
                switchSubView('calculators', 'tools-main-view');
                
                // Vul de waarden in
                document.getElementById('dil_start_vol').value = brew.batchSize || '';
                document.getElementById('dil_start_sg').value = brew.logData.actualOG || brew.logData.targetOG || '';
                
                // Scroll naar de calculator
                document.getElementById('dil_start_vol').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async function getYeastAdvice() {
                const og = document.getElementById('starterOG').value;
                const yeastDate = document.getElementById('yeastDate').value;
                const yeastType = document.getElementById('yeastType').value;
                const adviceOutput = document.getElementById('yeast-advice-output');

                if (!og || !yeastDate) {
                    adviceOutput.innerHTML = `<p class="text-red-500">Please enter both Starting Gravity and Yeast Date.</p>`;
                    return;
                }
                adviceOutput.innerHTML = '<div class="loader"></div>';

                const prompt = `You are a yeast expert. A homebrewer is making a mead with a starting gravity of ${og}. Their ${yeastType} yeast packet has a production date of ${yeastDate}. Today's date is ${new Date().toISOString().split('T')[0]}. Based on this, tell them if a yeast starter is necessary. If it is, provide a simple, step-by-step guide for making an appropriate starter for a 5-liter batch. Format the response in Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    adviceOutput.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting yeast advice:", error);
                    adviceOutput.innerHTML = `<p class="text-center text-red-500">Could not get yeast advice: ${error.message}</p>`;
                }
            }

            // --- Water Chemistry Functions ---
            const waterData = {
                spa: { ca: 5, mg: 2, na: 3, so4: 4, cl: 5, hco3: 17 },
                chaudfontaine: { ca: 65, mg: 18, na: 44, so4: 40, cl: 35, hco3: 305 },
                valvert: { ca: 68, mg: 2, na: 2, so4: 18, cl: 4, hco3: 204 },
                bru: { ca: 23.3, mg: 22.2, na: 8, so4: 5, cl: 4, hco3: 209 },
                villers: { ca: 106.1, mg: 11.1, na: 8, so4: 48.8, cl: 19.9, hco3: 340.4 }
            };

            function handleWaterSourceChange() {
                const select = document.getElementById('waterSource');
                const selectedValue = select.value;
                const [type, id] = selectedValue.split('_');

                let profile;
                if (type === 'builtin') {
                   profile = BUILT_IN_WATER_PROFILES[id];
                } else if (type === 'user') {
                   profile = userWaterProfiles.find(p => p.id === id);
                }  

                if (profile) {
                   currentWaterProfile = profile;
                   updateWaterProfileDisplay(profile);
                }
            }

            // VOEG DEZE KLEINE HELPER-FUNCTIE TOE
            function updateWaterProfileDisplay(profile) {
                document.getElementById('val-ca').textContent = profile.ca;
                document.getElementById('val-mg').textContent = profile.mg;
                document.getElementById('val-na').textContent = profile.na;
                document.getElementById('val-so4').textContent = profile.so4;
                document.getElementById('val-cl').textContent = profile.cl;
                document.getElementById('val-hco3').textContent = profile.hco3;
            }

            async function getWaterAdvice() {
                if (!currentWaterProfile) {
                    document.getElementById('water-advice-output').innerHTML = `<p class="text-center text-red-500">Please fetch or apply a water profile first.</p>`;
                    return;
                }
                
                const adviceOutput = document.getElementById('water-advice-output');
                adviceOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Analyzing water profile...</p>';
                
                const targetProfile = document.getElementById('meadTargetProfile').selectedOptions[0].text;
                const batchSize = document.getElementById('batchSize').value;
                const waterSourceType = document.getElementById('waterSource').value;

                // --- AANGEPAST: De prompt is nu dynamisch ---
                let prompt;
                const waterProfileString = `Calcium: ${currentWaterProfile.ca}, Magnesium: ${currentWaterProfile.mg}, Sodium: ${currentWaterProfile.na}, Sulfate: ${currentWaterProfile.so4}, Chloride: ${currentWaterProfile.cl}, Bicarbonate: ${currentWaterProfile.hco3}`;

                if (waterSourceType === 'tap') {
                    prompt = `You are an expert brew chemist. A user has provided their tap water profile in mg/L: ${waterProfileString}. They want to adjust this water for a ${batchSize}-liter batch of mead with a target character of "${targetProfile}". 
                    
                    Provide specific, actionable advice. Recommend additions of brewing salts (Gypsum, Calcium Chloride, Epsom Salt, Baking Soda) in grams to achieve the target profile. Start by explaining the goal (e.g., "For a rich and full-bodied mead, we want to increase Calcium and Chloride..."). Then, list the specific salt additions required. Format the response in simple Markdown.`;
                } else {
                    prompt = `You are an expert brew chemist. A user is starting with water that has the following profile in mg/L: ${waterProfileString}. They want to brew a ${batchSize}-liter batch of mead with a target character of "${targetProfile}". 
                    
                    First, analyze the provided water profile. Is it suitable as-is for the target mead style? If so, state that. If not, recommend specific additions of brewing salts (Gypsum, Calcium Chloride, Epsom Salt) in grams to improve it. Explain WHY you are recommending these changes (e.g., "add gypsum to accentuate dryness"). Format the response in simple Markdown.`;
                }


                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    adviceOutput.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting water advice:", error);
                    adviceOutput.innerHTML = `<p class="text-center text-red-500">Could not get water advice: ${error.message}</p>`;
                }
            }

            // --- Utility Functions ---
function parseIngredientsAndCalculateCost(markdown, inventory, batchSize) {
    let totalCost = 0;
    const requiredIngredients = parseIngredientsFromMarkdown(markdown);

    if (requiredIngredients.length === 0) {
        console.warn("Cost calculation: No ingredients found by the parser.");
        return 0;
    }

    // Helper functie om alles naar een basis-eenheid (g of ml) om te rekenen
    const convertToBaseUnit = (quantity, unit) => {
        const u = (unit || '').toLowerCase();
        if (u === 'kg') return { quantity: quantity * 1000, unit: 'g' };
        if (u === 'l') return { quantity: quantity * 1000, unit: 'ml' };
        return { quantity, unit: u };
    };

    requiredIngredients.forEach(req => {
        const inventoryItem = inventory.find(item => item.name.toLowerCase() === req.name.toLowerCase());
        
        if (inventoryItem && typeof inventoryItem.price === 'number' && inventoryItem.qty > 0) {
            // Stap 1: Converteer de benodigde hoeveelheid naar de basis-eenheid.
            const requiredAmountInBase = convertToBaseUnit(req.quantity, req.unit);

            // Stap 2: Bereken de prijs per basis-eenheid uit de inventaris.
            const inventoryAmountInBase = convertToBaseUnit(inventoryItem.qty, inventoryItem.unit);
            
            // Controleer of de eenheden overeenkomen na conversie (bv. g met g, ml met ml)
            if (requiredAmountInBase.unit === inventoryAmountInBase.unit) {
                const costPerBaseUnit = inventoryItem.price / inventoryAmountInBase.quantity;

                // Stap 3: Vermenigvuldig de benodigde hoeveelheid (in basis-eenheid) met de prijs per basis-eenheid.
                if (!isNaN(costPerBaseUnit)) {
                    totalCost += requiredAmountInBase.quantity * costPerBaseUnit;
                }
            } else {
                 console.warn(`Cannot calculate cost for '${req.name}'. Incompatible units: recipe wants '${requiredAmountInBase.unit}', inventory has '${inventoryAmountInBase.unit}'.`);
            }
        }
    });

    return totalCost;
}

            window.printEmptyLog = function() {
                const logHtml = getBrewLogHtml(null, 'empty');
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>Empty Brew Log</title><style>${document.querySelector('style').innerHTML}</style></head><body><div class="container mx-auto p-4">${logHtml}</div></body></html>`);
                printWindow.document.close();
                printWindow.print();
            }

            function getLogDataFromDOM(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return {};
                const logSection = container.querySelector('.brew-log-section');
                if (!logSection) return {};
                const suffix = `-${logSection.dataset.id}`;
                return {
                    recipeName: container.querySelector(`#recipeName${suffix}`)?.value || '',
                    brewDate: container.querySelector(`#brewDate${suffix}`)?.value || '',
                    targetOG: container.querySelector(`#targetOG${suffix}`)?.value || '',
                    actualOG: container.querySelector(`#actualOG${suffix}`)?.value || '',
                    targetFG: container.querySelector(`#targetFG${suffix}`)?.value || '',
                    actualFG: container.querySelector(`#actualFG${suffix}`)?.value || '',
                    targetABV: container.querySelector(`#targetABV${suffix}`)?.value || '',
                    finalABV: container.querySelector(`#finalABV${suffix}`)?.value || '',
                    fermentationLog: Array.from(container.querySelectorAll(`#fermentationTable${suffix} tbody tr`)).map(row => ({
                        date: row.cells[0].querySelector('input').value,
                        temp: row.cells[1].querySelector('input').value,
                        sg: row.cells[2].querySelector('input').value,
                        notes: row.cells[3].querySelector('input').value,
                    })),
                    agingNotes: container.querySelector(`#agingNotes${suffix}`)?.value || '',
                    bottlingNotes: container.querySelector(`#bottlingNotes${suffix}`)?.value || '',
                    tastingNotes: container.querySelector(`#tastingNotes${suffix}`)?.value || '',
                };
            }

function getBrewLogHtml(logData, idSuffix = 'new') {
    const data = logData || {};
    const fermLog = data.fermentationLog || Array.from({ length: 8 }, () => ({}));
    const escapedRecipeName = (data.recipeName || '').replace(/"/g, '&quot;');
    const copyOgToLogScript = `const ogInput = document.getElementById('actualOG-${idSuffix}'); const firstSgInput = document.querySelector('#fermentationTable-${idSuffix} tbody tr:first-child td:nth-child(3) input'); if (ogInput && firstSgInput) { firstSgInput.value = ogInput.value; }`;

    return `
        <div class="brew-log-section" data-id="${idSuffix}">
            <h3>Brewmaster's Log</h3>
            <div class="log-grid">
                <div class="log-item"><label for="recipeName-${idSuffix}">Recipe Name:</label><input type="text" id="recipeName-${idSuffix}" value="${escapedRecipeName}"></div>
                <div class="log-item"><label for="brewDate-${idSuffix}">Brew Date:</label><input type="date" id="brewDate-${idSuffix}" value="${data.brewDate || ''}"></div>
            </div>
            <div class="log-grid">
                 <div class="log-item"><label for="targetOG-${idSuffix}">Target OG:</label><input type="text" id="targetOG-${idSuffix}" value="${data.targetOG || ''}"></div>
                 <div class="log-item">
                    <label for="actualOG-${idSuffix}">Actual OG:</label>
                    <input type="text" id="actualOG-${idSuffix}" value="${data.actualOG || ''}" oninput="${copyOgToLogScript}">
                 </div>
                 <div class="log-item"><label for="targetFG-${idSuffix}">Target FG:</label><input type="text" id="targetFG-${idSuffix}" value="${data.targetFG || ''}"></div>
                <div class="log-item"><label for="actualFG-${idSuffix}">Actual FG:</label><input type="text" id="actualFG-${idSuffix}" value="${data.actualFG || ''}"></div>
                 <div class="log-item"><label for="targetABV-${idSuffix}">Target ABV:</label><input type="text" id="targetABV-${idSuffix}" value="${data.targetABV || ''}"></div>
                <div class="log-item"><label for="finalABV-${idSuffix}">Final ABV:</label><input type="text" id="finalABV-${idSuffix}" value="${data.finalABV || ''}"></div>
            </div>
            <div class="log-item">
                <label>Fermentation Log</label>
                <div class="overflow-x-auto">
                    <table class="fermentation-table table-fixed w-full" id="fermentationTable-${idSuffix}" style="min-width: 500px;">
                        <thead><tr><th style="width: 120px;">Date</th><th style="width: 80px;">Temp (°C)</th><th style="width: 90px;">S.G.</th><th>Notes</th></tr></thead>
                        <tbody>${fermLog.map(row => `<tr>
                                <td><input type="date" value="${row.date || ''}" class="w-full"></td>
                                <td><input type="number" step="0.5" placeholder="18.5" value="${row.temp || '18'}" class="w-full text-center"></td>
                                <td><input type="number" step="0.001" placeholder="1.050" value="${row.sg || ''}" class="w-full text-center"></td>
                                <td><input type="text" value="${row.notes || ''}" class="w-full"></td>
                            </tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>
            <div class="log-item"><label for="agingNotes-${idSuffix}">Aging & Conditioning Notes:</label><textarea id="agingNotes-${idSuffix}" rows="4" placeholder="...">${data.agingNotes || ''}</textarea></div>
            <div class="log-item"><label for="bottlingNotes-${idSuffix}">Bottling / Kegging Notes:</label><textarea id="bottlingNotes-${idSuffix}" rows="3" placeholder="...">${data.bottlingNotes || ''}</textarea></div>
            <div class="log-item"><label for="tastingNotes-${idSuffix}">Final Tasting Notes:</label><textarea id="tastingNotes-${idSuffix}" rows="6" placeholder="...">${data.tastingNotes || ''}</textarea></div>
        </div>
    `;
}

            // --- Functie voor de Actieve Batch Tijdlijn ---
function renderActiveBrewTimeline() {
    const card = document.getElementById('current-brew-card');
    if (!card) return;

    // Zoek de meest recente actieve (niet-gebottelde) brouwsel
    const activeBrew = brews.find(b => b.logData && b.logData.brewDate && b.logData.brewDate !== '' && !b.isBottled);

    if (!activeBrew) {
        card.classList.add('hidden');
        return;
    }

    const now = new Date();
    const brewDate = new Date(activeBrew.logData.brewDate);
    const daysFermenting = (now - brewDate) / (1000 * 60 * 60 * 24);

    // Bepaal de stadia en de voortgang
    const stages = [
        { name: 'Brew Day', day: 0 },
        { name: 'Primary End', day: 21 }, // Gemiddeld einde van primaire gisting
        { name: 'Aging', day: 60 }, // Een ijkpunt voor rijpen
        { name: 'Bottling Ready', day: 90 } // Indicatie dat het klaar zou kunnen zijn
    ];
    
    let statusText = `Day ${Math.round(daysFermenting)}: `;
    if (daysFermenting < stages[1].day) {
        statusText += "Primary Fermentation";
    } else if (daysFermenting < stages[2].day) {
        statusText += "Secondary / Clearing";
    } else {
        statusText += "Aging";
    }

    // Bereken de voortgang in procenten voor de progress bar
    const totalDuration = stages[stages.length - 1].day;
    const progressPercentage = Math.min(100, (daysFermenting / totalDuration) * 100);

    let timelineItemsHtml = '';
    stages.forEach((stage) => {
        const isActive = daysFermenting >= stage.day;
        timelineItemsHtml += `
            <div class="timeline-item ${isActive ? 'active' : ''}">
                <div class="timeline-node"></div>
                <div class="timeline-label">${stage.name}</div>
            </div>
        `;
    });

    card.innerHTML = `
        <h3 class="text-xl font-header font-bold mb-1">${activeBrew.recipeName}</h3>
        <p class="text-app-secondary mb-4">${statusText}</p>
        <div class="timeline-container">
            <div class="timeline-connector">
                <div class="timeline-progress" style="width: ${progressPercentage}%;"></div>
            </div>
            ${timelineItemsHtml}
        </div>
    `;

    card.classList.remove('hidden');
}

            function updateNextActionWidget() {
    const widget = document.getElementById('next-action-widget');
    const list = document.getElementById('next-action-list');
    if (!widget || !list) return;

    const widgetTitle = widget.querySelector('h3');
    if (widgetTitle) widgetTitle.textContent = "What's next?";

    list.innerHTML = '';
    const suggestions = [];
    const now = new Date();
    now.setHours(0,0,0,0);
    const twentyFourHoursAgo = new Date(new Date().getTime() - (24 * 60 * 60 * 1000));

    // Suggestion 1: Recently saved recipe
    if (brews.length > 0) {
        const newestBrew = brews[0];
        if (newestBrew.createdAt.toDate() > twentyFourHoursAgo && !newestBrew.isBottled) {
             suggestions.push(`
                <li>
                    You recently saved the recipe '<strong>${newestBrew.recipeName}</strong>'.
                    <button onclick="window.generateShoppingList('${newestBrew.id}')" class="text-blue-600 hover:underline font-semibold ml-2">Create shopping list</button> or
                    <button onclick="window.startBrewDay('${newestBrew.id}')" class="text-green-600 hover:underline font-semibold ml-1">Start brew day!</button>
                </li>
             `);
        }
    }

    // Suggestion 2: Mead fermenting for a while
    const fermentingBrews = brews.filter(b => b.logData && b.logData.brewDate && !b.isBottled && b.logData.brewDate !== '');
    if (fermentingBrews.length > 0) {
        fermentingBrews.forEach(brew => {
            const brewDate = new Date(brew.logData.brewDate);
            if (!isNaN(brewDate.getTime())) {
                const daysFermenting = (now - brewDate) / (1000 * 60 * 60 * 24);
                if (daysFermenting > 18 && !brew.logData.actualFG) {
                    suggestions.push(`
                        <li>
                            '<strong>${brew.recipeName}</strong>' has been fermenting for ${Math.round(daysFermenting)} days. Time for an SG reading?
                            <button onclick="window.showBrewDetail('${brew.id}')" class="text-blue-600 hover:underline font-semibold ml-2">View Log</button>
                        </li>
                    `);
                }
            }
        });
    }
    
    // Suggestion 3: Batch in cellar nearing peak
    if (cellar.length > 0) {
        cellar.forEach(item => {
            if(item.peakFlavorDate) {
                const peakDate = new Date(item.peakFlavorDate);
                 if (!isNaN(peakDate.getTime())) {
                    const daysUntilPeak = (peakDate - now) / (1000 * 60 * 60 * 24);
                    if(daysUntilPeak <= 14 && daysUntilPeak > -30) {
                         suggestions.push(`
                            <li>
                                The '<strong>${item.recipeName}</strong>' in your cellar is nearing its peak! Maybe it's time for a tasting?
                            </li>
                        `);
                    }
                }
            }
        });
    }

    // Suggestion 4: Expiring inventory
    if (inventory.length > 0) {
        inventory.forEach(item => {
            if (item.expirationDate) {
                const expDate = new Date(item.expirationDate);
                const daysUntilExp = (expDate - now) / (1000 * 60 * 60 * 24);
                if (daysUntilExp >= 0 && daysUntilExp <= 30) {
                    suggestions.push(`
                        <li>
                            <span class="text-amber-600 dark:text-amber-400">Warning:</span> Your <strong>${item.name}</strong> is expiring in ${Math.round(daysUntilExp)} days!
                        </li>
                    `);
                }
            }
        });
    }

    if (suggestions.length > 0) {
        list.innerHTML = suggestions.slice(0, 3).join('');
        widget.classList.remove('hidden');
    } else {
        widget.classList.add('hidden');
    }
}
            
            // --- Brew Day Assistant Functions ---
            window.startBrewDay = async function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    // Navigeer eerst naar de shopping list om de ingrediënten te controleren
    switchMainView('brewing');
    switchSubView('shopping-list', 'brewing-main-view');
    generateShoppingList(brewId, false);
}

function renderBrewDay(brewId) {
    if (brewId === 'none') {
        document.getElementById('brew-day-content').innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 1 - Primary Fermentation</h2><p class="text-center text-app-secondary/80">Select a new recipe from your History to start a new brew day.</p>`;
        return;
    }

    const brew = brews.find(b => b.id === brewId);
    const brewDayContent = document.getElementById('brew-day-content');
    if (!brew) {
        brewDayContent.innerHTML = `<p class="text-center text-red-500">Could not find the selected brew. Please start a new one.</p>`;
        return;
    }

    const primarySteps = brew.brewDaySteps || [];
    if (primarySteps.length === 0) {
         brewDayContent.innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2><p class="text-center text-app-secondary/80">Could not find Primary Fermentation steps for this recipe.</p>`;
         return;
    }

    let stepsHtml = primarySteps.map((step, index) => {
        const isCompleted = currentBrewDay.checklist[`step-${index}`] || false;
        const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${index}">${formatTime(step.duration)}</p>` : '';
        const buttonsHtml = step.duration > 0 ? `
            <button data-action="startTimer" data-step="${index}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
        ` : `
            <button data-action="completeStep" data-step="${index}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
        `;

        return `
            <div id="step-${index}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                <div>
                    <p class="step-title">${index + 1}. ${step.title}</p>
                    <p class="text-sm text-app-secondary">${step.description}</p>
                    <div class="mt-4">
                        ${timerHtml}
                        <div class="space-x-2" id="controls-${index}">
                            ${isCompleted ? '<span class="text-sm font-bold text-green-600">✓ Completed</span>' : buttonsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    const parsedTargets = parseRecipeData(brew.recipeMarkdown);
    const combinedLogData = { ...brew.logData, ...parsedTargets };
    const logHtml = getBrewLogHtml(combinedLogData, brew.id);

    brewDayContent.innerHTML = `
        <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2>
        <div class="mb-4">
            <div class="progress-bar-bg w-full h-2 rounded-full">
                <div id="brew-day-progress" class="progress-bar-fg h-2 rounded-full" style="width: 0%;"></div>
            </div>
        </div>
        <div id="brew-day-steps-container">
            ${stepsHtml}
        </div>
        <div class="text-center mt-6">
            <button data-action="resetBrewDay" class="text-sm bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 btn">Reset and Start Over</button>
        </div>
        <hr class="my-8 border-app">
        ${logHtml}
        <div class="mt-4 no-print">
            <button onclick="window.updateBrewLog('${brew.id}')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
        </div>
    `;

    initializeBrewDayState(primarySteps);
}

function renderBrewDay2() {
    const view = document.getElementById('brew-day-2-view');
    if (!view) return;

    // Vind alle brouwsels die gestart zijn maar nog niet gebotteld
    const secondaryBrews = brews.filter(b => b.primaryComplete && !b.isBottled);

    if (secondaryBrews.length === 0) {
        view.innerHTML = `
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-header font-bold mb-4 text-center">Secondary / Aging</h2>
                <p class="text-center text-app-secondary/80">You have no batches currently in the secondary or aging phase.</p>
            </div>
        `;
        return;
    }

    const listHtml = secondaryBrews.map(brew => {
        const brewDate = new Date(brew.logData.brewDate);
        const daysInFermentation = Math.floor((new Date() - brewDate) / (1000 * 60 * 60 * 24));
        return `
            <div class="p-4 card rounded-lg cursor-pointer hover:bg-app-primary" onclick="window.showBrewDay2Detail('${brew.id}')">
                <h4 class="font-bold text-lg font-header">${brew.recipeName || 'Untitled Brew'}</h4>
                <p class="text-sm text-app-secondary/80">Started on: ${brewDate.toLocaleDateString()} (${daysInFermentation} days ago)</p>
            </div>
        `;
    }).join('');

    view.innerHTML = `
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-header font-bold mb-6 text-center">Secondary / Aging</h2>
            <div id="brew-day-2-list" class="space-y-4">
                ${listHtml}
            </div>
        </div>
    `;
}

window.showBrewDay2Detail = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    currentBrewDay = userSettings.currentBrewDay?.brewId === brewId ? userSettings.currentBrewDay : { brewId: brewId, checklist: {} };

    const view = document.getElementById('brew-day-2-view');
    const secondarySteps = brew.secondarySteps || [];
    const stepOffset = (brew.brewDaySteps || []).length; // Start telling vanaf het einde van de primaire stappen

    let secondaryStepsHtml = '<p class="text-center text-app-secondary/80">No specific secondary steps found for this recipe. Ready to bottle?</p>';
    if (secondarySteps.length > 0) {
        secondaryStepsHtml = secondarySteps.map((step, index) => {
            const originalIndex = stepOffset + index;
            const isCompleted = currentBrewDay.checklist[`step-${originalIndex}`] || false;

            const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${originalIndex}">${formatTime(step.duration)}</p>` : '';
            const buttonsHtml = step.duration > 0 ? `
                <button data-action="startTimer" data-step="${originalIndex}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
            ` : `
                <button data-action="completeStep" data-step="${originalIndex}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
            `;

            return `
                <div id="step-${originalIndex}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                    <div>
                        <p class="step-title">${originalIndex + 1}. ${step.title}</p>
                        <p class="text-sm text-app-secondary">${step.description}</p>
                        <div class="mt-4">
                            ${timerHtml}
                            <div class="space-x-2" id="controls-${originalIndex}">
                                ${isCompleted ? '<span class="text-sm font-bold text-green-600">✓ Completed</span>' : buttonsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    const logHtml = getBrewLogHtml(brew.logData, brew.id);

    view.innerHTML = `
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <button onclick="renderBrewDay2()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to Secondary List</button>
            <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName}</h2>
            <div class="mb-6">
                <h3 class="text-xl font-header mb-2">Remaining Steps</h3>
                <div id="brew-day-steps-container">${secondaryStepsHtml}</div>
            </div>
            <div class="text-center my-6">
                <button onclick="window.showBottlingModal('${brew.id}')" class="bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                    Bottle This Batch
                </button>
            </div>
            <hr class="my-8 border-app">
            ${logHtml}
            <div class="mt-4 no-print">
                <button onclick="window.updateBrewLog('${brew.id}')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
            </div>
        </div>
    `;
}

            window.deleteBrew = async function(brewId) {
                if (!userId) return;
                const brewToDelete = brews.find(b => b.id === brewId);
                if (!brewToDelete) return;
                if (!confirm(`Are you sure you want to permanently delete the recipe "${brewToDelete.recipeName}"? This action cannot be undone.`)) return;

                try {
                    const appId = 'meandery-aa05e';
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
                    await deleteDoc(brewDocRef);
                    showToast(`Recipe "${brewToDelete.recipeName}" has been deleted.`, 'success');
                    goBackToHistoryList();
                } catch (error) {
                    console.error("Error deleting brew:", error);
                    showToast("An error occurred while deleting the recipe.", 'error');
                }
            }

            // --- State Management voor de Brouwdag Timer ---
            let brewDaySteps = [];
            let currentStepIndex = 0;
            let stepTimerInterval = null;
            let remainingTime = 0;

            // --- Gecentraliseerde Event Listener voor de Brouwdag ---
            function setupBrewDayEventListeners() {
    // AANGEPAST: Luister nu naar de hele 'brewing-main-view' in plaats van enkel 'brew-day-content'
    const viewContainer = document.getElementById('brewing-main-view');
    if (!viewContainer) return;

    viewContainer.addEventListener('click', function(e) {
        const target = e.target.closest('button[data-action]');
        if (!target) return; 

        const action = target.dataset.action;
        const stepIndex = parseInt(target.dataset.step);

        switch(action) {
            case 'startTimer':
                startStepTimer(stepIndex);
                break;
            case 'pauseTimer':
                pauseStepTimer();
                break;
            case 'skipTimer':
                skipTimer(stepIndex);
                break;
            case 'completeStep':
                completeStep(stepIndex);
                break;
            case 'resetBrewDay':
                resetBrewDay();
                break;
        }
    });
}

function parseStepsForBrewDay(markdown) {
    const steps = { primary: [], secondary: [] };
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = marked.parse(markdown);

    const primaryHeader = Array.from(tempDiv.querySelectorAll('h3')).find(h => h.textContent.toLowerCase().includes('primary fermentation'));
    const secondaryHeader = Array.from(tempDiv.querySelectorAll('h3')).find(h => h.textContent.toLowerCase().includes('secondary & aging'));

    // Deze functie leest nu gewoon de (correcte, relatieve) tijd uit de tag.
    const parseStepText = (text) => {
        let duration = 0;
        let title = text;
        const durationMatch = text.match(/\[d:(\d+):(\d{2}):(\d{2})\]/);

        if (durationMatch) {
            const hours = parseInt(durationMatch[1], 10);
            const minutes = parseInt(durationMatch[2], 10);
            const seconds = parseInt(durationMatch[3], 10);
            duration = (hours * 3600) + (minutes * 60) + seconds;
            title = text.replace(durationMatch[0], '').trim();
        }
        return { title: title, description: 'Follow the instruction.', duration: duration };
    };

    const processSection = (header, stepArray) => {
        if (header) {
            let element = header.nextElementSibling;
            while (element && element.tagName !== 'H2' && element.tagName !== 'H3') {
                if (element.tagName === 'OL' || element.tagName === 'UL') {
                    Array.from(element.children).forEach(li => {
                        if (li.tagName === 'LI') {
                            stepArray.push(parseStepText(li.textContent.trim()));
                        }
                    });
                }
                element = element.nextElementSibling;
            }
        }
    };

    processSection(primaryHeader, steps.primary);
    processSection(secondaryHeader, steps.secondary);
    
    return steps;
}

window.saveBrewToHistory = async function() {
    if (!userId || !currentRecipeMarkdown) {
        showToast("Cannot save. No user identified or no recipe generated.", "error");
        return;
    }
    const saveButton = document.getElementById('saveBtn');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    // CORRECTIE: De onnodige API-aanroep is hier verwijderd.
    const totalBatchCost = parseIngredientsAndCalculateCost(currentRecipeMarkdown, inventory, parseFloat(document.getElementById('batchSize').value) || 5);
    const brewDayStepsObject = parseStepsForBrewDay(currentRecipeMarkdown);
    
    const initialLogData = parseRecipeData(currentRecipeMarkdown);
    initialLogData.fermentationLog = Array.from({ length: 8 }, () => ({}));
    
    const batchSize = parseFloat(document.getElementById('batchSize').value) || 5;
    const brewData = {
        userId: userId,
        recipeName: initialLogData.recipeName || "Untitled Brew",
        recipeMarkdown: currentRecipeMarkdown,
        prompt: lastGeneratedPrompt,
        logData: initialLogData,
        createdAt: new Date(),
        batchSize: batchSize,
        totalCost: totalBatchCost,
        isBottled: false,
        primaryComplete: false,
        predictedFlavorProfile: currentPredictedProfile, // Gebruik de waarde die al bestaat
        brewDaySteps: brewDayStepsObject.primary,
        secondarySteps: brewDayStepsObject.secondary
    };

    try {
        const appId = 'meandery-aa05e';
        const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
        const docRef = await addDoc(brewsCol, brewData);
        
        const buttonContainer = saveButton.parentElement;
        
        buttonContainer.innerHTML += `
            <button onclick="window.startBrewDay('${docRef.id}')" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors btn">
                Start Brew Day
            </button>
        `;

        saveButton.textContent = 'Saved!';
        saveButton.classList.replace('bg-green-700', 'bg-gray-500');
        showToast("Recipe saved to History!", "success");

        promptToUpdateInventory(currentRecipeMarkdown);

    } catch (error) {
        console.error("Error saving brew:", error);
        showToast("Error saving recipe.", "error");
        saveButton.textContent = 'Save to Brew History';
        saveButton.disabled = false;
    }
}

function renderBrewDay(brewId) {
    if (brewId === 'none') {
        document.getElementById('brew-day-content').innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 1 - Primary Fermentation</h2><p class="text-center text-app-secondary/80">Select a new recipe from your History to start a new brew day.</p>`;
        return;
    }

    const brew = brews.find(b => b.id === brewId);
    const brewDayContent = document.getElementById('brew-day-content');
    if (!brew) {
        brewDayContent.innerHTML = `<p class="text-center text-red-500">Could not find the selected brew. Please start a new one.</p>`;
        return;
    }

    const primarySteps = brew.brewDaySteps || [];
    if (primarySteps.length === 0) {
         brewDayContent.innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2><p class="text-center text-app-secondary/80">Could not find Primary Fermentation steps for this recipe.</p>`;
         return;
    }

    let stepsHtml = primarySteps.map((step, index) => {
        const isCompleted = currentBrewDay.checklist[`step-${index}`] || false;
        const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${index}">${formatTime(step.duration)}</p>` : '';
        const buttonsHtml = step.duration > 0 ? `
            <button data-action="startTimer" data-step="${index}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
        ` : `
            <button data-action="completeStep" data-step="${index}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
        `;

        return `
            <div id="step-${index}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                <div>
                    <p class="step-title">${index + 1}. ${step.title}</p>
                    <p class="text-sm text-app-secondary">${step.description}</p>
                    <div class="mt-4">
                        ${timerHtml}
                        <div class="space-x-2" id="controls-${index}">
                            ${isCompleted ? '<span class="text-sm font-bold text-green-600">✓ Completed</span>' : buttonsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    const parsedTargets = parseRecipeData(brew.recipeMarkdown);
    const combinedLogData = { ...brew.logData, ...parsedTargets };
    const logHtml = getBrewLogHtml(combinedLogData, brew.id);

    brewDayContent.innerHTML = `
        <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2>
        <div class="mb-4">
            <div class="progress-bar-bg w-full h-2 rounded-full">
                <div id="brew-day-progress" class="progress-bar-fg h-2 rounded-full" style="width: 0%;"></div>
            </div>
        </div>
        <div id="brew-day-steps-container">
            ${stepsHtml}
        </div>
        <div class="text-center mt-6">
            <button data-action="resetBrewDay" class="text-sm bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 btn">Reset and Start Over</button>
        </div>
        <hr class="my-8 border-app">
        ${logHtml}
        <div class="mt-4 no-print">
            <button onclick="window.updateBrewLog('${brew.id}')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
        </div>
    `;

    initializeBrewDayState(primarySteps);
}

// VERVANG DE VOLLEDIGE OUDE showBrewDay2Detail FUNCTIE
window.showBrewDay2Detail = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    currentBrewDay = userSettings.currentBrewDay?.brewId === brewId ? userSettings.currentBrewDay : { brewId: brewId, checklist: {} };

    const view = document.getElementById('brew-day-2-view');
    const secondarySteps = brew.secondarySteps || [];
    const stepOffset = (brew.brewDaySteps || []).length;

    let secondaryStepsHtml = '<p class="text-center text-app-secondary/80">No specific secondary steps found for this recipe. Ready to bottle?</p>';
    if (secondarySteps.length > 0) {
        secondaryStepsHtml = secondarySteps.map((step, index) => {
            const originalIndex = stepOffset + index;
            const isCompleted = currentBrewDay.checklist[`step-${originalIndex}`] || false;

            const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${originalIndex}">${formatTime(step.duration)}</p>` : '';
            const buttonsHtml = step.duration > 0 ? `
                <button data-action="startTimer" data-step="${originalIndex}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
            ` : `
                <button data-action="completeStep" data-step="${originalIndex}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
            `;

            return `
                <div id="step-${originalIndex}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                    <div>
                        <p class="step-title">${originalIndex + 1}. ${step.title}</p>
                        <p class="text-sm text-app-secondary">${step.description}</p>
                        <div class="mt-4">
                            ${timerHtml}
                            <div class="space-x-2" id="controls-${originalIndex}">
                                ${isCompleted ? '<span class="text-sm font-bold text-green-600">✓ Completed</span>' : buttonsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    const logHtml = getBrewLogHtml(brew.logData, brew.id);

    view.innerHTML = `
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <button onclick="renderBrewDay2()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to Secondary List</button>
            <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName}</h2>
            <div class="mb-6">
                <h3 class="text-xl font-header mb-2">Remaining Steps</h3>
                <div id="brew-day-steps-container">${secondaryStepsHtml}</div>
            </div>
            <div class="text-center my-6">
                <button onclick="window.showBottlingModal('${brew.id}')" class="bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                    Bottle This Batch
                </button>
            </div>
            <hr class="my-8 border-app">
            ${logHtml}
            <div class="mt-4 no-print">
                <button onclick="window.updateBrewLog('${brew.id}')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
            </div>
        </div>
    `;
}

            function generateBrewDaySteps(brew) {
                // AANGEPAST: De functie leest nu de betrouwbare, opgeslagen array
                if (!brew.brewDaySteps || brew.brewDaySteps.length === 0) {
                    console.warn("No pre-parsed brew day steps found for this brew.");
                    return [];
                }
                
                // We voegen de standaard voorbereidingsstappen toe aan de geparste lijst
                const prepSteps = [
                    { title: "Prepare Brewing Water", description: "Adjust your water based on the recipe's recommendation.", duration: 600 },
                    { title: "Gather & Weigh Ingredients", description: "Prepare all necessary ingredients.", duration: 0 }
                ];

                const recipeSteps = brew.brewDaySteps.map(step => ({ ...step })); // Kopieer de stappen

                // Post-processing voor relatieve timers (bijv. voor nutrienten)
                let lastNutrientTimeInSeconds = 0;
                recipeSteps.forEach(step => {
                    if (step.title.match(/\d+\s*Hours:/i) && step.duration > 0) {
                        const absoluteDuration = step.duration;
                        step.duration = absoluteDuration - lastNutrientTimeInSeconds;
                        lastNutrientTimeInSeconds = absoluteDuration;
                    }
                });

                return [...prepSteps, ...recipeSteps];
            }

            function initializeBrewDayState(steps) {
                brewDaySteps = steps;
                
                // --- Controleer op een opgeslagen timer ---
                const savedTimer = localStorage.getItem('activeBrewDayTimer');
                if (savedTimer) {
                    const { brewId, stepIndex, endTime } = JSON.parse(savedTimer);
                    
                    // Herstel de timer enkel als het voor de HUIDIGE brouwdag is
                    if (brewId === currentBrewDay.brewId) {
                        const now = Date.now();
                        if (endTime > now) {
                            // Er is een actieve timer, herstart deze
                            currentStepIndex = stepIndex;
                            const remainingSeconds = Math.round((endTime - now) / 1000);
                            startStepTimer(stepIndex, remainingSeconds);
                            updateUI(); // Zorg dat de UI de actieve timer toont
                            return; // Stop de functie hier om de standaard UI-update over te slaan
                        } else {
                            // Timer is verlopen terwijl de app gesloten was
                            localStorage.removeItem('activeBrewDayTimer');
                            currentBrewDay.checklist[`step-${stepIndex}`] = true;
                        }
                    }
                }
                
                const lastCompleted = Object.keys(currentBrewDay.checklist).length - 1;
                currentStepIndex = lastCompleted >= 0 ? lastCompleted + 1 : 0;
                updateUI();
            }

            function startStepTimer(stepIndex, resumeTime = null) {
                if (stepTimerInterval) return; // Start geen nieuwe timer als er al een loopt

                // Zoek de actieve brew op
    const activeBrew = brews.find(b => b.id === currentBrewDay.brewId);
    if (!activeBrew) {
        console.error("Could not find active brew to start timer.");
        return;
    }

    // Combineer alle stappen om de juiste te vinden
    const allSteps = [...(activeBrew.brewDaySteps || []), ...(activeBrew.secondarySteps || [])];
    const step = allSteps[stepIndex];

    if (!step) {
        console.error(`Could not find step data for index ${stepIndex}.`);
        return;
    }

                let timeLeft = resumeTime !== null ? resumeTime : brewDaySteps[stepIndex].duration;
                
                // --- Sla de eindtijd van de timer op ---
                const endTime = Date.now() + timeLeft * 1000;
                const timerState = { brewId: currentBrewDay.brewId, stepIndex: stepIndex, endTime: endTime };
                localStorage.setItem('activeBrewDayTimer', JSON.stringify(timerState));

                const timerDisplay = document.getElementById(`timer-${stepIndex}`);
                const controlsDiv = document.getElementById(`controls-${stepIndex}`);
                
                controlsDiv.innerHTML = `
                    <button data-action="pauseTimer" data-step="${stepIndex}" class="text-sm bg-yellow-500 text-white py-1 px-3 rounded-lg hover:bg-yellow-600 btn">Pause</button>
                    <button data-action="skipTimer" data-step="${stepIndex}" class="text-sm bg-gray-500 text-white py-1 px-3 rounded-lg hover:bg-gray-600 btn">Skip Timer</button>
                `;
                
                stepTimerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = formatTime(timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(stepTimerInterval);
                        stepTimerInterval = null;
                        timerDisplay.textContent = "Done!";
                        new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAnxAAAAAAAAAAAAAAAAAAAAAAAABSUxNfAAAAAAAAAAAAAAAAAAAAAAAASU5GTwMAAAAUAAABowAAAA8AAAB1bml0eS1tZWRpYQAAAAAAAAAAAAAAAAAAAAAAAFQNCj/9oACQAAAAAABn//6w4j/wAANwAD//5L/xO//6s4j/9r/9E4//lVn//V///6/8j/9E5///8R/wD/1P/0j//8//lVn/Vn//6/8j/9E5///8AAAAAQU1QRTGk9f/7QJ8QaSqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq==").play();
                        localStorage.removeItem('activeBrewDayTimer'); // Timer is voltooid
                        completeStep(stepIndex);
                    }
                }, 1000);
            }

            function pauseStepTimer() {
                clearInterval(stepTimerInterval);
                stepTimerInterval = null;
                
                // --- Sla de resterende tijd op en verwijder de eindtijd ---
                const timerDisplay = document.getElementById(`timer-${currentStepIndex}`);
                localStorage.removeItem('activeBrewDayTimer');
                const timeParts = timerDisplay.textContent.split(':');
                if (timeParts.length === 2) {
                    remainingTime = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]);
                } else if (timeParts.length === 3) {
                    remainingTime = parseInt(timeParts[0]) * 3600 + parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]);
                }

                const controlsDiv = document.getElementById(`controls-${currentStepIndex}`);
                controlsDiv.innerHTML = `<button data-action="startTimer" data-step="${currentStepIndex}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Resume</button>`;
            }


function skipTimer(stepIndex) {
    clearInterval(stepTimerInterval);
    stepTimerInterval = null;
    remainingTime = 0;

    localStorage.removeItem('activeBrewDayTimer');

    completeStep(stepIndex);
}

            function resetBrewDay() {
                if (confirm("Are you sure you want to reset your progress for this brew day?")) {
                    currentBrewDay.checklist = {};
                    saveChecklistState();
                    
                    // --- Verwijder een eventuele actieve timer ---
                    clearInterval(stepTimerInterval);
                    stepTimerInterval = null;
                    remainingTime = 0;
                    localStorage.removeItem('activeBrewDayTimer');

                    renderBrewDay(currentBrewDay.brewId);
                }
            }

// --- VERVANG JE VOLLEDIGE completeStep FUNCTIE MET DEZE ---
async function completeStep(stepIndex) {
    if (stepTimerInterval) {
        clearInterval(stepTimerInterval);
        stepTimerInterval = null;
        remainingTime = 0;
        localStorage.removeItem('activeBrewDayTimer');
    }
    
    currentBrewDay.checklist[`step-${stepIndex}`] = true;
    await saveChecklistState();

    const stepDiv = document.getElementById(`step-${stepIndex}`);
    if (stepDiv) {
        stepDiv.classList.remove('active');
        stepDiv.classList.add('completed');
        
        const controlsDiv = document.getElementById(`controls-${stepIndex}`);
        if (controlsDiv) {
            controlsDiv.innerHTML = `<span class="text-sm font-bold text-green-600">✓ Completed</span>`;
        }
    }

    // Vind de container en alle stappen die momenteel op het scherm zichtbaar zijn.
    const allStepsContainer = stepDiv.closest('[id$="-steps-container"]');
    if (!allStepsContainer) return; // Veiligheidsklep

    const allStepItems = allStepsContainer.querySelectorAll('.step-item');
    
    // Bepaal de positie (index) van de HUIDIGE stap binnen de ZICHTBARE lijst.
    const currentRelativeIndex = Array.from(allStepItems).findIndex(item => item.id === `step-${stepIndex}`);

    // Controleer of dit de laatste stap in de ZICHTBARE lijst was.
    if (currentRelativeIndex !== -1 && currentRelativeIndex + 1 < allStepItems.length) {
        // Nee, het was niet de laatste stap. Activeer de volgende.
        const nextStepDiv = allStepItems[currentRelativeIndex + 1];
        if (nextStepDiv) {
            nextStepDiv.classList.add('active');
        }
    } else {
        // Ja, dit was de laatste stap van de HUIDIGE fase (Brew Day 1 of 2).
        const brew = brews.find(b => b.id === currentBrewDay.brewId);
        const primaryStepCount = (brew.brewDaySteps || []).length;
        
        // Toon de "Phase 1 Complete" kaart ENKEL en ALLEEN als de zojuist voltooide stap
        // de allerlaatste stap van de primaire fase was (bv. stap 11 van 12, want index is 0-based).
        if (stepIndex === primaryStepCount - 1) {
             await markPrimaryAsComplete(currentBrewDay.brewId);
             
             // Gebruik de correcte container die we eerder hebben gevonden.
             allStepsContainer.innerHTML += `
                <div class="text-center p-6 card rounded-lg mt-6">
                    <h3 class="text-2xl font-header font-bold text-green-600">Phase 1 Complete!</h3>
                    <p class="my-2">Great! The primary fermentation steps are done.</p>
                    <p class="text-app-secondary mb-4">The next steps for this batch can now be found on the 'Brew Day 2' tab.</p>
                    <button onclick="window.finalizeBrewDay1()" class="bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">
                        Go to Brew Day 2
                    </button>
                </div>
            `;
        }
    }
}

function updateUI() {
    const progress = (currentStepIndex / brewDaySteps.length) * 100;
    const progressBar = document.getElementById('brew-day-progress');
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
    }

    brewDaySteps.forEach((step, index) => {
        const stepDiv = document.getElementById(`step-${index}`);
        if (!stepDiv) return;

        const controlsDiv = document.getElementById(`controls-${index}`);
        stepDiv.classList.remove('active', 'completed');

        if (index < currentStepIndex) {
            stepDiv.classList.add('completed');
            if (controlsDiv) {
                controlsDiv.innerHTML = `<span class="text-sm font-bold text-green-600">✓ Completed</span>`;
            }
        } else if (index === currentStepIndex) {
            stepDiv.classList.add('active');
        }
    });
}

async function markPrimaryAsComplete(brewId) {
    if (!userId || !brewId) return;
    try {
        const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
        await updateDoc(brewDocRef, { primaryComplete: true });
        
        // Update ook de lokale data onmiddellijk
        const brewIndex = brews.findIndex(b => b.id === brewId);
        if (brewIndex > -1) {
            brews[brewIndex].primaryComplete = true;
        }
    } catch (error) {
        console.error("Could not mark primary as complete:", error);
    }
}

window.finalizeBrewDay1 = async function() {
    // Stap 1: Bouw de inhoud van de (nog verborgen) Brew Day 2 weergave opnieuw op.
    renderBrewDay2();

    // Stap 2: Schakel nu pas over naar de weergave om deze zichtbaar te maken.
    window.switchSubView('brew-day-2', 'brewing-main-view');

    // Stap 3: Reset de Brew Day 1 status
    currentBrewDay = { brewId: null, checklist: {} };
    await saveUserSettings(); // Sla de lege status op in de database

    // Stap 4: Maak de Brew Day 1 view visueel leeg voor de volgende batch
    renderBrewDay('none');
}

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "00:00";
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                if (h > 0) {
                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                }
                return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
   
            // --- Analysis Functions ---
// --- VERVANG JE VOLLEDIGE generateShoppingList FUNCTIE MET DEZE ---
window.generateShoppingList = function(brewId, navigate = false) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    const listState = brew.shoppingListState || {};

    const convertToBaseUnit = (quantity, unit) => {
        const u = unit.toLowerCase();
        if (u === 'kg') return { quantity: quantity * 1000, unit: 'g' };
        if (u === 'l') return { quantity: quantity * 1000, unit: 'ml' };
        return { quantity, unit: u };
    };

    const requiredIngredients = parseIngredientsFromMarkdown(brew.recipeMarkdown);
    const shoppingList = [];

    requiredIngredients.forEach(req => {
        const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
        const requiredAmount = convertToBaseUnit(req.quantity, req.unit);
        let stockAmount = { quantity: 0, unit: requiredAmount.unit };

        if (invItem) {
            stockAmount = convertToBaseUnit(invItem.qty, invItem.unit);
            if (stockAmount.unit !== requiredAmount.unit) {
                console.warn(`Unit mismatch for ${req.name}`);
            }
        }

        if (!invItem || stockAmount.quantity < requiredAmount.quantity) {
            let toBuy = requiredAmount.quantity - stockAmount.quantity;
            let unitToDisplay = req.unit;
            if (req.unit.toLowerCase() === 'g' && toBuy >= 1000) { 
                toBuy /= 1000;
                unitToDisplay = 'kg';
            } else if (req.unit.toLowerCase() === 'ml' && toBuy >= 1000) { 
                toBuy /= 1000;
                unitToDisplay = 'L';
            }
            shoppingList.push({ name: req.name, quantity: toBuy, unit: unitToDisplay });
        }
    });

    const contentDiv = document.getElementById('shopping-list-content');
    let html = `<h4 class="text-xl font-header mb-4">${brew.recipeName} - Shopping List</h4>`;
    
    if (shoppingList.length > 0) {
            html += `<div id="shopping-list-items" class="space-y-2">`;
            html += shoppingList.map((item, index) => {
                const displayQty = Number.isInteger(item.quantity) ? item.quantity : item.quantity.toFixed(2);
                const isChecked = listState[item.name] || false;
                const escapedItemName = item.name.replace(/'/g, "\\'");

                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="shop-item-${index}" 
                               onchange="window.updateShoppingListItemStatus('${brew.id}', '${escapedItemName}', this.checked)" 
                               class="h-5 w-5 rounded border-gray-300 text-app-brand focus:ring-app-brand flex-shrink-0"
                               ${isChecked ? 'checked' : ''}>
                        <label for="shop-item-${index}" class="ml-3 text-app-primary">${item.name}: ${displayQty} ${item.unit}</label>
                    </div>
                `;
            }).join('');
            html += `</div>`;
            
            html += `
                <div class="mt-6 pt-4 border-t border-app">
                    <button id="add-to-inventory-btn" onclick="window.addMissingItemsToInventory('${brew.id}')" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
                        Add Missing Items to Inventory (as 0 qty)
                    </button>
                </div>
            `;

            html += `<div id="start-brew-day-container" class="mt-6 text-center hidden">
                    <p class="text-green-600 dark:text-green-400 font-semibold mb-2">All items acquired!</p>
                    <button onclick="window.startActualBrewDay('${brew.id}')" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 btn">Let's Start Brewing!</button>
                 </div>`;
    } else {
            html += `<p class="text-green-600 dark:text-green-400 font-semibold mb-4">You have all the ingredients you need!</p>`;
            html += `<button onclick="window.startActualBrewDay('${brew.id}')" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 btn">Let's Start Brewing!</button>`;
    }

    contentDiv.innerHTML = html;
    
    if (navigate) {
        switchMainView('brewing');
        switchSubView('shopping-list', 'brewing-main-view');
    }
    
    checkShoppingList(brewId);
}

            window.updateShoppingListItemStatus = async function(brewId, ingredientName, isChecked) {
                if (!userId) return;
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                // Initialiseer de shoppingListState als deze nog niet bestaat
                if (!brew.shoppingListState) {
                    brew.shoppingListState = {};
                }
                // Update de status voor het specifieke ingrediënt
                brew.shoppingListState[ingredientName] = isChecked;

                try {
                    // Sla de bijgewerkte staat op in Firestore
                    const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, {
                        shoppingListState: brew.shoppingListState
                    });
                    
                    // Roep de bestaande functie aan om te controleren of de "Start Brew Day" knop getoond moet worden
                    checkShoppingList(brewId);

                } catch (error) {
                    console.error("Error updating shopping list state:", error);
                    showToast("Could not save shopping list status.", "error");
                }
            }

            window.addMissingItemsToInventory = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew || !userId) return;

                const addButton = document.getElementById('add-to-inventory-btn');
                addButton.disabled = true;
                addButton.textContent = 'Adding...';

                const requiredIngredients = parseIngredientsFromMarkdown(brew.recipeMarkdown);
                const missingItems = [];

                requiredIngredients.forEach(req => {
                    const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
                    // Voeg enkel toe als het item VOLLEDIG ontbreekt in de inventaris
                    if (!invItem) {
                        missingItems.push({ name: req.name, unit: req.unit });
                    }
                });

                if (missingItems.length === 0) {
                    showToast("All items already exist in your inventory.", "info");
                    addButton.textContent = 'No New Items to Add';
                    return;
                }

                const batch = writeBatch(db);
                const appId = 'meandery-aa05e';
                const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');

                missingItems.forEach(item => {
                    const newItemRef = doc(invCol);
                    // Probeer een categorie af te leiden, anders gebruik 'Adjunct'
                    let category = 'Adjunct';
                    const nameLower = item.name.toLowerCase();
                    if (nameLower.includes('honey')) category = 'Honey';
                    else if (nameLower.includes('yeast')) category = 'Yeast';
                    else if (nameLower.includes('malt')) category = 'Malt Extract';
                    else if (nameLower.includes('fermaid') || nameLower.includes('go-ferm')) category = 'Nutrient';
                    
                    const newItemData = {
                        userId: userId,
                        name: item.name,
                        qty: 0,
                        unit: item.unit.toLowerCase(),
                        price: 0,
                        category: category,
                        expirationDate: null
                    };
                    batch.set(newItemRef, newItemData);
                });

                try {
                    await batch.commit();
                    showToast(`${missingItems.length} missing item(s) added to inventory. You can now update their quantity and price.`, 'success');
                    addButton.textContent = 'Added to Inventory!';
                    generateShoppingList(brewId, false); 
                } catch (error) {
                    console.error("Error adding missing items to inventory:", error);
                    showToast("Could not add items to inventory.", "error");
                    addButton.disabled = false;
                    addButton.textContent = 'Add Missing Items to Inventory (as 0 qty)';
                }
            } 

window.checkShoppingList = function(brewId) {
    const checkboxes = document.querySelectorAll('#shopping-list-items input[type="checkbox"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    const container = document.getElementById('start-brew-day-container');
    if (container) { // Voer de code enkel uit als de container bestaat
        container.classList.toggle('hidden', !allChecked);
    }
}

window.startActualBrewDay = async function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    // --- NIEUWE LOGICA: Zet de datum hier ---
    if (!brew.logData.brewDate) {
        brew.logData.brewDate = new Date().toISOString().split('T')[0];
        try {
            const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
            await updateDoc(brewDocRef, { logData: brew.logData });
            // Forceer een update van de lokale data, zodat de Brew Day 2 lijst direct correct is.
            const brewIndex = brews.findIndex(b => b.id === brewId);
            if (brewIndex > -1) {
                brews[brewIndex].logData.brewDate = brew.logData.brewDate;
            }
            showToast("Brew date set to today!", "info");
        } catch (error) {
            console.error("Could not auto-set brew date:", error);
        }
    }

    window.switchSubView('brew-day-1', 'brewing-main-view');
    currentBrewDay = { brewId: brewId, checklist: {} };
    saveUserSettings();
    renderBrewDay(brewId);
}

            // --- Social Media Functies ---

            window.generateSocialContent = async function(brewId) {
                const socialView = document.getElementById('social-view');
                socialView.dataset.brewId = brewId; // Sla de brewId op voor later gebruik

                switchMainView('tools');
                switchSubView('social', 'tools-main-view');

                runSocialMediaGenerator(); 
            }

            async function runSocialMediaGenerator() {
                const selectedBrewId = document.getElementById('social-recipe-select').value;
                if (!selectedBrewId) {
                    alert("Please select a recipe from the dropdown list first.");
                    return;
                }
                const brew = brews.find(b => b.id === selectedBrewId);
                if (!brew) {
                    alert("Could not find the selected recipe data.");
                    return;
                }
                document.getElementById('social-output-container').classList.remove('hidden');
                const socialContainer = document.getElementById('social-content-container');
                const imageContainer = document.getElementById('social-image-container');
                socialContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">The Alchemist is writing a post for you...</p>';
                imageContainer.innerHTML = '';
                const persona = document.getElementById('social-persona').value;
                const platform = document.getElementById('social-platform').value;
                const tweak = document.getElementById('social-tweak').value;
                const negativeConstraint = " CRUCIAL: Do not wrap your response in a markdown code block using triple backticks (```).";
                let personaPrompt = "You are an homebrewer sharing your passion.";
                if (persona === 'pro_brewery') personaPrompt = "You are a social media expert for a professional craft brewery.";
                else if (persona === 'sommelier') personaPrompt = "You are a knowledgeable mead sommelier, focusing on tasting notes and pairings.";
                let platformPrompt = "Generate a short, engaging Instagram post. Use relevant emojis and hashtags." + negativeConstraint;
                if (platform === 'untappd_checkin') platformPrompt = "Generate a descriptive PERSONAL check-in description for Untappd. Write from a first-person perspective (e.g., 'I get notes of...'). Focus on aroma, appearance, taste, and mouthfeel. Do not use hashtags." + negativeConstraint;
                else if (platform === 'untappd_description') platformPrompt = "Generate an official, commercial description for a new mead to be added to Untappd. The description should be objective, informative, and appealing, detailing the style, key ingredients, and expected flavor profile. This is NOT a personal check-in. Do not use hashtags." + negativeConstraint;
                let tweakPrompt = tweak.trim() !== '' ? `An additional instruction from the user is: "${tweak}". You must follow this instruction.` : "";
                const finalPrompt = `${personaPrompt} ${platformPrompt} ${tweakPrompt} Base the content on the following mead recipe:\n\n---\n${brew.recipeMarkdown}\n---\nFormat the entire response in Markdown.`;
                try {
                    const socialMarkdown = await performApiCall(finalPrompt);
                    let processedMarkdown = socialMarkdown.trim();
                    if (processedMarkdown.startsWith("```markdown")) processedMarkdown = processedMarkdown.substring(10, processedMarkdown.lastIndexOf("```")).trim();
                    else if (processedMarkdown.startsWith("```")) processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
                    const socialHtml = marked.parse(processedMarkdown);
                    
                    // AANGEPAST: Voeg de save knop toe
                    // PLAK DEZE NIEUWE CODE
socialContainer.innerHTML = `
    <div>${socialHtml}</div>
    <div class="mt-6 space-y-2">
        <button id="trigger-image-generation-btn" class="w-full bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">
            Generate Image (Uses Credits)
        </button>
        <button id="save-social-post-btn" onclick="window.saveSocialPost()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
            Save Post to Recipe Notes
        </button>
    </div>
`;

document.getElementById('trigger-image-generation-btn').addEventListener('click', function(e) {
    generateSocialImage(brew.recipeName, processedMarkdown);
    e.target.style.display = 'none'; // Verberg de knop na het klikken
});
                } catch (error) {
                    console.error("Error generating social content:", error);
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Could not generate social post: ${error.message}</p>`;
                }
            }

            async function runManualSocialMediaGenerator() {
                const socialContainer = document.getElementById('social-content-container');
                const imageContainer = document.getElementById('social-image-container');
                const manualInput = document.getElementById('manual-social-input').value;
                if (!manualInput.trim()) {
                    alert("Voer eerst een onderwerp in om een post te genereren.");
                    return;
                }
                document.getElementById('social-output-container').classList.remove('hidden');
                socialContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">De Alchemist schrijft een nieuw bericht voor je...</p>';
                imageContainer.innerHTML = '';
                const persona = document.getElementById('social-persona').value;
                const platform = document.getElementById('social-platform').value;
                const tweak = document.getElementById('social-tweak').value;
                const negativeConstraint = " CRUCIAL: Do not wrap your response in a markdown code block using triple backticks (```).";
                let personaPrompt = "You are an enthusiastic homebrewer sharing your passion.";
                if (persona === 'pro_brewery') personaPrompt = "You are a social media expert for a professional craft brewery.";
                else if (persona === 'sommelier') personaPrompt = "You are a knowledgeable mead sommelier, focusing on tasting notes and pairings.";
                let platformPrompt = "Generate a short, engaging Instagram post. Use relevant emojis and hashtags." + negativeConstraint;
                if (platform === 'untappd_checkin') platformPrompt = "Generate a descriptive PERSONAL check-in description for Untappd. Write from a first-person perspective. Focus on aroma, appearance, taste, and mouthfeel. Do not use hashtags." + negativeConstraint;
                else if (platform === 'untappd_description') platformPrompt = "Generate an official, commercial description for a new mead to be added to Untappd. The description should be objective and informative. This is NOT a personal check-in. Do not use hashtags." + negativeConstraint;
                let tweakPrompt = tweak.trim() !== '' ? `An additional instruction from the user is: "${tweak}". You must follow this instruction.` : "";
                const finalPrompt = `${personaPrompt} ${platformPrompt} ${tweakPrompt} Base the content on the following topic or description provided by the user:\n\n---\n${manualInput}\n---\nFormat the entire response in Markdown.`;
                try {
                    const socialMarkdown = await performApiCall(finalPrompt);
                    let processedMarkdown = socialMarkdown.trim();
                    if (processedMarkdown.startsWith("```markdown")) processedMarkdown = processedMarkdown.substring(10, processedMarkdown.lastIndexOf("```")).trim();
                    else if (processedMarkdown.startsWith("```")) processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
                    const socialHtml = marked.parse(processedMarkdown);

                    // AANGEPAST: Voeg de save knop toe
                    // PLAK DEZE NIEUWE CODE
socialContainer.innerHTML = `
    <div>${socialHtml}</div>
    <div class="mt-6 space-y-2">
        <button id="trigger-image-generation-btn" class="w-full bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">
            Generate Image (Uses Credits)
        </button>
        <button id="save-social-post-btn" onclick="window.saveSocialPost()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
            Save Post to Recipe Notes
        </button>
    </div>
`;

document.getElementById('trigger-image-generation-btn').addEventListener('click', function(e) {
    generateSocialImage(manualInput, processedMarkdown);
    e.target.style.display = 'none'; // Verberg de knop na het klikken
});
                } catch (error) {
                    console.error("Error generating manual social content:", error);
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Kon geen social media post genereren: ${error.message}</p>`;
                }
            }

function populateSocialRecipeDropdown() {
    const select = document.getElementById('social-recipe-select');
    if (!select) return;

    // Bewaar de huidige selectie
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">-- Choose a Recipe --</option>'; // Reset
    
    brews.forEach(brew => {
        const option = document.createElement('option');
        option.value = brew.id;
        option.textContent = brew.recipeName;
        select.appendChild(option);
    });

    // Herstel de selectie indien mogelijk
    select.value = currentValue;
}

            async function generateSocialImage(title, description) {
    const imageContainer = document.getElementById('social-image-container');
    imageContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">The Alchemist is painting a masterpiece...</p>';

    const imageApiKey = userSettings.imageApiKey;
    if (!imageApiKey) {
        imageContainer.innerHTML = `<p class="text-center text-red-500">Please enter your Image Generation API key in the Settings page first.</p>`;
        return;
    }

    const imagePrompt = `You are an AI image generation expert. Create a short, descriptive, powerful prompt for an image generator based on the following mead. The prompt should be in English. The final image should be a high-quality, photorealistic shot of the mead in a bottle or glass, styled for a professional product advertisement.
    
    Mead Title: "${title}"
    Description: "${description}"

    Generate ONLY the image prompt itself, focusing on visual elements.`;

    try {
        const generatedImagePrompt = await performApiCall(imagePrompt);
        
        const engineId = 'stable-diffusion-xl-1024-v1-0';
        const apiHost = 'https://api.stability.ai';
        const apiUrl = `${apiHost}/v1/generation/${engineId}/text-to-image`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${imageApiKey}`
            },
            body: JSON.stringify({
                text_prompts: [
                    {
                        "text": `A photorealistic image of: ${generatedImagePrompt}, cinematic lighting, high detail, commercial photography`
                    }
                ],
                cfg_scale: 7,
                height: 1024,
                width: 1024,
                steps: 30,
                samples: 1,
            }),
        });

        if (!response.ok) {
            throw new Error(`Stability AI request failed with status ${response.status}: ${await response.text()}`);
        }

        const result = await response.json();

        if (result.artifacts && result.artifacts[0] && result.artifacts[0].base64) {
            const imageData = result.artifacts[0].base64;
            const imageSrc = `data:image/png;base64,${imageData}`;

            imageContainer.innerHTML = `
                <img src="${imageSrc}" alt="AI-generated image for ${title}" class="rounded-lg mx-auto shadow-lg">
                <p class="text-xs text-app-secondary/80 mt-2"><strong>Image Prompt:</strong> ${generatedImagePrompt}</p>
                <p class="text-xs text-app-secondary/60 mt-1">Generated with Stable Diffusion</p>
            `;
        } else {
            throw new Error("Invalid image data in Stability AI response.");
        }

    } catch (error) {
        console.error("Error generating social image:", error);
        imageContainer.innerHTML = `<p class="text-center text-red-500">Could not generate image: ${error.message}</p>`;
    }
}

function parseIngredientsFromMarkdown(markdown) {
    const ingredients = [];
    
    // Poging 1: Zoek naar een JSON-blok (de nieuwe, robuuste methode)
    const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
    const jsonMatch = markdown.match(jsonRegex);

    if (jsonMatch && jsonMatch[1]) {
        try {
            const ingredientsArray = JSON.parse(jsonMatch[1]);
            return ingredientsArray.map(item => ({
                name: (item.ingredient || '').trim(),
                quantity: parseFloat(item.quantity) || 0,
                unit: (item.unit || '').trim()
            }));
        } catch (e) {
            console.error("Failed to parse JSON block, falling back to table parser.", e);
        }
    }

    // Poging 2: Fallback naar de oude tabel-parser
    const tableContentRegex = /\|-+\|.*\n([\s\S]*?)(?:\n\n|##|$)/;
    const match = markdown.match(tableContentRegex);

    if (!match || !match[1]) {
        console.warn("Definitive parser could not find ingredient table content.");
        return ingredients; // Geef lege lijst terug als beide methodes falen
    }

    const rows = match[1].trim().split('\n').filter(row => row.trim().startsWith('|'));
    rows.forEach(row => {
        const columns = row.split('|').map(c => c.trim()).slice(1, 4); 
        if (columns.length === 3) {
            const [name, quantityStr, unit] = columns;
            const quantity = parseFloat(quantityStr);
            if (name && !isNaN(quantity)) {
                ingredients.push({ name: name.trim(), quantity: quantity, unit: (unit || '').trim() });
            }
        }
    });
    
    return ingredients;
}

            // getPackagingCosts FUNCTIE
            function getPackagingCosts() {
                const calculatedCosts = {};
    
                PACKAGING_ITEMS.forEach(item => {
                    const itemData = packagingCosts[item.id];
                    let costPerUnit = 0;
                    if (itemData && itemData.qty > 0 && itemData.price > 0) {
                        costPerUnit = itemData.price / itemData.qty;
                    }
        
                    // Specifieke mapping voor de bottel-logica
                    if (item.id === 'bottle_750') calculatedCosts['750'] = costPerUnit;
                    if (item.id === 'bottle_500') calculatedCosts['500'] = costPerUnit;
                    if (item.id === 'bottle_450') calculatedCosts['450'] = costPerUnit; // <-- NIEUW
                    if (item.id === 'bottle_330') calculatedCosts['330'] = costPerUnit;
                    if (item.id === 'bottle_250') calculatedCosts['250'] = costPerUnit;
                    if (item.id === 'cork') calculatedCosts['cork'] = costPerUnit;
                    if (item.id === 'crown_cap_26') calculatedCosts['crown_cap_26'] = costPerUnit; // <-- AANGEPAST
                    if (item.id === 'crown_cap_29') calculatedCosts['crown_cap_29'] = costPerUnit; // <-- NIEUW
                    if (item.id === 'label') calculatedCosts['label'] = costPerUnit;
                });
 
                return calculatedCosts;
            }

            function updateCostAnalysis() {
    const currency = userSettings.currencySymbol || '€';
    // Berekening inventariswaarde blijft hetzelfde
    const totalSpend = inventory.reduce((acc, item) => acc + (item.price || 0), 0);
    document.getElementById('total-spend').textContent = `${currency}${totalSpend.toFixed(2)}`;

    // NIEUW: Bereken de totale kelderwaarde
    const packagingCostsPerUnit = getPackagingCosts();

const totalCellarValue = cellar.reduce((totalValue, cellarItem) => {
    const originalBrew = brews.find(b => b.id === cellarItem.brewId);
    if (!originalBrew) return totalValue; // Sla over als het originele brouwsel niet is gevonden

    const ingredientCostPerLiter = (cellarItem.ingredientCost || 0) / (originalBrew.batchSize || 1);

    const valueOfThisCellarItem = cellarItem.bottles.reduce((itemValue, bottle) => {
        if (bottle.quantity <= 0) return itemValue; // Sla flessen over die niet meer op voorraad zijn

        const meadCostInBottle = ingredientCostPerLiter * (bottle.size / 1000);

        const bottleCost = packagingCostsPerUnit[bottle.size.toString()] || 0;
        let closureCost = 0;
        if (bottle.size >= 750) { closureCost = packagingCostsPerUnit.cork || 0; }
        else if (bottle.size >= 500) { closureCost = packagingCostsPerUnit.crown_cap_29 || 0; }
        else { closureCost = packagingCostsPerUnit.crown_cap_26 || 0; }
        const labelCost = packagingCostsPerUnit.label || 0;

        const singleBottleTotalCost = meadCostInBottle + bottleCost + closureCost + labelCost;

        return itemValue + (singleBottleTotalCost * bottle.quantity);
    }, 0);

    return totalValue + valueOfThisCellarItem;
}, 0);

document.getElementById('total-cellar-value').textContent = `${currency}${totalCellarValue.toFixed(2)}`;
    document.getElementById('total-cellar-value').textContent = `${currency}${totalCellarValue.toFixed(2)}`;

    // De rest van de functie (grafiek) blijft hetzelfde
    const spendByCategory = inventory.reduce((acc, item) => {
        acc[item.category] = (acc[item.category] || 0) + (item.price || 0);
        return acc;
    }, {});
    const ctx = document.getElementById('cost-chart').getContext('2d');
    const chartData = {
        labels: Object.keys(spendByCategory),
        datasets: [{
            label: 'Spend by Category',
            data: Object.values(spendByCategory),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#7BC225'],
        }]
    };
    if (costChart) { costChart.destroy(); }
    costChart = new Chart(ctx, { type: 'doughnut', data: chartData, options: { /* ... */ } });
}

            function renderFermentationGraph(brewId) {
                const brew = brews.find(b => b.id === brewId);
                // Zorg ervoor dat er logdata is met geldige waarden
                if (!brew || !brew.logData || !brew.logData.fermentationLog) return;

                const logData = brew.logData.fermentationLog
                    .filter(entry => entry.date && entry.sg) // Filter op entries die een datum en SG hebben
                    .sort((a, b) => new Date(a.date) - new Date(b.date)); // Sorteer op datum

                if (logData.length < 2) return; // We hebben minstens 2 punten nodig voor een lijn

                const labels = logData.map(entry => new Date(entry.date).toLocaleDateString());
                const sgData = logData.map(entry => parseFloat(entry.sg));

                const canvasId = `fermChart-${brewId}`;
                const ctx = document.getElementById(canvasId);
                if (!ctx) return; // Stop als de canvas niet gevonden kan worden

                // Verwijder een eventuele oude grafiek voordat we een nieuwe tekenen
                if (window.fermChartInstances && window.fermChartInstances[canvasId]) {
                window.fermChartInstances[canvasId].destroy();
                }
                if (!window.fermChartInstances) {
                window.fermChartInstances = {};
           }

                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');

                window.fermChartInstances[canvasId] = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                        label: 'Specific Gravity (SG)',
                        data: sgData,
                        borderColor: brandColor,
                        backgroundColor: brandColor + '33', // Transparante vulling
                        tension: 0.1,
                        fill: true,
                    }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         title: { display: false },
                         legend: { display: false }
                     },
                     scales: {
                         x: {
                             ticks: { color: textColor },
                             grid: { color: borderColor }
                         },
                         y: {
                            title: {
                                display: true,
                                text: 'Specific Gravity',
                                color: textColor
                     },
                     ticks: { 
                         color: textColor,
                         // Formatteer de y-as labels (bv. 1.050)
                         callback: function(value) { return value.toFixed(3); }
                     },
                     grid: { color: borderColor }
                 }
             }
         }
     });
 }

            // --- Troubleshooter Functions ---
            async function getTroubleshootingAdvice() {
                const description = document.getElementById('troubleshoot-description').value;
                const outputDiv = document.getElementById('troubleshoot-output');

                if (!description.trim()) {
                    outputDiv.innerHTML = `<p class="text-red-500">Please describe your problem first.</p>`;
                    return;
                }

                outputDiv.innerHTML = '<div class="loader"></div>';
                
                const prompt = `You are an expert mead maker and troubleshooter. A user is having a problem with their mead. Their description of the problem is: "${description}". Provide a step-by-step guide to help them diagnose the issue. Ask clarifying questions they should answer for themselves, suggest potential causes, and offer clear, actionable solutions. Format the response in Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    outputDiv.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting troubleshooting advice:", error);
                    outputDiv.innerHTML = `<p class="text-center text-red-500">Could not get advice: ${error.message}</p>`;
                }
            }

            // --- Label Generator Functies ---
            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoPreview = document.getElementById('label-logo-preview');
                        logoPreview.src = e.target.result;
                        logoPreview.classList.remove('hidden');
                        
                        // Maak de 'verwijder' knop zichtbaar
                        document.getElementById('removeLogoBtn').classList.remove('hidden');

                        updateLabelPreview();
                    }
                    reader.readAsDataURL(file);
                }
            }

            function removeLogo() {
                const logoPreview = document.getElementById('label-logo-preview');
                const logoUploadInput = document.getElementById('logoUpload');
                const removeBtn = document.getElementById('removeLogoBtn');

                // Verberg de preview en reset de bron
                logoPreview.src = '';
                logoPreview.classList.add('hidden');

                // Reset de waarde van het file input veld
                logoUploadInput.value = '';

                // Verberg de 'verwijder' knop weer
                removeBtn.classList.add('hidden');
                
                updateLabelPreview();
            }  

            function updateLabelPreview() {
                const select = document.getElementById('labelRecipeSelect');
                const selectedBrew = brews.find(b => b.id === select.value);
                const fullTitle = (select.options[select.selectedIndex] && select.value) ? select.options[select.selectedIndex].text : 'Mead Name';

                let namePart = fullTitle;
                if (fullTitle.includes(':')) { namePart = fullTitle.split(':')[0]; } 
                else if (fullTitle.includes(' - ')) { namePart = fullTitle.split(' - ')[0]; }
                
                document.getElementById('label-name-preview').textContent = namePart;
                document.getElementById('label-style-preview').textContent = document.getElementById('labelStyle').value || 'Style / Subtitle';
                
                const date = document.getElementById('labelDate').value || 'Bottling Date';
                const abv = document.getElementById('labelAbv').value || 'ABV';
                const volValue = parseFloat(document.getElementById('labelVol').value);
                const vol = !isNaN(volValue) ? (volValue >= 1000 ? `${(volValue / 1000).toFixed(1)} L` : `${volValue} ml`) : 'VOL';

                document.getElementById('label-date-preview').textContent = date;
                document.getElementById('label-abv-preview').textContent = abv;
                document.getElementById('label-vol-preview').textContent = vol;

                const allergensContainer = document.getElementById('label-allergens-container');
                const ogContainer = document.getElementById('label-og-preview');
                const fgContainer = document.getElementById('label-fg-preview');
                const yeastContainer = document.getElementById('label-yeast-preview');

                if (selectedBrew) {
                    ogContainer.textContent = selectedBrew.logData?.targetOG || 'N/A';
                    fgContainer.textContent = selectedBrew.logData?.actualFG || selectedBrew.logData?.targetFG || 'N/A';
                    const ingredients = parseIngredientsFromMarkdown(selectedBrew.recipeMarkdown);
                    yeastContainer.textContent = ingredients.find(i => i.name.toLowerCase().includes('yeast'))?.name.replace('Yeast','').trim() || 'N/A';

                    const allergens = [];
                    const markdown = selectedBrew.recipeMarkdown.toLowerCase();
                    if (markdown.includes('metabisulfite')) allergens.push('sulfites');
                    if (markdown.includes('lactose')) allergens.push('lactose');
                    if (markdown.includes('barley') || markdown.includes('malt')) allergens.push('gluten');

                    if (allergens.length > 0) {
                        allergensContainer.innerHTML = `Contains: <strong>${allergens.join(', ')}</strong>`;
                        allergensContainer.classList.remove('hidden');
                    } else {
                        allergensContainer.classList.add('hidden');
                    }
                } else {
                    if (allergensContainer) allergensContainer.classList.add('hidden');
                }
            }

            function switchLabelStyle(styleName) {
                const labelPreview = document.getElementById('label-preview');
                
                // Wissel de stijl-class op de preview zelf
                labelPreview.classList.remove('label-minimalist', 'label-industrial', 'label-professional');
                labelPreview.classList.add(`label-${styleName}`);

                // Werk de actieve status van de knoppen bij
                document.querySelectorAll('.label-style-btn').forEach(btn => {
                    const isSelected = btn.dataset.style === styleName;
                    
                    // Verwijder eerst alle mogelijke status-classes
                    btn.classList.remove('border-2', 'border-app-brand', 'text-app-brand', 'border', 'border-app');
                    
                    if (isSelected) {
                        // Voeg de 'actieve' classes toe aan de geselecteerde knop
                        btn.classList.add('border-2', 'border-app-brand', 'text-app-brand');
                    } else {
                        // Voeg de standaard 'inactieve' classes toe aan de andere knoppen
                        btn.classList.add('border', 'border-app');
                    }
                });
            }

            function setLabelOrientation(orientation) {
                // Update de actieve status van de knoppen
                document.querySelectorAll('.orientation-btn').forEach(btn => {
                    const isSelected = btn.dataset.orientation === orientation;
                    btn.classList.toggle('active', isSelected);
                    btn.classList.toggle('border-2', isSelected);
                    btn.classList.toggle('border-app-brand', isSelected);
                    btn.classList.toggle('text-app-brand', isSelected);
                    btn.classList.toggle('border', !isSelected);
                    btn.classList.toggle('border-app', !isSelected);
                });
                // Roep de functie aan die de preview bijwerkt
                updatePreviewAspectRatio();
            }

            function updatePreviewAspectRatio() {
                const previewDiv = document.getElementById('label-preview');
                const formatSelector = document.getElementById('labelFormatSelect');
                if (!previewDiv || !formatSelector) return;

                // Bepaal de actieve oriëntatie
                const orientation = document.querySelector('.orientation-btn.active')?.dataset.orientation || 'vertical';

                let format;
                if (formatSelector.value === 'custom') {
                    format = {
                        width_mm: parseFloat(document.getElementById('customWidth').value) || 1,
                        height_mm: parseFloat(document.getElementById('customHeight').value) || 1,
                    };
                } else {
                    format = labelFormats[formatSelector.value];
                }

                if (format && format.width_mm && format.height_mm) {
                    if (orientation === 'horizontal') {
                        // Gebruik de normale verhouding voor een liggende (horizontale) weergave
                        previewDiv.style.aspectRatio = `${format.width_mm} / ${format.height_mm}`;
                    } else {
                        // Wissel de breedte en hoogte voor een staande (verticale) weergave
                        previewDiv.style.aspectRatio = `${format.height_mm} / ${format.width_mm}`;
                    }
                }
            }

            function generatePrintPage() {
                const labelHTML = document.getElementById('label-preview').outerHTML;
                const formatSelector = document.getElementById('labelFormatSelect');
                let format;

                if (formatSelector.value === 'custom') {
                    format = {
                        width_mm: parseFloat(document.getElementById('customWidth').value),
                        height_mm: parseFloat(document.getElementById('customHeight').value),
                        cols: parseInt(document.getElementById('customCols').value),
                        rows: parseInt(document.getElementById('customRows').value),
                        top_margin_mm: parseFloat(document.getElementById('customMarginTop').value),
                        left_margin_mm: parseFloat(document.getElementById('customMarginLeft').value),
                    }
                } else {
                    format = labelFormats[formatSelector.value];
                }

                const totalLabels = format.cols * format.rows;
                let printContent = '';
                for (let i = 0; i < totalLabels; i++) {
                    printContent += labelHTML.replace('id="label-preview"', `class="print-label ${labelPreview.className}"`);
                }

                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>Print Labels - ${format.name || 'Custom'}</title>
                            <style>
                                @page { size: A4; margin: 0; }
                                body { margin: 0; }
                                .print-container {
                                    display: grid;
                                    grid-template-columns: repeat(${format.cols}, 1fr);
                                    gap: 0;
                                    padding-top: ${format.top_margin_mm}mm;
                                    padding-left: ${format.left_margin_mm}mm;
                                    width: 210mm;
                                    height: 297mm;
                                    box-sizing: border-box;
                                }
                                .print-label {
                                    width: ${format.width_mm}mm;
                                    height: ${format.height_mm}mm;
                                    box-sizing: border-box;
                                    overflow: hidden;
                                }
                                ${document.querySelector('style').innerHTML}
                            </style>
                        </head>
                        <body>
                            <div class="print-container">${printContent}</div>
                        </body>
                    </html>
                `);
                newWindow.document.close();
                newWindow.focus();
                setTimeout(() => { newWindow.print(); }, 500);
            }


function populateLabelRecipeDropdown() {
    const select = document.getElementById('labelRecipeSelect');
    if (!select) return;
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Choose a Saved Recipe --</option>';
    brews.forEach(brew => {
        const option = document.createElement('option');
        option.value = brew.id;

        // Splits de titel en gebruik alleen het deel vóór de dubbele punt of het streepje.
        let displayName = brew.recipeName || 'Untitled Brew';
        if (displayName.includes(':')) {
            displayName = displayName.split(':')[0].trim();
        } else if (displayName.includes(' - ')) {
            displayName = displayName.split(' - ')[0].trim();
        }
        option.textContent = displayName;
        
        select.appendChild(option);
    });
    select.value = currentValue;
}

            // --- VERVANG JE VOLLEDIGE handleLabelRecipeSelect FUNCTIE MET DEZE ---
function handleLabelRecipeSelect(event) {
    const brewId = event.target.value;
    const styleInput = document.getElementById('labelStyle');
    const abvInput = document.getElementById('labelAbv');
    const volInput = document.getElementById('labelVol');
    const dateInput = document.getElementById('labelDate');
    
    if (!brewId) {
        // Maak velden leeg als de gebruiker "-- Choose --" selecteert
        if(styleInput) styleInput.value = '';
        if(abvInput) abvInput.value = '';
        if(volInput) volInput.value = '';
        if(dateInput) dateInput.value = '';
        updateLabelPreview();
        return;
    }

    const selectedBrew = brews.find(b => b.id === brewId);
    if (!selectedBrew) return;

    // Haal de volledige titel uit de originele data, niet uit de dropdown.
    const fullTitle = selectedBrew.recipeName;
    let subtitlePart = '';

    if (fullTitle.includes(':')) {
        const parts = fullTitle.split(/:\s*(.*)/s);
        subtitlePart = parts[1] || '';
    } else if (fullTitle.includes(' - ')) {
        const parts = fullTitle.split(/\s*-\s*(.*)/s);
        subtitlePart = parts[1] || '';
    }

    // Vul de input-velden in
    if(styleInput) styleInput.value = subtitlePart;
    if(abvInput) abvInput.value = selectedBrew.logData?.finalABV?.replace('%','') || selectedBrew.logData?.targetABV?.replace('%','') || '';
    if(volInput) volInput.value = selectedBrew.batchSize ? selectedBrew.batchSize * 1000 : '750';
    if(dateInput) dateInput.value = selectedBrew.createdAt ? selectedBrew.createdAt.toDate().toLocaleDateString('en-GB', { month: 'long', year: 'numeric' }) : '';
    
    // Update de visuele preview
    updateLabelPreview();
}

            function updateLabelPreview() {
                // Haal alle elementen op
                const namePreview = document.getElementById('label-name-preview');
                const stylePreview = document.getElementById('label-style-preview');
                const abvPreview = document.getElementById('label-abv-preview');
                const volPreview = document.getElementById('label-vol-preview');
                const datePreview = document.getElementById('label-date-preview');
                const ogPreview = document.getElementById('label-og-preview');
                const fgPreview = document.getElementById('label-fg-preview');
                const allergensContainer = document.getElementById('label-allergens-container');
                const select = document.getElementById('labelRecipeSelect');
                const styleInput = document.getElementById('labelStyle');
                
                // --- Update naam en ondertitel ---
                const selectedOption = select.options[select.selectedIndex];
                const fullTitle = (selectedOption && selectedOption.value) ? selectedOption.text : 'Mead Name';
                let namePart = fullTitle;

                if (fullTitle.includes(':')) {
                    namePart = fullTitle.split(':')[0];
                } else if (fullTitle.includes(' - ')) {
                    namePart = fullTitle.split(' - ')[0];
                }
                
                if(namePreview) namePreview.textContent = namePart;
                if(stylePreview) stylePreview.textContent = styleInput.value || 'Style / Subtitle';
                
                // --- Update overige details ---
                if(abvPreview) abvPreview.textContent = document.getElementById('labelAbv').value || 'ABV';
                if(volPreview) {
                    const volInput = document.getElementById('labelVol');
                    const volValue = parseFloat(volInput.value);
                    if (!isNaN(volValue)) {
                        volPreview.textContent = volValue >= 1000 ? `${(volValue / 1000).toFixed(1)} L` : `${volValue} ml`;
                    } else {
                        volPreview.textContent = 'VOL';
                    }
                }
                if(datePreview) datePreview.textContent = document.getElementById('labelDate').value || 'Bottling Date';

                // --- Update Professional velden en Allergenen ---
                const selectedBrew = brews.find(b => b.id === select.value);
                if (selectedBrew) {
                    if(ogPreview) ogPreview.textContent = selectedBrew.logData?.targetOG || 'N/A';
                    if(fgPreview) fgPreview.textContent = selectedBrew.logData?.actualFG || selectedBrew.logData?.targetFG || 'N/A';
                    
                    // --- Allergenen logica ---
                    const allergens = [];
                    const markdown = selectedBrew.recipeMarkdown.toLowerCase();
                    if (markdown.includes('metabisulfite')) allergens.push('sulfites');
                    if (markdown.includes('lactose') || markdown.includes('milk sugar')) allergens.push('lactose');
                    if (markdown.includes('barley') || markdown.includes('wheat') || markdown.includes('malt')) allergens.push('gluten');

                    if (allergens.length > 0 && allergensContainer) {
                        allergensContainer.innerHTML = `Contains: <strong>${allergens.join(', ')}</strong>`;
                        allergensContainer.classList.remove('hidden');
                    } else if (allergensContainer) {
                        allergensContainer.innerHTML = '';
                        allergensContainer.classList.add('hidden');
                    }
                } else {
                    if(ogPreview) ogPreview.textContent = 'OG';
                    if(fgPreview) fgPreview.textContent = 'FG';
                    if(allergensContainer) allergensContainer.classList.add('hidden');
                }
            }

// Toont het invoerveld en verbergt de titel
window.showTitleEditor = function(brewId) {
    document.getElementById(`title-display-${brewId}`).classList.add('hidden');
    document.getElementById(`title-editor-${brewId}`).classList.remove('hidden');
    document.getElementById(`title-input-${brewId}`).focus();
}

// Verbergt het invoerveld en toont de titel weer
window.hideTitleEditor = function(brewId) {
    document.getElementById(`title-display-${brewId}`).classList.remove('hidden');
    document.getElementById(`title-editor-${brewId}`).classList.add('hidden');
}

// Slaat de nieuwe titel op in Firestore
window.saveNewTitle = async function(brewId) {
    if (!userId) return;
    const newTitle = document.getElementById(`title-input-${brewId}`).value.trim();
    if (!newTitle) {
        showToast("Title cannot be empty.", "error");
        return;
    }

    try {
        const appId = 'meandery-aa05e';
        const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
        await updateDoc(brewDocRef, { recipeName: newTitle });

        // Update de lokale data en UI onmiddellijk voor een snelle respons
        const brew = brews.find(b => b.id === brewId);
        if (brew) brew.recipeName = newTitle;
        
        document.querySelector(`#title-display-${brewId} h2`).textContent = newTitle;
        hideTitleEditor(brewId);
        renderHistoryList(); // Ververs de lijstweergave
        showToast("Recipe title updated!", "success");

    } catch (error) {
        console.error("Error updating title:", error);
        showToast("Could not update title.", "error");
    }
}            
            // --- Start the App ---
            // Wacht tot de volledige HTML-pagina is geladen voordat het script wordt uitgevoerd.
            document.addEventListener('DOMContentLoaded', (event) => {
                initApp();
            });

        })(); // End of IIFE
    </script>
   <div id="bottling-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-app-tertiary p-8 rounded-lg shadow-xl w-full max-w-lg"> <h3 class="text-2xl font-header font-bold mb-6">Bottle Batch</h3>
        <form id="bottling-form">
    <div class="space-y-6">
        <div>
            <label for="bottlingDate" class="block text-sm font-bold mb-2">Bottling Date</label>
            <input type="date" id="bottlingDate" required class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="closureTypeSelect" class="block text-sm font-bold mb-2">Closure Type</label>
            <select id="closureTypeSelect" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
                <option value="auto" selected>Automatic (based on size)</option>
                <option value="cork">Cork</option>
                <option value="crown_cap_26">Crown Cap 26mm</option>
                <option value="crown_cap_29">Crown Cap 29mm</option>
            </select>
        </div>
        <div>
    <label class="block text-sm font-bold mb-2">Number of Bottles (Standard Sizes)</label>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
            <label for="qty750" class="block text-xs text-app-secondary">750ml</label>
            <input type="number" id="qty750" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="qty500" class="block text-xs text-app-secondary">500ml</label>
            <input type="number" id="qty500" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="qty330" class="block text-xs text-app-secondary">330ml</label>
            <input type="number" id="qty330" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="qty250" class="block text-xs text-app-secondary">250ml</label>
            <input type="number" id="qty250" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
    </div>
</div>

        <div class="border-t border-app pt-4 space-y-4">
    <div>
        <label class="block text-sm font-bold mb-2">Add Custom Bottle Sizes</label>
        <div class="grid grid-cols-3 gap-4">
            <div>
                <label for="customSize" class="block text-xs text-app-secondary">Size (ml)</label>
                <input type="number" id="customSize" min="0" step="1" placeholder="650" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
            </div>
            <div>
                <label for="customQty" class="block text-xs text-app-secondary">Quantity</label>
                <input type="number" id="customQty" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
            </div>
            <div>
                <label for="customPrice" class="block text-xs text-app-secondary">Cost/Bottle (€)</label>
                <input type="number" id="customPrice" min="0" step="0.01" placeholder="0.65" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
            </div>
        </div>
        <button type="button" onclick="window.addCustomBottleToList()" class="w-full mt-3 bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-700 btn text-sm">
            + Add This Custom Bottle to List
        </button>
    </div>
    <div id="custom-bottles-list" class="space-y-2"></div>
</div>
    </div>
    <div class="flex justify-end gap-4 mt-8">
        <button type="button" onclick="window.hideBottlingModal()" class="px-6 py-2 rounded-lg bg-gray-600 text-gray-300 hover:bg-gray-500 btn">Cancel</button>
        <button type="submit" class="px-6 py-2 rounded-lg bg-app-action text-white font-bold hover:opacity-90 btn">Add to Cellar</button>
    </div>
</form>
    </div>
</div>
<div id="prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-app-tertiary p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-header font-bold">AI Prompt Details</h3>
            <button id="close-prompt-modal-btn" class="text-2xl font-bold hover:text-red-500">&times;</button>
        </div>
        <pre id="prompt-modal-content" class="whitespace-pre-wrap text-sm bg-app-primary p-4 rounded text-app-primary" style="font-family: monospace;"></pre>
    </div>
</div>
<div id="danger-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-app-tertiary p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-xl font-header font-bold text-red-600 mb-4">Are you absolutely sure?</h3>
        <p class="text-app-secondary mb-4">This action is irreversible. All associated data will be permanently deleted. To confirm, please type "<strong id="danger-confirm-text" class="text-red-500"></strong>" in the box below.</p>
        <input type="text" id="danger-confirm-input" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-red-500 text-app-primary mb-4">
        <div class="flex justify-end gap-4">
            <button id="danger-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500 btn">Cancel</button>
            <button id="danger-confirm-btn" class="px-6 py-2 rounded-lg bg-red-700 text-white font-bold btn opacity-50 cursor-not-allowed" disabled>Confirm Deletion</button>
        </div>
    </div>
</div>
</body>
</html>