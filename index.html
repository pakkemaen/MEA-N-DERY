<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEA(N)DERY - AI Mead Recipe Creator</title>
    
    <meta name="theme-color" content="#a89a87"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
    /* --- 1. VARIABLES & THEME SETUP --- */
    :root {
        --bg-primary: #f4f1ea;       /* Iets warmer wit/grijs (Paper) */
        --bg-secondary: #ffffff;     /* Puur wit voor panelen */
        --bg-tertiary: #f9f9f7;      /* Zeer licht grijs voor inputs/sub-kaarten */
        --text-primary: #2d2a26;     /* Bijna zwart (Charcoal) */
        /* OUD: --text-secondary: #6b655d; */
        /* NIEUW (Meer contrast): */
        --text-secondary: #59544d;
        --border-color: #e0dbd0;     /* Zachte rand */
        
        /* Brand Colors */
        --brand-color: #8F8C79;      /* Jouw Olive/Grey brand kleur */
        --brand-dark: #6e6b5c;       /* Donkere variant voor hover */
        --action-color: #b45309;     /* Amber/Oranje voor acties */
        
        --danger-color: #ef4444;
        --success-color: #22c55e;
        --info-color: #3b82f6;
        
        /* Spacing & Radius */
        --radius-md: 8px;
        --radius-lg: 12px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .dark {
        --bg-primary: #0f0f0f;       /* Diep zwart */
        --bg-secondary: #1a1a1a;     /* Donkergrijs panel */
        --bg-tertiary: #262626;      /* Lichter grijs inputs */
        --text-primary: #e5e5e5;     /* Off-white */
        --text-secondary: #a3a3a3;
        --border-color: #333333;
        
        --brand-color: #a3a08f;      /* Iets lichter voor contrast */
        --brand-dark: #8F8C79;
        --action-color: #d97706;
    }

    body {
        font-family: 'Barlow Semi Condensed', sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s, color 0.3s;
        line-height: 1.6;
    }

    /* Zorg dat placeholders leesbaar zijn in light mode */
    ::placeholder {
        color: #a8a29e; /* Een iets donkerder grijs */
        opacity: 1;
    }

    .dark ::placeholder {
        color: #525252; /* Iets lichter voor dark mode */
    }

    /* --- 2. TYPOGRAPHY (UNIFIED) --- */
    /* Alle koppen krijgen nu de 'Recipe Style' */
    h1, h2, h3, h4, .font-header {
        font-family: 'Barlow Semi Condensed', sans-serif;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-primary);
    }

    h1 { font-size: 2.5rem; line-height: 1.1; }
    h2 { font-size: 1.75rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
    h3 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--brand-color); }

    .text-app-secondary { color: var(--text-secondary) !important; }
    .text-app-brand { color: var(--brand-color) !important; }

    /* --- 3. CARDS & CONTAINERS --- */
    /* Maak alle vlakken consistent */
    .card, .bg-app-secondary {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    /* Specifiek voor dashboard knoppen */
    button.card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--brand-color);
    }

    /* --- 4. FORMS & INPUTS (MODERN) --- */
    input[type="text"], input[type="number"], input[type="date"], 
    input[type="password"], select, textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        font-family: inherit;
        font-size: 1rem;
        transition: all 0.2s;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--brand-color);
        background-color: var(--bg-secondary);
        box-shadow: 0 0 0 3px rgba(143, 140, 121, 0.15); /* Glow effect */
    }

    /* Dark mode fixes voor inputs */
    .dark input, .dark select, .dark textarea {
        background-color: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
    }
    
    /* Fix voor browser autofill (witte achtergrond) */
    .dark input:-webkit-autofill {
        -webkit-box-shadow: 0 0 0 30px var(--bg-tertiary) inset !important;
        -webkit-text-fill-color: var(--text-primary) !important;
    }

    /* --- 5. BUTTON SYSTEM --- */
    
    /* Basis Knop Stijl */
    .btn {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-radius: var(--radius-md);
        padding: 10px 20px;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtiele schaduw voor diepte */
    }
    
    .btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
    .btn:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* 1. PRIMARY ACTION (De belangrijkste knop: Generate, Save, Start) - AMBER/ORANJE */
    .bg-app-action {
        background-color: var(--action-color) !important; /* Amber/Oranje */
        color: #ffffff !important;
    }

    /* 2. SECONDARY / BRAND (Neutrale acties: Navigatie, Info) - OLIVE/GREY */
    .bg-app-brand, .bg-primary-btn {
        background-color: var(--brand-color) !important; /* Olive */
        color: #ffffff !important;
    }

    /* 3. FUNCTIONAL COLORS (Specifieke acties) */
    .bg-green-600, .bg-green-700 { background-color: var(--success-color) !important; color: white !important; }
    .bg-red-600, .bg-red-700     { background-color: var(--danger-color) !important; color: white !important; }
    .bg-blue-600, .bg-blue-700   { background-color: var(--info-color) !important; color: white !important; }
    .bg-purple-600, .bg-purple-700 { background-color: #9333ea !important; color: white !important; } /* AI Actions */

    /* 4. TERTIARY / GHOST (Annuleren, Minder belangrijk) */
    .bg-app-tertiary {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        box-shadow: none;
    }
    .bg-app-tertiary:hover {
        border-color: var(--brand-color);
        background-color: var(--bg-secondary);
    }

    /* --- TEXTAREA FIXES --- */
    textarea {
        /* 1. Meer ademruimte: tekst en placeholder schuiven naar binnen */
        padding: 16px !important; 
        
        /* 2. Verwijder het 'puntje' (resize handle) rechtsonder */
        resize: none !important; 
        
        /* Zorg dat de tekst mooi leest */
        line-height: 1.6 !important;
    }

    /* 5. NAVIGATION BUTTONS (Dashboard tegels) */
    .main-nav-btn {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .main-nav-btn:hover {
        border-color: var(--brand-color);
        /* Zorg voor contrast in dark mode hover */
        background-color: var(--bg-tertiary);
    }

    /* --- 6. TABLES (CLEAN & TRANSPARENT) --- */
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 1rem 0;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    th {
        background-color: var(--text-primary);
        color: var(--bg-primary);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 12px 16px;
        text-align: left;
        letter-spacing: 0.05em;
    }

    td {
        padding: 0; /* Geen padding in de cel zelf, de input vult hem op */
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        height: 3rem; /* Vaste hoogte voor rust */
        position: relative;
    }

    tr:last-child td { border-bottom: none; }
    
    /* Zebra striping */
    tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }
    .dark tr:nth-child(even) { background-color: rgba(255,255,255,0.03); }

    /* --- DE FIX: TRANSPARANTE INPUTS --- */
    table input, table select {
        background-color: transparent !important; /* Geen achtergrondkleur! */
        border: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        
        width: 100%;
        height: 100%;
        padding: 0 12px !important; /* Padding in de input zelf */
        
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.95rem;
    }

    /* Zorg dat datums en nummers niet verspringen */
    table input[type="date"], 
    table input[type="number"] {
        text-align: left;
        cursor: pointer; /* Laat zien dat het klikbaar is */
    }

    /* Centreer de nummers in de middelste kolommen als je dat wilt */
    table td:not(:first-child):not(:last-child) input {
        text-align: center;
    }

    /* Alleen als je erop klikt/typt krijg je een highlight */
    table input:focus {
        background-color: var(--bg-tertiary) !important; /* Lichte highlight */
        outline: 2px solid var(--brand-color);
        outline-offset: -2px; /* Randje binnenin */
    }

    /* 1. De Container (Het kader om alles heen) */
.log-container {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg); /* Mooie ronde hoeken */
    overflow: hidden; /* Zorgt dat de hoeken van de tabel niet uitsteken */
    background-color: var(--bg-secondary); /* Achtergrondkleur */
    margin-bottom: 0.5rem; /* Ruimte onder de tabel */
}

/* 2. De Tabel zelf resetten */
table.fermentation-table {
    border: none !important; /* Geen dubbele randen */
    border-radius: 0 !important;
    margin: 0 !important; /* Geen marges binnen het kader */
}

/* 3. De Header Balk */
.fermentation-table th {
    background-color: var(--text-primary); /* Zwart/Donker */
    color: var(--bg-primary); /* Wit/Licht tekst */
    border: none;
}

/* 4. De Rijen */
.fermentation-table td {
    border-bottom: 1px solid var(--border-color);
    /* Zorg dat de inputs transparant zijn zodat de rij-kleur zichtbaar blijft */
}

/* De allerlaatste rij mag geen lijntje onderaan hebben, anders ziet het er dubbel uit met het kader */
.fermentation-table tr:last-child td {
    border-bottom: none;
}

    /* --- 7. NAVIGATION TABS --- */
    .sub-tab {
        padding: 8px 16px;
        border-radius: 20px; /* Pill shape */
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-secondary); /* Dit is #6b655d in light mode - kan te licht zijn */
    }

    /* FIX: Maak de tekst donkerder bij hover in light mode */
    .sub-tab:hover {
        background-color: var(--bg-tertiary);
        color: var(--brand-dark); /* Gebruik de donkere brand kleur (#6e6b5c) */
    }

    /* FIX: Zorg voor hard contrast bij actieve tab */
    .sub-tab.active {
        background-color: var(--text-primary); /* Donkergrijs in light mode */
        color: #ffffff; /* Geforceerd wit voor leesbaarheid */
        border-color: var(--text-primary);
    }
    
    .dark .sub-tab.active {
        background-color: var(--brand-color);
        color: #000;
        border-color: var(--brand-color);
    }

    /* --- 8. RECIPE CONTENT SPECIFICS (Behouden van vorige stap) --- */
    .recipe-content h2, .recipe-content h3 { color: var(--brand-color); margin-top: 2rem; }
    .recipe-content h2 { border-bottom: 2px solid var(--border-color); }
        padding-bottom: 0.5rem; /* Iets ruimte tussen tekst en de lijn */
        margin-bottom: 1.5rem;  /* CRUCIAAL: Dit duwt het kader (de box) naar beneden */
    .recipe-content p, .recipe-content ul, .recipe-content ol {
        background-color: var(--bg-tertiary);
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }
    .recipe-content ol { list-style: none; counter-reset: recipe-counter; }
    /* --- RECIPE STEPS FIX --- */
    .recipe-content ol li { 
        counter-increment: recipe-counter; 
        position: relative; 
        padding-left: 3rem; /* Iets meer ruimte rechts van het bolletje */
        margin-bottom: 1.5rem; /* Meer ruimte ONDER elke stap */
        min-height: 2.2rem; /* CRUCIAAL: Zorgt dat de regel nooit kleiner is dan de bol */
        line-height: 1.6;
    }

    .recipe-content ol li::before {
        content: counter(recipe-counter);
        position: absolute; 
        left: 0; 
        top: -0.2em; /* Ietsje hoger plaatsen voor optische uitlijning met tekst */
        width: 2rem; 
        height: 2rem;
        background-color: var(--brand-color); 
        color: #fff;
        border-radius: 50%; 
        text-align: center; 
        line-height: 2rem; /* Zorgt dat cijfer verticaal middenin bol staat */
        font-weight: bold;
        font-size: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* --- 9. UTILITIES & MOBILE --- */
    .hidden { display: none !important; }
    
    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--brand-color); }
    
    .loader {
        border: 3px solid var(--bg-tertiary);
        border-top: 3px solid var(--brand-color);
        border-radius: 50%;
        width: 30px; height: 30px;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width: 768px) {
        h1 { font-size: 2rem; }
        .card { padding: 1rem !important; } /* Minder padding op mobiel */
        input, select, textarea { font-size: 16px !important; } /* Zoom fix */
        th, td { padding: 8px 10px; font-size: 0.85rem; } /* Compactere tabellen */
        
        /* Sticky headers voor lange lijsten */
        .inventory-panel th, .fermentation-table th {
            position: sticky; top: 0; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    }
    
    /* Label Preview Styles (Behouden) */
    #label-preview { transition: all 0.3s; }
    .label-minimalist { background: #fff; color: #000; border: 1px solid #ccc; font-family: sans-serif; }
    .label-industrial { background: #fff; color: #000; border: 2px solid #000; font-family: monospace; }
    .label-professional { background: #fff; color: #2b2118; border: 4px double #2b2118; font-family: serif; }
    
    /* Timeline Styles (Behouden) */
    .timeline-container { position: relative; display: flex; justify-content: space-between; padding: 1rem 0; }
    /* Standaard connector stijl */
    .timeline-connector { 
        position: absolute; top: 50%; left: 0; right: 0; height: 4px; 
        background: #d1cec4; /* Standaard donkerder voor light mode */
        transform: translateY(-50%); z-index: 1; 
    }
    /* Dark mode override */
    .dark .timeline-connector {
        background-color: var(--border-color);
    }

    .timeline-progress { position: absolute; top: 0; left: 0; height: 100%; background: var(--brand-color); transition: width 0.5s; }
    .timeline-item { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; width: 25%; }
    .timeline-node { width: 20px; height: 20px; background: var(--bg-tertiary); border: 4px solid var(--border-color); border-radius: 50%; }
    .timeline-item.active .timeline-node { background: var(--brand-color); border-color: var(--brand-color); }
    .timeline-label { margin-top: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); }
    .timeline-item.active .timeline-label { color: var(--text-primary); }
    
    /* Progress Bar Styles */
    .progress-bar-bg {
        background-color: var(--border-color); /* Lichtgrijs in light, donkergrijs in dark */
        overflow: hidden; /* Zorgt dat de vulling niet buiten de ronding komt */
    }
    
    .progress-bar-fg {
        background-color: var(--brand-color);
        transition: width 0.5s ease-in-out;
    }

    /* Toggle Switch */
    .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--brand-color); }
    input:checked + .slider:before { transform: translateX(24px); }

</style>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</head>
<body class="bg-app-primary text-app-primary">

    <div id="login-view" class="fixed inset-0 bg-app-primary flex items-center justify-center z-50">
        <div class="text-center p-8 max-w-md mx-auto">
            <h1 class="text-6xl font-header text-app-header">MEA<span class="text-app-brand">(N)</span>DERY</h1>
            <p class="text-app-secondary mt-2 mb-8">Brewbuddy</p>
            <div class="card p-8 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">Welcome</h2>
                <p class="text-app-secondary mb-6">Please sign in to access your brewing data.</p>
                <button id="google-login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 btn flex items-center justify-center">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-4 no-print">
            <h1 class="text-5xl font-header text-app-header">MEA<span class="text-app-brand">(N)</span>DERY</h1>
            <p class="text-app-secondary mt-2">Brewbuddy</p>
        </header>

        <!-- Main Content Area -->
        <div id="dashboard-main-view">
    <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div onclick="switchMainView('brewing'); switchSubView('brew-day-1', 'brewing-main-view')" 
                 class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-md hover:scale-105 transition-all duration-200 group">
                <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-brand">Fermenting</p>
                <p id="stat-active-batches" class="text-2xl font-header font-bold text-app-primary">--</p>
            </div>

            <div onclick="switchMainView('management'); switchSubView('cellar', 'management-main-view')" 
                 class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-md hover:scale-105 transition-all duration-200 group">
                <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-brand">In Cellar</p>
                <p id="stat-bottles" class="text-2xl font-header font-bold text-app-primary">--</p>
            </div>

            <div onclick="switchMainView('management'); switchSubView('financials', 'management-main-view')" 
                 class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-md hover:scale-105 transition-all duration-200 group">
                <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-brand">Spent</p>
                <p id="stat-spent" class="text-xl font-header font-bold text-app-primary">--</p>
            </div>
        </div>

        <div id="current-brew-card" class="card p-6 rounded-lg mb-6 hidden border-2 border-app-brand/20 bg-app-tertiary">
            </div>

        <div id="next-action-widget" class="card p-5 rounded-lg mb-6 hidden border border-app-brand/30 bg-app-secondary shadow-sm">
            <h3 class="text-lg font-header font-bold mb-3 text-app-brand flex items-center gap-2 uppercase tracking-wider">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                What's next?
            </h3>
            <ul id="next-action-list" class="list-disc pl-5 space-y-2 text-app-primary text-sm leading-relaxed"></ul>
        </div>

        <div id="low-stock-card" class="card p-4 rounded-lg mb-6 hidden bg-red-50 dark:bg-red-900/10 border border-red-200">
             <h3 class="text-md font-bold mb-2 text-red-600 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                Low Stock Alerts
             </h3>
             <ul id="low-stock-list" class="list-disc pl-5 text-sm text-app-secondary"></ul>
        </div>

        <h3 class="text-sm font-bold text-app-secondary uppercase mb-3 ml-1">Quick Access</h3>
        <div class="grid grid-cols-4 gap-3 mb-4">
            <button data-view="brewing" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1 bg-app-primary hover:bg-white">
                <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <span class="text-xs font-bold">Brew</span>
            </button>
            <button data-view="management" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1 bg-app-primary hover:bg-white">
                <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="text-xs font-bold">Manage</span>
            </button>
            <button data-view="tools" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1 bg-app-primary hover:bg-white">
                <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-xs font-bold">Tools</span>
            </button>
            <button data-view="settings" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1 bg-app-primary hover:bg-white">
                <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                <span class="text-xs font-bold">Settings</span>
            </button>
        </div>

    </div>
</div>

        <div id="brewing-main-view" class="hidden">
    <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
    <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
        <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap">
            <button id="creator-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Creator</button>
            <button id="shopping-list-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Shopping List</button>
            <button id="brew-day-1-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day 1</button>
            <button id="brew-day-2-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day 2</button>
            <button id="history-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">History</button>
        </nav>
    </div>
            <div id="creator-view">
                <div class="flex flex-col lg:flex-row gap-8 mt-4">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg control-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Craft Your Mead</h2>
                        
                        <div class="mb-6">
                            <label for="customDescription" class="block text-sm font-bold mb-2">Describe Your Dream Mead</label>
                            <textarea id="customDescription" rows="4" placeholder="Be descriptive! e.g., 'A dry, sparkling mead with lavender and lemon, around 8% ABV, perfect for summer.'" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary"></textarea>
                            <p id="description-priority-warning" class="hidden text-xs text-center text-amber-600 dark:text-amber-400 mt-2">U gebruikt de vrije beschrijving. De onderstaande opties worden genegeerd.</p>
                            <p class="text-xs text-center text-app-secondary/80 mt-2">Or, use the options below for a more structured recipe.</p>
                        </div>

                        <div id="structured-options-container" class="space-y-6 pt-6 border-t border-app">
                            <div>
                                <label for="batchSize" class="block text-sm font-bold mb-2">Batch Size (Liters)</label>
                                <input type="number" id="batchSize" placeholder="5" min="1" max="100" step="0.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="equipmentProfileSelect" class="block text-sm font-bold mb-2">Equipment Profile</label>
                                <select id="equipmentProfileSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="">None (Use default values)</option>
                                    </select>
                            </div>
                            <div>
                                <label for="abv" class="block text-sm font-bold mb-2">Target ABV (%)</label>
                                <input type="number" id="abv" placeholder="12" min="5" max="18" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="sweetness" class="block text-sm font-bold mb-2">Final Sweetness</label>
                                <select id="sweetness" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="" disabled selected>-- Select a Sweetness --</option>
                                    <option value="dry">Dry (FG ~1.000)</option>
                                    <option value="semi-sweet">Semi-Sweet (FG ~1.015)</option>
                                    <option value="sweet">Sweet (FG ~1.030)</option>
                                </select>
                            </div> 

                            <div>
                                <label for="style" class="block text-sm font-bold mb-2">Base Style</label>
                                <select id="style" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                   <option value="" disabled selected>-- Select a Style --</option>
                                   <optgroup label="Mead Styles">
                                       <option value="Traditional">Traditional Mead (Honey Only)</option>
                                       <option value="Melomel">Melomel (Fruit Mead)</option>
                                       <option value="Metheglin">Metheglin (Spice Mead)</option>
                                       <option value="Bochet">Bochet (Caramelized Honey)</option>
                                       <option value="Cyser">Cyser (Apple Mead)</option>
                                       <option value="Pyment">Pyment (Grape Mead)</option>
                                       <option value="Braggot">Braggot (Mead/Beer Hybrid)</option>
                                       <option value="Hydromel">Hydromel (Session Mead, <10% ABV)</option>
                                       <option value="Sack Mead">Sack Mead (Dessert Mead, >14% ABV)</option>
                                       <option value="Capsicumel">Capsicumel (Chili Pepper Mead)</option>
                                       <option value="Rhodomel">Rhodomel (Rose Mead)</option>
                                       <option value="Acerglyn">Acerglyn (Maple Mead)</option>
                                    </optgroup>
                                    <optgroup label="Alternative & Hybrid Styles">
                                       <option value="Bochetomel">Bochetomel (Caramelized Fruit Mead)</option>
                                       <option value="Viking's Blood">Viking's Blood (Cherry Melomel)</option>
                                       <option value="Black Mead">Black Mead (Blackcurrant Melomel)</option>
                                       <option value="Morat">Morat (Mulberry Mead)</option>
                                       <option value="Tej">Tej (Ethiopian Honey Wine)</option>
                                       <option value="Great Mead">Great Mead (Long-Aging Potential)</option>
                                       <option value="Short Mead">Short Mead (Quick Fermentation)</option>
                                       <option value="Sparkling Mead">Sparkling Mead</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div>
                                <label for="honeyVariety" class="block text-sm font-bold mb-2">Honey Variety</label>
                                <select id="honeyVariety" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="" disabled selected>-- Select a Honey --</option>
                                    <optgroup label="Floral & Light">
                                        <option value="Acacia">Acacia Honey</option>
                                        <option value="Linden">Linden Honey</option>
                                        <option value="Clover">Clover Honey</option>
                                        <option value="Rapeseed">Rapeseed Honey</option>
                                        <option value="Orange Blossom">Orange Blossom Honey</option>
                                        <option value="Wildflower">Wildflower Honey (Default)</option>
                                    </optgroup>
                                    <optgroup label="Fruity & Complex">
                                        <option value="Heather">Heather Honey</option>
                                        <option value="Himalayan Balsam">Himalayan Balsam Honey</option>
                                        <option value="Sunflower">Sunflower Honey</option>
                                    </optgroup>
                                    <optgroup label="Rich, Spicy & Dark">
                                        <option value="Chestnut">Chestnut Honey</option>
                                        <option value="Buckwheat">Buckwheat Honey</option>
                                        <option value="Forest/Honeydew">Forest/Honeydew Honey</option>
                                        <option value="Pine/Fir">Pine/Fir Honey</option>
                                    </optgroup>
                                    <optgroup label="Exotic & Special">
                                        <option value="Thyme">Thyme Honey</option>
                                        <option value="Lavender">Lavender Honey</option>
                                        <option value="Eucalyptus">Eucalyptus Honey</option>
                                    </optgroup>
                                    <option value="other">Other...</option>
                                </select>
                                <input type="text" id="honeyVarietyOther" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary mt-2 hidden" placeholder="Specify other honey">
                            </div>

                            <div id="fruit-section" class="hidden space-y-2">
                                <label class="block text-sm font-bold">Choose Fruits (for Melomel)</label>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_apples" class="mr-2"><label for="fruit_apples">Apples</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_apricots" class="mr-2"><label for="fruit_apricots">Apricots</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blackberries" class="mr-2"><label for="fruit_blackberries">Blackberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blackcurrants" class="mr-2"><label for="fruit_blackcurrants">Blackcurrants</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blueberries" class="mr-2"><label for="fruit_blueberries">Blueberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_cherries" class="mr-2"><label for="fruit_cherries">Cherries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_gooseberries" class="mr-2"><label for="fruit_gooseberries">Gooseberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_peaches" class="mr-2"><label for="fruit_peaches">Peaches</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_pears" class="mr-2"><label for="fruit_pears">Pears</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_plums" class="mr-2"><label for="fruit_plums">Plums</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_raspberries" class="mr-2"><label for="fruit_raspberries">Raspberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_redcurrants" class="mr-2"><label for="fruit_redcurrants">Redcurrants</label></div>
                                </div>

                                <div class="pt-2">
                                    <label for="fruitOther" class="block text-xs font-bold text-app-secondary">Other Fruits (comma-separated)</label>
                                    <input type="text" id="fruitOther" placeholder="e.g., Mango, Passion Fruit" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>

                                <div class="mt-2 pt-2 border-t border-app-brand/30">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="isNoWaterCheckbox" class="h-4 w-4 text-app-brand focus:ring-app-brand rounded border-gray-300">
                                        <label for="isNoWaterCheckbox" class="ml-2 block text-sm font-bold text-app-brand">No-Water Method (Pure Juice)</label>
                                    </div>
                                    <p class="text-xs text-app-secondary ml-6">Requires ~1.8kg fruit per liter. No water added.</p>
                                </div>  
                            </div>

                             <div id="spice-section" class="hidden space-y-2">
                                <label class="block text-sm font-bold">Choose Spices (for Metheglin)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_cinnamon" class="mr-2"><label for="spice_cinnamon">Cinnamon</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_cloves" class="mr-2"><label for="spice_cloves">Cloves</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_coriander" class="mr-2"><label for="spice_coriander">Coriander</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_nutmeg" class="mr-2"><label for="spice_nutmeg">Nutmeg</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_orange" class="mr-2"><label for="spice_orange">Orange Peel</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_vanilla" class="mr-2"><label for="spice_vanilla">Vanilla</label></div>
                                </div>
                                <div class="pt-2">
                                    <label for="spiceOther" class="block text-xs font-bold text-app-secondary">Other Spices (comma-separated)</label>
                                    <input type="text" id="spiceOther" placeholder="e.g., Star Anise, Grains of Paradise" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            <div id="braggot-section" class="hidden">
                                <label for="braggotStyle" class="block text-sm font-bold mb-2">Braggot Base Style</label>
                                <select id="braggotStyle" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="belgian_blond">Belgian Blond</option>
                                    <option value="dubbel">Belgian Dubbel</option>
                                    <option value="ipa">IPA</option>
                                    <option value="old_ale">Old Ale / Barleywine</option>
                                    <option value="saison">Saison</option>
                                    <option value="scotch_ale">Scotch Ale / Wee Heavy</option>
                                    <option value="stout">Stout</option>
                                </select>
                            </div>
                            <div class="space-y-4 pt-4 border-t border-app">
                                <div class="flex items-center">
                                    <input type="checkbox" id="addOak" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                    <label for="addOak" class="ml-3 block text-sm font-bold">Include Oak Aging?</label>
                                </div>
                                <div>
                                    <label for="specialIngredients" class="block text-sm font-bold mb-2">Special Ingredients (optional)</label>
                                    <input type="text" id="specialIngredients" placeholder="e.g., Rose petals, Lapsang tea..." class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t-2 border-app-brand mt-6">
                            <label class="block text-sm font-bold text-app-brand">Use inventory for:</label>
                            
                            <div id="inventory-options-container" class="grid grid-cols-2 gap-x-4 gap-y-2 pl-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="useInventory_Yeast" data-category="Yeast" class="inventory-toggle h-4 w-4 rounded text-app-brand focus:ring-app-brand">
                                    <label for="useInventory_Yeast" class="ml-2 block text-sm font-medium">Yeast</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="useInventory_Nutrients" data-category="Nutrient" class="inventory-toggle h-4 w-4 rounded text-app-brand focus:ring-app-brand">
                                    <label for="useInventory_Nutrients" class="ml-2 block text-sm font-medium">Nutrients</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="useInventory_Honey" data-category="Honey" class="inventory-toggle h-4 w-4 rounded text-app-brand focus:ring-app-brand">
                                    <label for="useInventory_Honey" class="ml-2 block text-sm font-medium">Honey</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="useInventory_Fruits" data-category="Fruit" class="inventory-toggle h-4 w-4 rounded text-app-brand focus:ring-app-brand">
                                    <label for="useInventory_Fruits" class="ml-2 block text-sm font-medium">Fruit</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="useInventory_Spices" data-category="Spice" class="inventory-toggle h-4 w-4 rounded text-app-brand focus:ring-app-brand">
                                    <label for="useInventory_Spices" class="ml-2 block text-sm font-medium">Spices</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="useInventory_Other" data-category="Other" class="inventory-toggle h-4 w-4 rounded text-app-brand focus:ring-app-brand">
                                    <label for="useInventory_Other" class="ml-2 block text-sm font-medium">Other</label>
                                </div>
                            </div>
                            
                            <div id="budget-section" class="hidden pl-3 space-y-2 pt-2 border-t border-app">
                                <div class="flex items-center">
                                    <input type="checkbox" id="useBudget" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                    <label for="useBudget" class="ml-3 block text-sm font-bold">Genereer binnen budget?</label>
                                </div>
                                <div id="budget-input-container" class="hidden">
                                    <label for="maxBudget" class="block text-sm font-bold mb-1">Max Budget</label>
                                    <input type="number" id="maxBudget" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <button id="generateBtn" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">
                                GENERATE RECIPE
                            </button>
                        </div>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                        <div id="recipe-output" class="prose max-w-none text-app-primary">
                        </div>
                    </main>
                </div>
            </div>

            <div id="brew-day-1-view" class="hidden mt-4">
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
            <div id="brew-day-content">
                <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 1 - Primary Fermentation</h2>
                <p class="text-center text-app-secondary/80">Generate a recipe, click "Start New Batch", and the relevant steps will appear here.</p>
            </div>
        </div>
    </div>

    <div id="brew-day-2-view" class="hidden mt-4">
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
            <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 2 - Secondary / Aging</h2>
            <p class="text-center text-app-secondary/80">This section will show your batches that are in the secondary fermentation or aging phase.</p>
        </div>
    </div>
            <div id="history-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <div id="history-list-container">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew History</h2>                        
                        <div class="mb-4">
                            <input type="text" id="history-search-input" placeholder="Search recipes by name..." class="w-full p-3 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                        </div>                        
                        <div id="history-list" class="space-y-4">
                            </div>
                    </div>
                    <div id="history-detail-container" class="hidden">
                        </div>
                 </div>
            </div>
            <div id="shopping-list-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg ...">
                      <h2 class="text-3xl font-header font-bold mb-6 text-center">Shopping List</h2>
                      <div id="shopping-list-container" class="mb-8">
                         <div id="shopping-list-content" class="p-4 card rounded-lg">
                             <p class="text-app-secondary text-center">Click "Start New Batch" on a saved recipe to generate a shopping list here.</p>
                         </div>
                      </div>
                </div>
            </div>
        </div>

        <div id="management-main-view" class="hidden">
             <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
             <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap">
                    <button id="inventory-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Inventory</button>
                    <button id="equipment-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Equipment</button>
                    <button id="packaging-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Packaging</button>
                    <button id="cellar-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Cellar</button>
                    <button id="financials-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Financials</button>
                </nav>
            </div>
            <div id="inventory-view" class="mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <div id="barcode-scanner-container" class="relative hidden mb-4">
                            <div id="barcode-reader" class="w-full rounded-lg"></div>
                            <button id="close-scanner-btn" class="absolute top-2 right-2 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold btn">&times;</button>
                        </div>
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add to Inventory</h2>
                        <button id="scan-barcode-btn" class="w-full mb-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><path d="M7 12h10"></path></svg>
                            Scan Barcode
                        </button>
                        <p class="text-xs text-center text-app-secondary/80 mb-4">- OR -</p>
                        <form id="inventory-form" class="space-y-4">
                            <div>
                                <label for="itemName" class="block text-sm font-bold mb-2">Ingredient Name</label>
                                <input type="text" id="itemName" placeholder="e.g., Acacia Honey" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="itemQty" class="block text-sm font-bold mb-2">Quantity</label>
                                    <input type="number" id="itemQty" step="0.01" placeholder="e.g., 1.5" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                                <div>
                                    <label for="itemUnit" class="block text-sm font-bold mb-2">Unit</label>
                                    <select id="itemUnit" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                        <option>kg</option><option>g</option><option>L</option><option>ml</option><option>packets</option><option>items</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label for="itemPrice" class="block text-sm font-bold mb-2">Price ()</label>
                                <input type="number" id="itemPrice" step="0.01" placeholder="e.g., 12.50" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="itemCategory" class="block text-sm font-bold mb-2">Category</label>
                                <select id="itemCategory" class="w-full p-2 ...">
                                       <option>Honey</option><option>Yeast</option><option>Nutrient</option><option>Malt Extract</option><option>Fruit</option><option>Spice</option><option>Adjunct</option><option>Chemical</option>                  <option>Water</option>
                                </select>
                            </div>
                            <div>
                                <label for="itemExpirationDate" class="block text-sm font-bold mb-2">Expiration Date (Optional)</label>
                                <input type="date" id="itemExpirationDate" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">Add Ingredient</button>
                        </form>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Current Stock</h2>
                        <div id="inventory-list"></div>
                    </main>
                </div>
            </div>
            <div id="packaging-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
        
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Packaging Stock</h2>
                        <form id="packaging-add-form" class="space-y-4">
                            <div>
                                <label for="packaging-item-select" class="block text-sm font-bold mb-2">Packaging Material</label>
                                <select id="packaging-item-select" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="packaging-item-qty" class="block text-sm font-bold mb-2">Quantity Added</label>
                                    <input type="number" id="packaging-item-qty" step="1" min="0" placeholder="e.g., 24" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                               <div>
                                   <label for="packaging-item-price" class="block text-sm font-bold mb-2">Total Price Paid ()</label>
                                   <input type="number" id="packaging-item-price" step="0.01" min="0" placeholder="e.g., 18.50" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                               </div>
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">
                                Add to Stock
                            </button>
                        </form>
                    </aside>
        
                    <main id="packaging-stock-container" class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel lg:overflow-y-auto lg:max-h-[70vh]">
                       <h2 class="text-3xl font-header font-bold mb-4 text-center">Current Packaging Stock</h2>
                       <div id="packaging-list" class="space-y-2">
                           </div>
                    </main>
                </div>
            </div>             
            <div id="equipment-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Equipment Profile</h2>
                        <form id="equipment-profile-form" class="space-y-4">
                            <div>
                                <label for="equipProfileName" class="block text-sm font-bold mb-2">Profile Name</label>
                                <input type="text" id="equipProfileName" placeholder="e.g., My 30L Fermenter" required class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary focus:ring-2 focus:ring-app-brand">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="equipProfileType" class="block text-sm font-bold mb-2">Equipment Type</label>
                                    <select id="equipProfileType" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                                        <option value="Fermenter">Fermenter</option>
                                        <option value="Kettle">Kettle / Boil Pot</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="equipProfileQuantity" class="block text-sm font-bold mb-2">Aantal</label>
                                    <input type="number" id="equipProfileQuantity" value="1" min="1" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="equipCapacityLiters" class="block text-sm font-bold mb-2">Total Capacity (L)</label>
                                    <input type="number" id="equipCapacityLiters" step="0.1" placeholder="30" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                                </div>
                                <div>
                                    <label for="trubLossLiters" class="block text-sm font-bold mb-2">Trub/Yeast Loss (L)</label>
                                    <input type="number" id="trubLossLiters" step="0.1" placeholder="0.75" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                                </div>
                            </div>
                            <div id="boil-off-rate-container" class="hidden">
                                <label for="boilOffRateLitersPerHour" class="block text-sm font-bold mb-2">Boil-Off Rate (Liters/Hour)</label>
                                <input type="number" id="boilOffRateLitersPerHour" step="0.1" placeholder="2.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">Add Profile</button>
                        </form>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Saved Equipment Profiles</h2>
                        <div id="equipment-profiles-list">
                        </div>
                    </main>
                </div>
            </div>
            <div id="cellar-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">My Cellar</h2>
                    <div id="cellar-list" class="space-y-4">
                    </div>
                </div>
            </div>
            <div id="financials-view" class="hidden mt-4">
    <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
         <h2 class="text-3xl font-header font-bold mb-6 text-center">Financials</h2>
         <div id="cost-analysis-container">
            <h3 class="text-2xl font-header mb-4">Cost Analysis</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-4 rounded-lg text-center">
                    <h4 class="text-lg font-bold text-app-secondary">Total Inventory Value</h4>
                    <p id="total-spend" class="text-3xl font-bold text-app-brand">0.00</p>
                </div>
                <div class="card p-4 rounded-lg text-center">
                    <h4 class="text-lg font-bold text-app-secondary">Total Cellar Value</h4>
                    <p id="total-cellar-value" class="text-3xl font-bold text-app-brand">0.00</p>
                </div>
            </div>
            <div class="card p-4 rounded-lg mt-6">
                <h4 class="text-lg font-bold text-app-secondary text-center mb-4">Spend by Category</h4>
                <canvas id="cost-chart"></canvas>
            </div>
         </div>
    </div>
</div>
        </div>
        <div id="tools-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap">
                    <button id="calculators-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Calculators</button>
                    <button id="labels-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Labels</button>
                    <button id="water-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Water</button>
                    <button id="troubleshoot-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Troubleshoot</button>
                    <button id="social-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Social</button>
                    <button id="library-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Library</button>
                </nav>
            </div>
            
            <div id="calculators-view" class="mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg calculator-panel overflow-y-auto" style="max-height: 80vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">Brewing Calculators</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">ABV Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="og" class="block text-sm font-bold mb-1">Original Gravity (OG)</label><input type="number" id="og" step="0.001" placeholder="e.g., 1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="fg" class="block text-sm font-bold mb-1">Final Gravity (FG)</label><input type="number" id="fg" step="0.001" placeholder="e.g., 1.015" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcAbvBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate ABV</button>
                                <div id="abvResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Hydrometer Correction</h3>
                            <div class="space-y-4">
                                <div><label for="sgReading" class="block text-sm font-bold mb-1">Hydrometer Reading</label><input type="number" id="sgReading" step="0.001" placeholder="e.g., 1.052" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="tempReading" class="block text-sm font-bold mb-1">Liquid Temperature (C)</label><input type="number" id="tempReading" placeholder="e.g., 25" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="calTemp" class="block text-sm font-bold mb-1">Hydrometer Calibration Temp (C)</label><input type="number" id="calTemp" value="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="correctSgBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Correct Gravity</button>
                                <div id="sgResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Backsweetening Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="bs_current_vol" class="block text-sm font-bold mb-1">Current Volume (L)</label><input type="number" id="bs_current_vol" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="bs_current_sg" class="block text-sm font-bold mb-1">Current SG</label><input type="number" id="bs_current_sg" step="0.001" placeholder="0.998" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="bs_target_sg" class="block text-sm font-bold mb-1">Target SG</label><input type="number" id="bs_target_sg" step="0.001" placeholder="1.015" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcBacksweetenBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Honey</button>
                                <div id="backsweetenResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg md:col-span-2 lg:col-span-3">
                             <h3 class="text-xl font-header mb-4">TOSNA Nutrient Calculator</h3>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="tosna_og" class="block text-sm font-bold mb-1">Original Gravity (OG)</label><input type="number" id="tosna_og" step="0.001" placeholder="1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="tosna_vol" class="block text-sm font-bold mb-1">Batch Volume (L)</label><input type="number" id="tosna_vol" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="tosna_yeast" class="block text-sm font-bold mb-1">Yeast Nutrient Need</label><select id="tosna_yeast" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
                             </div>
                             <button id="calcTosnaBtn" class="w-full mt-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Schedule</button>
                             <div id="tosnaResult" class="prose max-w-none text-app-primary mt-4"></div>
                        </div>
                        
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Dilution Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="dil_start_vol" class="block text-sm font-bold mb-1">Starting Volume (L)</label><input type="number" id="dil_start_vol" placeholder="18" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="dil_start_sg" class="block text-sm font-bold mb-1">Starting SG</label><input type="number" id="dil_start_sg" step="0.001" placeholder="1.120" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="dil_target_sg" class="block text-sm font-bold mb-1">Target SG</label><input type="number" id="dil_target_sg" step="0.001" placeholder="1.100" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcDilutionBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Dilution</button>
                                <div id="dilutionResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Priming Sugar Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="carbVol" class="block text-sm font-bold mb-1">Target CO2 Volume</label><input type="number" id="carbVol" step="0.1" placeholder="e.g., 2.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="carbTemp" class="block text-sm font-bold mb-1">Mead Temperature (C)</label><input type="number" id="carbTemp" placeholder="e.g., 20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="carbBatchSize" class="block text-sm font-bold mb-1">Batch Size (L)</label><input type="number" id="carbBatchSize" step="0.1" placeholder="e.g., 19" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcSugarBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Sugar</button>
                                <div id="sugarResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Blending Calculator</h3>
                            <div class="space-y-4">
                                <div><label for="vol1" class="block text-sm font-bold mb-1">Volume 1 (L)</label><input type="number" id="vol1" step="0.1" placeholder="10" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="sg1" class="block text-sm font-bold mb-1">SG 1</label><input type="number" id="sg1" step="0.001" placeholder="1.020" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="vol2" class="block text-sm font-bold mb-1">Volume 2 (L)</label><input type="number" id="vol2" step="0.1" placeholder="5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="sg2" class="block text-sm font-bold mb-1">SG 2</label><input type="number" id="sg2" step="0.001" placeholder="0.998" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <button id="calcBlendBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Blend</button>
                                <div id="blendResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>

                        <div class="p-4 card rounded-lg md:col-span-2 lg:col-span-3">
                            <h3 class="text-xl font-header mb-4">AI Yeast Starter Calculator</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="starterOG" class="block text-sm font-bold mb-1">Starting Gravity of Mead</label><input type="number" id="starterOG" step="0.001" placeholder="1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="yeastDate" class="block text-sm font-bold mb-1">Yeast Production Date</label><input type="date" id="yeastDate" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                <div><label for="yeastType" class="block text-sm font-bold mb-1">Yeast Type</label><select id="yeastType" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"><option>Liquid</option><option>Dry</option></select></div>
                            </div>
                            <button id="getYeastAdviceBtn" class="w-full mt-4 bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">Get AI Starter Advice</button>
                            <div id="yeast-advice-output" class="prose max-w-none text-app-primary mt-4"></div>
                        </div>

                    </div>
                </div>
            </div>
            <div id="labels-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Label Designer</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="labelRecipeSelect" class="block text-sm font-bold mb-1">Select Recipe</label>
                                <select id="labelRecipeSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    <option value="">-- Choose a Saved Recipe --</option>
                                </select>
                            </div>
                            <div>
                                <label for="labelStyle" class="block text-sm font-bold mb-1">Style / Subtitle</label>
                                <input type="text" id="labelStyle" placeholder="e.g., Lavender & Lemon Melomel" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="labelAbv" class="block text-sm font-bold mb-1">ABV (%)</label>
                                    <input type="text" id="labelAbv" placeholder="12.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="labelVol" class="block text-sm font-bold mb-1">Volume (ml)</label>
                                    <input type="text" id="labelVol" placeholder="750" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            <div>
                                <label for="labelDate" class="block text-sm font-bold mb-1">Bottling Date</label>
                                <input type="text" id="labelDate" placeholder="August 2025" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <div>
                                <label for="logoUpload" class="block text-sm font-bold mb-1">Upload Your Logo</label>
                                <input type="file" id="logoUpload" accept="image/*" class="w-full text-sm text-app-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-app-primary file:text-app-brand hover:file:bg-app-tertiary">
                                <button id="removeLogoBtn" class="hidden text-xs text-red-500 hover:underline mt-2">Remove logo</button>
                            </div>
                            <div class="pt-4 border-t border-app space-y-4">
                                <div>
                                    <label for="labelFormatSelect" class="block text-sm font-bold mb-2">Label Format</label>
                                    <select id="labelFormatSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                        <option value="herma_4453">Herma 4453 (99.1 x 139 mm) - 4/pagina</option>
                                        <option value="avery_l7165">Avery L7165 (99.1 x 67.7 mm) - 8/pagina</option>
                                        <option value="herma_10730">Herma 10730 (99.1 x 33.8 mm) - 16/pagina</option>
                                        <option value="custom">Custom Format...</option>
                                    </select>
                                </div>
                                <div id="custom-format-inputs" class="hidden space-y-2 p-3 border rounded-md border-app">
                                     <h4 class="text-sm font-bold text-center">Custom Page Layout</h4>
                                     <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div><label>Label Width (mm)</label><input type="number" id="customWidth" value="99.1" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Label Height (mm)</label><input type="number" id="customHeight" value="67.7" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Columns</label><input type="number" id="customCols" value="2" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Rows</label><input type="number" id="customRows" value="4" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Top Margin (mm)</label><input type="number" id="customMarginTop" value="11.1" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                        <div><label>Left Margin (mm)</label><input type="number" id="customMarginLeft" value="5.45" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                     </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Choose a Style</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button class="label-style-btn p-2 border-2 border-app-brand rounded-lg text-app-brand btn" data-style="minimalist">Minimalist</button>
                                        <button class="label-style-btn p-2 border rounded-lg btn" data-style="industrial">Industrial</button>
                                        <button class="label-style-btn p-2 border rounded-lg btn" data-style="professional">Professional</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Orientation</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="orientation-btn active p-2 border-2 border-app-brand rounded-lg text-app-brand btn" data-orientation="vertical">Vertical</button>
                                        <button class="orientation-btn p-2 border rounded-lg btn" data-orientation="horizontal">Horizontal</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-2 text-center">Live Preview</h2>
                        <p class="text-center text-sm text-app-secondary mb-6">Dit is hoe n etiket eruit zal zien.</p>
                        <div class="max-w-xs mx-auto">
                            <div id="label-preview" class="label-minimalist aspect-[3/4] p-4 flex flex-col">
                                <img id="label-logo-preview" src="" class="hidden h-1/3 w-auto mb-4 mx-auto"/>
                                
                                <div class="flex-grow flex flex-col justify-center text-center">
                                    <h3 id="label-name-preview" class="text-2xl font-bold font-header">Mead Name</h3>
                                    <p id="label-style-preview" class="text-sm">Style / Subtitle</p>
                                </div>
                                
                                <div class="mt-auto">
                                    <div id="label-details-container" class="w-full border-t pt-2 text-xs">
                                        <div class="detail-row flex justify-between">
                                            <span id="label-date-preview">Bottling Date</span>
                                            <span><span id="label-abv-preview">ABV</span>% ABV</span>
                                            <span><span id="label-vol-preview">VOL</span></span>
                                        </div>
                                        <div class="detail-row professional-only hidden">
                                            <span id="label-og-container">OG: <span id="label-og-preview">OG</span></span>
                                            <span id="label-fg-container">FG: <span id="label-fg-preview">FG</span></span>
                                            <span id="label-yeast-container">Yeast: <span id="label-yeast-preview">Yeast</span></span>
                                        </div>
                                    </div>
                                    <div id="label-allergens-container" class="w-full text-xs mt-1 text-center hidden">
                                         </div>
                                </div>
                            </div>
                        <div class="text-center mt-8">
                            <button id="generate-print-btn" class="w-full max-w-xs bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                                Generate Printable Page
                            </button>
                        </div>
                    </main>
                </div>
            </div>
            <div id="water-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8 lg:items-start">
        
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg flex flex-col lg:overflow-y-auto lg:max-h-[80vh]">
                       <h2 class="text-2xl font-header font-bold mb-4 border-b pb-4 border-app">Water Management</h2>
    
                       <div class="mb-4">
                           <label for="waterSource" class="block text-sm font-bold mb-2">Select Water Profile</label>
                           <select id="waterSource" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></select>
                      </div>
                      <div id="waterProfileDisplay" class="mb-4 p-4 card rounded-lg">
                          <h4 class="font-bold font-header text-lg mb-2">Active Mineral Profile (mg/L)</h4>
                          <ul class="space-y-1 text-sm text-app-primary">
                              <li><strong>Ca:</strong> <span id="val-ca">--</span></li>
                              <li><strong>Mg:</strong> <span id="val-mg">--</span></li>
                              <li><strong>Na:</strong> <span id="val-na">--</span></li>
                              <li><strong>SO4:</strong> <span id="val-so4">--</span></li>
                              <li><strong>Cl:</strong> <span id="val-cl">--</span></li>
                              <li><strong>HCO3:</strong> <span id="val-hco3">--</span></li>
                          </ul>
                      </div>
            
                      <hr class="border-app my-4">

                      <div id="ai-water-search-section" class="mb-4">
                          <h3 class="text-xl font-header font-bold mb-4">Find Profile with AI</h3>
                          <div class="flex gap-2">
                              <input type="text" id="ai-water-search-name" placeholder="e.g., Orval, Mont Roucous" class="flex-grow p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                              <button id="ai-water-search-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 btn">Find</button>
                          </div>
                      </div>
            
                      <form id="water-profile-form" class="space-y-2 pt-4 border-t border-app">
                          <input type="hidden" id="water-profile-id">
                          <h4 class="font-bold text-center">Add or Edit a Profile</h4>
                          <div>
                              <label for="water-profile-name">Profile Name</label>
                              <input type="text" id="water-profile-name" required placeholder="e.g., My Tap Water" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary">
                          </div>
                          <div class="grid grid-cols-3 gap-2">
                              <div><label for="manual_ca">Ca</label><input type="number" id="manual_ca" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_mg">Mg</label><input type="number" id="manual_mg" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_na">Na</label><input type="number" id="manual_na" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_so4">SO4</label><input type="number" id="manual_so4" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_cl">Cl</label><input type="number" id="manual_cl" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                              <div><label for="manual_hco3">HCO3</label><input type="number" id="manual_hco3" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                          </div>
                          <button type="submit" class="w-full mt-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Save Custom Profile</button>
                      </form>
            
                      <div class="mt-auto pt-4 flex-grow">
                          <h3 class="text-xl font-header font-bold mt-4 mb-2">My Saved Profiles</h3>
                          <div id="user-water-profiles-list" class="space-y-2"></div>
                      </div>
                  </aside>
        
                  <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg lg:overflow-y-auto lg:max-h-[80vh]">
                      <h2 class="text-3xl font-header font-bold mb-4 text-center">AI Adjustment Recommendations</h2>
                      <div class="space-y-4 mb-6">
                          <div>
                              <label for="meadTargetProfile" class="block text-sm font-bold mb-2">Desired Mead Character</label>
                              <select id="meadTargetProfile" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                  <option value="balanced">Balanced / All-Purpose</option>
                                  <option value="dry_crisp">Dry & Crisp (e.g., Traditional, Saison)</option>
                                  <option value="rich_full">Rich & Full-bodied (e.g., Sweet Melomel, Quad)</option>
                                  <option value="hoppy_braggot">Hoppy Braggot (IPA style)</option>
                              </select>
                          </div>
                          <button id="getWaterAdviceBtn" class="w-full bg-purple-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-800 btn">Get Brewing Advice</button>
                      </div>
                      <div id="water-advice-output" class="prose max-w-none text-app-primary">
                          <p class="text-center text-app-secondary/80">Select a water source and a desired mead character, then ask your buddy for advice.</p>
                      </div>
                  </main>
               </div>
            </div>
            <div id="troubleshoot-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">AI Troubleshooter</h2>
                    <div class="max-w-xl mx-auto">
                        <div class="card p-6 rounded-lg">
                            <label for="troubleshoot-description" class="block text-lg font-bold mb-2">Describe your brewing problem:</label>
                            <textarea id="troubleshoot-description" rows="5" placeholder="e.g., My fermentation seems to have stopped after only 3 days. The airlock isn't bubbling anymore." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
                            <button id="troubleshoot-btn" class="w-full mt-4 bg-purple-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-800 btn">Get Advice</button>
                        </div>
                        <div id="troubleshoot-output" class="mt-6 prose max-w-none text-app-primary"></div>
                    </div>
                 </div>
            </div>
<div id="social-view" class="hidden mt-4">
    <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
        <h2 class="text-3xl font-header font-bold mb-6 text-center">Social Media Assistant</h2>
        
        <!-- Recept Selecteren -->
        <div class="card p-4 rounded-lg mb-6">
            <label for="social-recipe-select" class="block text-sm font-bold mb-2">Select a Recipe from your History</label>
            <select id="social-recipe-select" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                <option value="">-- Choose a Recipe --</option>
                <!-- Recepten worden hier geladen door JS -->
            </select>
        </div>
        <div class="card p-4 rounded-lg mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="social-persona" class="block text-sm font-bold mb-2">AI Persona</label>
                    <select id="social-persona" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        <option value="homebrewer">Enthusiastic Homebrewer</option>
                        <option value="pro_brewery">Professional Brewery</option>
                        <option value="sommelier">Mead Sommelier</option>
                    </select>
                </div>
                <div>
                    <label for="social-platform" class="block text-sm font-bold mb-2">Platform</label>
                    <select id="social-platform" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        <option value="instagram">Instagram Post</option>
                        <option value="untappd_checkin">Untappd Check-in</option>
                        <option value="untappd_description">Untappd Mead Description</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                 <label for="social-tweak" class="block text-sm font-bold mb-2">Tweak / Extra Instruction</label>
                 <textarea id="social-tweak" rows="2" placeholder="e.g., 'Make it funny', 'Focus on the honey used', etc." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
            </div>
        </div>
        <div id="social-from-recipe-container">
            <button id="generate-social-from-recipe-btn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Generate Post from Selected Recipe</button>
        </div>
        <hr class="my-8 border-app">
        <div id="social-from-manual-container">
             <label for="manual-social-input" class="block text-sm font-bold mb-2">Or, generate from your own text:</label>
             <textarea id="manual-social-input" rows="4" placeholder="Type your topic here. e.g., 'Just bottled my cherry mead. It's beautifully clear with a deep red color and smells amazing!'" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
             <button id="generate-manual-social-btn" class="w-full mt-4 bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">Generate Post from Manual Input</button>
        </div>
        <div id="social-output-container" class="mt-8 border-t border-app pt-6 hidden">
            <h3 class="text-2xl font-header font-bold mb-4">Generated Content</h3>
            <div id="social-content-container" class="mb-6"></div>
            <h3 class="text-2xl font-header font-bold mb-4">Generated Image</h3>
            <div id="social-image-container" class="p-4 card rounded-lg text-center"></div>
        </div>
    </div>
</div>
<div id="library-view" class="hidden mt-4">
    <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
        <h2 class="text-3xl font-header font-bold mb-6 text-center">The Mazer's Library</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="space-y-4">
                <h3 class="text-xl font-header font-bold text-app-brand border-b border-app pb-2">Science & Process</h3>
                
                <div class="card p-4 rounded-lg hover:shadow-md transition-shadow">
                    <h4 class="font-bold text-lg">Scott Labs Winemaking Handbook (2025-2026)</h4>
                    <p class="text-sm text-app-secondary mb-3">The absolute bible for yeast nutrition, rehydration, and fermentation protocols. Essential for TOSNA logic.</p>
                    <a href="https://scottlab.com/content/files/documents/handbooks/2025-2026%20scott%20labs%20winemaking%20handbook.pdf" target="_blank" class="text-blue-600 hover:underline font-semibold text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Open PDF
                    </a>
                </div>

                <div class="card p-4 rounded-lg hover:shadow-md transition-shadow">
                    <h4 class="font-bold text-lg">The BOMM Protocol (Bray Denard)</h4>
                    <p class="text-sm text-app-secondary mb-3">Scientific approach to making mead drinkable in one month. Focuses heavily on pH buffering and temperature control.</p>
                    <a href="https://denardbrewing.com/blog/post/Start/" target="_blank" class="text-blue-600 hover:underline font-semibold text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        Visit Website
                    </a>
                </div>

                <div class="card p-4 rounded-lg hover:shadow-md transition-shadow">
                    <h4 class="font-bold text-lg">UC Davis Mead Making Resources</h4>
                    <p class="text-sm text-app-secondary mb-3">Academic papers and troubleshooting guides from the premier Enology university.</p>
                    <a href="https://honey.ucdavis.edu/learn/mead-making" target="_blank" class="text-blue-600 hover:underline font-semibold text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        Visit Website
                    </a>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-xl font-header font-bold text-app-brand border-b border-app pb-2">Styles & Standards</h3>

                <div class="card p-4 rounded-lg hover:shadow-md transition-shadow">
                    <h4 class="font-bold text-lg">BJCP Mead Style Guidelines (2015)</h4>
                    <p class="text-sm text-app-secondary mb-3">The official standard for categorizing mead. Learn the difference between a Melomel, Metheglin, and Open Category.</p>
                    <a href="https://www.bjcp.org/style/2015/m1/" target="_blank" class="text-blue-600 hover:underline font-semibold text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        Read Guidelines
                    </a>
                </div>

                <div class="card p-4 rounded-lg hover:shadow-md transition-shadow">
                    <h4 class="font-bold text-lg">GotMead? Forum</h4>
                    <p class="text-sm text-app-secondary mb-3">The oldest and largest community of mead makers. Excellent for searching specific ingredient combinations.</p>
                    <a href="https://gotmead.com/blog/forum/" target="_blank" class="text-blue-600 hover:underline font-semibold text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path></svg>
                        Visit Forum
                    </a>
                </div>
                
                <div class="card p-4 rounded-lg hover:shadow-md transition-shadow bg-purple-50 dark:bg-purple-900/20 border-l-4 border-purple-500">
                    <h4 class="font-bold text-lg">MEA(N)DERY Best Practices</h4>
                    <p class="text-sm text-app-secondary mb-2">Quick reminders for this app:</p>
                    <ul class="list-disc pl-4 text-xs text-app-secondary space-y-1">
                        <li>Always rehydrate dry yeast with Go-Ferm.</li>
                        <li>Degas daily during the first 1/3 of fermentation.</li>
                        <li>Add nutrients at 24h, 48h, 72h, and 1/3 break.</li>
                        <li>Never boil your honey (unless making a Bochet).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
          <div id="settings-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg settings-panel overflow-y-auto" style="max-height: 80vh;">
                <h2 class="text-3xl font-header font-bold mb-6 text-center">Settings</h2>
                <div class="max-w-xl mx-auto">
                    <div class="mb-6 card p-6 rounded-lg">
    <h3 class="text-xl font-header font-bold mb-4">API Keys</h3>
    
    <div class="mb-4">
        <label for="apiKeyInput" class="block text-lg font-bold mb-2">Google AI API Key (for Text)</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your Google AI API key" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
        <p class="text-sm text-app-secondary mt-2">
            Required for recipe creation, analysis, etc. Get one from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>.
        </p>
    </div>
    
    <div class="pt-4 border-t border-app">
        <label for="imageApiKeyInput" class="block text-lg font-bold mb-2">Image Generation API Key (for Images)</label>
        <input type="password" id="imageApiKeyInput" placeholder="Enter your Stability AI API key" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
        <p class="text-sm text-app-secondary mt-2">
            Optional, for generating images on the Social tab. Get free credits from <a href="https://platform.stability.ai/" target="_blank" class="text-blue-600 hover:underline">Stability AI</a>.
        </p>
    </div>
</div>

                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">Personalization & Defaults</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="defaultBatchSizeInput" class="block text-lg font-bold mb-2">Default Batch Size (Liters)</label>
                                <input type="number" id="defaultBatchSizeInput" placeholder="e.g., 20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                <p class="text-sm text-app-secondary mt-2">Set the default batch size that appears on the Creator tab.</p>
                            </div>
                            <div>
                                <label for="defaultCurrencyInput" class="block text-lg font-bold mb-2">Currency Symbol</label>
                                <input type="text" id="defaultCurrencyInput" placeholder="e.g., $" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                 <p class="text-sm text-app-secondary mt-2">Set the currency symbol used for cost calculations.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">User Interface</h3>
                        <div class="flex items-center justify-between">
                            <label class="text-lg font-bold">Theme</label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch" for="theme-toggle-checkbox">
                                    <input type="checkbox" id="theme-toggle-checkbox" />
                                    <div class="slider round"></div>
                                </label>
                            </div>
                        </div>
                    </div>
              
                    <button id="saveSettingsBtn" class="w-full mt-4 bg-blue-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 btn">Save Settings</button>

                    <div class="mt-10 p-6 rounded-lg border-2 border-red-400">
                        <h3 class="text-xl font-header font-bold mb-4 text-red-600">Data Management</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="exportHistoryBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 btn">Export Brew History</button>
                            <button id="exportInventoryBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 btn">Export Inventory</button>
                            <div>
                                <label for="importHistoryFile" class="w-full text-center block bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 cursor-pointer btn">Import Brew History</label>
                                <input type="file" id="importHistoryFile" class="hidden" accept=".json">
                            </div>
                             <div>
                                <label for="importInventoryFile" class="w-full text-center block bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 cursor-pointer btn">Import Inventory</label>
                                <input type="file" id="importInventoryFile" class="hidden" accept=".json">
                            </div>
                        </div>
                        <div class="space-y-4 mt-8 border-t-2 border-red-400 pt-4">
                            <p class="text-sm text-red-500 text-center">Warning: The following actions cannot be undone.</p>
                            <button id="clearHistoryBtn" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 btn">Delete All Brew History</button>
                            <button id="clearInventoryBtn" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 btn">Delete All Inventory</button>
                        </div>
                    </div>
                    <p class="text-center text-sm text-app-secondary/60 mt-8">MEA(N)DERY - v1.0 - Fort Knox -  2025</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, deleteDoc, getDoc, setDoc, writeBatch, getDocs, arrayUnion,  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IIFE to create a private scope and avoid polluting the global namespace
        (function() {
            // --- App State ---
            let db, auth, userId;
            let lastGeneratedPrompt = '';
            let brews = []; // Local cache of brews
            let inventory = []; // Local cache of inventory
            let equipmentProfiles = []; // Local cache of equipment profiles
            let cellar = [];    // Local cache of bottled batches
            let userSettings = {}; // Holds settings from Firestore
            let currentBrewDay = { brewId: null, checklist: {} }; // Holds the state for the current brew day
            let currentRecipeMarkdown = ''; // To hold the latest generated recipe markdown
            let currentWaterProfile = null; // To hold the fetched water data
            let costChart = null; // To hold the chart instance
            let fermChartInstance = null;
            let html5QrcodeScanner = null;
            let customBottles = []; // Houdt de lijst met custom flessen bij
            let currentPredictedProfile = null;

// Functie om de lijst met custom flessen op het scherm te tekenen
window.renderCustomBottlesList = function() {
    const listDiv = document.getElementById('custom-bottles-list');
    if (!listDiv) return;

    if (customBottles.length === 0) {
        listDiv.innerHTML = '';
        return;
    }

    listDiv.innerHTML = customBottles.map((bottle, index) => `
        <div class="flex justify-between items-center p-2 bg-app-primary rounded-md text-sm">
            <span><strong>${bottle.quantity}x</strong> ${bottle.size}ml (at ${userSettings.currencySymbol || ''}${bottle.price.toFixed(2)} each)</span>
            <button type="button" onclick="window.removeCustomBottleFromList(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
        </div>
    `).join('');
}

// Functie die wordt aangeroepen door de '+ Add' knop
window.addCustomBottleToList = function() {
    const size = parseInt(document.getElementById('customSize').value) || 0;
    const quantity = parseInt(document.getElementById('customQty').value) || 0;
    const price = parseFloat(document.getElementById('customPrice').value) || 0;

    if (size <= 0 || quantity <= 0) {
        showToast("Please enter a valid size and quantity for the custom bottle.", "error");
        return;
    }

    customBottles.push({ size, quantity, price });
    renderCustomBottlesList();

    // Maak de input velden leeg voor de volgende invoer
    document.getElementById('customSize').value = '';
    document.getElementById('customQty').value = '';
    document.getElementById('customPrice').value = '';
    document.getElementById('customSize').focus();
}

// Functie om een fles uit de lijst te verwijderen
window.removeCustomBottleFromList = function(index) {
    customBottles.splice(index, 1);
    renderCustomBottlesList();
}

            let packagingCosts = {}; // Houdt de geladen kosten vast
            const PACKAGING_ITEMS = [
                { id: 'bottle_750', name: '750ml Bottle' },
                { id: 'bottle_500', name: '500ml Bottle' },
                { id: 'bottle_330', name: '330ml Bottle' },
                { id: 'bottle_250', name: '250ml Bottle' },
                { id: 'cork', name: 'Cork' },
                { id: 'crown_cap_26', name: 'Crown Cap 26mm' },
                { id: 'crown_cap_29', name: 'Crown Cap 29mm' },
                { id: 'label', name: 'Label' }
            ]; 
            
            const labelFormats = {
                'herma_4453': { name: 'Herma 4453', width_mm: 99.1, height_mm: 139, cols: 2, rows: 2, top_margin_mm: 10, left_margin_mm: 5.45 },
                'avery_l7165': { name: 'Avery L7165', width_mm: 99.1, height_mm: 67.7, cols: 2, rows: 4, top_margin_mm: 11.1, left_margin_mm: 5.45 },
                'herma_10730': { name: 'Herma 10730', width_mm: 99.1, height_mm: 33.8, cols: 2, rows: 8, top_margin_mm: 10, left_margin_mm: 5.45 },
            };

            let userWaterProfiles = []; // Voor de opgeslagen waterprofielen
            const BUILT_IN_WATER_PROFILES = { // Hernoemd van waterData
                spa: { name: 'Spa Reine', ca: 5, mg: 2, na: 3, so4: 4, cl: 5, hco3: 17 },
                chaudfontaine: { name: 'Chaudfontaine', ca: 65, mg: 18, na: 44, so4: 40, cl: 35, hco3: 305 },
                // ... voeg hier de andere ingebouwde waters toe met een 'name' eigenschap
            };

            // --- Toast Notification Helper ---
            function showToast(message, type = 'info', duration = 4000) {
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = "linear-gradient(to right, #22c55e, #16a34a)";
            break;
        case 'error':
            backgroundColor = "linear-gradient(to right, #ef4444, #dc2626)";
            break;
        default: // 'info' or any other type
            backgroundColor = "linear-gradient(to right, #3b82f6, #2563eb)";
    }
    Toastify({
        text: message.replace(/\n/g, '<br>'), // Vervang newlines met <br> voor leesbaarheid
        duration: duration, // Gebruik de meegegeven duur
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        escapeMarkup: false, // Sta HTML toe (voor de <br>)
        style: { background: backgroundColor, borderRadius: "8px" }
    }).showToast();
}

            // --- UI Elements ---
            let dashboardMainView, creatorView, brewingView, historyView, inventoryView, 
                planningView, financialsView, socialView, troubleshootView, calculatorsView, 
                waterView, settingsView, brewingMainView, managementMainView, toolsMainView,
                styleSelect, fruitSection, spiceSection, braggotSection, generateBtn, 
                recipeOutput, brewDayContent, historyList, historyDetailContainer, 
                historyListContainer, inventoryForm, inventoryList, fetchWaterProfileBtn, 
                getWaterAdviceBtn, getYeastAdviceBtn, waterSourceSelect, manualWaterProfileDiv,
                troubleshootBtn, apiKeyInput, defaultBatchSizeInput, defaultCurrencyInput, 
                saveSettingsBtn, settingsMessage, themeToggle, exportHistoryBtn, 
                exportInventoryBtn, importHistoryFile, importInventoryFile, 
                clearHistoryBtn, clearInventoryBtn, labelsView, logoUploadInput, labelPreview;

            function handleStyleChange() {
    const style = styleSelect.value.toLowerCase(); // Gebruik toLowerCase() voor zekerheid
    const isMelomel = style.includes('melomel');
    const isMetheglin = style.includes('metheglin');
    const isBraggot = style.includes('braggot');

    fruitSection.classList.toggle('hidden', !isMelomel);
    spiceSection.classList.toggle('hidden', !isMetheglin);
    braggotSection.classList.toggle('hidden', !isBraggot);

    // Reset de vinkjes en velden als de sectie verborgen wordt
    if (!isMelomel) {
        document.querySelectorAll('#fruit-section input:checked').forEach(cb => cb.checked = false);
        const fruitOther = document.getElementById('fruitOther');
        if(fruitOther) fruitOther.value = ''; // Maak ook het 'other' veld leeg
    }
    if (!isMetheglin) {
        document.querySelectorAll('#spice-section input:checked').forEach(cb => cb.checked = false);
        const spiceOther = document.getElementById('spiceOther');
        if(spiceOther) spiceOther.value = ''; // Maak ook het 'other' veld leeg
    }
}

            function handleDescriptionInput() {
                const descriptionInput = document.getElementById('customDescription');
                const optionsContainer = document.getElementById('structured-options-container');
                const warningMessage = document.getElementById('description-priority-warning');
                
                const hasText = descriptionInput.value.trim() !== '';

                // Schakel de container visueel uit of in
                optionsContainer.classList.toggle('opacity-50', hasText);
                optionsContainer.classList.toggle('pointer-events-none', hasText);
                
                // Maak de waarschuwing zichtbaar of onzichtbaar
                warningMessage.classList.toggle('hidden', !hasText);

                // Schakel alle invoervelden in de container daadwerkelijk uit of in
                optionsContainer.querySelectorAll('input, select, checkbox').forEach(el => {
                    // Schakel alles uit, BEHALVE het "useInventory" vinkje
                    if (el.id !== 'useInventory') {
                        el.disabled = hasText;
                    }
                });
            }

            function handleInventoryToggle(e) {
                const useInventory = e.target.checked;
                const helperText = document.getElementById('inventory-helper-text');
                
                // Definieer de velden die we willen uitschakelen
                const fieldsToDisable = [
                    'honeyVariety', 
                    ...document.querySelectorAll('#fruit-section input, #spice-section input')
                ];

                fieldsToDisable.forEach(el => {
                    const element = typeof el === 'string' ? document.getElementById(el) : el;
                    if (element) {
                        element.disabled = useInventory;
                        element.closest('div').classList.toggle('opacity-50', useInventory);
                    }
                });
                
                // Toon of verberg de hulptekst
                helperText.classList.toggle('hidden', !useInventory);
            }

            // --- Functies voor de AI Prompt Modal ---
            window.showLastPrompt = function() {
                const modal = document.getElementById('prompt-modal');
                const content = document.getElementById('prompt-modal-content');
                content.textContent = lastGeneratedPrompt;
                modal.classList.remove('hidden');
            }

            function hidePromptModal() {
                document.getElementById('prompt-modal').classList.add('hidden');
            }

            let dangerAction = null; // Holds the function to execute on confirmation

function showDangerModal(action, confirmationText) {
    dangerAction = action;
    document.getElementById('danger-confirm-text').textContent = confirmationText;
    document.getElementById('danger-confirm-input').value = '';
    document.getElementById('danger-modal').classList.remove('hidden');
    checkDangerConfirmation(); // Initial check
}

function hideDangerModal() {
    document.getElementById('danger-modal').classList.add('hidden');
    dangerAction = null;
}

function checkDangerConfirmation() {
    const input = document.getElementById('danger-confirm-input').value;
    const requiredText = document.getElementById('danger-confirm-text').textContent;
    const confirmBtn = document.getElementById('danger-confirm-btn');

    if (input === requiredText) {
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        confirmBtn.disabled = true;
        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function executeDangerAction() {
    if (typeof dangerAction === 'function') {
        dangerAction();
    }
    hideDangerModal();
}

            async function signInWithGoogle() {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
        // De onAuthStateChanged listener zal de rest afhandelen.
    } catch (error) {
        // Log de volledige fout naar de console voor debugging.
        console.error("Google Sign-In failed:", error);

        // Gebruik een simpele alert() als fallback om zeker te weten dat de gebruiker de fout ziet.
        // Dit is handig als de Toastify-bibliotheek niet laadt of een ander probleem heeft.
        alert("Login Mislukt: " + error.message);

        // Probeer de toast-notificatie nog steeds te gebruiken.
        if (typeof showToast === 'function') {
            showToast(`Login failed: ${error.message}`, "error");
        }
    }
}


            function populatePackagingDropdown() {
                const select = document.getElementById('packaging-item-select');
                if (!select) return;

                select.innerHTML = PACKAGING_ITEMS.map(item => 
                   `<option value="${item.id}">${item.name}</option>`
                ).join('');
            }

            window.renderPackagingUI = function() {
                const listContainer = document.getElementById('packaging-list');
                const stockContainer = document.getElementById('packaging-stock-container');
                if (!listContainer || !stockContainer) return;

                // Controleer of er voorraad is
                const hasStock = PACKAGING_ITEMS.some(item => packagingCosts[item.id] && packagingCosts[item.id].qty > 0);

                // Verberg de hele sectie als er geen voorraad is
                stockContainer.classList.toggle('hidden', !hasStock);

                if (hasStock) {
                    // Als er wel voorraad is, bouw dan de lijst op zoals voorheen
                    const currency = userSettings.currencySymbol || '';
                    listContainer.innerHTML = PACKAGING_ITEMS
                        .filter(item => packagingCosts[item.id] && packagingCosts[item.id].qty > 0)
                        .map(item => {
                            const itemData = packagingCosts[item.id]; // We weten nu zeker dat deze data bestaat
                            const costPerUnit = (itemData.qty > 0 && itemData.price > 0) ? (itemData.price / itemData.qty).toFixed(2) : '0.00';

                            return `
                               <div id="pkg-item-${item.id}" class="p-3 card rounded-md">
                                   <div class="flex justify-between items-center">
                                       <div>
                                           <p class="font-bold">${item.name}</p>
                                           <p class="text-sm text-app-secondary/80">Cost per unit: ${currency}${costPerUnit}</p>
                                       </div>
                                       <div class="flex items-center gap-4">
                                           <span class="font-semibold">${itemData.qty} items - ${currency}${itemData.price.toFixed(2)} total</span>
                                           <div class="flex gap-2">
                                               <button onclick="window.editPackagingItem('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                               <button onclick="window.clearPackagingItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           `;
                       }).join('');
               } else {
                  listContainer.innerHTML = '';
               }
           }

async function addPackagingStock(e) {
    e.preventDefault();
    if (!userId) return;

    const itemId = document.getElementById('packaging-item-select').value;
    const qtyAdded = parseFloat(document.getElementById('packaging-item-qty').value) || 0;
    const priceAdded = parseFloat(document.getElementById('packaging-item-price').value) || 0;

    if (!itemId || qtyAdded <= 0) {
        showToast("Please fill in a valid material and quantity.", "error");
        return;
    }

    const currentQty = packagingCosts[itemId]?.qty || 0;
    const currentPrice = packagingCosts[itemId]?.price || 0;

    const newQty = currentQty + qtyAdded;
    const newPrice = currentPrice + priceAdded;
    
    packagingCosts[itemId] = { qty: newQty, price: newPrice };
    
    await savePackagingCosts(); 
    
    document.getElementById('packaging-add-form').reset();
}

async function loadPackagingCosts() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'packaging');
    try {
        const docSnap = await getDoc(settingsDocRef);
        if (docSnap.exists()) {
            packagingCosts = docSnap.data();
        } else {
            // Maak een leeg object als er nog geen data is
            packagingCosts = {};
        }
        renderPackagingUI(); // Bouw de UI op met de geladen data
        populatePackagingDropdown();
    } catch (error) {
        console.error("Error loading packaging costs:", error);
    }
}

            // SavePackagingCosts FUNCTIE
async function savePackagingCosts() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'packaging');
    
    try {
        await setDoc(settingsDocRef, packagingCosts);
        showToast('Packaging stock updated successfully!', 'success');
        await loadPackagingCosts();
    } catch (error) {
        console.error("Error saving packaging costs:", error);
        showToast('Failed to save packaging costs.', 'error');
    }
}

// --- NIEUWE FUNCTIES VOOR WATERPROFIELBEHEER ---

// Laadt de profielen van de gebruiker uit Firestore
async function loadUserWaterProfiles() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const profilesCol = collection(db, 'artifacts', appId, 'users', userId, 'waterProfiles');
    
    onSnapshot(query(profilesCol), (snapshot) => {
        userWaterProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateWaterDropdown();
        renderUserWaterProfilesList();
    });
}

// Vult de dropdown met ingebouwde en eigen profielen
function populateWaterDropdown() {
    const select = document.getElementById('waterSource');
    if (!select) return;
    
    select.innerHTML = `
        <optgroup label="Built-in Profiles">
            ${Object.entries(BUILT_IN_WATER_PROFILES).map(([id, profile]) => `<option value="builtin_${id}">${profile.name}</option>`).join('')}
        </optgroup>
        <optgroup label="My Profiles">
            ${userWaterProfiles.map(profile => `<option value="user_${profile.id}">${profile.name}</option>`).join('')}
        </optgroup>
    `;
}

// Toont de lijst met eigen profielen
function renderUserWaterProfilesList() {
    const listDiv = document.getElementById('user-water-profiles-list');
    if (!listDiv) return;
    if (userWaterProfiles.length === 0) {
        listDiv.innerHTML = `<p class="text-sm text-app-secondary/80 text-center">You have no saved profiles.</p>`;
        return;
    }
    listDiv.innerHTML = userWaterProfiles.map(p => `
        <div class="flex justify-between items-center p-2 card rounded-md text-sm">
            <span>${p.name}</span>
            <div>
                <button onclick="window.editWaterProfile('${p.id}')" class="text-blue-600 hover:text-blue-800">Edit</button>
                <button onclick="window.deleteWaterProfile('${p.id}')" class="text-red-600 hover:text-red-800 ml-2">Delete</button>
            </div>
        </div>
    `).join('');
}

// Slaat een nieuw of bewerkt profiel op
async function saveWaterProfile(e) {
    e.preventDefault();
    if (!userId) return;
    
    const profileId = document.getElementById('water-profile-id').value;
    const profileData = {
        name: document.getElementById('water-profile-name').value,
        ca: parseFloat(document.getElementById('manual_ca').value) || 0,
        mg: parseFloat(document.getElementById('manual_mg').value) || 0,
        na: parseFloat(document.getElementById('manual_na').value) || 0,
        so4: parseFloat(document.getElementById('manual_so4').value) || 0,
        cl: parseFloat(document.getElementById('manual_cl').value) || 0,
        hco3: parseFloat(document.getElementById('manual_hco3').value) || 0,
    };
    if (!profileData.name) {
        showToast("Profile name is required.", "error");
        return;
    }
    
    const appId = 'meandery-aa05e';
    const profilesCol = collection(db, 'artifacts', appId, 'users', userId, 'waterProfiles');
    
    try {
        if (profileId) { // Update
            await setDoc(doc(profilesCol, profileId), profileData);
        } else { // Nieuw
            await addDoc(profilesCol, profileData);
        }
        showToast("Water profile saved!", "success");
        document.getElementById('water-profile-form').reset();
        document.getElementById('water-profile-id').value = '';
    } catch (error) {
        showToast("Error saving profile.", "error");
        console.error(error);
    }
}

// Vult het formulier om een profiel te bewerken
window.editWaterProfile = function(profileId) {
    const profile = userWaterProfiles.find(p => p.id === profileId);
    if (!profile) return;
    document.getElementById('water-profile-id').value = profile.id;
    document.getElementById('water-profile-name').value = profile.name;
    document.getElementById('manual_ca').value = profile.ca;
    document.getElementById('manual_mg').value = profile.mg;
    document.getElementById('manual_na').value = profile.na;
    document.getElementById('manual_so4').value = profile.so4;
    document.getElementById('manual_cl').value = profile.cl;
    document.getElementById('manual_hco3').value = profile.hco3;
    document.getElementById('water-profile-name').focus();
}

// Verwijdert een profiel
window.deleteWaterProfile = async function(profileId) {
    if (!userId || !confirm("Are you sure you want to delete this water profile?")) return;
    try {
        const appId = 'meandery-aa05e';
        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'waterProfiles', profileId));
        showToast("Profile deleted.", "success");
    } catch (error) {
        showToast("Error deleting profile.", "error");
    }
}

// Vind water profielen
async function findWaterProfileWithAI() {
    const searchBtn = document.getElementById('ai-water-search-btn');
    const searchInput = document.getElementById('ai-water-search-name');
    const brandName = searchInput.value;

    if (!brandName.trim()) {
        showToast("Please enter a brand name to search.", "error");
        return;
    }

    searchBtn.disabled = true;
    searchBtn.textContent = '...';

    const prompt = `Find the typical mineral water profile for a brand named "${brandName}". Provide the results for Calcium (ca), Magnesium (mg), Sodium (na), Sulfate (so4), Chloride (cl), and Bicarbonate (hco3) in mg/L. Respond ONLY with a valid JSON object matching the specified schema. If you cannot find the profile, respond with a JSON object where all values are 0.`;
    const schema = {
        type: "OBJECT",
        properties: {
            "ca": { "type": "NUMBER" }, "mg": { "type": "NUMBER" },
            "na": { "type": "NUMBER" }, "so4": { "type": "NUMBER" },
            "cl": { "type": "NUMBER" }, "hco3": { "type": "NUMBER" }
        },
        required: ["ca", "mg", "na", "so4", "cl", "hco3"]
    };

    try {
        const jsonResponse = await performApiCall(prompt, schema);
        const profile = JSON.parse(jsonResponse);

        if (profile.ca === 0 && profile.mg === 0) {
            showToast(`Could not find a profile for "${brandName}".`, 'info');
        } else {
            // Vul het formulier in met de gevonden data
            document.getElementById('water-profile-name').value = brandName;
            document.getElementById('manual_ca').value = profile.ca;
            document.getElementById('manual_mg').value = profile.mg;
            document.getElementById('manual_na').value = profile.na;
            document.getElementById('manual_so4').value = profile.so4;
            document.getElementById('manual_cl').value = profile.cl;
            document.getElementById('manual_hco3').value = profile.hco3;
            showToast(`Profile for "${brandName}" found! Review and save.`, 'success');
        }
    } catch (error) {
        showToast("AI search failed. Please try again.", "error");
        console.error(error);
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Find';
    }
}

window.showBrewPrompt = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew || !brew.prompt) {
        showToast("No prompt was saved for this recipe.", "info");
        return;
    }
    const modal = document.getElementById('prompt-modal');
    const content = document.getElementById('prompt-modal-content');
    content.textContent = brew.prompt;
    modal.classList.remove('hidden');
}

function refreshCurrentChecklistView() {
    // Controleer welke view momenteel zichtbaar is
    const brewDay1View = document.getElementById('brew-day-1-view');
    const brewDay2View = document.getElementById('brew-day-2-view');

    if (brewDay1View && !brewDay1View.classList.contains('hidden')) {
        // We zijn op Brew Day 1, update de UI met de progressiebalk
        currentStepIndex = Object.keys(currentBrewDay.checklist).length;
        updateUI();
    } else if (brewDay2View && !brewDay2View.classList.contains('hidden')) {
        // We zijn op Brew Day 2, herlaad de volledige detailweergave
        window.showBrewDay2Detail(currentBrewDay.brewId);
    }
}

            // --- Initialization ---
            function initApp() {

            // --- Assign UI Elements now that the DOM is loaded ---
            dashboardMainView = document.getElementById('dashboard-main-view');
            creatorView = document.getElementById('creator-view');
            brewingView = document.getElementById('brewing-view');
            historyView = document.getElementById('history-view');
            inventoryView = document.getElementById('inventory-view');
            planningView = document.getElementById('planning-view');
            financialsView = document.getElementById('financials-view');
            socialView = document.getElementById('social-view');
            troubleshootView = document.getElementById('troubleshoot-view');
            calculatorsView = document.getElementById('calculators-view');
            waterView = document.getElementById('water-view');
            settingsView = document.getElementById('settings-main-view');
            brewingMainView = document.getElementById('brewing-main-view');
            managementMainView = document.getElementById('management-main-view');
            toolsMainView = document.getElementById('tools-main-view');
            styleSelect = document.getElementById('style');
            fruitSection = document.getElementById('fruit-section');
            spiceSection = document.getElementById('spice-section');
            braggotSection = document.getElementById('braggot-section');
            generateBtn = document.getElementById('generateBtn');
            recipeOutput = document.getElementById('recipe-output');
            brewDayContent = document.getElementById('brew-day-content');
            historyList = document.getElementById('history-list');
            historyDetailContainer = document.getElementById('history-detail-container');
            historyListContainer = document.getElementById('history-list-container');
            inventoryForm = document.getElementById('inventory-form');
            inventoryList = document.getElementById('inventory-list');
            getWaterAdviceBtn = document.getElementById('getWaterAdviceBtn');
            getYeastAdviceBtn = document.getElementById('getYeastAdviceBtn');
            waterSourceSelect = document.getElementById('waterSource');
            manualWaterProfileDiv = document.getElementById('manualWaterProfile');
            troubleshootBtn = document.getElementById('troubleshoot-btn');
            apiKeyInput = document.getElementById('apiKeyInput');
            defaultBatchSizeInput = document.getElementById('defaultBatchSizeInput');
            defaultCurrencyInput = document.getElementById('defaultCurrencyInput');
            saveSettingsBtn = document.getElementById('saveSettingsBtn');
            settingsMessage = document.getElementById('settingsMessage');
            themeToggle = document.getElementById('theme-toggle-checkbox');
            exportHistoryBtn = document.getElementById('exportHistoryBtn');
            exportInventoryBtn = document.getElementById('exportInventoryBtn');
            importHistoryFile = document.getElementById('importHistoryFile');
            importInventoryFile = document.getElementById('importInventoryFile');
            clearHistoryBtn = document.getElementById('clearHistoryBtn');
            clearInventoryBtn = document.getElementById('clearInventoryBtn');
            labelsView = document.getElementById('labels-view');
            logoUploadInput = document.getElementById('logoUpload');
            labelPreview = document.getElementById('label-preview');

            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyAhOOrwJCYve5XTGS6oXvhCg_l3_LcK00I",
              authDomain: "meandery-aa05e.firebaseapp.com",
              projectId: "meandery-aa05e",
              storageBucket: "meandery-aa05e.appspot.com",
              messagingSenderId: "388311971225",
              appId: "1:388311971225:web:e5b0e81ce18d96b4a88f08",
              measurementId: "G-S5CPLP80XT"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);

                onAuthStateChanged(auth, async (user) => {
    const loginView = document.getElementById('login-view');
    // AANGEPAST: We verwijzen naar de container van de hele app, niet alleen het dashboard.
    // Dit zorgt ervoor dat de header en andere elementen ook correct getoond/verborgen worden.
    const appContainer = document.querySelector('.container.mx-auto'); 

    if (user && !user.isAnonymous) {
        // Gebruiker is succesvol ingelogd met Google
        userId = user.uid;

        // 1. VERBERG HET LOGIN-SCHERM ONMIDDELLIJK en toon de app
        loginView.classList.add('hidden');
        if (appContainer) appContainer.classList.remove('hidden'); // Toon de app

        // 2. LAAD VERVOLGENS VEILIG DE DATA
        // Een try...catch blok vangt fouten op zonder de hele app te laten crashen.
        // Promise.all() laadt alles tegelijk voor betere prestaties.
        try {
            await Promise.all([
                loadHistory(),
                loadInventory(),
                loadEquipmentProfiles(),
                loadCellar(),
                loadUserSettings(),
                loadPackagingCosts(),
                loadUserWaterProfiles()
            ]);
        } catch (error) {
            console.error("Fout bij het laden van de gebruikersdata:", error);
            // Toon een duidelijke foutmelding aan de gebruiker
            showToast("Kon niet alle gegevens laden. Probeer de pagina te vernieuwen.", "error", 6000);
        }

    } else {
        // Geen gebruiker of anonieme gebruiker -> toon login-scherm
        loginView.classList.remove('hidden');
        if (appContainer) appContainer.classList.add('hidden'); // Verberg de app

        // Log eventuele anonieme of onbekende gebruikers uit
        if (user && user.isAnonymous) {
            auth.signOut();
        }
    }
});
    } catch (e) {
        console.error("Firebase initialization failed. App will run in offline mode.", e);
        recipeOutput.innerHTML = `<p class="text-orange-600 font-bold">Running in offline mode. History and Inventory are disabled.</p>`;
    }


    // --- Event Listeners ---
    document.getElementById('history-search-input').addEventListener('input', renderHistoryList);
    document.getElementById('packaging-add-form').addEventListener('submit', addPackagingStock);
    document.getElementById('danger-cancel-btn').addEventListener('click', hideDangerModal);
    document.getElementById('danger-confirm-btn').addEventListener('click', executeDangerAction);
    document.getElementById('danger-confirm-input').addEventListener('input', checkDangerConfirmation);
    document.getElementById('customDescription').addEventListener('input', handleDescriptionInput);
    document.getElementById('close-prompt-modal-btn').addEventListener('click', hidePromptModal);
    document.getElementById('water-profile-form').addEventListener('submit', saveWaterProfile);
    document.getElementById('waterSource').addEventListener('change', handleWaterSourceChange);
    document.getElementById('ai-water-search-btn').addEventListener('click', findWaterProfileWithAI);
    document.getElementById('prompt-modal').addEventListener('click', function(e) {
        if (e.target.id === 'prompt-modal') {
            hidePromptModal();
        }
    });
    document.querySelectorAll('.main-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => switchMainView(btn.dataset.view));
    });
    document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => {
        btn.addEventListener('click', () => switchMainView('dashboard'));
    });
    document.querySelectorAll('.sub-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const parentId = e.target.closest('[id$="-main-view"]').id;
            switchSubView(e.target.id.replace('-sub-tab', ''), parentId);
        });
    });
    document.getElementById('honeyVariety').addEventListener('change', (e) => {
    document.getElementById('honeyVarietyOther').classList.toggle('hidden', e.target.value !== 'other');
    });

    setupBrewDayEventListeners();
    styleSelect.addEventListener('change', handleStyleChange);
    generateBtn.addEventListener('click', generateRecipe);
    inventoryForm.addEventListener('submit', addInventoryItem);
    document.getElementById('equipment-profile-form').addEventListener('submit', addEquipmentProfile);
    document.getElementById('equipProfileType').addEventListener('change', handleEquipmentTypeChange);
    document.getElementById('bottling-form').addEventListener('submit', bottleBatch);
    document.getElementById('scan-barcode-btn').addEventListener('click', startScanner);
    document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
    // Event listener voor de NIEUWE inventory toggles
        document.querySelectorAll('.inventory-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                // Toon de budget-sectie als *ten minste n* box is aangevinkt
                const anyChecked = Array.from(document.querySelectorAll('.inventory-toggle')).some(cb => cb.checked);
                document.getElementById('budget-section').classList.toggle('hidden', !anyChecked);
            });
        });
    document.getElementById('useBudget').addEventListener('change', (e) => {
        document.getElementById('budget-input-container').classList.toggle('hidden', !e.target.checked);
    });

    // Calculator buttons
    document.getElementById('calcAbvBtn').addEventListener('click', calculateABV);
    document.getElementById('correctSgBtn').addEventListener('click', correctHydrometer);
    document.getElementById('calcSugarBtn').addEventListener('click', calculatePrimingSugar);
    document.getElementById('calcBlendBtn').addEventListener('click', calculateBlend);
    document.getElementById('calcBacksweetenBtn').addEventListener('click', calculateBacksweetening);
    document.getElementById('calcDilutionBtn').addEventListener('click', calculateDilution);
    document.getElementById('calcTosnaBtn').addEventListener('click', calculateTOSNA);
    getYeastAdviceBtn.addEventListener('click', getYeastAdvice);

    // Manual social post button
    document.getElementById('generate-manual-social-btn').addEventListener('click', runManualSocialMediaGenerator);
    document.getElementById('generate-social-from-recipe-btn').addEventListener('click', runSocialMediaGenerator);
    
    // Water tab buttons
    waterSourceSelect.addEventListener('change', handleWaterSourceChange);
    getWaterAdviceBtn.addEventListener('click', getWaterAdvice);

    // Settings
    saveSettingsBtn.addEventListener('click', saveUserSettings);
    themeToggle.addEventListener('change', (e) => applyTheme(e.target.checked ? 'dark' : 'light'));
    exportHistoryBtn.addEventListener('click', exportHistory);
    exportInventoryBtn.addEventListener('click', exportInventory);
    // We gebruiken een anonieme functie om de generieke 'importData' aan te roepen met het juiste type
    importHistoryFile.addEventListener('change', (e) => importData(e, 'brews'));
    importInventoryFile.addEventListener('change', (e) => importData(e, 'inventory'));
    clearHistoryBtn.addEventListener('click', clearHistory);
    clearInventoryBtn.addEventListener('click', clearInventory);
    
    // Troubleshoot
    troubleshootBtn.addEventListener('click', getTroubleshootingAdvice);
    
            // Label Generator Listeners
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            document.getElementById('removeLogoBtn').addEventListener('click', removeLogo);
            document.getElementById('labelRecipeSelect').addEventListener('change', handleLabelRecipeSelect);
            document.querySelectorAll('.label-style-btn').forEach(btn => btn.addEventListener('click', () => switchLabelStyle(btn.dataset.style)));
            document.getElementById('generate-print-btn').addEventListener('click', generatePrintPage);
            document.querySelectorAll('.orientation-btn').forEach(btn => {
                btn.addEventListener('click', () => setLabelOrientation(btn.dataset.orientation));
            });
            
            ['labelStyle', 'labelAbv', 'labelVol', 'labelDate'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keyup', updateLabelPreview);
                }
            });

            const formatSelect = document.getElementById('labelFormatSelect');
            if (formatSelect) {
                formatSelect.addEventListener('change', (e) => {
                    document.getElementById('custom-format-inputs').classList.toggle('hidden', e.target.value !== 'custom');
                    updatePreviewAspectRatio(); // Update aspect ratio bij wijziging
                });
            }

            // Listeners voor custom formaat inputs
            ['customWidth', 'customHeight', 'customCols', 'customRows', 'customMarginTop', 'customMarginLeft'].forEach(id => {
                const input = document.getElementById(id);
                if(input) {
                    input.addEventListener('input', updatePreviewAspectRatio);
                }
            });

    handleStyleChange();
    }

            // --- View Management ---
            window.switchMainView = function(viewName) {
                if (window.hideBottlingModal) hideBottlingModal();
                
                [dashboardMainView, brewingMainView, managementMainView, toolsMainView, settingsView].forEach(v => v.classList.add('hidden'));
                
                const viewToShow = document.getElementById(`${viewName}-main-view`);

                if (viewToShow) {
                    viewToShow.classList.remove('hidden');

                    if (viewName === 'brewing') {
                        populateEquipmentProfilesDropdown();
                    }
                }
            }

            window.switchSubView = function(viewName, parentViewId) {
    const parentView = document.getElementById(parentViewId);
    parentView.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
    parentView.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));

    const viewId = `${viewName}-view`;
    const tabId = `${viewName}-sub-tab`;

    const viewToShow = document.getElementById(viewId);
    const tabToActivate = document.getElementById(tabId);

    if (viewToShow) viewToShow.classList.remove('hidden');
    if (tabToActivate) tabToActivate.classList.add('active');

    if (viewName === 'brew-day-2') {
        renderBrewDay2();
    }

    if (viewName === 'creator') {
        populateEquipmentProfilesDropdown();
    } 
    if (viewName === 'social') {
        populateSocialRecipeDropdown();
    }
    if (viewName === 'labels') {
        populateLabelRecipeDropdown();
        updatePreviewAspectRatio();
    }
}

            // --- Settings Management (Firebase) ---
            async function loadUserSettings() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
    
    try {
        const docSnap = await getDoc(settingsDocRef);
        if (docSnap.exists()) {
            userSettings = docSnap.data();
            // --- AANGEPAST: currentBrewDay is nu veel simpeler ---
            currentBrewDay = userSettings.currentBrewDay || { brewId: null };
            if(currentBrewDay.brewId) {
               renderBrewDay(currentBrewDay.brewId);
            }
        } else {
            // Voeg de nieuwe imageApiKey toe aan de standaardinstellingen
            userSettings = { apiKey: '', imageApiKey: '', defaultBatchSize: 5, currencySymbol: '', theme: 'light' };
        }
        applySettings();
    } catch (error) {
        console.error("Error loading user settings:", error);
    }
}
            
            function applySettings() {
    apiKeyInput.value = userSettings.apiKey || '';
    document.getElementById('imageApiKeyInput').value = userSettings.imageApiKey || '';
    
    // Set the placeholder for the main batch size input, don't pre-fill it.
    const batchSizeInput = document.getElementById('batchSize');
    if (batchSizeInput) {
        batchSizeInput.placeholder = userSettings.defaultBatchSize || 5;
    }

    defaultBatchSizeInput.value = userSettings.defaultBatchSize || 5;
    defaultCurrencyInput.value = userSettings.currencySymbol || '';
    themeToggle.checked = (userSettings.theme === 'dark');
                
                const priceLabel = document.querySelector('label[for="itemPrice"]');
                if(priceLabel) {
                    priceLabel.textContent = `Price (${userSettings.currencySymbol || ''})`;
                }
                
                applyTheme(userSettings.theme);
            }

            async function saveUserSettings() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
    
    // Voeg de nieuwe imageApiKey toe aan de op te slagen data
    const newSettings = {
        apiKey: document.getElementById('apiKeyInput').value.trim(),
        imageApiKey: document.getElementById('imageApiKeyInput').value.trim(), // NIEUW
        defaultBatchSize: parseFloat(defaultBatchSizeInput.value) || 5,
        currencySymbol: defaultCurrencyInput.value.trim() || '',
        theme: themeToggle.checked ? 'dark' : 'light',
        // --- AANGEPAST: Sla enkel de ID op, niet de checklist ---
        currentBrewDay: { brewId: currentBrewDay.brewId }
    };
    try {
        await setDoc(settingsDocRef, newSettings, { merge: true });
        userSettings = newSettings;
        applySettings();
        showToast('Settings saved successfully!', 'success');
    } catch (error) {
        console.error("Error saving settings:", error);
        showToast('Failed to save settings.', 'error');
    }
}

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // --- Data Management Functions ---
            function exportData(data, filename) {
                const dataToExport = data.map(item => {
                    const newItem = {...item};
                    // Convert Firestore Timestamps to a serializable format
                    if (newItem.createdAt && typeof newItem.createdAt.toDate === 'function') {
                        newItem.createdAt = newItem.createdAt.toDate().toISOString();
                    }
                    return newItem;
                });
                const jsonStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportHistory() {
                exportData(brews, 'meandery_history_export.json');
            }

            function exportInventory() {
                exportData(inventory, 'meandery_inventory_export.json');
            }

            // --- VERBETERDE IMPORT FUNCTIE ---
function importData(event, collectionName) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            // De 'reviver' functie checkt elke waarde tijdens het parsen
            const data = JSON.parse(e.target.result, (key, value) => {
                // Regex om ISO datums te herkennen (YYYY-MM-DDTHH:mm:ss.sssZ)
                const dateFormat = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d*)?Z$/;
                if (typeof value === "string" && dateFormat.test(value)) {
                    return new Date(value);
                }
                return value;
            });

            if (!Array.isArray(data)) throw new Error("Invalid JSON format. Expected an array.");

            if (!confirm(`This will OVERWRITE your current ${collectionName}. This cannot be undone. Are you sure?`)) return;

            showToast(`Importing ${collectionName}...`);
            const appId = 'meandery-aa05e';
            const collectionRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
            
            // Maak eerst de collectie leeg
            await clearCollection(collectionName, false);

            const batch = writeBatch(db);
            data.forEach(item => {
                // Verwijder de oude ID om conflicten te voorkomen, Firestore maakt nieuwe
                const { id, ...itemData } = item; 
                const newDocRef = doc(collectionRef); // Nieuw ID genereren
                batch.set(newDocRef, itemData);
            });
            await batch.commit();
            showToast(`${collectionName} imported successfully!`, 'success');
            
            // Herlaad de data direct zodat je het resultaat ziet
            if(collectionName === 'brews') loadHistory();
            if(collectionName === 'inventory') loadInventory();
            
        } catch (error) {
            console.error(`Error importing ${collectionName}:`, error);
            showToast(`Error: ${error.message}`, 'error');
        } finally {
            event.target.value = ''; // Reset input zodat je hetzelfde bestand nog eens kunt kiezen
        }
    };
    reader.readAsText(file);
}

            async function clearCollection(collectionName, confirmFirst = true) {
    if (confirmFirst && !confirm(`DANGER: This will permanently delete all your ${collectionName}. This cannot be undone. Are you sure?`)) {
        return false;
                }
                if (!userId) return false;
                const appId = 'meandery-aa05e';
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
                const snapshot = await getDocs(collectionRef);
                if (snapshot.empty) return true; // Nothing to delete
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                return true;
            }

            async function clearHistory() {
    const action = async () => {
        if (await clearCollection('brews', false)) { // 'false' to skip the old confirm
            showToast('Brew history cleared.', 'success');
        }
    };
    showDangerModal(action, "DELETE HISTORY");
}

async function clearInventory() {
    const action = async () => {
        if (await clearCollection('inventory', false)) { // 'false' to skip the old confirm
            showToast('Inventory cleared.', 'success');
        }
    };
    showDangerModal(action, "DELETE INVENTORY");
}

            // --- Core AI Functions ---
            async function performApiCall(prompt, schema = null) {
    const apiKey = userSettings.apiKey;
    if (!apiKey) {
        throw new Error("Please enter your Google AI API key in the Settings page first.");
    }
    
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
    const payload = { contents: chatHistory };

    if (schema) {
        payload.generationConfig = {
            responseMimeType: "application/json",
            responseSchema: schema
        };
    }

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const errorBody = await response.json();
        const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
        throw new Error(errorMessage);
    }
    
    const result = await response.json();

    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
        return result.candidates[0].content.parts[0].text;
    } else {
        throw new Error("Invalid response structure from API.");
    }
}

            function parseRecipeData(markdown) {
    console.log("--- Entering parseRecipeData ---");
    const data = {};
    try {
        const titleMatch = markdown.match(/^#\s*(.*)/m);
        if (titleMatch && titleMatch[1]) { data.recipeName = titleMatch[1].trim(); }
        console.log("parseRecipeData - Found Title:", data.recipeName);

        // --- ROBUUSTERE REGEX ---
        // Deze regex zoekt naar 'OG', 'FG', of 'ABV', negeert (optionele) interpunctie zoals ':',
        // en pakt het eerste getal (met punt of komma) dat volgt.
        const createRegex = (key) => new RegExp(`(?:${key}|${key.replace('.', '\\.')})[\\s\\*:]*~?([\\d.,]+)`, 'i');

        const ogRegex = createRegex('Target OG|Original Gravity|Start SG|O\\.G\\.|OG');
        const fgRegex = createRegex('Target FG|Final Gravity|Eind SG|F\\.G\\.|FG');
        const abvRegex = createRegex('Target ABV|ABV|Alcoholpercentage'); // ABV-getal heeft vaak een % erachter

        const ogMatch = markdown.match(ogRegex);
        if (ogMatch && ogMatch[1]) { data.targetOG = ogMatch[1]; }
        console.log("parseRecipeData - Found OG:", data.targetOG);

        const fgMatch = markdown.match(fgRegex);
        if (fgMatch && fgMatch[1]) { data.targetFG = fgMatch[1]; }
        console.log("parseRecipeData - Found FG:", data.targetFG);

        // Voor ABV passen we de regex iets aan om het %-teken correct te negeren
        const abvMatchGlobal = markdown.match(new RegExp(`(?:Target ABV|ABV|Alcoholpercentage)[\\s\\*:]*~?([\\d.,]+)\\s*%?`, 'i'));
        if (abvMatchGlobal && abvMatchGlobal[1]) { data.targetABV = abvMatchGlobal[1]; }
        console.log("parseRecipeData - Found ABV:", data.targetABV);

    } catch (e) {
        console.error("!!! Error during parseRecipeData regex matching:", e);
    }
    console.log("--- Exiting parseRecipeData ---");
    return data;
}

async function generateRecipe() {
    recipeOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Your buddy is thinking ... relax while your custom recipe is being crafted.</p>';
    generateBtn.disabled = true;
    generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
    currentPredictedProfile = null;

    try {
        const prompt = buildPrompt();
        lastGeneratedPrompt = prompt;
        
        // 1. Haal het ruwe antwoord op
        let rawResponse = await performApiCall(prompt); 
        
        // 2. SCHOONMAAK ACTIE: Verwijder Markdown code blocks (```markdown ... ```)
        let cleanedResponse = rawResponse.trim();
        if (cleanedResponse.startsWith("```markdown")) {
            cleanedResponse = cleanedResponse.substring(11, cleanedResponse.lastIndexOf("```"));
        } else if (cleanedResponse.startsWith("```")) {
            cleanedResponse = cleanedResponse.substring(3, cleanedResponse.lastIndexOf("```"));
        }
        
        currentRecipeMarkdown = cleanedResponse.trim(); // Sla de schone versie op

        await renderRecipeOutput(currentRecipeMarkdown); 

    } catch (error) {
        console.error("Error calling Gemini API:", error);
        recipeOutput.innerHTML = `<p class="text-center text-red-600 font-bold">Sorry, your buddy is busy. Please try again.</p><p class="text-center text-sm text-app-secondary/80">${error.message}</p>`;
    } finally {
        generateBtn.disabled = false;
        generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

// --- NIEUWE FUNCTIE: Creative Title Generator (Persona Based) ---
async function generateAndInjectCreativeTitle(markdown) {
    // Zoek de titel in de huidige weergave
    const titleHeader = document.querySelector('#recipe-output h1');
    if (!titleHeader) return;

    // Visuele feedback dat hij nadenkt (subtiel)
    const originalTitle = titleHeader.textContent;
    titleHeader.innerHTML = `${originalTitle} <span class="text-sm font-normal text-app-brand animate-pulse">...brewing a name...</span>`;

    const prompt = `You are a witty, cynical, modern branding expert for a high-end craft meadery. 
    
    **YOUR TASK:** Read this mead recipe and invent a SINGLE, bold, creative name for it.

    **RECIPE CONTEXT:**
    ${markdown.substring(0, 1000)}... [truncated]

    **PERSONALITY & INSPIRATION (CRUCIAL):**
    - **The Vibe:** Channel the dry, self-aware wit of **Ryan Reynolds** (Aviation Gin marketing) mixed with the abstract minimalism of a **Scandi-style craft brewery** (like Mikkeller or Omnipollo).
    - **The Rules:** 1. **NO CLICHS:** If it sounds like a fantasy novel (Viking, Thor, Elixir, Nectar, Blood), DELETE IT.
        2. **Dry Humor:** Use understatement, irony, or a slightly absurd statement.
        3. **Short & Punchy:** Maximum 4 words. Ideally 2 or 3.
    
    **WHAT TO AIM FOR:**
    - Instead of "Sweet Cherry Mead", say "Expensive Juice" or "Red".
    - Instead of "Spiced Holiday Brew", say "December Issues" or "Liquid Sweater".
    - Instead of "Strong Oak Aged Mead", say "The Wood One" or "Patience".

    **Format:** Output ONLY the name. No quotes, no explanations. Just the text.
    `;

    try {
        // Korte API call
        const newTitle = await performApiCall(prompt);
        const cleanTitle = newTitle.replace(/['"]/g, '').trim();

        // 1. Update de DOM (Zichtbaar voor gebruiker)
        titleHeader.textContent = cleanTitle;

        // 2. Update de opgeslagen Markdown (Zodat Save to History werkt)
        if (currentRecipeMarkdown) {
            currentRecipeMarkdown = currentRecipeMarkdown.replace(/^#\s*(.*)/m, `# ${cleanTitle}`);
        }

    } catch (error) {
        console.warn("Title generation failed:", error);
        titleHeader.textContent = originalTitle; // Zet terug bij fout
    }
}

// --- NIEUWE FUNCTIE: RENDER RECEPT OUTPUT ---
            async function renderRecipeOutput(markdown) {
                // 'markdown' is de parameter, vervangt 'currentRecipeMarkdown'
                
                currentPredictedProfile = await getPredictedFlavorProfile(markdown); 
                
                let flavorProfileHtml = `
                    <div id="flavor-profile-section" class="mt-8 pt-6 border-t border-app">
                        <h3 class="text-2xl font-header font-bold text-center mb-4">Predicted Flavor Profile</h3>
                `;
        
                if (currentPredictedProfile) {
                    flavorProfileHtml += `
                        <div class="card p-4 rounded-lg max-w-sm mx-auto">
                            <canvas id="generated-flavor-wheel"></canvas>
                        </div>
                    `;
                } else {
                     flavorProfileHtml += `
                        <div class="card p-4 rounded-lg max-w-sm mx-auto text-center">
                            <p class="text-app-secondary/80 text-sm mb-4">Could not generate profile initially. Try again?</p>
                            <button id="retry-flavor-btn" onclick="window.regenerateFlavorProfile()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 btn">
                                Generate Profile
                            </button>
                            <div id="flavor-generation-status" class="mt-2 text-sm"></div> 
                        </div>
                    `;
                }
                flavorProfileHtml += `</div>`;
                
                let finalMarkdown = markdown; // Gebruik de parameter
                const jsonRegex = /(?:```json\s*([\s\S]*?)\s*```|(\[\s*\{[\s\S]*?\}\s*\]))/;
                const jsonMatch = markdown.match(jsonRegex); // Gebruik de parameter
                let tableMarkdown = ''; 

                if (jsonMatch && (jsonMatch[1] || jsonMatch[2])) {
                    const jsonString = jsonMatch[1] || jsonMatch[2];
                    try {
                        const ingredientsArray = JSON.parse(jsonString);
                        tableMarkdown = '| Ingredient | Quantity | Unit |\n';
                        tableMarkdown += '|---|---|---|\n';
                        ingredientsArray.forEach(item => {
                            let displayQty = item.quantity;
                            let displayUnit = item.unit;
                            if ((displayUnit || '').toLowerCase() === 'g' && displayQty >= 1000) {
                                displayQty /= 1000; displayUnit = 'kg';
                            } else if ((displayUnit || '').toLowerCase() === 'ml' && displayQty >= 1000) {
                                displayQty /= 1000; displayUnit = 'L';
                            }
                            if (displayQty % 1 !== 0) { displayQty = parseFloat(displayQty.toFixed(2)); }
                            tableMarkdown += `| ${item.ingredient} | ${displayQty} | ${displayUnit} |\n`;
                        });
                        finalMarkdown = markdown.replace(jsonRegex, tableMarkdown); // Gebruik de parameter
                    } catch (e) {
                        console.error("Failed to parse ingredients JSON from AI response:", e);
                        tableMarkdown = `\n**Error:** Could not display ingredients. The AI provided invalid data.\n`;
                        finalMarkdown = markdown.replace(jsonRegex, tableMarkdown); // Gebruik de parameter
                    }
                } else {
                    console.warn("Could not find ingredients JSON block in AI response.");
                }
        
                finalMarkdown = finalMarkdown.replace(/\[d:[\d:]+\]/g, '');
                const recipeHtml = marked.parse(finalMarkdown);
                
                // --- AANGEPAST: Voeg de Tweak-sectie toe ---
                const fullHtml = `
                    <div class="print-button-container text-right mb-4 flex justify-end flex-wrap gap-2 no-print">
                        <button onclick="window.showLastPrompt()" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn text-sm">
                            Show AI Prompt
                        </button>
                        <button onclick="window.print()" class="bg-stone-600 text-white py-2 px-4 rounded-lg hover:bg-stone-700 transition-colors btn">
                            Print Recipe
                        </button>
                    </div>
                    <div class="recipe-content">${recipeHtml}</div>
                    ${flavorProfileHtml}
                    
                    <div id="tweak-unsaved-section" class="mt-6 pt-6 border-t-2 border-app-brand no-print">
                        <h3 class="text-2xl font-header font-bold text-center mb-4">Not quite right? Tweak it.</h3>
                        <div class="card p-4 rounded-lg">
                            <label for="tweak-unsaved-request" class="block text-sm font-bold mb-2">Describe what you want to change:</label>
                            <textarea id="tweak-unsaved-request" rows="3" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary" placeholder="e.g., 'Make this for 20 liters', or 'Replace the apples with pears'"></textarea>
                            <button id="tweak-unsaved-btn" class="w-full mt-3 bg-purple-700 text-white py-3 px-4 rounded-lg hover:bg-purple-800 btn">
                                Generate Tweaked Recipe
                            </button>
                        </div>
                        <div id="tweak-unsaved-output" class="mt-6"></div>
                    </div>

                    <div class="mt-6 no-print">
                        <button id="saveBtn" class="w-full bg-green-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-800 transition-colors btn">
                            Save to Brew History
                        </button>
                    </div>
                `;
                recipeOutput.innerHTML = fullHtml;
        
                if (currentPredictedProfile) {
                    renderGeneratedFlavorWheel(currentPredictedProfile);
                }
        
                document.getElementById('saveBtn').addEventListener('click', saveBrewToHistory);
                document.getElementById('tweak-unsaved-btn').addEventListener('click', tweakUnsavedRecipe);

                // --- NIEUW: Trigger de titel generator ---
                // We doen dit als laatste, zodat de gebruiker het recept al kan lezen
                generateAndInjectCreativeTitle(markdown);
            }

            async function tweakUnsavedRecipe() {
    const tweakRequest = document.getElementById('tweak-unsaved-request').value.trim();
    if (!tweakRequest) { showToast("Please enter your tweak request.", "error"); return; }

    const tweakOutput = document.getElementById('tweak-unsaved-output');
    tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Recalculating with Fort Knox protocols...</p>';
    const tweakBtn = document.getElementById('tweak-unsaved-btn');
    tweakBtn.disabled = true;

    // 0. BEWAAR DE DATA (State Preservation)
    // We kijken of er al een log-sectie is en halen de naam/datum op
    let preservedTitle = '';
    let preservedDate = '';
    const currentNameInput = document.querySelector('input[id^="recipeName-new"]');
    const currentDateInput = document.querySelector('input[id^="brewDate-new"]');
    
    if (currentNameInput) preservedTitle = currentNameInput.value;
    if (currentDateInput) preservedDate = currentDateInput.value;

    // 1. Context Analyse
    const contextLower = (currentRecipeMarkdown + tweakRequest).toLowerCase();
    const isNoWater = contextLower.includes('no-water') || contextLower.includes('no water');
    const isBraggot = contextLower.includes('braggot');
    const isHydromel = contextLower.includes('session') || contextLower.includes('hydromel');
    const isWild = contextLower.includes('wild') || contextLower.includes('sour') || contextLower.includes('brett');

    // 2. Haal Wetten op
    const laws = getFortKnoxLaws(isNoWater, isBraggot, isHydromel, false, isWild);

    // 3. NIEUW: Inventory Context ophalen (Hetzelfde als in buildPrompt)
    const relevantCategories = ['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical', 'Water'];
    const fullInventoryList = inventory.filter(item => relevantCategories.includes(item.category));
    const inventoryString = fullInventoryList.map(item => `${item.name} (${item.qty} ${item.unit})`).join('; ');
    const inventoryContext = `\n**INVENTORY CONTEXT:** The user has the following items in stock: [${inventoryString}]. If the tweak requires adding ingredients, prioritize these items if appropriate.`;

    const prompt = `You are "MEA(N)DERY", a master mazer. A user wants to tweak a recipe.
    
    Original Recipe:
    ---
    ${currentRecipeMarkdown}
    ---

    User Tweak Request: "${tweakRequest}"

    **TASK:** Rewrite the FULL recipe to incorporate the tweak.
    
    ${laws}
    ${inventoryContext}  <-- HIER IS HET GEHEUGEN

    **LOGIC CHECK:**
    - If the user changed the Batch Size -> Recalculate ALL ingredients.
    - If the user changed the Fruit -> Check if Honey needs adjustment for ABV targets.
    `;

    try {
        const tweakedMarkdown = await performApiCall(prompt);
        // ... (rest van je bestaande logica: cleanup, render, etc.) ...
        let processedMarkdown = tweakedMarkdown.trim();
        if (processedMarkdown.startsWith("```markdown")) {
             processedMarkdown = processedMarkdown.substring(11, processedMarkdown.lastIndexOf("```")).trim();
        } else if (processedMarkdown.startsWith("```")) {
             processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
        }

        currentRecipeMarkdown = processedMarkdown;
        await renderRecipeOutput(processedMarkdown);

        // 4. HERSTEL DE DATA (State Restoration)
        // De render functie heeft nieuwe inputs gemaakt met 'new' suffix. Vul ze terug in.
        if (preservedTitle) {
            const newNameInput = document.querySelector('input[id^="recipeName-new"]');
            if(newNameInput) newNameInput.value = preservedTitle;
        }
        if (preservedDate) {
            const newDateInput = document.querySelector('input[id^="brewDate-new"]');
            if(newDateInput) newDateInput.value = preservedDate;
        }
        recipeOutput.scrollTop = 0;
        
        if(tweakBtn) tweakBtn.disabled = false;
        tweakOutput.innerHTML = '';

    } catch (error) {
        console.error("Error tweaking:", error);
        tweakOutput.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        tweakBtn.disabled = false;
    }
}          

function buildPrompt() {
    try {
        // --- STAP 1: DATA VERZAMELEN ---
        const batchSize = parseFloat(document.getElementById('batchSize').value) || 5;
        const targetABV = parseFloat(document.getElementById('abv').value) || 12;
        const sweetness = document.getElementById('sweetness').value;
        const styleSelect = document.getElementById('style');
        const style = styleSelect.selectedOptions.length > 0 ? styleSelect.selectedOptions[0].text : 'Traditional Mead';
        const customDescription = document.getElementById('customDescription').value;
        
        // --- STAP 1.5: INPUT ANALYSE ---
        const inputString = (customDescription + " " + style).toLowerCase();
        const noWaterCheckbox = document.getElementById('isNoWaterCheckbox');
        
        // Context detectie
        const isNoWater = (noWaterCheckbox && noWaterCheckbox.checked) || inputString.includes('no-water') || inputString.includes('no water');
        const isBraggot = inputString.includes('braggot');
        
        // --- BUDGET DETECTIE (DE FIX) ---
        const useBudget = document.getElementById('useBudget')?.checked;
        let budgetContext = "";
        if (useBudget) {
             const maxBudget = parseFloat(document.getElementById('maxBudget').value);
             if (maxBudget > 0) {
                 budgetContext = `\n- **STRICT BUDGET CONSTRAINT:** The total cost of ingredients MUST be below **${maxBudget}**. Prioritize cheaper ingredients or smaller batches if necessary to hit this target.`;
             }
        }

        // --- STAP 2: MATH INJECTION ---
        const honeyGramsPerLiter = targetABV * 22; 
        const totalHoneyKg = (honeyGramsPerLiter * batchSize) / 1000;
        const estimatedYAN = Math.round(targetABV * 10); 
        
        let mathContext = `
**CALCULATED TARGETS:**
- **Batch:** ${batchSize}L | **Target ABV:** ${targetABV}%
- **Honey Baseline:** ~${totalHoneyKg.toFixed(2)} kg (Assuming honey provides 100% of the alcohol).
- **SHOPPING LIST RULE:** If target is **SWEET**, add ~15% extra honey to the JSON for backsweetening.
- **Nitrogen Target:** ~${estimatedYAN} PPM YAN.${budgetContext}  <-- HIER WORDT HET BUDGET GENJECTEERD
`;
        // SPECIAL MATH LOGIC
        if (isNoWater) {
            mathContext += `
- **PROTOCOL: NO-WATER MELOMEL.** 1. No added water. 2. Need ~1.8kg fruit/Liter. 3. **SUGAR ALERT:** Fruit adds sugar. REDUCE Honey Baseline significantly to maintain ABV target.
`;
        } else if (isBraggot) { // FIX: Braggot Math
            mathContext += `
- **PROTOCOL: BRAGGOT (MEAD/BEER HYBRID).** 1. This style requires Malt Extract or Grain.
  2. **SUGAR SPLIT:** You MUST assume Malt provides ~30-50% of the sugars. **REDUCE** the Honey Baseline calculated above proportionally so the TOTAL ABV remains ${targetABV}%.
`;
        } else {
            mathContext += `
- **JUICE WARNING:** If replacing water with Fruit Juice (Cyser), reduce honey to prevent overshooting ABV.
`;
        }

        // --- STAP 3: INVENTORY ANALYSE (Fort Knox Upgrade) ---
        const inventoryToggles = {
            Yeast: document.getElementById('useInventory_Yeast').checked,
            Nutrient: document.getElementById('useInventory_Nutrients').checked,
            Honey: document.getElementById('useInventory_Honey').checked,
            Fruit: document.getElementById('useInventory_Fruits').checked,
            Spice: document.getElementById('useInventory_Spices').checked,
            Other: document.getElementById('useInventory_Other').checked
        };
        
        // 1. Haal ALLES op wat relevant is voor brouwen (niet filteren op vinkjes!)
        const relevantCategories = ['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical', 'Water'];
        const fullInventoryList = inventory.filter(item => relevantCategories.includes(item.category));
        
        // 2. Maak de string voor de AI
        const inventoryString = fullInventoryList.map(item => `${item.name} (${item.qty} ${item.unit})`).join('; ');
        
        // 3. Bepaal de INSTRUCTIE op basis van de vinkjes
        const useAnyInventory = Object.values(inventoryToggles).some(val => val === true);
        
        // Filter welke categorien specifiek zijn aangevraagd (voor de prompt instructie)
        const requestedCategories = Object.keys(inventoryToggles).filter(k => inventoryToggles[k]);
        
        let inventoryInstruction = "";
        
        if (useAnyInventory) {
             // Als er vinkjes staan: "Probeer deze te gebruiken"
             inventoryInstruction = `**INVENTORY MODE:** The user wants to use their stock. Prioritize using items from the following categories: ${requestedCategories.join(', ')}.`;
        } else {
             // Als er geen vinkjes staan: "Ter info, dit hebben ze."
             inventoryInstruction = `**STOCK AWARENESS:** The user has these items in stock (see list). You are NOT forced to use them, but if an item matches the style perfectly, suggest using it instead of buying new.`;
        }

        // 4. De Slimme Nutrinten Logic (Blijft hetzelfde, maar gebruikt nu fullInventoryList)
        const invLower = inventoryString.toLowerCase();
        const hasSafeOrganic = invLower.includes('fermaid o') || invLower.includes('ferm o') || invLower.includes('cellvit') || invLower.includes('yeast hulls');
        const hasDAP = invLower.includes('dap') || invLower.includes('diammonium') || invLower.includes('nutrisal');
        const hasHybrid = invLower.includes('nutrivit') || invLower.includes('fermaid k') || invLower.includes('combi') || invLower.includes('ultra') || invLower.includes('tronozym');
        
        let baseNutrientRule = "";
        // (Hieronder gaat je bestaande nutrinten logica verder...)
        if (inventoryToggles.Nutrient) { 
             // ... etc (je huidige logica voor nutrinten is prima)
             if (!hasSafeOrganic && (hasHybrid || hasDAP)) {
                baseNutrientRule = `1. **Nutrients (HYBRID SCHEDULE):** Detected Inorganic/Hybrid stock (Nutrisal/Combi) but NO Fermaid O. Use ONLY this stock. **WARNING:** Instruct user to STOP adding these after 1/3 sugar break (9% ABV).`;
            } else if (hasSafeOrganic) {
                baseNutrientRule = `1. **Nutrients (ORGANIC):** Use Fermaid O/Cellvit from stock.`;
            } else {
                baseNutrientRule = `1. **Nutrients (Recommendation):** Prescribe standard TOSNA (Fermaid O).`;
            }
        } else {
             baseNutrientRule = `1. **Nutrients (Standard):** Use standard TOSNA guidelines.`;
        }

        const inventoryLogic = `${inventoryInstruction} \n **FULL STOCK LIST:** [${inventoryString}]. \n Rule: List TOTAL quantity in JSON. Tell user to buy difference.`;

        // --- STAP 4: STYLE ROUTER ---
        const sourKeywords = ['sour', 'wild', 'gueuze', 'lambic', 'brett', 'funky', 'farmhouse', 'lacto', 'pedio', 'geuze'];
        const isQuickSour = inputString.includes('philly') || inputString.includes('kettle');
        const isWildMode = sourKeywords.some(k => inputString.includes(k));

        const belgianKeywords = ['quad', 'tripel', 'dubbel', 'belgian', 'abbey', 'trappist', 'saison', 'blond', 'bruin', 'stout', 'barleywine'];
        // Braggot valt ook onder complex/monastic als het geen sour braggot is
        const isBelgianMode = belgianKeywords.some(k => inputString.includes(k)) || isBraggot; 

        const heavyKeywords = ['rum', 'bourbon', 'whisky', 'barrel', 'oak', 'bochet', 'dessert', 'pastry', 'sack', 'port', 'sherry', 'amaretto', 'chocolate', 'vanilla', 'coffee', 'maple'];
        const isHydromel = targetABV < 8 || inputString.includes('session') || inputString.includes('hydromel');
        const isHeavyMode = heavyKeywords.some(k => inputString.includes(k)) || targetABV > 15;

        // --- STAP 5: PROTOCOLLEN ---
        let protocolContext = "";
        let specificLaws = "";

        // SCENARIO A: SOUR & WILD
        if (isWildMode) {
            protocolContext = `**PROTOCOL: WILD & SOUR.**`;
            let timeRule = isQuickSour 
                ? `**Time:** Philly Sour acts fast. Treat like ale.` 
                : `**Time:** Genuine Wild/Brett needs **6-24 months** aging.`;
            
            let wildNutrientRule = baseNutrientRule;
            if (hasDAP || hasHybrid) {
                wildNutrientRule = `1. **Nutrients (WILD CAUTION):** User has Inorganic nutrients. **REDUCE DOSAGE by 50%** and front-load.`;
            }

            specificLaws = `
**WILD LAWS:**
${wildNutrientRule}
2.  **Yeast:** Recommend Philly Sour, Lambic Blend, or Brett. Warn about plastic.
3.  **Acidity:** NO Carbonate buffers.
4.  ${timeRule}
5.  **Hops:** Aged Hops for Gueuze.
`;

        // SCENARIO B: BELGIAN & COMPLEX (Include Braggot)
        } else if (isBelgianMode) {
            protocolContext = `**PROTOCOL: MONASTIC/COMPLEX (BELGIAN/BRAGGOT).** Focus on Esters, Phenols, and Malt/Syrup character.`;
            specificLaws = `
**MONASTIC LAWS:**
${baseNutrientRule}
2.  **Yeast:** Ale Yeasts (M47, BE-256, WLP500).
3.  **Temp:** Warmer (20-25C) permitted *IF* yeast strain allows.
4.  **Ingredients:** Consider Dark Candi Syrup or Malt Extract.
5.  **Carbonation:** Recommend bottle conditioning.
`;

        // SCENARIO C: STANDARD SCIENTIFIC
        } else {
            protocolContext = `**PROTOCOL: STANDARD SCIENTIFIC (BOMM).**`;

            let timeAndAgingRule = "";
            let hydromelRule = "";

            if (isHydromel) {
                timeAndAgingRule = `4. **Efficiency:** Fast turnaround (1 month).`;
                hydromelRule = `5. **Hydromel Body:** Low ABV mead feels watery. Recommend adding **Erythritol, Lactose, or Maltodextrin** for mouthfeel, OR carbonating.`;
            } else if (isHeavyMode || isNoWater) {
                timeAndAgingRule = `4. **Aging:** High Gravity/Fruit load requires **3-6 months bulk aging**.`;
            } else {
                timeAndAgingRule = `4. **Efficiency:** Aim for clean ferment ready in 2-3 months.`;
            }

            specificLaws = `
**SCIENTIFIC LAWS:**
${baseNutrientRule}
2.  **Yeast:** Reliable strains (71B, EC-1118, D47, US-05).
3.  **Buffer:** Traditionals MUST have Potassium Carbonate.
4.  **Stability:** Ferment DRY -> Stabilize -> Backsweeten.
${timeAndAgingRule}
${hydromelRule}
`;
        }

        // --- STAP 6: WATER ---
        let waterContext = "";
        if (isNoWater) {
            waterContext = `**WATER RULE:** DO NOT ADD WATER. Liquid must come from fruit juice/maceration only.`;
        } else if (currentWaterProfile) {
            waterContext = `Use Water: ${currentWaterProfile.name}`;
        } else {
            waterContext = `Recommend Ideal Water Profile.`;
        }

        // --- STAP 7: INPUT VERWERKING ---
        let creativeBrief = ""; 
        if (customDescription.trim() !== '') {
             creativeBrief = `User Vision: "${customDescription}". Override stats only if specified. Base: ${batchSize}L, ${targetABV}%.`;
        } else {
             creativeBrief = `Structure: ${style}, Batch: ${batchSize}L, Target: ${targetABV}%, Sweetness: ${sweetness}.`;
             if (style.includes('Melomel')) {
                const fruits = Array.from(document.querySelectorAll('#fruit-section input[type=checkbox]:checked')).map(el => el.labels[0].innerText);
                const otherFruits = document.getElementById('fruitOther').value;
                const fStr = [...fruits, otherFruits].filter(Boolean).join(', ');
                if(fStr) creativeBrief += `\n- Fruits: ${fStr}`;
             }
             if (style.includes('Metheglin')) {
                const spices = Array.from(document.querySelectorAll('#spice-section input[type=checkbox]:checked')).map(el => el.labels[0].innerText);
                const otherSpices = document.getElementById('spiceOther').value;
                const sStr = [...spices, otherSpices].filter(Boolean).join(', ');
                if(sStr) creativeBrief += `\n- Spices: ${sStr}`;
             }
             if (style.includes('Braggot')) {
                 creativeBrief += `\n- Braggot Base: ${document.getElementById('braggotStyle').value}`;
             }
             const useBudget = document.getElementById('useBudget')?.checked;
             if(useBudget) {
                 const maxBudget = parseFloat(document.getElementById('maxBudget').value);
                 if(maxBudget) creativeBrief += `\n- Budget Constraint: Try to keep the recipe cost around ${maxBudget}.`;
             }
        }

        // --- STAP 8: FINAL PROMPT ---
        return `You are "MEA(N)DERY", a master mazer. 

${mathContext}
${protocolContext}
${specificLaws}
${inventoryLogic}
${waterContext}

**GLOBAL SAFETY OVERRIDE:**
1. **Temp:** NEVER recommend a fermentation temp exceeding the yeast manufacturer's limit (e.g. D47 <20C).
2. **Sanity Check:** If the user requests impossible physics (e.g. 25% ABV without distillation, or 0 days fermentation), correct them politely and provide a realistic recipe.

**OUTPUT FORMAT (STRICT):**
1. **Markdown** structure.
2. **Ingredients JSON:** \`\`\`json [{"ingredient": "Name", "quantity": 0, "unit": "kg"}] \`\`\` (List ALL ingredients with calculated amounts).
3. **Timers:** \`[TIMER:HH:MM:SS]\` for wait steps.
4. **Notes:** Explain choices based on the Active Protocol.

Request:
---
${creativeBrief}
---`;

    } catch (error) {
        console.error("Error building prompt:", error);
        throw new Error(`Failed to build the prompt. (Details: ${error.message})`);
    }
}

// Deze functie retourneert de harde wetten die voor ELKE prompt gelden
function getFortKnoxLaws(isNoWater = false, isBraggot = false, isHydromel = false, isHeavy = false, isWild = false) {
    return `
**THE FORT KNOX PROTOCOLS (NON-NEGOTIABLE):**

1.  **GLOBAL SAFETY OVERRIDE:**
    - **Temp:** NEVER recommend a fermentation temp exceeding the yeast manufacturer's limit (e.g. D47 <20C).
    - **Sanity Check:** If the user requests impossible physics (e.g. 25% ABV without distillation, or 0 days fermentation), correct them politely.

2.  **SCIENTIFIC LAWS:**
    - **Buffer:** Traditionals/Cysers MUST have Potassium Carbonate.
    - **Stability:** Ferment DRY -> Stabilize -> Backsweeten.
    - ${isNoWater ? '**NO-WATER RULE:** DO NOT ADD WATER. Liquid must come from fruit juice/maceration only.' : ''}
    - ${isBraggot ? '**BRAGGOT MATH:** Malt provides 30-50% sugar. Reduce honey to prevent overshooting ABV.' : ''}
    - ${isHydromel ? '**HYDROMEL BODY:** Low ABV needs Erythritol/Lactose/Carbonation to avoid tasting watery.' : ''}

3.  **NUTRIENT SECURITY:**
    - If user has *only* DAP/Nutrisal: WARN against adding it after 9% ABV (Ammonia taste).
    - If style is *Wild/Sour*: Reduce nutrient dosage by 50% and front-load.

**OUTPUT FORMAT (STRICT):**
- **Markdown** structure.
- **Ingredients JSON:** \`\`\`json [{"ingredient": "Name", "quantity": 0, "unit": "kg"}] \`\`\` (List ALL ingredients with calculated amounts).
- **Timers:** \`[TIMER:HH:MM:SS]\` for wait steps.
`;
}

            function loadHistory() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
                const q = query(brewsCol);

                onSnapshot(q, (snapshot) => {
                    brews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    brews.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()); // Sort newest first
                    renderHistoryList();
                    populateSocialRecipeDropdown();
                    updateCostAnalysis();
                    renderActiveBrewTimeline();
                    updateNextActionWidget();
                    updateDashboardStats();
                }, (error) => {
                    console.error("Error loading history: ", error);
                    historyList.innerHTML = `<p class="text-red-500">Could not load brew history.</p>`;
                });
            }

function renderHistoryList() {
    const searchTerm = document.getElementById('history-search-input').value.toLowerCase();
    
    // Toon alle opgeslagen recepten, en filter enkel op basis van de zoekterm
    const filteredBrews = brews.filter(brew => 
         (brew.recipeName || 'Untitled Brew').toLowerCase().includes(searchTerm)
    );

    if (brews.length === 0) { // Controleer de ongefilterde lijst voor de "leeg" melding
        historyList.innerHTML = `<p class="text-center text-app-secondary/80">You have no brews in your history yet. Go to the Creator to make one!</p>`;
        return;
    }
    
    if (filteredBrews.length === 0) {
        historyList.innerHTML = `<p class="text-center text-app-secondary/80">No recipes found matching your search.</p>`;
        return;
    }

    historyList.innerHTML = filteredBrews.map(brew => `
        <div class="p-4 card rounded-lg cursor-pointer hover:bg-app-primary" onclick="window.showBrewDetail('${brew.id}')">
            <h4 class="font-bold text-lg font-header">${brew.recipeName || 'Untitled Brew'}</h4>
            <p class="text-sm text-app-secondary/80">Saved on: ${brew.createdAt.toDate().toLocaleDateString()}</p>
        </div>
    `).join('');
}

window.showBrewDetail = function(brewId) {
    // 1. FIX: Zorg dat we eerst naar de juiste hoofdpagina en subtab navigeren
    switchMainView('brewing');
    switchSubView('history', 'brewing-main-view');

    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    let finalMarkdown = brew.recipeMarkdown;
    const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
    const jsonMatch = brew.recipeMarkdown.match(jsonRegex);

    if (jsonMatch && jsonMatch[1]) {
        try {
            const ingredientsArray = JSON.parse(jsonMatch[1]);
            let tableMarkdown = '| Ingredient | Quantity | Unit |\n';
            tableMarkdown += '|---|---|---|\n';
            ingredientsArray.forEach(item => {
  
                let displayQty = item.quantity;
                let displayUnit = item.unit;
                const ing = item.ingredient || 'N/A';

                if ((displayUnit || '').toLowerCase() === 'g' && displayQty >= 1000) {
                    displayQty /= 1000;
                    displayUnit = 'kg';
                } else if ((displayUnit || '').toLowerCase() === 'ml' && displayQty >= 1000) {
                    displayQty /= 1000;
                    displayUnit = 'L';
                }

                if (displayQty % 1 !== 0) {
                   displayQty = parseFloat(displayQty.toFixed(2));
                }

                tableMarkdown += `| ${ing} | ${displayQty || 0} | ${displayUnit || 'N/A'} |\n`;
            });
            finalMarkdown = brew.recipeMarkdown.replace(jsonRegex, tableMarkdown);
        } catch (e) {
            console.error("Failed to parse ingredients JSON from saved recipe:", e);
        }
    }

    finalMarkdown = finalMarkdown.replace(/\[d:[\d:]+\]/g, '');

    const recipeHtmlWithoutTitle = marked.parse(finalMarkdown.replace(/^#\s.*$/m, ''));
    const logHtml = getBrewLogHtml(brew.logData, brew.id);
    const currency = userSettings.currencySymbol || '';

    let costHtml = '';
    if (brew.totalCost !== undefined && brew.totalCost > 0) {
        const costPerLiter = brew.batchSize > 0 ? brew.totalCost / brew.batchSize : 0;
        costHtml = `
            <div class="mt-6 p-4 bg-amber-100 rounded-lg dark:bg-amber-900/20">
                <h3 class="font-header text-lg text-amber-900 dark:text-amber-200">Batch Cost Analysis</h3>
                <p class="text-amber-800 dark:text-amber-200"><strong>Total Ingredient Cost:</strong> ${currency}${brew.totalCost.toFixed(2)}</p>
                <p class="text-amber-800 dark:text-amber-200"><strong>Cost Per Liter:</strong> ${currency}${costPerLiter.toFixed(2)}</p>
            </div>
        `;
    }

    const flavorWheelTitle = brew.predictedFlavorProfile ? 'Predicted Flavor Profile' : 'Flavor Profile Analysis';
    const flavorWheelDescription = brew.predictedFlavorProfile
        ? 'This is the AI-predicted flavor profile based on the recipe.'
        : 'Enter your tasting notes in the log above, save them, and then click the button below to generate a flavor profile.';

    historyDetailContainer.innerHTML = `
        <button onclick="window.goBackToHistoryList()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to History</button>

        <div class="mb-4">
            <div id="title-display-${brew.id}">
                <h2 class="text-3xl font-header font-bold w-full">${brew.recipeName}</h2>
                <div class="text-right w-full mt-1">
                     <button onclick="window.showTitleEditor('${brew.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold no-print">Edit Title</button>
                </div>
            </div>
            <div id="title-editor-${brew.id}" class="hidden">
                <input type="text" id="title-input-${brew.id}" value="${brew.recipeName}" class="w-full text-2xl font-bold p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                <div class="flex gap-2 mt-2">
                    <button onclick="window.saveNewTitle('${brew.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm btn">Save</button>
                    <button onclick="window.hideTitleEditor('${brew.id}')" class="bg-gray-500 text-white px-3 py-1 rounded text-sm btn">Cancel</button>
                </div>
            </div>
        </div>
        <div class="print-button-container mb-4 grid grid-cols-2 gap-2 no-print">
            <button onclick="window.cloneBrew('${brew.id}')" class="bg-blue-700 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition-colors btn flex items-center justify-center"> Clone Recipe </button>
            <button onclick="window.startBrewDay('${brew.id}')" class="bg-app-action text-white py-2 px-4 rounded-lg hover:opacity-90 transition-colors btn">Start New Batch</button>
            <button onclick="window.recalculateBatchCost('${brew.id}')" class="bg-purple-700 text-white py-2 px-4 rounded-lg hover:bg-purple-800 transition-colors btn">Recalculate Cost</button>
            <button onclick="window.deleteBrew('${brew.id}')" class="bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800 transition-colors btn flex items-center justify-center"> Delete Recipe </button>
        </div>

        <div class="recipe-content">${recipeHtmlWithoutTitle}</div>
        ${costHtml}
        <div class="mt-6 card p-4 rounded-lg"><h3 class="font-header text-lg text-center">Fermentation Progress</h3><canvas id="fermChart-${brew.id}"></canvas></div>
        ${logHtml}

        <div class="mt-4 no-print">
            <button onclick="window.updateBrewLog('${brew.id}', 'history-detail-container')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>
        </div>

        <div class="mt-6 pt-4 border-t-2 border-app-brand no-print">
            <h3 class="text-2xl font-header font-bold text-center mb-4">${flavorWheelTitle}</h3>
            <div class="card p-4 rounded-lg text-center">
                <p class="text-app-secondary mb-4">${flavorWheelDescription}</p>
                <button onclick="window.generateFlavorWheel('${brew.id}')" class="bg-purple-600 ... btn"> Analyze My Tasting Notes </button>
                <div id="flavor-wheel-container-${brew.id}" class="mt-4" style="max-width: 400px; margin: auto;"></div>
            </div>
        </div>

        <div class="mt-6 pt-4 border-t-2 border-app no-print">
             <h3 class="text-2xl font-header font-bold text-center mb-4">Tweak Recipe with AI</h3>
             <div class="card p-4 rounded-lg">
                <label for="tweak-request-${brew.id}" class="block text-sm font-bold mb-2">Describe what you want to change:</label>
                <textarea id="tweak-request-${brew.id}" rows="3" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary" placeholder="e.g., 'Make this recipe for 20 liters', or 'Replace the apples with pears and add cinnamon'"></textarea>
                <button onclick="window.freeformTweakRecipe('${brew.id}')" class="w-full mt-3 bg-purple-700 text-white py-3 px-4 rounded-lg hover:bg-purple-800 btn">Generate Tweaked Recipe</button>
             </div>
        </div>

        <div id="tweak-output-${brew.id}" class="mt-6"></div>
    `;
    historyListContainer.classList.add('hidden');
    historyDetailContainer.classList.remove('hidden');
    renderFermentationGraph(brew.id);

    if (brew.predictedFlavorProfile) {
        const container = document.getElementById(`flavor-wheel-container-${brewId}`);
        container.style.display = 'block';
        const labels = ['Sweetness', 'Acidity', 'Fruity/Floral', 'Spiciness', 'Earthy/Woody', 'Body'];
        const data = [
            brew.predictedFlavorProfile.sweetness,
            brew.predictedFlavorProfile.acidity,
            brew.predictedFlavorProfile.fruity_floral,
            brew.predictedFlavorProfile.spiciness,
            brew.predictedFlavorProfile.earthy_woody,
            brew.predictedFlavorProfile.body_mouthfeel
        ];
        renderFlavorWheel(brewId, labels, data);
    }
}

window.recalculateBatchCost = async function(brewId) {
    if (!userId) return;
    const brew = brews.find(b => b.id === brewId);
    if (!brew) {
        showToast("Could not find brew to recalculate.", "error");
        return;
    }

    // Roep de globale, correcte parseerfunctie aan
    const costResult = parseIngredientsAndCalculateCost(brew.recipeMarkdown, inventory, brew.batchSize);
    const newTotalCost = costResult.cost;

    // NIEUW: Toon de waarschuwingen als die er zijn
    if (costResult.warnings.length > 0) {
        showToast(`Cost Warning: Could not calculate cost for some items:\n- ${costResult.warnings.join('\n- ')}`, 'error', 7000);
    }
    const oldTotalCost = brew.totalCost || 0;

    if (confirm(`The new calculated total ingredient cost is ${userSettings.currencySymbol || ''}${newTotalCost.toFixed(2)} (was ${oldTotalCost.toFixed(2)}). Do you want to update?`)) {
        try {
            const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
            await updateDoc(brewDocRef, { totalCost: newTotalCost });

            // Update ook de cellar entry als die bestaat
            const cellarEntry = cellar.find(c => c.brewId === brewId);
            if (cellarEntry) {
                const cellarDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar', cellarEntry.id);
                // De 'totalBatchCost' in de kelder is de som van ingredinten en verpakking. 
                // We kunnen hier enkel de 'ingredientCost' veilig updaten.
                await updateDoc(cellarDocRef, { ingredientCost: newTotalCost });
            }

            showToast("Batch cost updated successfully!", "success");
            // De onSnapshot-listener zal de UI automatisch verversen, inclusief de detailweergave
            goBackToHistoryList();
        } catch (error) {
            console.error("Error recalculating cost:", error);
            showToast("Failed to update cost.", "error");
        }
    }
}

            window.editPackagingItem = function(itemId) {
                const item = PACKAGING_ITEMS.find(i => i.id === itemId);
                const itemData = packagingCosts[itemId] || {};
                const itemDiv = document.getElementById(`pkg-item-${itemId}`);

                const qtyValue = itemData.qty > 0 ? itemData.qty : '';
                const priceValue = itemData.price > 0 ? itemData.price : '';

                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <p class="font-bold">${item.name}</p>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="edit-qty-${itemId}" value="${qtyValue}" placeholder="Quantity" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-price-${itemId}" value="${priceValue}" step="0.01" placeholder="Total Price (${userSettings.currencySymbol || ''})" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.updatePackagingItem('${itemId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                            <button onclick="renderPackagingUI()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                       </div>
                   </div>
                `;
            }

            window.updatePackagingItem = function(itemId) {
                const qty = parseFloat(document.getElementById(`edit-qty-${itemId}`).value) || 0;
                const price = parseFloat(document.getElementById(`edit-price-${itemId}`).value) || 0;

                packagingCosts[itemId] = { qty, price };
                savePackagingCosts(); // Sla de volledige set van kosten op
            }

            window.clearPackagingItem = function(itemId) {
                if (confirm("Are you sure you want to delete the data for this item? This will set quantity and price to 0.")) {
                   packagingCosts[itemId] = { qty: 0, price: 0 };
                   savePackagingCosts();
                }
            }

window.cloneBrew = async function(brewId) {
    const originalBrew = brews.find(b => b.id === brewId);
    if (!originalBrew) {
        showToast("Could not find the original recipe to clone.", "error");
        return;
    }
    // Maak een diepe kopie van de log data en reset de waarden
    const newLogData = JSON.parse(JSON.stringify(originalBrew.logData || {}));
    newLogData.brewDate = ''; 
    newLogData.actualOG = ''; 
    newLogData.actualFG = ''; 
    newLogData.finalABV = '';
    newLogData.fermentationLog = Array.from({ length: 3 }, () => ({ date: '', temp: '', sg: '', notes: '' }));
    newLogData.agingNotes = ''; 
    newLogData.bottlingNotes = ''; 
    newLogData.tastingNotes = '';

    const newBrewData = {
        userId: userId,
        recipeName: `Clone of ${originalBrew.recipeName}`,
        recipeMarkdown: originalBrew.recipeMarkdown,
        logData: newLogData,
        createdAt: new Date(),
        batchSize: originalBrew.batchSize,
        totalCost: originalBrew.totalCost,
        isBottled: false,
        primaryComplete: false, // Belangrijk: reset deze status
        predictedFlavorProfile: originalBrew.predictedFlavorProfile || null,
        
        brewDaySteps: originalBrew.brewDaySteps || [],     // Kopieer de primaire stappen
        secondarySteps: originalBrew.secondarySteps || []  // Kopieer de secundaire stappen
    };

    try {
        const appId = 'meandery-aa05e';
        const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
        await addDoc(brewsCol, newBrewData);
        showToast(`'${newBrewData.recipeName}' has been created! You can now start a new batch from it.`, 'success');
        goBackToHistoryList(); // Ga terug naar de lijst zodat de gebruiker de nieuwe kloon kan zien
    } catch (error) {
        console.error("Error cloning brew:", error);
        showToast("An error occurred while cloning the recipe.", "error");
    }
}

            window.goBackToHistoryList = function() {
                historyDetailContainer.classList.add('hidden');
                historyListContainer.classList.remove('hidden');
            }
            
            window.updateBrewLog = async function(brewId, containerId) {
    if (!userId || !brewId) return;

    // Find the specific button that was clicked inside the container
    const container = document.getElementById(containerId);
    const btn = container ? container.querySelector('button[onclick*="updateBrewLog"]') : null;
    const originalText = btn ? btn.innerText : 'Save Log Changes';
    
    if(btn) {
        btn.disabled = true;
        btn.innerText = "Saving...";
    }

    const logData = getLogDataFromDOM(containerId); 

    try {
        const appId = 'meandery-aa05e';
        const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
        await updateDoc(brewDocRef, { logData: logData });
        
        // We don't need the toast anymore if the button gives feedback, 
        // but keeping it doesn't hurt:
        showToast('Log updated successfully!', 'success');

        if (containerId === 'history-detail-container') {
            showBrewDetail(brewId);
        } else {
            const brewIndex = brews.findIndex(b => b.id === brewId);
            if (brewIndex > -1) {
                brews[brewIndex].logData = logData;
            }
        }

        if(btn) {
            btn.innerText = "Saved!";
            btn.classList.remove('bg-app-action'); // Remove standard color
            btn.classList.add('bg-green-600');     // Add success color
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = originalText;
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-app-action'); // Restore standard color
            }, 2000);
        }

    } catch(error) {
        console.error("Error updating log:", error);
        showToast('Failed to update log.', 'error');
        
        // Reset button on error
        if(btn) {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
}

            // --- NIEUWE FUNCTIE OM LOG REGEL TOE TE VOEGEN ---
window.addLogLine = function(idSuffix) {
    const tableBody = document.querySelector(`#fermentationTable-${idSuffix} tbody`);
    if (!tableBody) return;

    // Zoek de laatste rij om waarden te kopiren
    const lastRow = tableBody.lastElementChild;
    let lastTemp = '';
    if (lastRow) {
        const tempInput = lastRow.querySelector('td:nth-child(2) input');
        if (tempInput) lastTemp = tempInput.value;
    }

    const newRow = document.createElement('tr');
    // Vul de placeholder of value met de laatste temperatuur
    newRow.innerHTML = `
        <td><input type="date" class="w-full" ondblclick="this.value = new Date().toISOString().split('T')[0]"></td>
        <td><input type="number" step="0.5" value="${lastTemp}" placeholder="18.5" class="w-full text-center"></td>
        <td><input type="number" step="0.001" placeholder="1.050" class="w-full text-center"></td>
        <td><input type="text" class="w-full"></td>
    `;
    tableBody.appendChild(newRow);
}

            window.saveSocialPost = async function() {
                const saveBtn = document.getElementById('save-social-post-btn');
                if (!saveBtn || saveBtn.disabled) return;
                
                const brewId = document.getElementById('social-recipe-select').value;
                if (!brewId) {
                    showToast("You must select a recipe to save the post to.", "error");
                    return;
                }

                const contentDiv = document.getElementById('social-content-container').querySelector('div');
                const platform = document.getElementById('social-platform').options[document.getElementById('social-platform').selectedIndex].text;
                const persona = document.getElementById('social-persona').options[document.getElementById('social-persona').selectedIndex].text;

                if (!contentDiv || !contentDiv.innerText.trim()) {
                    showToast("No content to save.", "error");
                    return;
                }

                const newPost = {
                    platform: platform,
                    persona: persona,
                    content: contentDiv.innerText,
                    createdAt: new Date().toISOString()
                };

                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                try {
                    const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, {
                        socialMediaPosts: arrayUnion(newPost)
                    });
                    showToast("Post saved to recipe notes!", "success");
                    saveBtn.textContent = 'Saved!';
                } catch (error) {
                    console.error("Error saving social post:", error);
                    showToast("Could not save post.", "error");
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Post to Recipe Notes';
                }
            }

// --- NIEUWE FUNCTIE: AUTOMATISCHE ABV BEREKENING ---
window.autoCalculateABV = function(idSuffix) {
    const ogInput = document.getElementById(`actualOG-${idSuffix}`);
    const fgInput = document.getElementById(`actualFG-${idSuffix}`);
    const abvInput = document.getElementById(`finalABV-${idSuffix}`);

    if (!ogInput || !fgInput || !abvInput) return;

    // Vervang komma's door punten voor de zekerheid en parse naar getal
    const og = parseFloat(ogInput.value.replace(',', '.'));
    const fg = parseFloat(fgInput.value.replace(',', '.'));

    // Voer berekening alleen uit als we twee geldige getallen hebben
    if (!isNaN(og) && !isNaN(fg)) {
        // Standaard formule: (OG - FG) * 131.25
        const abv = (og - fg) * 131.25;
        
        // Als het resultaat positief is, vul het in (1 decimaal + %)
        if (abv >= 0) {
            abvInput.value = abv.toFixed(1) + '%';
        } else {
            abvInput.value = ''; // Wis als het onlogisch is (FG > OG)
        }
    }
};

window.generateFlavorWheel = async function(brewId) {
    const container = document.getElementById(`flavor-wheel-container-${brewId}`);
    const tastingNotes = document.getElementById(`tastingNotes-${brewId}`).value;

    if (!tastingNotes.trim()) {
        alert("Please enter some tasting notes before analyzing the flavor.");
        return;
    }

    container.style.display = 'block';
    container.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Analyzing flavor profile...</p>';

    const prompt = `You are a professional mead sommelier. Analyze the following tasting notes and assign a score from 0 to 5 for each of the following categories: Sweetness, Acidity, Fruity/Floral, Spiciness, Earthy/Woody, and Body/Mouthfeel. Provide your output ONLY in a valid JSON format according to the specified schema. Tasting notes: "${tastingNotes}"`;

    const schema = {
        type: "OBJECT",
        properties: {
            "sweetness": { "type": "NUMBER" },
            "acidity": { "type": "NUMBER" },
            "fruity_floral": { "type": "NUMBER" },
            "spiciness": { "type": "NUMBER" },
            "earthy_woody": { "type": "NUMBER" },
            "body_mouthfeel": { "type": "NUMBER" }
        },
        required: ["sweetness", "acidity", "fruity_floral", "spiciness", "earthy_woody", "body_mouthfeel"]
    };

    try {
        const jsonResponse = await performApiCall(prompt, schema);
        const flavorData = JSON.parse(jsonResponse);
        
        const labels = ['Sweetness', 'Acidity', 'Fruity/Floral', 'Spiciness', 'Earthy/Woody', 'Body'];
        const data = [
            flavorData.sweetness,
            flavorData.acidity,
            flavorData.fruity_floral,
            flavorData.spiciness,
            flavorData.earthy_woody,
            flavorData.body_mouthfeel
        ];
        
        renderFlavorWheel(brewId, labels, data);

    } catch (error) {
        console.error("Error generating flavor wheel:", error);
        container.innerHTML = `<p class="text-center text-red-500">Could not analyze flavor profile: ${error.message}</p>`;
    }
}

function renderFlavorWheel(brewId, labels, data) {
    const container = document.getElementById(`flavor-wheel-container-${brewId}`);
    container.innerHTML = `<canvas id="flavorWheelChart-${brewId}"></canvas>`;
    const ctx = document.getElementById(`flavorWheelChart-${brewId}`).getContext('2d');

    if (window.flavorChartInstances && window.flavorChartInstances[brewId]) {
        window.flavorChartInstances[brewId].destroy();
    }
    if (!window.flavorChartInstances) {
        window.flavorChartInstances = {};
    }
    
    const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');
    
    // Bepaal de kleuren expliciet op basis van het thema voor perfect contrast.
    const isDarkMode = document.documentElement.classList.contains('dark');
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#e0e0e0' : '#4a3c2c'; // Gebruik de expliciete kleurcodes

    window.flavorChartInstances[brewId] = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Flavor Profile',
                data: data,
                backgroundColor: brandColor + '4D',
                borderColor: brandColor,
                borderWidth: 2,
                pointBackgroundColor: brandColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true, // Maak de legende zichtbaar
                    labels: { color: textColor } // Gebruik de correcte tekstkleur
                }
            },
            scales: {
                r: {
                    angleLines: { color: gridColor },
                    grid: { color: gridColor },
                    pointLabels: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        font: { size: 12, family: "'Barlow Semi Condensed', sans-serif" }
                    },
                    ticks: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        backdropColor: 'transparent',
                        stepSize: 1
                    },
                    suggestedMin: 0,
                    suggestedMax: 5
                }
            }
        }
    });
}

async function getPredictedFlavorProfile(markdown) {
    console.log("Generating predicted flavor profile...");
    const prompt = `You are a professional mead sommelier. Analyze the following mead recipe and PREDICT its final flavor profile. Assign a score from 0 to 5 for each of the following categories: Sweetness, Acidity, Fruity/Floral, Spiciness, Earthy/Woody, and Body/Mouthfeel. Provide your output ONLY in a valid JSON format according to the specified schema. Recipe: "${markdown}"`;

    const schema = {
        type: "OBJECT",
        properties: {
            "sweetness": { "type": "NUMBER" },
            "acidity": { "type": "NUMBER" },
            "fruity_floral": { "type": "NUMBER" },
            "spiciness": { "type": "NUMBER" },
            "earthy_woody": { "type": "NUMBER" },
            "body_mouthfeel": { "type": "NUMBER" }
        },
        required: ["sweetness", "acidity", "fruity_floral", "spiciness", "earthy_woody", "body_mouthfeel"]
    };

    try {
        const jsonResponse = await performApiCall(prompt, schema);
        return JSON.parse(jsonResponse);
    } catch (error) {
        console.error("Could not generate predicted flavor profile:", error);
        return null; // Geef null terug bij een fout
    }
}

function renderGeneratedFlavorWheel(flavorData) {
    const ctx = document.getElementById('generated-flavor-wheel');
    if (!ctx) return;

    const labels = ['Sweetness', 'Acidity', 'Fruity/Floral', 'Spiciness', 'Earthy/Woody', 'Body'];
    const data = [
        flavorData.sweetness,
        flavorData.acidity,
        flavorData.fruity_floral,
        flavorData.spiciness,
        flavorData.earthy_woody,
        flavorData.body_mouthfeel
    ];

    const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');

    // Bepaal de kleuren expliciet op basis van het thema voor perfect contrast.
    const isDarkMode = document.documentElement.classList.contains('dark');
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#e0e0e0' : '#4a3c2c'; // Gebruik de expliciete kleurcodes

    new Chart(ctx.getContext('2d'), {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Predicted Profile',
                data: data,
                backgroundColor: brandColor + '4D',
                borderColor: brandColor,
                borderWidth: 2,
                pointBackgroundColor: brandColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true, // Maak de legende zichtbaar
                    labels: { color: textColor } // Gebruik de correcte tekstkleur
                }
            },
            scales: {
                r: {
                    angleLines: { color: gridColor },
                    grid: { color: gridColor },
                    pointLabels: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        font: { size: 12, family: "'Barlow Semi Condensed', sans-serif" }
                    },
                    ticks: {
                        color: textColor, // Gebruik de correcte tekstkleur
                        backdropColor: 'transparent',
                        stepSize: 1
                    },
                    suggestedMin: 0,
                    suggestedMax: 5
                }
            }
        }
    });
}

window.regenerateFlavorProfile = async function() {
            const button = document.getElementById('retry-flavor-btn');
            const statusDiv = document.getElementById('flavor-generation-status');
            const sectionDiv = document.getElementById('flavor-profile-section'); // De div rond de knop/canvas
            const containerDiv = button.parentElement; // De div waar de knop in zit

            if (!currentRecipeMarkdown) {
                statusDiv.innerHTML = `<p class="text-red-500">No recipe data available.</p>`;
                return;
            }

            button.disabled = true;
            statusDiv.innerHTML = '<div class="loader mx-auto" style="width:20px; height:20px; border-width:2px;"></div><p>Generating...</p>';

            try {
                const profile = await getPredictedFlavorProfile(currentRecipeMarkdown);
                if (profile) {
                    currentPredictedProfile = profile; // Sla het succesvolle profiel op
                    // Vervang de knop-container door de canvas container
                    containerDiv.innerHTML = `<canvas id="generated-flavor-wheel"></canvas>`;
                    renderGeneratedFlavorWheel(profile); // Teken de grafiek
                } else {
                     throw new Error("AI did not return a valid profile.");
                }
            } catch (error) {
                 console.error("Error regenerating flavor profile:", error);
                 statusDiv.innerHTML = `<p class="text-red-500">Failed: ${error.message}</p>`;
                 button.disabled = false; // Laat de gebruiker opnieuw proberen
            }
        }

            window.quickTweakRecipe = async function(brewId, tweakType) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Applying quick tweak...</p>';

                let tweakInstruction = '';
                switch (tweakType) {
                    case 'make_dryer':
                        tweakInstruction = "make the final mead dryer by adjusting the honey quantity or yeast choice to achieve a lower final gravity.";
                        break;
                    case 'increase_abv':
                        tweakInstruction = "increase the final ABV by approximately 2%. You must adjust the initial honey quantity to provide more fermentable sugar.";
                        break;
                    case 'add_oak':
                        tweakInstruction = "add a step for aging with a light touch of oak cubes or chips. Specify the type, amount, and contact time.";
                        break;
                    default:
                        tweakOutput.innerHTML = `<p class="text-center text-red-500">Unknown tweak type.</p>`;
                        return;
                }

                const prompt = `You are an expert mead maker. Take the following mead recipe and apply this specific modification: ${tweakInstruction}. You must generate the complete, updated recipe, including a regenerated ingredient table and instructions. Explain your changes briefly in the 'Brewer's Notes'. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;

                try {
                    const tweakedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 card rounded-lg">${marked.parse(tweakedMarkdown)}</div>`;
                } catch (error) {
                    console.error("Error during quick tweak:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not perform tweak: ${error.message}</p>`;
                }
            }

            window.swapIngredient = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const swapInput = document.getElementById(`ingredient-swap-input-${brew.id}`);
                const swapRequest = swapInput.value;
                if (!swapRequest.trim()) {
                    alert("Please describe the ingredient swap you want to make.");
                    return;
                }

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Calculating ingredient swap...</p>';

                const prompt = `You are an expert mead maker. Take the following mead recipe. A user wants to make an ingredient substitution. Their request is: "${swapRequest}". 
                
                Please analyze this request. Adjust ingredient quantities if necessary (e.g., accounting for different sugar content in a new honey type). Modify the instructions where needed. In the 'Brewer's Notes', you MUST explain the likely impact of this swap on the final flavor profile. 
                
                Generate the complete, updated recipe with the swap integrated. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;
                
                try {
                    const swappedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 card rounded-lg">${marked.parse(swappedMarkdown)}</div>`;
                    swapInput.value = ''; // Clear input after successful swap
                } catch (error) {
                    console.error("Error swapping ingredient:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not perform swap: ${error.message}</p>`;
                }
            }
            
            // --- Inventory Functions ---
            async function addInventoryItem(e) {
                e.preventDefault();
                if (!userId) return;
                const name = document.getElementById('itemName').value;
                const qty = parseFloat(document.getElementById('itemQty').value);
                const unit = document.getElementById('itemUnit').value;
                const price = parseFloat(document.getElementById('itemPrice').value);
                const category = document.getElementById('itemCategory').value;
                const expirationDate = document.getElementById('itemExpirationDate').value || null;
                if (!name || isNaN(qty) || isNaN(price)) return;
                const itemData = { userId, name, qty, unit, price, category, expirationDate };
                try {
                    const appId = 'meandery-aa05e';
                    const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
                    await addDoc(invCol, itemData);
                    inventoryForm.reset();
                    showToast("Ingredient added to inventory!", "success");
                } catch (error) {
                    console.error("Error adding inventory item:", error);
                    showToast("Could not add ingredient.", "error");
                }
            }

            function loadInventory() {
    if (!userId) return;
    const appId = 'meandery-aa05e';
    const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
    const q = query(invCol);

    onSnapshot(q, (snapshot) => {
        inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderInventory();
        updateCostAnalysis();
        updateNextActionWidget(); // Update dashboard with potential expiry warnings
        updateDashboardStats();
    }, (error) => {
        console.error("Error loading inventory: ", error);
        inventoryList.innerHTML = `<p class="text-red-500">Could not load inventory.</p>`;
    });
}

window.renderInventory = function() {
    const grouped = inventory.reduce((acc, item) => {
        (acc[item.category] = acc[item.category] || []).push(item);
        return acc;
    }, {});

    const categories = ['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical', 'Water'];
    const currency = userSettings.currencySymbol || '';
    let html = '';

    for (const category of categories) {
        if (grouped[category]) {
            html += `<h3 class="text-xl font-header mt-4 mb-2">${category}</h3>`;
            html += `<div class="space-y-2">`;
            grouped[category].forEach(item => {
                const expDateStr = item.expirationDate ? new Date(item.expirationDate).toLocaleDateString() : 'N/A';
                let dateClass = 'text-app-secondary/80';
                if (item.expirationDate) {
                    const expDate = new Date(item.expirationDate);
                    const now = new Date();
                    now.setHours(0,0,0,0);
                    const daysUntilExp = (expDate - now) / (1000 * 60 * 60 * 24);
                    if (daysUntilExp < 0) {
                        dateClass = 'text-red-500 font-bold';
                    } else if (daysUntilExp <= 30) {
                        dateClass = 'text-amber-500 font-semibold';
                    }
                }

                html += `<div id="item-${item.id}" class="p-3 card rounded-md">
                    <div class="flex justify-between items-center">
                        <span>${item.name}</span>
                        <div class="flex items-center gap-4">
                            <span class="font-semibold">${item.qty} ${item.unit} - ${currency}${(item.price || 0).toFixed(2)}</span>
                            <div class="flex gap-2">
                                <button onclick="window.editInventoryItem('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                <button onclick="window.deleteInventoryItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs ${dateClass}">Exp: ${expDateStr}</p>
                </div>`;
            });
            html += `</div>`;
        }
    }
    
    if (inventory.length === 0) {
        html = `<p class="text-center text-app-secondary/80">Your inventory is empty. Add your first ingredient!</p>`;
    }

    inventoryList.innerHTML = html;
}

            window.deleteInventoryItem = async function(itemId) {
                if (!userId) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemId);
                    await deleteDoc(itemDocRef);
                    showToast("Item deleted.", "success");
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast("Could not delete item.", "error");
                }
            }

            window.editInventoryItem = function(itemId) {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;

                const itemDiv = document.getElementById(`item-${itemId}`);
                const currency = userSettings.currencySymbol || '';
                
                // Bouw de opties voor de 'unit' dropdown
                const unitOptions = ['kg', 'g', 'L', 'ml', 'packets', 'items'];
                const unitSelectHtml = unitOptions.map(unit => 
                    `<option value="${unit}" ${item.unit === unit ? 'selected' : ''}>${unit}</option>`
                ).join('');

                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <input type="text" id="edit-name-${itemId}" value="${item.name}" placeholder="Name" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        <div>
                            <select id="edit-category-${itemId}" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                                ${['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical', 'Water'].map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="number" id="edit-qty-${itemId}" value="${item.qty}" step="0.01" placeholder="Quantity" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <select id="edit-unit-${itemId}" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">${unitSelectHtml}</select>
                            <input type="number" id="edit-price-${itemId}" value="${item.price}" step="0.01" placeholder="Price (${userSettings.currencySymbol || ''})" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div>
                             <label for="edit-date-${itemId}" class="text-xs text-app-secondary">Exp. Date</label>
                             <input type="date" id="edit-date-${itemId}" value="${item.expirationDate || ''}" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.updateInventoryItem('${itemId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                            <button onclick="renderInventory()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                        </div>
                    </div>
                `;
            }

            window.updateInventoryItem = async function(itemId) {
                if (!userId) return;
                const updatedData = {
                    name: document.getElementById(`edit-name-${itemId}`).value,
                    qty: parseFloat(document.getElementById(`edit-qty-${itemId}`).value),
                    unit: document.getElementById(`edit-unit-${itemId}`).value,
                    price: parseFloat(document.getElementById(`edit-price-${itemId}`).value),
                    expirationDate: document.getElementById(`edit-date-${itemId}`).value || null,
                    category: document.getElementById(`edit-category-${itemId}`).value
                };
                if (!updatedData.name || isNaN(updatedData.qty) || isNaN(updatedData.price)) {
                    showToast("Invalid input. Please check all fields.", "error");
                    return;
                }
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemId);
                    await updateDoc(itemDocRef, updatedData);
                    showToast("Item updated!", "success");
                    renderInventory(); // Belangrijk: vernieuw de lijst na het opslaan
                } catch (error) {
                    console.error("Error updating item:", error);
                    showToast("Could not update item.", "error");
                }
            }

            // --- NIEUWE HERBRUIKBARE FUNCTIE ---
            window.performInventoryDeduction = async function(ingredientsArray) {
                if (!userId || !ingredientsArray || ingredientsArray.length === 0) {
                    showToast("No ingredients to deduct.", "info");
                    return;
                }

                const batch = writeBatch(db);
                let updatesMade = 0;
                let notFound = [];

                ingredientsArray.forEach(req => {
                    const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
                    const requestedQuantity = parseFloat(req.quantity || req.actualQty); // Werkt voor beide formaten
                    
                    if (isNaN(requestedQuantity) || requestedQuantity <= 0) {
                        return; // Sla items over zonder geldige hoeveelheid
                    }

                    if (invItem) {
                        // Converteer eenheden indien nodig (basis-aanname, kan complexer)
                        // Voor nu gaan we uit van overeenkomende eenheden.
                        const newQty = invItem.qty - requestedQuantity;
                        
                        if (newQty >= 0) {
                            const itemDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'inventory', invItem.id);
                            batch.update(itemDocRef, { qty: newQty });
                            updatesMade++;
                        } else {
                            notFound.push(`${req.name} (not enough stock: need ${requestedQuantity}, have ${invItem.qty})`);
                        }
                    } else {
                        notFound.push(`${req.name} (not found in inventory)`);
                    }
                });

                if (updatesMade > 0) {
                    try {
                        await batch.commit();
                        let message = `${updatesMade} ingredient(s) deducted from your inventory.`;
                        if (notFound.length > 0) {
                            message += `\nCould not deduct: ${notFound.join(', ')}.`;
                        }
                        showToast(message, 'success', 6000);
                    } catch (error) {
                        console.error("Error updating inventory:", error);
                        showToast("An error occurred while updating the inventory.", 'error');
                    }
                } else if (notFound.length > 0) {
                    showToast(`Could not deduct items: \n- ${notFound.join('\n- ')}`, 'error', 6000);
                } else {
                    showToast("No ingredients were deducted.", "info");
                }
            }

            window.deductActualsFromInventory = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) {
                    showToast("Could not find brew.", "error");
                    return;
                }

                // Haal de data uit de DOM, niet uit de (mogelijk verouderde) 'brew' variabele
                const logData = getLogDataFromDOM('brew-day-content');
                const actualIngredients = logData.actualIngredients;

                if (!actualIngredients || actualIngredients.length === 0) {
                    showToast("No 'Actual Ingredients' data found. Click 'Save Log Changes' first.", "error", 6000);
                    return;
                }

                if (confirm(`This will deduct the *exact* amounts from the 'Actuals' log for "${brew.recipeName}" from your inventory. This cannot be undone. Continue?`)) {
                    // Hernoem de 'actualQty' sleutel naar 'quantity' zodat de deductie-functie het begrijpt
                    const ingredientsToDeduct = actualIngredients.map(item => ({
                        name: item.name,
                        quantity: item.actualQty,
                        unit: item.actualUnit
                    }));
                    
                    window.performInventoryDeduction(ingredientsToDeduct);
                }
            }

            // --- Automatische Inventaris Update Functies ---
            function promptToUpdateInventory(markdown) {
                if (confirm("Recipe saved! Do you want to automatically deduct the used ingredients from your inventory?")) {
                    updateInventoryFromRecipe(markdown);
                }
            }

            window.updateInventoryFromRecipe = async function(markdown) {
                const requiredIngredients = parseIngredientsFromMarkdown(markdown);
                if (requiredIngredients.length === 0) {
                    showToast("No ingredients found in recipe to deduct.", "error");
                    return;
                }
                
                // Roep de nieuwe, herbruikbare functie aan
                await window.performInventoryDeduction(requiredIngredients);
            }

            // --- Equipment Profile Functions ---
            async function addEquipmentProfile(e) {
                e.preventDefault();
                if (!userId) return;
                const name = document.getElementById('equipProfileName').value;
                const type = document.getElementById('equipProfileType').value;
                const quantity = parseInt(document.getElementById('equipProfileQuantity').value) || 1;
                const capacityLiters = parseFloat(document.getElementById('equipCapacityLiters').value) || null;
                const trubLossLiters = parseFloat(document.getElementById('trubLossLiters').value) || 0;
                const boilOffRateLitersPerHour = (type === 'Kettle') ? parseFloat(document.getElementById('boilOffRateLitersPerHour').value) || 0 : 0;
                if (!name) {
                    showToast("Profile Name is required.", "error");
                    return;
                }
                const profileData = { userId, name, type, quantity, capacityLiters, trubLossLiters, boilOffRateLitersPerHour };
                try {
                    const appId = 'meandery-aa05e';
                    const equipCol = collection(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles');
                    await addDoc(equipCol, profileData);
                    document.getElementById('equipment-profile-form').reset();
                    document.getElementById('equipProfileQuantity').value = 1;
                    handleEquipmentTypeChange();
                    showToast("Equipment profile added!", "success");
                } catch (error) {
                    console.error("Error adding equipment profile:", error);
                    showToast("Could not add profile.", "error");
                }
            }

            function loadEquipmentProfiles() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const equipCol = collection(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles');
                const q = query(equipCol);

                onSnapshot(q, (snapshot) => {
                    equipmentProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEquipmentProfiles();
                    populateEquipmentProfilesDropdown();
                }, (error) => {
                    console.error("Error loading equipment profiles: ", error);
                    document.getElementById('equipment-profiles-list').innerHTML = `<p class="text-red-500">Could not load equipment profiles.</p>`;
                });
            }

            window.renderEquipmentProfiles = function() {
                const listDiv = document.getElementById('equipment-profiles-list');
                if (equipmentProfiles.length === 0) {
                    listDiv.innerHTML = `<p class="text-center text-app-secondary/80">You have no saved equipment profiles. Add one to get started!</p>`;
                    return;
                }
                
                listDiv.innerHTML = equipmentProfiles.map(p => `
                    <div id="equip-item-${p.id}" class="p-3 card rounded-md mb-2">
                        <div class="flex justify-between items-center">
                             <div class="flex-grow">
                                <p class="font-bold">${p.name} <span class="text-sm font-normal text-app-secondary/80">(${p.type})</span></p>
                                <p class="text-sm text-app-secondary">Capacity: ${p.capacityLiters || 'N/A'}L | Trub Loss: ${p.trubLossLiters || 0}L ${p.type === 'Kettle' ? `| Boil-off: ${p.boilOffRateLitersPerHour || 0}L/hr` : ''}</p>
                            </div>
                            <div class="flex items-center gap-4 flex-shrink-0 ml-4">
                                <span class="font-semibold">${p.quantity || 1}x in stock</span>
                                <div class="flex gap-2">
                                    <button onclick="window.editEquipmentProfile('${p.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Edit</button>
                                    <button onclick="window.deleteEquipmentProfile('${p.id}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
           window.editEquipmentProfile = function(profileId) {
                const p = equipmentProfiles.find(i => i.id === profileId);
                if (!p) return;

                const itemDiv = document.getElementById(`equip-item-${profileId}`);
                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="text" id="edit-equip-name-${p.id}" value="${p.name}" placeholder="Name" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-quantity-${p.id}" value="${p.quantity || 1}" min="1" placeholder="Aantal" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="number" id="edit-equip-cap-${p.id}" value="${p.capacityLiters || ''}" placeholder="Capacity (L)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-trub-${p.id}" value="${p.trubLossLiters || '0'}" placeholder="Trub Loss (L)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-boiloff-${p.id}" value="${p.boilOffRateLitersPerHour || '0'}" placeholder="Boil-off (L/hr)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary ${p.type !== 'Kettle' ? 'hidden' : ''}">
                            <div class="flex gap-2 col-span-2 md:col-span-1">
                                <button onclick="window.updateEquipmentProfile('${p.id}', '${p.type}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                                <button onclick="renderEquipmentProfiles()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            window.updateEquipmentProfile = async function(profileId, type) {
                if (!userId) return;
                const updatedData = {
                    name: document.getElementById(`edit-equip-name-${profileId}`).value,
                    quantity: parseInt(document.getElementById(`edit-equip-quantity-${profileId}`).value) || 1,
                    capacityLiters: parseFloat(document.getElementById(`edit-equip-cap-${profileId}`).value) || null,
                    trubLossLiters: parseFloat(document.getElementById(`edit-equip-trub-${profileId}`).value) || 0,
                    boilOffRateLitersPerHour: (type === 'Kettle') ? parseFloat(document.getElementById(`edit-equip-boiloff-${profileId}`).value) || 0 : 0
                };

                if (!updatedData.name) {
                    showToast("Profile name cannot be empty.", "error");
                    return;
                }

                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles', profileId);
                    await updateDoc(itemDocRef, updatedData);
                    showToast("Equipment profile updated!", "success");
                    renderEquipmentProfiles(); // Belangrijk: vernieuw de lijst
                } catch (error) {
                    console.error("Error updating equipment profile:", error);
                    showToast("Could not update profile.", "error");
                }
            }

            window.deleteEquipmentProfile = async function(profileId) {
                if (!userId) return;
                if (!confirm('Are you sure you want to delete this equipment profile?')) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles', profileId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting equipment profile:", error);
                }
            }
            
            function handleEquipmentTypeChange() {
                 const type = document.getElementById('equipProfileType').value;
                 document.getElementById('boil-off-rate-container').classList.toggle('hidden', type !== 'Kettle');
            }

            function populateEquipmentProfilesDropdown() {
                const select = document.getElementById('equipmentProfileSelect');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">None (Use default values)</option>'; // Reset
                
                equipmentProfiles.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
                select.value = currentValue; // Probeer de selectie te behouden
            }

            // --- Cellar Functions ---

            function loadCellar() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const cellarCol = collection(db, 'artifacts', appId, 'users', userId, 'cellar');
                const q = query(cellarCol);

                onSnapshot(q, (snapshot) => {
                    cellar = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sorteer op botteldatum, nieuwste eerst
                    if (cellar.length > 0 && cellar[0].bottlingDate) {
                        cellar.sort((a, b) => b.bottlingDate.toDate() - a.bottlingDate.toDate());
                    }
                    renderCellar();
                    updateNextActionWidget();
                    updateDashboardStats();
                }, (error) => {
                    console.error("Error loading cellar: ", error);
                    document.getElementById('cellar-list').innerHTML = `<p class="text-red-500">Could not load cellar.</p>`;
                });
            }

            function renderCellar() {
    const listDiv = document.getElementById('cellar-list');
    const currency = userSettings.currencySymbol || '';

    if (cellar.length === 0) {
        listDiv.innerHTML = `<p class="text-center text-app-secondary/80">Your cellar is empty. Bottle a batch from your history to add it here!</p>`;
        return;
    }
    
    const packagingCostsPerUnit = getPackagingCosts();

    listDiv.innerHTML = cellar.map(item => {
        const originalBrew = brews.find(b => b.id === item.brewId);
        const escapedRecipeName = item.recipeName.replace(/'/g, "\\'");
        const originalBatchSize = originalBrew ? originalBrew.batchSize : 1; // Fallback
        const ingredientCostPerLiter = originalBatchSize > 0 ? (item.ingredientCost || 0) / originalBatchSize : 0;

        const bottlingDateStr = item.bottlingDate ? item.bottlingDate.toDate().toLocaleDateString() : 'No date';

        const bottleDetailsHtml = (item.bottles && Array.isArray(item.bottles)) ? item.bottles.map(b => {
            const meadCostInBottle = ingredientCostPerLiter * (b.size / 1000);
            
            let closureCost = 0;
            if (b.size >= 750) { closureCost = packagingCostsPerUnit.cork || 0; } 
            else if (b.size >= 500) { closureCost = packagingCostsPerUnit.crown_cap_29 || 0; } 
            else { closureCost = packagingCostsPerUnit.crown_cap_26 || 0; }
            
            const bottleCost = packagingCostsPerUnit[b.size.toString()] || 0;
            const labelCost = packagingCostsPerUnit.label || 0;
            const finalCostPerBottle = meadCostInBottle + bottleCost + closureCost + labelCost;
            const costText = finalCostPerBottle > 0 ? `<span class="font-bold">${currency}${finalCostPerBottle.toFixed(2)}/st</span>` : '';

            return `
            <div class="flex items-center justify-between text-sm py-1">
                <span>${b.quantity} x ${b.size}ml</span>
                <div class="flex items-center gap-4">
                    ${costText}
                    <button onclick="window.consumeBottle('${item.id}', ${b.size})" class="text-xs bg-app-action text-white px-2 py-1 rounded hover:opacity-80 btn">-1 Bottle</button>
                </div>
            </div>`;
        }).join('') : `<p class="text-sm">Bottle data not available.</p>`;
        
        const totalBottlesInBatch = item.bottles.reduce((acc, b) => acc + b.quantity, 0);

        const adviceHtml = item.peakFlavorDate ? `
            <div class="mt-3 pt-3 border-t border-app">
                <p class="text-sm font-bold text-app-primary">Aging Advice:</p>
                <p class="text-sm text-app-secondary/90">
                    <span class="font-semibold">Peak Flavor around: ${item.peakFlavorDate}.</span> ${item.peakFlavorJustification || ''}
                </p>
            </div> ` : '';

        return `
        <div class="p-4 card rounded-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-lg font-header">${item.recipeName}</h4>
                    <p class="text-sm text-app-secondary">Bottled on: ${bottlingDateStr}</p>
                </div>
                <div class="text-right flex-shrink-0 ml-4">
                    <p class="text-2xl font-bold text-app-brand">${totalBottlesInBatch} <span class="text-base font-normal">total</span></p>
                </div>
            </div>
            <div class="mt-3 space-y-2">${bottleDetailsHtml}</div>
            ${adviceHtml}
            <div class="text-right mt-3 border-t border-app pt-2 flex justify-end items-center gap-4">
                 <button onclick="window.setTastingReminder('${item.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold">Set Reminder</button>
                 <button onclick="window.deleteCellarItem('${item.id}', '${escapedRecipeName}')" class="text-red-600 hover:text-red-800 text-xs font-semibold">Delete Batch</button>
            </div>
        </div>
        `;
    }).join('');
}

            // --- Kalender Herinnering Functies ---
            window.setTastingReminder = function(cellarItemId) {
                const item = cellar.find(c => c.id === cellarItemId);
                if (!item) return;

                const months = prompt(`Set a tasting reminder for "${item.recipeName}".\n\nIn how many months from today?`, "6");
                if (months === null || isNaN(parseInt(months)) || parseInt(months) <= 0) {
                    return; // Gebruiker annuleert of geeft ongeldige invoer
                }

                const reminderDate = new Date();
                reminderDate.setMonth(reminderDate.getMonth() + parseInt(months));
                
                generateAndDownloadIcs(item, reminderDate);
            }

            function generateAndDownloadIcs(item, date) {
                // Formatteer de datum naar UTC (vereist voor .ics bestanden)
                const toICSFormat = (d) => {
                    return d.getUTCFullYear() + 
                           ('0' + (d.getUTCMonth() + 1)).slice(-2) + 
                           ('0' + d.getUTCDate()).slice(-2) + 'T' +
                           ('0' + d.getUTCHours()).slice(-2) +
                           ('0' + d.getUTCMinutes()).slice(-2) +
                           ('0' + d.getUTCSeconds()).slice(-2) + 'Z';
                }

                const eventStart = toICSFormat(date);
                const eventStamp = toICSFormat(new Date());

                // Bouw de inhoud van het .ics bestand
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'BEGIN:VEVENT',
                    `UID:${Date.now()}@meandery.app`,
                    `DTSTAMP:${eventStamp}`,
                    `DTSTART;VALUE=DATE:${eventStart.substring(0,8)}`, // We maken er een "hele dag" evenement van
                    `SUMMARY:Tasting Reminder: ${item.recipeName}`,
                    'DESCRIPTION:Time to taste your aged mead from the MEA(N)DERY app! Notes: How is the aroma, clarity, and flavor? Has it mellowed out?',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                // Maak en download het bestand
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Tasting_Reminder_${item.recipeName.replace(/\s/g, '_')}.ics`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // --- Barcode Scanner Functies ---
            function startScanner() {
                document.getElementById('barcode-scanner-container').classList.remove('hidden');

                html5QrcodeScanner = new Html5Qrcode("barcode-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 150 } };

                html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
                     .catch(err => {
                         console.error("Unable to start scanning.", err);
                         alert("Could not start camera. Please grant camera permissions.");
                     });
            }

            function stopScanner() {
                if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                    html5QrcodeScanner.stop().then(() => {
                        document.getElementById('barcode-scanner-container').classList.add('hidden');
                    }).catch(err => console.error("Error stopping scanner:", err));
                } else {
                     document.getElementById('barcode-scanner-container').classList.add('hidden');
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                // Stop de scanner onmiddellijk na een succesvolle scan
                stopScanner();

                // Vraag de productinformatie op
                fetchProductInfo(decodedText);
            }

            async function fetchProductInfo(barcode) {
                const itemNameInput = document.getElementById('itemName');
                const originalPlaceholder = itemNameInput.placeholder;
                itemNameInput.value = '';
                itemNameInput.placeholder = 'Looking up barcode...';

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                    if (!response.ok) throw new Error("Product not found in the database.");

                    const data = await response.json();

                    if (data.status === 1 && data.product && data.product.product_name) {
                        itemNameInput.value = data.product.product_name;
                    } else {
                        throw new Error("Product not found in the database.");
                    }
               } catch (error) {
                   console.error("Barcode lookup failed:", error);
                   alert(error.message);
               } finally {
                   itemNameInput.placeholder = originalPlaceholder;
               }
            }

            window.consumeBottle = async function(cellarItemId, bottleSize) {
                if (!userId) return;

                const cellarItemRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar', cellarItemId);
                
                try {
                    // Haal het huidige document op
                    const docSnap = await getDoc(cellarItemRef);
                    if (!docSnap.exists()) {
                        console.error("Cellar item not found!");
                        return;
                    }

                    const itemData = docSnap.data();
                    const bottles = itemData.bottles;

                    // Vind de juiste flesmaat en verminder de hoeveelheid
                    const bottleIndex = bottles.findIndex(b => b.size == bottleSize);
                    if (bottleIndex > -1 && bottles[bottleIndex].quantity > 0) {
                        bottles[bottleIndex].quantity -= 1;

                        // Optioneel: verwijder de flesmaat als de hoeveelheid 0 is
                        const updatedBottles = bottles.filter(b => b.quantity > 0);
                        
                        // Update het document in Firestore
                        await updateDoc(cellarItemRef, { bottles: updatedBottles });
                    } else {
                        alert("Bottle size not found or quantity is already 0.");
                    }
                } catch (error) {
                    console.error("Error consuming bottle: ", error);
                }
            }

            window.deleteCellarItem = async function(itemId, recipeName) {
                if (!userId) return;
                if (!confirm(`Are you sure you want to delete the entire batch of '${recipeName}' from your cellar? This cannot be undone.`)) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'cellar', itemId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting cellar item:", error);
                }
            }


            // --- Functies voor het bottel-proces ---

            let currentBrewToBottleId = null; 

            window.showBottlingModal = function(brewId) {
                customBottles = []; // Reset de lijst
                renderCustomBottlesList(); // Maak de UI leeg
                currentBrewToBottleId = brewId;
                const bottlingForm = document.getElementById('bottling-form');
                bottlingForm.reset();
                document.getElementById('bottlingDate').valueAsDate = new Date();
                document.getElementById('bottling-modal').classList.remove('hidden');
            }

            window.hideBottlingModal = function() {
                document.getElementById('bottling-modal').classList.add('hidden');
                currentBrewToBottleId = null;
            }

async function bottleBatch(e) {
    e.preventDefault();
    if (!currentBrewToBottleId) return;

    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<div class="loader" style="height:20px; width:20px; border-width: 2px; margin: 0 auto;"></div>';

    try {
        const originalBrew = brews.find(b => b.id === currentBrewToBottleId);
        if (!originalBrew) throw new Error("Could not find the original recipe to bottle.");

        const bottlesData = [
            { size: 750, quantity: parseInt(document.getElementById('qty750').value) || 0, price: null },
            { size: 500, quantity: parseInt(document.getElementById('qty500').value) || 0, price: null },
            { size: 330, quantity: parseInt(document.getElementById('qty330').value) || 0, price: null },
            { size: 250, quantity: parseInt(document.getElementById('qty250').value) || 0, price: null },
            ...customBottles
        ].filter(b => b.quantity > 0 && b.size > 0);

        if (bottlesData.length === 0) throw new Error("Please enter a quantity for at least one bottle size.");

        const closureType = document.getElementById('closureTypeSelect').value;
        const outOfStockItems = [];
        let totalBottles = 0;

        bottlesData.forEach(bottle => {
            totalBottles += bottle.quantity;
            if (bottle.price === null) {
                const stockId = `bottle_${bottle.size}`;
                const currentStock = packagingCosts[stockId]?.qty || 0;
                if (bottle.quantity > currentStock) {
                    outOfStockItems.push(`${bottle.quantity} x ${bottle.size}ml bottle(s) (only ${currentStock} in stock)`);
                }
            }
        })

        if (closureType === 'auto') {
            const closuresNeeded = { cork: 0, crown_cap_26: 0, crown_cap_29: 0 };
            bottlesData.forEach(b => {
                if (b.size >= 750) closuresNeeded.cork += b.quantity;
                else if (b.size >= 500) closuresNeeded.crown_cap_29 += b.quantity;
                else closuresNeeded.crown_cap_26 += b.quantity;
            });
            if (closuresNeeded.cork > (packagingCosts['cork']?.qty || 0)) outOfStockItems.push(`Not enough corks (needed: ${closuresNeeded.cork})`);
            if (closuresNeeded.crown_cap_26 > (packagingCosts['crown_cap_26']?.qty || 0)) outOfStockItems.push(`Not enough 26mm caps (needed: ${closuresNeeded.crown_cap_26})`);
            if (closuresNeeded.crown_cap_29 > (packagingCosts['crown_cap_29']?.qty || 0)) outOfStockItems.push(`Not enough 29mm caps (needed: ${closuresNeeded.crown_cap_29})`);
        } else {
            const needed = totalBottles;
            const inStock = packagingCosts[closureType]?.qty || 0;
            if (needed > inStock) {
                outOfStockItems.push(`${needed} x ${closureType.replace(/_/g, ' ')} (only ${inStock} in stock)`);
            }
        }

        const currentLabelStock = packagingCosts['label']?.qty || 0;
        if (totalBottles > currentLabelStock) outOfStockItems.push(`${totalBottles} label(s) (only ${currentLabelStock} in stock)`);

        if (outOfStockItems.length > 0) {
            throw new Error(`Not enough stock. Missing:\n- ${outOfStockItems.join('\n- ')}`);
        }

        const packagingCostsPerUnit = getPackagingCosts();
        let totalPackagingCost = 0;

        bottlesData.forEach(bottle => {
            const bottleCost = bottle.price !== null ? bottle.price : (packagingCostsPerUnit[bottle.size.toString()] || 0);
            let closureCost = 0;

            if (closureType === 'auto') {
                if (bottle.size >= 750) { closureCost = packagingCostsPerUnit.cork || 0; }
                else if (bottle.size >= 500) { closureCost = packagingCostsPerUnit.crown_cap_29 || 0; }
                else { closureCost = packagingCostsPerUnit.crown_cap_26 || 0; }
            } else {
                closureCost = packagingCostsPerUnit[closureType] || 0;
            }

            const labelCost = packagingCostsPerUnit.label || 0;
            totalPackagingCost += bottle.quantity * (bottleCost + closureCost + labelCost);
        });

        const ingredientCost = originalBrew.totalCost || 0;
        if (ingredientCost === 0) {
           showToast("Warning: The ingredient cost for this batch is 0.00. The total cost may be inaccurate. You can try recalculating it from the History view.", "error", 8000);
        }
        let finalTotalCost = ingredientCost + totalPackagingCost;

        if (confirm(`The calculated packaging cost is ${userSettings.currencySymbol || ''}${totalPackagingCost.toFixed(2)}. The new total batch cost will be ${userSettings.currencySymbol || ''}${finalTotalCost.toFixed(2)}. Do you want to continue?`)) {
            const updatedPackagingStock = JSON.parse(JSON.stringify(packagingCosts));

            const deductFromStock = (stock, itemId, quantity) => {
                if (stock[itemId] && stock[itemId].qty > 0) {
                    const costPerUnit = stock[itemId].price / stock[itemId].qty;
                    const costToDeduct = costPerUnit * quantity;
                    
                    stock[itemId].qty -= quantity;
                    stock[itemId].price -= costToDeduct;

                    if (stock[itemId].qty <= 0) {
                        stock[itemId].qty = 0;
                        stock[itemId].price = 0;
                    }
                }
            };

            bottlesData.forEach(bottle => {
                if(bottle.price === null) {
                    deductFromStock(updatedPackagingStock, `bottle_${bottle.size}`, bottle.quantity);
                }
            });

            if (closureType === 'auto') {
                 bottlesData.forEach(bottle => {
                    let closureId;
                    if (bottle.size >= 750) { closureId = 'cork'; }
                    else if (bottle.size >= 500) { closureId = 'crown_cap_29'; }
                    else { closureId = 'crown_cap_26'; }
                    deductFromStock(updatedPackagingStock, closureId, bottle.quantity);
                 });
            } else {
                deductFromStock(updatedPackagingStock, closureType, totalBottles);
            }
            deductFromStock(updatedPackagingStock, 'label', totalBottles);

            const appId = 'meandery-aa05e';
            const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'packaging');
            await setDoc(settingsDocRef, updatedPackagingStock);
            packagingCosts = updatedPackagingStock;

            const bottlingDate = new Date(document.getElementById('bottlingDate').value);
            const cellarData = {
                userId: userId,
                brewId: currentBrewToBottleId,
                recipeName: originalBrew.recipeName,
                bottlingDate: bottlingDate,
                bottles: bottlesData.map(({price, ...rest}) => rest),
                totalBatchCost: finalTotalCost,
                ingredientCost: originalBrew.totalCost || 0,
                peakFlavorDate: null,
                peakFlavorJustification: 'Advice could not be generated.'
            };

            try {
                const logSummary = `
                    - Target OG: ${originalBrew.logData.targetOG}, Actual OG: ${originalBrew.logData.actualOG}
                    - Target FG: ${originalBrew.logData.targetFG}, Actual FG: ${originalBrew.logData.actualFG}
                    - Final ABV: ${originalBrew.logData.finalABV}
                    - Fermentation notes: ${JSON.stringify(originalBrew.logData.fermentationLog)}
                `;

                const agingPrompt = `You are an expert mead maker and keldermeester. Analyze the journey of the following mead from recipe to bottling and provide a definitive cellaring note. Pay close attention to any deviations between the target and actual values.

                Original Recipe:
                ---
                ${originalBrew.recipeMarkdown}
                ---

                Brewmaster's Log Summary:
                ---
                ${logSummary}
                ---

                The mead was bottled on: ${bottlingDate.toISOString().split('T')[0]}.

                Based on all this data, provide a single, expert "Cellaring Note:" explaining the aging potential and a recommended peak drinking window. Your entire response should be just the note itself, starting with "This mead...".`;

                const definitiveAdvice = await performApiCall(agingPrompt);
                cellarData.peakFlavorJustification = definitiveAdvice.trim();

            } catch (aiError) {
                console.error("Definitive aging advice failed, but bottling will continue:", aiError);
            }

            const cellarCol = collection(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar');
            await addDoc(cellarCol, cellarData);

            const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', currentBrewToBottleId);
            await updateDoc(brewDocRef, { isBottled: true });

            const brewIndex = brews.findIndex(b => b.id === currentBrewToBottleId);
            if (brewIndex > -1) {
                brews[brewIndex].isBottled = true;
            }

            if (currentBrewDay.brewId === currentBrewToBottleId) {
                currentBrewDay = { brewId: null, checklist: {} };
                await saveUserSettings();
            }

            renderBrewDay2();
            renderHistoryList();
            renderBrewDay('none');

            hideBottlingModal();
            showToast("Batch bottled and added to cellar!", "success");
            switchMainView('management');
            switchSubView('cellar', 'management-main-view');
        } else {
             throw new Error("Bottling cancelled by user.");
        }
    } catch (error) {
        console.error("Error during bottling process: ", error);
        showToast(error.message, "error");
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
    }
}

            // --- Calculator Functions ---
            function calculateABV() {
                const og = parseFloat(document.getElementById('og').value);
                const fg = parseFloat(document.getElementById('fg').value);
                const resultDiv = document.getElementById('abvResult');
                if (og && fg && og > fg) {
                    const abv = (og - fg) * 131.25;
                    resultDiv.textContent = `ABV: ${abv.toFixed(2)}%`;
                } else {
                    resultDiv.textContent = 'Invalid Input';
                }
            }

            function correctHydrometer() {
                const sg = parseFloat(document.getElementById('sgReading').value);
                const t = parseFloat(document.getElementById('tempReading').value);
                const c = parseFloat(document.getElementById('calTemp').value);
                const resultDiv = document.getElementById('sgResult');

                if (isNaN(sg) || isNaN(t) || isNaN(c)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // Formula for hydrometer correction
                const correctedSg = sg * ((1.00130346 - 0.000134722124 * t + 0.00000204052596 * t**2 - 0.00000000232820948 * t**3) / (1.00130346 - 0.000134722124 * c + 0.00000204052596 * c**2 - 0.00000000232820948 * c**3));
                resultDiv.textContent = `Corrected: ${correctedSg.toFixed(3)}`;
            }

            function calculatePrimingSugar() {
                const vol = parseFloat(document.getElementById('carbVol').value);
                const temp = parseFloat(document.getElementById('carbTemp').value);
                const size = parseFloat(document.getElementById('carbBatchSize').value);
                const resultDiv = document.getElementById('sugarResult');

                if (isNaN(vol) || isNaN(temp) || isNaN(size)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // Formula for priming sugar (sucrose)
                const sugarGrams = (vol - (3.0378 - 0.050062 * temp + 0.00026555 * temp**2)) * 4 * size;
                resultDiv.textContent = `${sugarGrams.toFixed(1)} g sugar`;
            }
            
            function calculateBlend() {
                const vol1 = parseFloat(document.getElementById('vol1').value);
                const sg1 = parseFloat(document.getElementById('sg1').value);
                const vol2 = parseFloat(document.getElementById('vol2').value);
                const sg2 = parseFloat(document.getElementById('sg2').value);
                const resultDiv = document.getElementById('blendResult');

                if (isNaN(vol1) || isNaN(sg1) || isNaN(vol2) || isNaN(sg2)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }

                const totalVolume = vol1 + vol2;
                const finalSG = (((vol1 * (sg1 - 1)) + (vol2 * (sg2 - 1))) / totalVolume) + 1;
                
                resultDiv.textContent = `Final: ${totalVolume.toFixed(2)}L at ${finalSG.toFixed(3)} SG`;
            }

            function calculateBacksweetening() {
                const vol = parseFloat(document.getElementById('bs_current_vol').value);
                const currentSg = parseFloat(document.getElementById('bs_current_sg').value);
                const targetSg = parseFloat(document.getElementById('bs_target_sg').value);
                const resultDiv = document.getElementById('backsweetenResult');

                if (isNaN(vol) || isNaN(currentSg) || isNaN(targetSg) || targetSg <= currentSg) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }

                // Honing voegt ongeveer 35 zwaartekrachtpunten per pond per gallon toe.
                // 1 pond = 453.6g; 1 gallon = 3.785L.
                // Dit komt neer op ongeveer 120g/L voor 35 punten, of 3.4g/L per punt (0.001 SG).
                const pointsToAdd = (targetSg - currentSg) * 1000;
                const honeyGrams = pointsToAdd * 3.4 * vol;
                const honeyKg = honeyGrams / 1000;

                resultDiv.textContent = `Add ${honeyGrams.toFixed(0)}g (${honeyKg.toFixed(2)}kg) honey`;
            }

            function calculateDilution() {
                const startVol = parseFloat(document.getElementById('dil_start_vol').value);
                const startSg = parseFloat(document.getElementById('dil_start_sg').value);
                const targetSg = parseFloat(document.getElementById('dil_target_sg').value);
                const resultDiv = document.getElementById('dilutionResult');

                if (isNaN(startVol) || isNaN(startSg) || isNaN(targetSg) || startSg <= targetSg) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // (V1 * G1) = (V2 * G2) => V_add = V1 * (G1 - G2) / (G2 - 1)
                const startPoints = startSg * 1000 - 1000;
                const targetPoints = targetSg * 1000 - 1000;
                const waterToAdd = startVol * (startPoints / targetPoints - 1);
                
                resultDiv.textContent = `Add ${waterToAdd.toFixed(2)}L water`;
            }

            function calculateTOSNA() {
                const og = parseFloat(document.getElementById('tosna_og').value);
                const vol = parseFloat(document.getElementById('tosna_vol').value);
                const yeastNeed = document.getElementById('tosna_yeast').value;
                const resultDiv = document.getElementById('tosnaResult');

                if (isNaN(og) || isNaN(vol)) {
                    resultDiv.innerHTML = `<p class="text-red-500">Invalid Input</p>`;
                    return;
                }

                // YAN (mg/L or ppm) = (2.7 * Brix) - 13.5  ; Brix = SG_points / 4
                const brix = (og * 1000 - 1000) / 4;
                let targetYAN;
                if (yeastNeed === 'low') targetYAN = 20 * brix;
                else if (yeastNeed === 'medium') targetYAN = 25 * brix;
                else targetYAN = 35 * brix;
                
                // Fermaid-O is ~40mg YAN/gram.
                const totalFermaidO = (targetYAN / 40) * vol;
                const addition = totalFermaidO / 4;

                resultDiv.innerHTML = `
                    <h4 class="font-bold text-lg">TOSNA 2.0 Schedule</h4>
                    <p><strong>Total Fermaid-O needed:</strong> ${totalFermaidO.toFixed(2)} grams.</p>
                    <ul class="list-disc pl-5 mt-2">
                        <li><strong>24 Hours:</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                        <li><strong>48 Hours:</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                        <li><strong>72 Hours:</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                        <li><strong>1/3 Sugar Break (or Day 7):</strong> Add ${addition.toFixed(2)}g Fermaid-O</li>
                    </ul>
                `;
            }

            window.linkToBacksweetenCalc = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew || !brew.logData) return;

                // Navigeer naar de calculators tab
                switchMainView('tools');
                switchSubView('calculators', 'tools-main-view');

                // Vul de waarden in
                document.getElementById('bs_current_vol').value = brew.batchSize || '';
                document.getElementById('bs_current_sg').value = brew.logData.actualFG || brew.logData.targetFG || '';
                
                // Scroll naar de calculator
                document.getElementById('bs_current_vol').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            window.linkToDilutionCalc = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew || !brew.logData) return;

                // Navigeer naar de calculators tab
                switchMainView('tools');
                switchSubView('calculators', 'tools-main-view');
                
                // Vul de waarden in
                document.getElementById('dil_start_vol').value = brew.batchSize || '';
                document.getElementById('dil_start_sg').value = brew.logData.actualOG || brew.logData.targetOG || '';
                
                // Scroll naar de calculator
                document.getElementById('dil_start_vol').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async function getYeastAdvice() {
                const og = document.getElementById('starterOG').value;
                const yeastDate = document.getElementById('yeastDate').value;
                const yeastType = document.getElementById('yeastType').value;
                const adviceOutput = document.getElementById('yeast-advice-output');

                if (!og || !yeastDate) {
                    adviceOutput.innerHTML = `<p class="text-red-500">Please enter both Starting Gravity and Yeast Date.</p>`;
                    return;
                }
                adviceOutput.innerHTML = '<div class="loader"></div>';

                const prompt = `You are a yeast expert. A homebrewer is making a mead with a starting gravity of ${og}. Their ${yeastType} yeast packet has a production date of ${yeastDate}. Today's date is ${new Date().toISOString().split('T')[0]}. Based on this, tell them if a yeast starter is necessary. If it is, provide a simple, step-by-step guide for making an appropriate starter for a 5-liter batch. Format the response in Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    adviceOutput.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting yeast advice:", error);
                    adviceOutput.innerHTML = `<p class="text-center text-red-500">Could not get yeast advice: ${error.message}</p>`;
                }
            }

            // --- Water Chemistry Functions ---
            const waterData = {
                spa: { ca: 5, mg: 2, na: 3, so4: 4, cl: 5, hco3: 17 },
                chaudfontaine: { ca: 65, mg: 18, na: 44, so4: 40, cl: 35, hco3: 305 },
                valvert: { ca: 68, mg: 2, na: 2, so4: 18, cl: 4, hco3: 204 },
                bru: { ca: 23.3, mg: 22.2, na: 8, so4: 5, cl: 4, hco3: 209 },
                villers: { ca: 106.1, mg: 11.1, na: 8, so4: 48.8, cl: 19.9, hco3: 340.4 }
            };

            function handleWaterSourceChange() {
                const select = document.getElementById('waterSource');
                const selectedValue = select.value;
                const [type, id] = selectedValue.split('_');

                let profile;
                if (type === 'builtin') {
                   profile = BUILT_IN_WATER_PROFILES[id];
                } else if (type === 'user') {
                   profile = userWaterProfiles.find(p => p.id === id);
                }  

                if (profile) {
                   currentWaterProfile = profile;
                   updateWaterProfileDisplay(profile);
                }
            }

            // VOEG DEZE KLEINE HELPER-FUNCTIE TOE
            function updateWaterProfileDisplay(profile) {
                document.getElementById('val-ca').textContent = profile.ca;
                document.getElementById('val-mg').textContent = profile.mg;
                document.getElementById('val-na').textContent = profile.na;
                document.getElementById('val-so4').textContent = profile.so4;
                document.getElementById('val-cl').textContent = profile.cl;
                document.getElementById('val-hco3').textContent = profile.hco3;
            }

            async function getWaterAdvice() {
                if (!currentWaterProfile) {
                    document.getElementById('water-advice-output').innerHTML = `<p class="text-center text-red-500">Please fetch or apply a water profile first.</p>`;
                    return;
                }
                
                const adviceOutput = document.getElementById('water-advice-output');
                adviceOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Analyzing water profile...</p>';
                
                const targetProfile = document.getElementById('meadTargetProfile').selectedOptions[0].text;
                const batchSize = document.getElementById('batchSize').value;
                const waterSourceType = document.getElementById('waterSource').value;

                // --- AANGEPAST: De prompt is nu dynamisch ---
                let prompt;
                const waterProfileString = `Calcium: ${currentWaterProfile.ca}, Magnesium: ${currentWaterProfile.mg}, Sodium: ${currentWaterProfile.na}, Sulfate: ${currentWaterProfile.so4}, Chloride: ${currentWaterProfile.cl}, Bicarbonate: ${currentWaterProfile.hco3}`;

                if (waterSourceType === 'tap') {
                    prompt = `You are an expert brew chemist. A user has provided their tap water profile in mg/L: ${waterProfileString}. They want to adjust this water for a ${batchSize}-liter batch of mead with a target character of "${targetProfile}". 
                    
                    Provide specific, actionable advice. Recommend additions of brewing salts (Gypsum, Calcium Chloride, Epsom Salt, Baking Soda) in grams to achieve the target profile. Start by explaining the goal (e.g., "For a rich and full-bodied mead, we want to increase Calcium and Chloride..."). Then, list the specific salt additions required. Format the response in simple Markdown.`;
                } else {
                    prompt = `You are an expert brew chemist. A user is starting with water that has the following profile in mg/L: ${waterProfileString}. They want to brew a ${batchSize}-liter batch of mead with a target character of "${targetProfile}". 
                    
                    First, analyze the provided water profile. Is it suitable as-is for the target mead style? If so, state that. If not, recommend specific additions of brewing salts (Gypsum, Calcium Chloride, Epsom Salt) in grams to improve it. Explain WHY you are recommending these changes (e.g., "add gypsum to accentuate dryness"). Format the response in simple Markdown.`;
                }


                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    adviceOutput.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting water advice:", error);
                    adviceOutput.innerHTML = `<p class="text-center text-red-500">Could not get water advice: ${error.message}</p>`;
                }
            }

            // --- Utility Functions ---
function parseIngredientsAndCalculateCost(markdown, inventory, batchSize) {
    let totalCost = 0;
    const warnings = []; // NIEUW: Array om waarschuwingen op te slaan
    const requiredIngredients = parseIngredientsFromMarkdown(markdown);

    if (requiredIngredients.length === 0) {
        console.warn("Cost calculation: No ingredients found by the parser.");
        return { cost: 0, warnings: [] }; // AANGEPAST: Geef een object terug
    }

    const convertToBaseUnit = (quantity, unit) => {
        const u = (unit || '').toLowerCase().trim();
        
        // Standaard conversies
        if (u === 'kg') return { quantity: quantity * 1000, unit: 'g' };
        if (u === 'l' || u === 'liter' || u === 'liters') return { quantity: quantity * 1000, unit: 'ml' };
        
        // Slimme 'Packet' conversie (Aanname: 1 packet gist/voeding is vaak 5g, 10g of 11g)
        // Omdat we het niet zeker weten, proberen we het te matchen met 'items' of 'packets' in de inventory
        if (u === 'packet' || u === 'packets' || u === 'sachet' || u === 'pkg' || u === 'pack') {
            return { quantity: quantity, unit: 'packets' }; // We normaliseren alles naar 'packets'
        }
        
        // Stuks
        if (u === 'item' || u === 'items' || u === 'st' || u === 'piece' || u === 'pieces') {
             return { quantity: quantity, unit: 'items' };
        }

        return { quantity, unit: u };
    };

    requiredIngredients.forEach(req => {
        const inventoryItem = inventory.find(item => item.name.toLowerCase() === req.name.toLowerCase());
        
        if (inventoryItem && typeof inventoryItem.price === 'number' && inventoryItem.qty > 0) {
            const requiredAmountInBase = convertToBaseUnit(req.quantity, req.unit);
            const inventoryAmountInBase = convertToBaseUnit(inventoryItem.qty, inventoryItem.unit);
            
            let match = false;
            let costPerBaseUnit = 0;

            // Directe match (g == g, ml == ml)
            if (requiredAmountInBase.unit === inventoryAmountInBase.unit) {
                match = true;
                costPerBaseUnit = inventoryItem.price / inventoryAmountInBase.quantity;
            }
            // Gist packet fix: Als recept 'g' vraagt, maar inventory is 'packets' (bijv 11g packet)
            else if (requiredAmountInBase.unit === 'g' && inventoryAmountInBase.unit === 'packets') {
                // Aanname: We kunnen dit niet perfect berekenen zonder te weten hoeveel gram er in een packet zit.
                // Fallback strategie: We rekenen 1 packet als "genoeg" voor kleine hoeveelheden gists.
                // Dit is de "Luxury" trade-off: liever iets te hoog inschatten dan 0.
                match = true;
                // Stel: 1 packet kost 3 euro. Recept vraagt 5g. We rekenen de prijs van 1 heel packet.
                // Dit is veiliger voor budgettering.
                // We berekenen de kosten per *recept-unit* (gram) niet, we voegen gewoon de item-prijs toe als we < 1 packet gebruiken.
                // Maar om het simpel te houden in deze loop:
                
                // Als we < 15g nodig hebben en we hebben packets, reken 1 packet prijs.
                if (requiredAmountInBase.quantity <= 15) {
                     totalCost += (inventoryItem.price / inventoryItem.qty) * 1; // Prijs van 1 packet
                     return; // Ga naar volgende item, we hebben kosten al toegevoegd
                }
            }
            
            if (match) {
                 if (!isNaN(costPerBaseUnit)) {
                    totalCost += requiredAmountInBase.quantity * costPerBaseUnit;
                }
            } else {
                 // AANGEPAST: Voeg de waarschuwing toe aan de array i.p.v. de console
                 const warningMsg = `'${req.name}': Mismatch (Recept: ${requiredAmountInBase.unit}, Inventaris: ${inventoryAmountInBase.unit})`;
                 warnings.push(warningMsg);
                 console.warn(`Cannot calculate cost for ${warningMsg}`);
            }
        } else if (!inventoryItem || inventoryItem.price === 0) {
             // NIEUW: Waarschuw ook als het item niet in de inventaris zit of geen prijs heeft
             warnings.push(`'${req.name}': Item not found in inventory or has no price.`);
        }
    });

    return { cost: totalCost, warnings: warnings }; // AANGEPAST: Geef het object terug
}

            window.printEmptyLog = function() {
                const logHtml = getBrewLogHtml(null, 'empty');
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>Empty Brew Log</title><style>${document.querySelector('style').innerHTML}</style></head><body><div class="container mx-auto p-4">${logHtml}</div></body></html>`);
                printWindow.document.close();
                printWindow.print();
            }

            function getLogDataFromDOM(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return {};
                const logSection = container.querySelector('.brew-log-section');
                if (!logSection) return {};
                const suffix = `-${logSection.dataset.id}`;
                const actualIngredients = Array.from(container.querySelectorAll(`#actualsTable${suffix} tbody tr`)).map(row => {
                    return {
                        name: row.dataset.name,
                        plannedQty: row.dataset.plannedqty,
                        plannedUnit: row.dataset.plannedunit,
                        actualQty: row.querySelector('.actual-qty-input').value,
                        actualUnit: row.dataset.plannedunit // We gaan ervan uit dat de eenheid niet verandert
                    };
                });
                return {
                    recipeName: container.querySelector(`#recipeName${suffix}`)?.value || '',
                    brewDate: container.querySelector(`#brewDate${suffix}`)?.value || '',
                    targetOG: container.querySelector(`#targetOG${suffix}`)?.value || '',
                    actualOG: container.querySelector(`#actualOG${suffix}`)?.value || '',
                    targetFG: container.querySelector(`#targetFG${suffix}`)?.value || '',
                    actualFG: container.querySelector(`#actualFG${suffix}`)?.value || '',
                    targetABV: (container.querySelector(`#targetABV${suffix}`)?.value || '').replace('%', ''),
                    finalABV: container.querySelector(`#finalABV${suffix}`)?.value || '',
                    actualIngredients: actualIngredients,
                    fermentationLog: Array.from(container.querySelectorAll(`#fermentationTable${suffix} tbody tr`)).map(row => ({
                        date: row.cells[0].querySelector('input').value,
                        temp: row.cells[1].querySelector('input').value,
                        sg: row.cells[2].querySelector('input').value,
                        notes: row.cells[3].querySelector('input').value,
                    })),
                    agingNotes: container.querySelector(`#agingNotes${suffix}`)?.value || '',
                    bottlingNotes: container.querySelector(`#bottlingNotes${suffix}`)?.value || '',
                    tastingNotes: container.querySelector(`#tastingNotes${suffix}`)?.value || '',
                };
            }

function getBrewLogHtml(logData, idSuffix = 'new', parsedTargets = {}) {
    console.log("--- Entering getBrewLogHtml ---"); // ENTRY LOG
    const data = logData || {};

    // Prioritize newly parsed targets directly
    const useTargetOG = parsedTargets.targetOG || data.targetOG || '';
    const useTargetFG = parsedTargets.targetFG || data.targetFG || '';
    const useTargetABV = parsedTargets.targetABV || data.targetABV || ''; // Will be just the number

    console.log(`DEBUG: Final values for log -> OG: ${useTargetOG}, FG: ${useTargetFG}, ABV: ${useTargetABV}`); // DEBUG

    const fermLog = data.fermentationLog || Array.from({ length: 3 }, () => ({}));
    const escapedRecipeName = (data.recipeName || '').replace(/"/g, '&quot;');
    const copyOgToLogScript = `const ogInput = document.getElementById('actualOG-${idSuffix}'); const firstSgInput = document.querySelector('#fermentationTable-${idSuffix} tbody tr:first-child td:nth-child(3) input'); if (ogInput && firstSgInput) { firstSgInput.value = ogInput.value; }`;

    // Ensure the correct variables ARE used in the 'value' attributes below
    return `
        <div class="brew-log-section" data-id="${idSuffix}">
            <h3>Brewmaster's Log</h3>
            <div class="log-grid">
                <div class="log-item"><label for="recipeName-${idSuffix}">Recipe Name:</label><input type="text" id="recipeName-${idSuffix}" value="${escapedRecipeName}"></div>
                <div class="log-item"><label for="brewDate-${idSuffix}">Brew Date:</label><input type="date" id="brewDate-${idSuffix}" value="${data.brewDate || ''}"></div>
            </div>
            <div class="log-grid">
                <div class="log-item"><label for="targetOG-${idSuffix}">Target OG:</label><input type="text" id="targetOG-${idSuffix}" value="${useTargetOG}" readonly class="bg-app-primary"></div>
                <div class="log-item">
                    <label for="actualOG-${idSuffix}">Actual OG:</label>
                    <input type="text" id="actualOG-${idSuffix}" value="${data.actualOG || ''}" 
                           oninput="${copyOgToLogScript}; window.autoCalculateABV('${idSuffix}')">
                </div>
                <div class="log-item"><label for="targetFG-${idSuffix}">Target FG:</label><input type="text" id="targetFG-${idSuffix}" value="${useTargetFG}" readonly class="bg-app-primary"></div>
                <div class="log-item">
                    <label for="actualFG-${idSuffix}">Actual FG:</label>
                    <input type="text" id="actualFG-${idSuffix}" value="${data.actualFG || ''}" 
                           oninput="window.autoCalculateABV('${idSuffix}')">
                </div>
                <div class="log-item"><label for="targetABV-${idSuffix}">Target ABV:</label><input type="text" id="targetABV-${idSuffix}" value="${useTargetABV}%" readonly class="bg-app-primary"></div>
                <div class="log-item"><label for="finalABV-${idSuffix}">Final ABV:</label><input type="text" id="finalABV-${idSuffix}" value="${data.finalABV || ''}"></div>
            </div>
            <div class="log-item">
                <label>Fermentation Log</label>
                <div class="overflow-x-auto log-container">
                     <table class="fermentation-table table-fixed w-full" id="fermentationTable-${idSuffix}" style="min-width: 500px;">
                        <thead><tr><th style="width: 120px;">Date</th><th style="width: 80px;">Temp (C)</th><th style="width: 90px;">S.G.</th><th>Notes</th></tr></thead>
                        <tbody>${fermLog.map(row => `<tr>
                                <td><input type="date" value="${row.date || ''}" class="w-full"></td>
                                <td><input type="number" step="0.5" placeholder="18.5" value="${row.temp || '18'}" class="w-full text-center"></td>
                                <td><input type="number" step="0.001" placeholder="1.050" value="${row.sg || ''}" class="w-full text-center"></td>
                                <td><input type="text" value="${row.notes || ''}" class="w-full"></td>
                            </tr>`).join('')}</tbody>
                    </table>
                    
                    <div class="text-right mt-1">
                        <button onclick="window.addLogLine('${idSuffix}')" class="text-xs text-app-brand hover:text-app-primary underline">+ Add Row</button>
                    </div>
                    </div>
            </div>
            <div class="log-item"><label for="agingNotes-${idSuffix}">Aging & Conditioning Notes:</label><textarea id="agingNotes-${idSuffix}" rows="4" placeholder="...">${data.agingNotes || ''}</textarea></div>
            <div class="log-item"><label for="bottlingNotes-${idSuffix}">Bottling / Kegging Notes:</label><textarea id="bottlingNotes-${idSuffix}" rows="3" placeholder="...">${data.bottlingNotes || ''}</textarea></div>
            <div class="log-item"><label for="tastingNotes-${idSuffix}">Final Tasting Notes:</label><textarea id="tastingNotes-${idSuffix}" rows="6" placeholder="...">${data.tastingNotes || ''}</textarea></div>
        </div>
    `;
}

            // --- NIEUWE FUNCTIE: Bouwt de "Actuals" tabel ---
            function getActualIngredientsHtml(brew) {
                const idSuffix = brew.id;
                const plannedIngredients = parseIngredientsFromMarkdown(brew.recipeMarkdown);
                const actualIngredients = brew.logData?.actualIngredients || [];

                if (plannedIngredients.length === 0) {
                    return '<p class="text-app-secondary/80">No ingredients found in recipe.</p>';
                }

                const tbodyHtml = plannedIngredients.map(plannedItem => {
                    // Zoek of er al een "actual" waarde is opgeslagen
                    const savedActual = actualIngredients.find(a => a.name === plannedItem.name);
                    
                    // Gebruik de opgeslagen 'actual' waarde, of val terug op de 'planned' waarde
                    const actualValue = savedActual ? savedActual.actualQty : plannedItem.quantity;
                    
                    return `
                        <tr data-name="${plannedItem.name}" 
                            data-plannedqty="${plannedItem.quantity}" 
                            data-plannedunit="${plannedItem.unit}">
                            
                            <td class="py-2 px-3">${plannedItem.name}</td>
                            <td class="py-2 px-3 text-app-secondary/80">${plannedItem.quantity} ${plannedItem.unit}</td>
                            <td class="py-2 px-3">
                                <input type="number" step="0.01" 
                                       class="actual-qty-input w-24 p-1 border rounded bg-app-primary border-app text-app-primary" 
                                       value="${actualValue}">
                            </td>
                            <td class="py-2 px-3">${plannedItem.unit}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="log-item">
                        <label>Actual Ingredients Log</label>
                        <table class="fermentation-table w-full" id="actualsTable-${idSuffix}">
                            <thead>
                                <tr>
                                    <th>Ingredient</th>
                                    <th>Planned</th>
                                    <th>Actual</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tbodyHtml}
                            </tbody>
                        </table>
                    </div>
                `;
            }

function renderActiveBrewTimeline() {
    const card = document.getElementById('current-brew-card');
    if (!card) return;

    // Zoek de meest recente actieve (niet-gebottelde) brouwsel
    const activeBrew = brews.find(b => b.logData && b.logData.brewDate && b.logData.brewDate !== '' && !b.isBottled);

    if (!activeBrew) {
        card.classList.add('hidden');
        return;
    }

    const now = new Date();
    const brewDate = new Date(activeBrew.logData.brewDate);
    const daysFermenting = Math.floor((now - brewDate) / (1000 * 60 * 60 * 24));

    let progressPercentage = 0;
    let statusText = `Day ${daysFermenting}: `;
    
    // Check de fases
    const checklist = activeBrew.checklist || {};
    const completedCount = Object.keys(checklist).filter(k => checklist[k] === true).length;

    if (!activeBrew.primaryComplete) {
        statusText += "Primary Fermentation";
        const totalPrimarySteps = (activeBrew.brewDaySteps || []).length || 1; 
        const phaseProgress = Math.min(1, completedCount / totalPrimarySteps);
        progressPercentage = phaseProgress * 50; 
    } else {
        statusText += "Secondary / Conditioning";
        const totalSecondarySteps = (activeBrew.secondarySteps || []).length || 1;
        const phaseProgress = Math.min(1, completedCount / totalSecondarySteps);
        progressPercentage = 50 + (phaseProgress * 50);
        
        if (phaseProgress > 0.9) statusText = `Day ${daysFermenting}: Bottling Ready?`;
    }

    const stages = [
        { name: 'Brew Day', active: true },
        { name: 'Primary End', active: activeBrew.primaryComplete || progressPercentage >= 50 },
        { name: 'Aging', active: activeBrew.primaryComplete && progressPercentage >= 75 }, 
        { name: 'Bottling Ready', active: progressPercentage >= 95 }
    ];

    let timelineItemsHtml = '';
    stages.forEach((stage) => {
        timelineItemsHtml += `
            <div class="timeline-item ${stage.active ? 'active' : ''}">
                <div class="timeline-node"></div>
                <div class="timeline-label text-[10px] uppercase tracking-wide">${stage.name}</div>
            </div>
        `;
    });

    // --- NIEUWE LAYOUT MET KNOP RECHTSBOVEN ---
    card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="pr-4">
                <h3 class="text-xl font-header font-bold text-app-brand leading-tight">${activeBrew.recipeName}</h3>
                <p class="text-app-secondary text-sm font-semibold mt-1">${statusText}</p>
            </div>
            <button onclick="window.showBrewDetail('${activeBrew.id}')" class="flex-shrink-0 bg-transparent border border-app-brand text-app-brand hover:bg-app-brand hover:text-white text-xs font-bold uppercase px-3 py-2 rounded transition-colors">
                View Details
            </button>
        </div>
        
        <div class="timeline-container mt-6 mb-2">
            <div class="timeline-connector">
                <div class="timeline-progress" style="width: ${progressPercentage}%;"></div>
            </div>
            ${timelineItemsHtml}
        </div>
    `;

    card.classList.remove('hidden');
}

// --- NIEUWE FUNCTIE: UPDATE DASHBOARD STATS ---
function updateDashboardStats() {
    // 1. Active Batches: Alles wat een startdatum heeft maar niet gebotteld is
    const activeCount = brews.filter(b => b.logData && b.logData.brewDate && !b.isBottled).length;
    const activeEl = document.getElementById('stat-active-batches');
    if(activeEl) activeEl.textContent = activeCount;

    // 2. Bottles in Cellar: Tel alle flessen in alle batches op
    let totalBottles = 0;
    if (cellar && cellar.length > 0) {
        cellar.forEach(item => {
            if (item.bottles) {
                totalBottles += item.bottles.reduce((acc, b) => acc + (parseInt(b.quantity) || 0), 0);
            }
        });
    }
    const bottlesEl = document.getElementById('stat-bottles');
    if(bottlesEl) bottlesEl.textContent = totalBottles;

    // 3. Total Spent: Totale waarde van de inventaris
    let totalSpent = 0;
    if (inventory && inventory.length > 0) {
        totalSpent = inventory.reduce((acc, item) => acc + (parseFloat(item.price) || 0), 0);
    }
    const currency = userSettings.currencySymbol || '';
    const spentEl = document.getElementById('stat-spent');
    
    // We ronden af voor een netter getal op het dashboard
    if(spentEl) spentEl.textContent = `${currency}${Math.round(totalSpent)}`;
}

            function updateNextActionWidget() {
    const widget = document.getElementById('next-action-widget');
    const list = document.getElementById('next-action-list');
    if (!widget || !list) return;

    const widgetTitle = widget.querySelector('h3');
    if (widgetTitle) widgetTitle.textContent = "What's next?";

    list.innerHTML = '';
    const suggestions = [];
    const now = new Date();
    now.setHours(0,0,0,0);
    const twentyFourHoursAgo = new Date(new Date().getTime() - (24 * 60 * 60 * 1000));

    // Suggestion 1: Recently saved recipe
    if (brews.length > 0) {
        const newestBrew = brews[0];
        if (newestBrew.createdAt.toDate() > twentyFourHoursAgo && !newestBrew.isBottled) {
             suggestions.push(`
                <li>
                    You recently saved the recipe '<strong>${newestBrew.recipeName}</strong>'.
                    <button onclick="window.generateShoppingList('${newestBrew.id}')" class="text-blue-600 hover:underline font-semibold ml-2">Create shopping list</button> or
                    <button onclick="window.startBrewDay('${newestBrew.id}')" class="text-green-600 hover:underline font-semibold ml-1">Start brew day!</button>
                </li>
             `);
        }
    }

    // Suggestion 2: Mead fermenting for a while
    const fermentingBrews = brews.filter(b => b.logData && b.logData.brewDate && !b.isBottled && b.logData.brewDate !== '');
    if (fermentingBrews.length > 0) {
        fermentingBrews.forEach(brew => {
            const brewDate = new Date(brew.logData.brewDate);
            if (!isNaN(brewDate.getTime())) {
                const daysFermenting = (now - brewDate) / (1000 * 60 * 60 * 24);
                if (daysFermenting > 18 && !brew.logData.actualFG) {
                    suggestions.push(`
                        <li>
                            '<strong>${brew.recipeName}</strong>' has been fermenting for ${Math.round(daysFermenting)} days. Time for an SG reading?
                            <button onclick="window.showBrewDetail('${brew.id}')" class="text-blue-600 hover:underline font-semibold ml-2">View Log</button>
                        </li>
                    `);
                }
            }
        });
    }
    
    // Suggestion 3: Batch in cellar nearing peak
    if (cellar.length > 0) {
        cellar.forEach(item => {
            if(item.peakFlavorDate) {
                const peakDate = new Date(item.peakFlavorDate);
                 if (!isNaN(peakDate.getTime())) {
                    const daysUntilPeak = (peakDate - now) / (1000 * 60 * 60 * 24);
                    if(daysUntilPeak <= 14 && daysUntilPeak > -30) {
                         suggestions.push(`
                            <li>
                                The '<strong>${item.recipeName}</strong>' in your cellar is nearing its peak! Maybe it's time for a tasting?
                            </li>
                        `);
                    }
                }
            }
        });
    }

    // Suggestion 4: Expiring inventory
    if (inventory.length > 0) {
        inventory.forEach(item => {
            if (item.expirationDate) {
                const expDate = new Date(item.expirationDate);
                const daysUntilExp = (expDate - now) / (1000 * 60 * 60 * 24);
                if (daysUntilExp >= 0 && daysUntilExp <= 30) {
                    suggestions.push(`
                        <li>
                            <span class="text-amber-600 dark:text-amber-400">Warning:</span> Your <strong>${item.name}</strong> is expiring in ${Math.round(daysUntilExp)} days!
                        </li>
                    `);
                }
            }
        });
    }

    if (suggestions.length > 0) {
        list.innerHTML = suggestions.slice(0, 3).join('');
        widget.classList.remove('hidden');
    } else {
        widget.classList.add('hidden');
    }
}
            
            // --- Brew Day Assistant Functions ---
            window.startBrewDay = async function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    // Navigeer eerst naar de shopping list om de ingredinten te controleren
    switchMainView('brewing');
    switchSubView('shopping-list', 'brewing-main-view');
    generateShoppingList(brewId, false);
}

function renderBrewDay(brewId) {
    // Behandel het geval waar er geen actieve brouwdag is
    if (brewId === 'none') {
        document.getElementById('brew-day-content').innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 1 - Primary Fermentation</h2><p class="text-center text-app-secondary/80">Select a new recipe from your History to start a new brew day.</p>`;
        return;
    }

    // Zoek het brouwsel op basis van ID
    const brew = brews.find(b => b.id === brewId);
    const brewDayContent = document.getElementById('brew-day-content');
    if (!brew) {
        brewDayContent.innerHTML = `<p class="text-center text-red-500">Could not find the selected brew. Please start a new one.</p>`;
        return;
    }

    // Haal de primaire stappen op (of een lege array)
    const primarySteps = brew.brewDaySteps || [];
    if (primarySteps.length === 0) {
         brewDayContent.innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2><p class="text-center text-app-secondary/80">Could not find Primary Fermentation steps for this recipe.</p>`;
         return;
    }

    // --- NIEUW: Haal de checklist op van het brouwsel zelf ---
    const checklist = brew.checklist || {};

    // Genereer de HTML voor elke stap in de checklist
    // IN renderBrewDay functie:

    let stepsHtml = primarySteps.map((step, index) => {
        // --- NIEUW: Slimme detectie van ingredinten in de stap ---
        // We zoeken naar een patroon als "2.5 kg" of "5 g" in de titel of beschrijving
        const amountMatch = (step.title + " " + step.description).match(/(\d+[.,]?\d*)\s*(kg|g|l|ml|oz|lbs)/i);
        let inputHtml = '';
        let detectedAmount = '';
        let detectedUnit = '';

        // Check of deze stap al eerder is afgevinkt en of er data is opgeslagen
        // We slaan dit op in checklist als object: { completed: true, actualAmount: 5.2 }
        const stepState = currentBrewDay.checklist[`step-${index}`]; 
        const isCompleted = stepState === true || (stepState && stepState.completed);
        const savedAmount = (stepState && stepState.actualAmount) ? stepState.actualAmount : '';

        if (amountMatch && !isCompleted) {
            detectedAmount = amountMatch[1];
            detectedUnit = amountMatch[2].toLowerCase();
            // Toon een invoerveld als we een hoeveelheid detecteren
            inputHtml = `
                <div class="mt-2 flex items-center gap-2 bg-app-tertiary p-2 rounded">
                    <label class="text-xs font-bold text-app-secondary uppercase">Actual Added:</label>
                    <input type="number" step="0.01" id="step-input-${index}" 
                           class="w-24 p-1 text-sm border rounded bg-app-primary border-app text-app-primary" 
                           placeholder="${detectedAmount}" value="${detectedAmount}">
                    <span class="text-sm font-bold">${detectedUnit}</span>
                </div>
            `;
        } else if (isCompleted && savedAmount) {
             // Als het al klaar is, toon wat we hebben ingevuld
             inputHtml = `
                <div class="mt-2 text-xs text-green-700 dark:text-green-400 font-mono">
                    Recorded: ${savedAmount} ${detectedUnit || ''}
                </div>
            `;
        }

        const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${index}">${formatTime(step.duration)}</p>` : '';
        
        // Let op: Ik geef 'detectedUnit' mee aan de knop zodat we die kunnen opslaan
        const buttonsHtml = step.duration > 0 ? `
            <button data-action="startTimer" data-step="${index}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
        ` : `
            <button data-action="completeStep" data-step="${index}" data-unit="${detectedUnit}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
        `;

        return `
            <div id="step-${index}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                <div>
                    <p class="step-title">${index + 1}. ${step.title}</p>
                    <p class="text-sm text-app-secondary">${step.description}</p>
                    
                    ${inputHtml} <div class="mt-4">
                        ${timerHtml}
                        <div class="space-x-2" id="controls-${index}">
                            ${isCompleted ? '<span class="text-sm font-bold text-green-600"> Completed</span>' : buttonsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // --- Genereer Log HTML ZONDER target values ---
    const parsedRecipeTargets = parseRecipeData(brew.recipeMarkdown); // Gebruik een aparte naam
    console.log("renderBrewDay - Parsed Targets before passing to getBrewLogHtml:", parsedRecipeTargets); // DEBUG
    // Geef de geparste targets door aan getBrewLogHtml
    const logHtml = getBrewLogHtml(brew.logData, brew.id, parsedRecipeTargets);
    const actualsHtml = getActualIngredientsHtml(brew);

    // --- Zet de volledige HTML in de pagina ---
    brewDayContent.innerHTML = `
        <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2>
        <div class="mb-4">
            <div class="progress-bar-bg w-full h-2 rounded-full">
                <div id="brew-day-progress" class="progress-bar-fg h-2 rounded-full" style="width: 0%;"></div>
            </div>
        </div>
        <div id="brew-day-steps-container">
            ${stepsHtml}
        </div>
        <div class="text-center mt-6">
            <button data-action="resetBrewDay" class="text-sm bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 btn">Reset and Start Over</button>
        </div>
        <hr class="my-8 border-app">
        ${logHtml} {/* Log HTML wordt hier ingevoegd */}
        <div class="mt-4 no-print space-y-3">
            <button onclick="window.updateBrewLog('${brew.id}', 'brew-day-content')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</d>
            
            <button onclick="window.deductActualsFromInventory('${brew.id}')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
                Deduct Actuals from Inventory
            </button>
        </div>
        <div class="mt-4 no-print">
            <button onclick="window.updateBrewLog('${brew.id}', 'brew-day-content')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>
        </div>
    `;

    // Initialiseer de status van de checklist (welke stap actief is, etc.)
    initializeBrewDayState(primarySteps);
}

function renderBrewDay2() {
    const view = document.getElementById('brew-day-2-view');
    if (!view) return;

    // Vind alle brouwsels die gestart zijn maar nog niet gebotteld
    const secondaryBrews = brews.filter(b => b.primaryComplete && !b.isBottled);

    if (secondaryBrews.length === 0) {
        view.innerHTML = `
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-header font-bold mb-4 text-center">Secondary / Aging</h2>
                <p class="text-center text-app-secondary/80">You have no batches currently in the secondary or aging phase.</p>
            </div>
        `;
        return;
    }

    const listHtml = secondaryBrews.map(brew => {
        const brewDate = new Date(brew.logData.brewDate);
        const daysInFermentation = Math.floor((new Date() - brewDate) / (1000 * 60 * 60 * 24));
        return `
            <div class="p-4 card rounded-lg cursor-pointer hover:bg-app-primary" onclick="window.showBrewDay2Detail('${brew.id}')">
                <h4 class="font-bold text-lg font-header">${brew.recipeName || 'Untitled Brew'}</h4>
                <p class="text-sm text-app-secondary/80">Started on: ${brewDate.toLocaleDateString()} (${daysInFermentation} days ago)</p>
            </div>
        `;
    }).join('');

    view.innerHTML = `
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-header font-bold mb-6 text-center">Secondary / Aging</h2>
            <div id="brew-day-2-list" class="space-y-4">
                ${listHtml}
            </div>
        </div>
    `;
}

window.showBrewDay2Detail = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    // --- AANGEPAST: `currentBrewDay` is nu enkel een ID-pointer. De checklist komt uit het brouwsel.
    currentBrewDay = { brewId: brewId }; 
    const checklist = brew.checklist || {};

    const view = document.getElementById('brew-day-2-view');
    const secondarySteps = brew.secondarySteps || [];
    const stepOffset = (brew.brewDaySteps || []).length; // Start telling vanaf het einde van de primaire stappen

    let secondaryStepsHtml = '<p class="text-center text-app-secondary/80">No specific secondary steps found for this recipe. Ready to bottle?</p>';
    if (secondarySteps.length > 0) {
        secondaryStepsHtml = secondarySteps.map((step, index) => {
            const originalIndex = stepOffset + index;
            const isCompleted = checklist[`step-${originalIndex}`] || false; // Gebruik de lokale checklist

            const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${originalIndex}">${formatTime(step.duration)}</p>` : '';
            const buttonsHtml = step.duration > 0 ? `
                <button data-action="startTimer" data-step="${originalIndex}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
            ` : `
                <button data-action="completeStep" data-step="${originalIndex}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
            `;

            return `
                <div id="step-${originalIndex}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                    <div>
                        <p class="step-title">${originalIndex + 1}. ${step.title}</p>
                        <p class="text-sm text-app-secondary">${step.description}</p>
                        <div class="mt-4">
                            ${timerHtml}
                            <div class="space-x-2" id="controls-${originalIndex}">
                                ${isCompleted ? '<span class="text-sm font-bold text-green-600"> Completed</span>' : buttonsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    const logHtml = getBrewLogHtml(brew.logData, brew.id);

    view.innerHTML = `
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <button onclick="renderBrewDay2()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to Secondary List</button>
            <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName}</h2>
            <div class="mb-6">
                <h3 class="text-xl font-header mb-2">Remaining Steps</h3>
                <div id="brew-day-steps-container">${secondaryStepsHtml}</div>
            </div>
            <div class="text-center my-6">
                <button onclick="window.showBottlingModal('${brew.id}')" class="bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                    Bottle This Batch
                </button>
            </div>
            <hr class="my-8 border-app">
            ${logHtml}
            <div class="mt-4 no-print">
                <button onclick="window.updateBrewLog('${brew.id}', 'brew-day-2-view')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
            </div>
        </div>
    `;
}

            window.deleteBrew = async function(brewId) {
                if (!userId) return;
                const brewToDelete = brews.find(b => b.id === brewId);
                if (!brewToDelete) return;
                if (!confirm(`Are you sure you want to permanently delete the recipe "${brewToDelete.recipeName}"? This action cannot be undone.`)) return;

                try {
                    const appId = 'meandery-aa05e';
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
                    await deleteDoc(brewDocRef);
                    showToast(`Recipe "${brewToDelete.recipeName}" has been deleted.`, 'success');
                    goBackToHistoryList();
                } catch (error) {
                    console.error("Error deleting brew:", error);
                    showToast("An error occurred while deleting the recipe.", 'error');
                }
            }

            // --- State Management voor de Brouwdag Timer ---
            let brewDaySteps = [];
            let currentStepIndex = 0;
            let stepTimerInterval = null;
            let remainingTime = 0;

            // --- Gecentraliseerde Event Listener voor de Brouwdag ---
            function setupBrewDayEventListeners() {
    // AANGEPAST: Luister nu naar de hele 'brewing-main-view' in plaats van enkel 'brew-day-content'
    const viewContainer = document.getElementById('brewing-main-view');
    if (!viewContainer) return;

    viewContainer.addEventListener('click', function(e) {
        const target = e.target.closest('button[data-action]');
        if (!target) return; 

        const action = target.dataset.action;
        const stepIndex = parseInt(target.dataset.step);

        switch(action) {
            case 'startTimer':
                startStepTimer(stepIndex);
                break;
            case 'pauseTimer':
                pauseStepTimer(stepIndex);
                break;
            case 'skipTimer':
                skipTimer(stepIndex);
                break;
            case 'completeStep':
                completeStep(stepIndex, true); // Pass 'true' to indicate a skip
                break;
            case 'resetBrewDay':
                resetBrewDay();
                break;
        }
    });
}

            function parseStepsForBrewDay(markdown) {
    const steps = { primary: [], secondary: [] };
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = marked.parse(markdown);

    // --- ROBUUSTERE HEADER ZOEKFUNCTIE ---
    // Zoekt naar ELK header-type (h1-h4) dat de sleutelwoorden bevat.
    const findHeader = (keywords) => {
        const headers = tempDiv.querySelectorAll('h1, h2, h3, h4');
        return Array.from(headers).find(h => {
            const text = h.textContent.toLowerCase();
            // Zorg ervoor dat alle sleutelwoorden aanwezig zijn
            return keywords.every(keyword => text.includes(keyword));
        });
    };

    const primaryHeader = findHeader(['primary']);
    const secondaryHeader = findHeader(['secondary', 'aging']);
    
    const processSection = (header, stepArray) => {
        if (header) {
            let element = header.nextElementSibling;
            // Blijf doorgaan totdat je een ANDERE header van hetzelfde of een hoger niveau tegenkomt
            while (element && !['H1', 'H2', 'H3', 'H4'].includes(element.tagName)) {
                if (element.tagName === 'OL' || element.tagName === 'UL') {
                    Array.from(element.children).forEach(li => {
                        if (li.tagName === 'LI') {
                            const text = li.textContent.trim();
                            if (text) { // Sla lege list-items over
                                stepArray.push(parseStepText(text));
                            }
                        }
                    });
                }
                element = element.nextElementSibling;
            }
        } else {
             console.warn("Kopje niet gevonden tijdens parsen van stappen.");
        }
    };

    processSection(primaryHeader, steps.primary);
    processSection(secondaryHeader, steps.secondary);
    
    // Fallback: Als 'secondary' geen stappen heeft, maar 'aging' wel, probeer die te vinden
    if (steps.secondary.length === 0 && !secondaryHeader) {
         const agingHeader = findHeader(['aging']);
         processSection(agingHeader, steps.secondary);
    }
    
    console.log(`Steps parsed: ${steps.primary.length} primary, ${steps.secondary.length} secondary.`);
    return steps;
}

            const parseStepText = (text) => {
                let duration = 0;
                let title = text;
                let description = 'Follow the instruction.';

                // Zoek naar de ENIGE betrouwbare tag: [TIMER:HH:MM:SS]
                const timerMatch = text.match(/\[TIMER:(\d{2}):(\d{2}):(\d{2})\]/);

                if (timerMatch) {
                    // Converteer de tag naar seconden
                    const hours = parseInt(timerMatch[1], 10);
                    const minutes = parseInt(timerMatch[2], 10);
                    const seconds = parseInt(timerMatch[3], 10);
                    duration = (hours * 3600) + (minutes * 60) + seconds;
                    
                    // Verwijder de tag uit de zichtbare tekst
                    title = text.replace(timerMatch[0], '').trim();
                }
                
                // Verwijder alle oude, mogelijk storende tags voor de zekerheid
                title = title.replace(/\[d:[\d:]+\]/g, '').trim();

                return { title: title, description: description, duration: duration };
            };


window.saveBrewToHistory = async function() {
    if (!userId || !currentRecipeMarkdown) {
        showToast("Cannot save. No user identified or no recipe generated.", "error");
        return;
    }
    const saveButton = document.getElementById('saveBtn');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    const costResult = parseIngredientsAndCalculateCost(currentRecipeMarkdown, inventory, parseFloat(document.getElementById('batchSize').value) || 5);
    const totalBatchCost = costResult.cost;

    // NIEUW: Toon de waarschuwingen als die er zijn
    if (costResult.warnings.length > 0) {
        showToast(`Cost Warning: Could not calculate cost for some items:\n- ${costResult.warnings.join('\n- ')}`, 'error', 7000);
    }
    const brewDayStepsObject = parseStepsForBrewDay(currentRecipeMarkdown);
    
    const initialLogData = parseRecipeData(currentRecipeMarkdown);
    initialLogData.fermentationLog = Array.from({ length: 8 }, () => ({}));
    
    const batchSize = parseFloat(document.getElementById('batchSize').value) || 5;
    const brewData = {
        userId: userId,
        recipeName: initialLogData.recipeName || "Untitled Brew",
        recipeMarkdown: currentRecipeMarkdown,
        prompt: lastGeneratedPrompt,
        logData: initialLogData,
        createdAt: new Date(),
        batchSize: batchSize,
        totalCost: totalBatchCost,
        isBottled: false,
        primaryComplete: false,
        predictedFlavorProfile: currentPredictedProfile,
        brewDaySteps: brewDayStepsObject.primary,
        secondarySteps: brewDayStepsObject.secondary
    };

    try {
        const appId = 'meandery-aa05e';
        const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
        const docRef = await addDoc(brewsCol, brewData);
        
        const buttonContainer = saveButton.parentElement;
        
        // Verberg de "Save" knop na succes
        saveButton.style.display = 'none';

        // Voeg de "Start Brew Day" knop toe
        buttonContainer.innerHTML += `
            <button onclick="window.startBrewDay('${docRef.id}')" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors btn">
                Start Brew Day
            </button>
        `;

        showToast("Recipe saved to History!", "success");
        promptToUpdateInventory(currentRecipeMarkdown);

    } catch (error) {
        console.error("Error saving brew:", error);
        showToast("Error saving recipe.", "error");
        saveButton.textContent = 'Save to Brew History';
        saveButton.disabled = false;
    }
}

function renderBrewDay(brewId) {
    if (brewId === 'none') {
        document.getElementById('brew-day-content').innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day 1 - Primary Fermentation</h2><p class="text-center text-app-secondary/80">Select a new recipe from your History to start a new brew day.</p>`;
        return;
    }

    const brew = brews.find(b => b.id === brewId);
    const brewDayContent = document.getElementById('brew-day-content');
    if (!brew) {
        brewDayContent.innerHTML = `<p class="text-center text-red-500">Could not find the selected brew. Please start a new one.</p>`;
        return;
    }

    const primarySteps = brew.brewDaySteps || [];
    if (primarySteps.length === 0) {
         brewDayContent.innerHTML = `<h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2><p class="text-center text-app-secondary/80">Could not find Primary Fermentation steps for this recipe.</p>`;
         return;
    }

    let stepsHtml = primarySteps.map((step, index) => {
        const isCompleted = currentBrewDay.checklist[`step-${index}`] || false;
        const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${index}">${formatTime(step.duration)}</p>` : '';
        const buttonsHtml = step.duration > 0 ? `
            <button data-action="startTimer" data-step="${index}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
        ` : `
            <button data-action="completeStep" data-step="${index}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
        `;

        return `
            <div id="step-${index}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                <div>
                    <p class="step-title">${index + 1}. ${step.title}</p>
                    <p class="text-sm text-app-secondary">${step.description}</p>
                    <div class="mt-4">
                        ${timerHtml}
                        <div class="space-x-2" id="controls-${index}">
                            ${isCompleted ? '<span class="text-sm font-bold text-green-600"> Completed</span>' : buttonsHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    const parsedTargets = parseRecipeData(brew.recipeMarkdown);
    const combinedLogData = { ...brew.logData, ...parsedTargets };
    const logHtml = getBrewLogHtml(combinedLogData, brew.id);

    brewDayContent.innerHTML = `
        <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2>
        <div class="mb-4">
            <div class="progress-bar-bg w-full h-2 rounded-full">
                <div id="brew-day-progress" class="progress-bar-fg h-2 rounded-full" style="width: 0%;"></div>
            </div>
        </div>
        <div id="brew-day-steps-container">
            ${stepsHtml}
        </div>
        <div class="text-center mt-6">
            <button data-action="resetBrewDay" class="text-sm bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 btn">Reset and Start Over</button>
        </div>
        <hr class="my-8 border-app">
        ${logHtml}
        <div class="mt-4 no-print">
            <button onclick="window.updateBrewLog('${brew.id}', 'brew-day-content')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
        </div>
    `;

    initializeBrewDayState(primarySteps);
}

// VERVANG DE VOLLEDIGE OUDE showBrewDay2Detail FUNCTIE
window.showBrewDay2Detail = function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    currentBrewDay = userSettings.currentBrewDay?.brewId === brewId ? userSettings.currentBrewDay : { brewId: brewId, checklist: {} };

    const view = document.getElementById('brew-day-2-view');
    const secondarySteps = brew.secondarySteps || [];
    const stepOffset = (brew.brewDaySteps || []).length;

    let secondaryStepsHtml = '<p class="text-center text-app-secondary/80">No specific secondary steps found for this recipe. Ready to bottle?</p>';
    if (secondarySteps.length > 0) {
        secondaryStepsHtml = secondarySteps.map((step, index) => {
            const originalIndex = stepOffset + index;
            const isCompleted = currentBrewDay.checklist[`step-${originalIndex}`] || false;

            const timerHtml = step.duration > 0 ? `<p class="timer-display my-2" id="timer-${originalIndex}">${formatTime(step.duration)}</p>` : '';
            const buttonsHtml = step.duration > 0 ? `
                <button data-action="startTimer" data-step="${originalIndex}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Start Timer</button>
            ` : `
                <button data-action="completeStep" data-step="${originalIndex}" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 btn">Mark as Complete</button>
            `;

            return `
                <div id="step-${originalIndex}" class="step-item p-4 rounded-r-lg mb-3 ${isCompleted ? 'completed' : ''}">
                    <div>
                        <p class="step-title">${originalIndex + 1}. ${step.title}</p>
                        <p class="text-sm text-app-secondary">${step.description}</p>
                        <div class="mt-4">
                            ${timerHtml}
                            <div class="space-x-2" id="controls-${originalIndex}">
                                ${isCompleted ? '<span class="text-sm font-bold text-green-600"> Completed</span>' : buttonsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    const logHtml = getBrewLogHtml(brew.logData, brew.id);

    view.innerHTML = `
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <button onclick="renderBrewDay2()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to Secondary List</button>
            <h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName}</h2>
            <div class="mb-6">
                <h3 class="text-xl font-header mb-2">Remaining Steps</h3>
                <div id="brew-day-steps-container">${secondaryStepsHtml}</div>
            </div>
            <div class="text-center my-6">
                <button onclick="window.showBottlingModal('${brew.id}')" class="bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                    Bottle This Batch
                </button>
            </div>
            <hr class="my-8 border-app">
            ${logHtml}
            <div class="mt-4 no-print">
                <button onclick="window.updateBrewLog('${brew.id}')" class="w-full bg-app-action text-white py-3 px-4 rounded-lg hover:opacity-90 btn">Save Log Changes</button>    
            </div>
        </div>
    `;
}

            function generateBrewDaySteps(brew) {
                // AANGEPAST: De functie leest nu de betrouwbare, opgeslagen array
                if (!brew.brewDaySteps || brew.brewDaySteps.length === 0) {
                    console.warn("No pre-parsed brew day steps found for this brew.");
                    return [];
                }
                
                // We voegen de standaard voorbereidingsstappen toe aan de geparste lijst
                const prepSteps = [
                    { title: "Prepare Brewing Water", description: "Adjust your water based on the recipe's recommendation.", duration: 600 },
                    { title: "Gather & Weigh Ingredients", description: "Prepare all necessary ingredients.", duration: 0 }
                ];

                const recipeSteps = brew.brewDaySteps.map(step => ({ ...step })); // Kopieer de stappen

                // Post-processing voor relatieve timers (bijv. voor nutrienten)
                let lastNutrientTimeInSeconds = 0;
                recipeSteps.forEach(step => {
                    if (step.title.match(/\d+\s*Hours:/i) && step.duration > 0) {
                        const absoluteDuration = step.duration;
                        step.duration = absoluteDuration - lastNutrientTimeInSeconds;
                        lastNutrientTimeInSeconds = absoluteDuration;
                    }
                });

                return [...prepSteps, ...recipeSteps];
            }

            function initializeBrewDayState(steps) {
                brewDaySteps = steps;
                
                // --- Controleer op een opgeslagen timer ---
                const savedTimer = localStorage.getItem('activeBrewDayTimer');
                if (savedTimer) {
                    const { brewId, stepIndex, endTime } = JSON.parse(savedTimer);
                    
                    // Herstel de timer enkel als het voor de HUIDIGE brouwdag is
                    if (brewId === currentBrewDay.brewId) {
                        const now = Date.now();
                        if (endTime > now) {
                            // Er is een actieve timer, herstart deze
                            currentStepIndex = stepIndex;
                            const remainingSeconds = Math.round((endTime - now) / 1000);
                            startStepTimer(stepIndex, remainingSeconds);
                            updateUI(); // Zorg dat de UI de actieve timer toont
                            return; // Stop de functie hier om de standaard UI-update over te slaan
                        } else {
                            // Timer is verlopen terwijl de app gesloten was
                            localStorage.removeItem('activeBrewDayTimer');
                            currentBrewDay.checklist[`step-${stepIndex}`] = true;
                        }
                    }
                }
                
                // --- NIEUW: Haal de checklist op van de actieve brew ---
                const activeBrew = brews.find(b => b.id === currentBrewDay.brewId);
                const checklist = (activeBrew && activeBrew.checklist) ? activeBrew.checklist : {};
                
                // Gebruik de checklist van het brouwsel, niet de globale
                const lastCompleted = Object.keys(checklist).length - 1;
                currentStepIndex = lastCompleted >= 0 ? lastCompleted + 1 : 0;
                updateUI();
            }

            function startStepTimer(stepIndex, resumeTime = null) {
                if (stepTimerInterval) return; // Start geen nieuwe timer als er al een loopt

                // Zoek de actieve brew op
    const activeBrew = brews.find(b => b.id === currentBrewDay.brewId);
    if (!activeBrew) {
        console.error("Could not find active brew to start timer.");
        return;
    }

    // Combineer alle stappen om de juiste te vinden
    const allSteps = [...(activeBrew.brewDaySteps || []), ...(activeBrew.secondarySteps || [])];
    const step = allSteps[stepIndex];

    if (!step) {
        console.error(`Could not find step data for index ${stepIndex}.`);
        return;
    }

                let timeLeft = resumeTime !== null ? resumeTime : (remainingTime > 0 ? remainingTime : allSteps[stepIndex].duration);
                
                // --- Sla de eindtijd van de timer op ---
                const endTime = Date.now() + timeLeft * 1000;
                const timerState = { brewId: currentBrewDay.brewId, stepIndex: stepIndex, endTime: endTime };
                localStorage.setItem('activeBrewDayTimer', JSON.stringify(timerState));

                const timerDisplay = document.getElementById(`timer-${stepIndex}`);
                const controlsDiv = document.getElementById(`controls-${stepIndex}`);
                
                controlsDiv.innerHTML = `
                    <button data-action="pauseTimer" data-step="${stepIndex}" class="text-sm bg-yellow-500 text-white py-1 px-3 rounded-lg hover:bg-yellow-600 btn">Pause</button>
                    <button data-action="skipTimer" data-step="${stepIndex}" class="text-sm bg-gray-500 text-white py-1 px-3 rounded-lg hover:bg-gray-600 btn">Skip Timer</button>
                `;
                
                stepTimerInterval = setInterval(() => {
                    remainingTime = 0; // Clear the global remaining time
                    timeLeft--;
                    timerDisplay.textContent = formatTime(timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(stepTimerInterval);
                        stepTimerInterval = null;
                        timerDisplay.textContent = "Done!";
                        new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAnxAAAAAAAAAAAAAAAAAAAAAAAABSUxNfAAAAAAAAAAAAAAAAAAAAAAAASU5GTwMAAAAUAAABowAAAA8AAAB1bml0eS1tZWRpYQAAAAAAAAAAAAAAAAAAAAAAAFQNCj/9oACQAAAAAABn//6w4j/wAANwAD//5L/xO//6s4j/9r/9E4//lVn//V///6/8j/9E5///8R/wD/1P/0j//8//lVn/Vn//6/8j/9E5///8AAAAAQU1QRTGk9f/7QJ8QaSqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq==").play();
                        localStorage.removeItem('activeBrewDayTimer'); // Timer is voltooid
                        completeStep(stepIndex, true);
                    }
                }, 1000);
            }

            function pauseStepTimer(stepIndex) {
                clearInterval(stepTimerInterval);
                stepTimerInterval = null;
                
                // --- Sla de resterende tijd op en verwijder de eindtijd ---
                const timerDisplay = document.getElementById(`timer-${stepIndex}`);
                localStorage.removeItem('activeBrewDayTimer');
                const timeParts = timerDisplay.textContent.split(':');
                if (timeParts.length === 2) {
                    remainingTime = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]);
                } else if (timeParts.length === 3) {
                    remainingTime = parseInt(timeParts[0]) * 3600 + parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]);
                }

                const controlsDiv = document.getElementById(`controls-${stepIndex}`);
                controlsDiv.innerHTML = `<button data-action="startTimer" data-step="${stepIndex}" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 btn">Resume</button>`;
            }


function skipTimer(stepIndex) {
    // Clear the timer interval and reset state (no change)
    clearInterval(stepTimerInterval);
    stepTimerInterval = null;
    remainingTime = 0;
    localStorage.removeItem('activeBrewDayTimer');

    // --- Update UI for the SKIPPED step ---
    const stepDiv = document.getElementById(`step-${stepIndex}`);
    if (stepDiv) {
        stepDiv.classList.remove('active'); // Remove active state
        stepDiv.classList.add('completed');   // Add completed state

        const controlsDiv = document.getElementById(`controls-${stepIndex}`);
        if (controlsDiv) {
            // Replace buttons with "Completed" text
            controlsDiv.innerHTML = `<span class="text-sm font-bold text-green-600"> Completed</span>`;
        }
        // Update timer display if it exists, though it might already be cleared
        const timerDisplay = document.getElementById(`timer-${stepIndex}`);
        if (timerDisplay) {
             timerDisplay.textContent = "Skipped"; // Or "Completed"
        }
    }

    // Now call completeStep to handle saving state and activating the next step (no change)
    completeStep(stepIndex, true);
}

            async function resetBrewDay() {
                if (!confirm("Are you sure you want to reset your progress for this brew day?")) return;
                
                const brewId = currentBrewDay.brewId;
                if (!brewId) return;

                const brewIndex = brews.findIndex(b => b.id === brewId);
                if (brewIndex === -1) return;

                // 1. Update de lokale data
                brews[brewIndex].checklist = {};

                // 2. Sla de wijziging op in Firestore
                try {
                    const appId = 'meandery-aa05e';
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, { checklist: {} });
                    
                    // 3. Reset de UI en timer-staat
                    clearInterval(stepTimerInterval);
                    stepTimerInterval = null;
                    remainingTime = 0;
                    localStorage.removeItem('activeBrewDayTimer');

                    renderBrewDay(brewId); // Her-render de UI met de lege checklist
                    showToast("Progress reset.", "success");
                } catch (error) {
                    console.error("Error resetting checklist:", error);
                    showToast("Could not reset progress.", "error");
                }
            }

async function completeStep(stepIndex, isSkipping = false) {
    // --- Timer Cleanup (No Change) ---
    if (stepTimerInterval) {
        clearInterval(stepTimerInterval);
        stepTimerInterval = null;
        remainingTime = 0;
        localStorage.removeItem('activeBrewDayTimer');
    }

    // --- AANGEPAST: Markeer stap als voltooid en sla op in het BREW OBJECT ---
    const brewId = currentBrewDay.brewId;
    if (!brewId) {
        console.error("completeStep: No active brewId found.");
        return;
    }
    const brewIndex = brews.findIndex(b => b.id === brewId);
    if (brewIndex === -1) {
        console.error("completeStep: Active brew not found in local array.");
        return;
    }

    // Initialiseer checklist als deze niet bestaat
    if (!brews[brewIndex].checklist) {
        brews[brewIndex].checklist = {};
    }
    
    // Update de lokale checklist
    brews[brewIndex].checklist[`step-${stepIndex}`] = true;
    
    // Sla de gewijzigde checklist op in Firestore
    try {
        const appId = 'meandery-aa05e';
        const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
        // We slaan enkel het checklist-object op om data te besparen
        await updateDoc(brewDocRef, { checklist: brews[brewIndex].checklist });
    } catch (error) {
        console.error("Error saving checklist update to Firestore:", error);
        showToast("Failed to save progress.", "error");
        // Optioneel: zet de lokale wijziging terug
        delete brews[brewIndex].checklist[`step-${stepIndex}`];
        return; // Stop als het opslaan mislukt
    }
    // --- EINDE AANPASSING ---

    // --- Update UI for CURRENT Step (No Change) ---
    const stepDiv = document.getElementById(`step-${stepIndex}`);
    if (stepDiv) {
        stepDiv.classList.remove('active');
        stepDiv.classList.add('completed');
        const controlsDiv = document.getElementById(`controls-${stepIndex}`);
        if (controlsDiv) {
            controlsDiv.innerHTML = `<span class="text-sm font-bold text-green-600"> Completed</span>`;
        }
    }

    // --- START OF NEW LOGIC ---

    // 1. Find the active brew data
    const activeBrew = brews.find(b => b.id === currentBrewDay.brewId);
    if (!activeBrew) return;

    // 2. Get data for the step JUST completed
    const allSteps = [...(activeBrew.brewDaySteps || []), ...(activeBrew.secondarySteps || [])];
    const completedStepData = allSteps[stepIndex];

    // 3. Check if the COMPLETED step itself has a timer duration
    if (completedStepData && completedStepData.duration > 0 && !isSkipping) {
        // YES, this step initiates a wait. Start its timer immediately.
        // We pass the index of the completed step itself to startStepTimer now.
        startStepTimer(stepIndex);
        // We don't activate the next step yet; it becomes active when the timer finishes.
        return; // Stop further processing for this step completion
    }

    // 4. If the completed step DID NOT have a timer, activate the NEXT step (if it exists)
    const nextStepIndex = stepIndex + 1;
    const nextStepData = allSteps[nextStepIndex];
    const nextStepDiv = document.getElementById(`step-${nextStepIndex}`);

    if (nextStepData && nextStepDiv) {
        // Activate the next step normally
        nextStepDiv.classList.add('active');
    } else {
        // No next step exists, this was the last step of the phase.
        // Handle end-of-phase logic (e.g., mark primary complete)
        const brew = brews.find(b => b.id === currentBrewDay.brewId);
        const primaryStepCount = (brew.brewDaySteps || []).length;

        if (stepIndex === primaryStepCount - 1) { // Check if it was the last *primary* step
             await markPrimaryAsComplete(currentBrewDay.brewId);

             const allStepsContainer = stepDiv?.closest('[id$="-steps-container"]'); // Use optional chaining
             if (allStepsContainer) {
                 allStepsContainer.innerHTML += `
                    <div class="text-center p-6 card rounded-lg mt-6">
                        <h3 class="text-2xl font-header font-bold text-green-600">Phase 1 Complete!</h3>
                        <p class="my-2">Great! The primary fermentation steps are done.</p>
                        <p class="text-app-secondary mb-4">The next steps for this batch can now be found on the 'Brew Day 2' tab.</p>
                        <button onclick="window.finalizeBrewDay1()" class="bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">
                            Go to Brew Day 2
                        </button>
                    </div>
                `;
             }
        }
        // Add similar logic here if needed for the end of secondary steps
    }
    // --- END OF NEW LOGIC ---
}

function updateUI() {
    const progress = (currentStepIndex / brewDaySteps.length) * 100;
    const progressBar = document.getElementById('brew-day-progress');
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
    }

    brewDaySteps.forEach((step, index) => {
        const stepDiv = document.getElementById(`step-${index}`);
        if (!stepDiv) return;

        const controlsDiv = document.getElementById(`controls-${index}`);
        stepDiv.classList.remove('active', 'completed');

        if (index < currentStepIndex) {
            stepDiv.classList.add('completed');
            if (controlsDiv) {
                controlsDiv.innerHTML = `<span class="text-sm font-bold text-green-600"> Completed</span>`;
            }
        } else if (index === currentStepIndex) {
            stepDiv.classList.add('active');
        }
    });
}

async function markPrimaryAsComplete(brewId) {
    if (!userId || !brewId) return;
    try {
        const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
        await updateDoc(brewDocRef, { primaryComplete: true });
        
        // Update ook de lokale data onmiddellijk
        const brewIndex = brews.findIndex(b => b.id === brewId);
        if (brewIndex > -1) {
            brews[brewIndex].primaryComplete = true;
        }
    } catch (error) {
        console.error("Could not mark primary as complete:", error);
    }
}

window.finalizeBrewDay1 = async function() {
    // Stap 1: Bouw de inhoud van de (nog verborgen) Brew Day 2 weergave opnieuw op.
    renderBrewDay2();

    // Stap 2: Schakel nu pas over naar de weergave om deze zichtbaar te maken.
    window.switchSubView('brew-day-2', 'brewing-main-view');

    // Stap 3: Reset de Brew Day 1 status
    currentBrewDay = { brewId: null };
    await saveUserSettings(); // Sla de lege status op in de database

    // Stap 4: Maak de Brew Day 1 view visueel leeg voor de volgende batch
    renderBrewDay('none');
}

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "00:00";
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                if (h > 0) {
                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                }
                return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
   
            // --- Analysis Functions ---
// --- VERVANG JE VOLLEDIGE generateShoppingList FUNCTIE MET DEZE ---
window.generateShoppingList = function(brewId, navigate = false) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    const listState = brew.shoppingListState || {};

    const convertToBaseUnit = (quantity, unit) => {
        const u = unit.toLowerCase();
        if (u === 'kg') return { quantity: quantity * 1000, unit: 'g' };
        if (u === 'l') return { quantity: quantity * 1000, unit: 'ml' };
        return { quantity, unit: u };
    };

    const requiredIngredients = parseIngredientsFromMarkdown(brew.recipeMarkdown);
    const shoppingList = [];

    requiredIngredients.forEach(req => {
        const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
        const requiredAmount = convertToBaseUnit(req.quantity, req.unit);
        let stockAmount = { quantity: 0, unit: requiredAmount.unit };

        if (invItem) {
            stockAmount = convertToBaseUnit(invItem.qty, invItem.unit);
            if (stockAmount.unit !== requiredAmount.unit) {
                console.warn(`Unit mismatch for ${req.name}`);
            }
        }

        if (!invItem || stockAmount.quantity < requiredAmount.quantity) {
            let toBuy = requiredAmount.quantity - stockAmount.quantity;
            let unitToDisplay = req.unit;
            if (req.unit.toLowerCase() === 'g' && toBuy >= 1000) { 
                toBuy /= 1000;
                unitToDisplay = 'kg';
            } else if (req.unit.toLowerCase() === 'ml' && toBuy >= 1000) { 
                toBuy /= 1000;
                unitToDisplay = 'L';
            }
            shoppingList.push({ name: req.name, quantity: toBuy, unit: unitToDisplay });
        }
    });

    const contentDiv = document.getElementById('shopping-list-content');
    let html = `<h4 class="text-xl font-header mb-4">${brew.recipeName} - Shopping List</h4>`;
    
    if (shoppingList.length > 0) {
            html += `<div id="shopping-list-items" class="space-y-2">`;
            html += shoppingList.map((item, index) => {
                const displayQty = Number.isInteger(item.quantity) ? item.quantity : item.quantity.toFixed(2);
                const isChecked = listState[item.name] || false;
                const escapedItemName = item.name.replace(/'/g, "\\'");

                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="shop-item-${index}" 
                               onchange="window.updateShoppingListItemStatus('${brew.id}', '${escapedItemName}', this.checked)" 
                               class="h-5 w-5 rounded border-gray-300 text-app-brand focus:ring-app-brand flex-shrink-0"
                               ${isChecked ? 'checked' : ''}>
                        <label for="shop-item-${index}" class="ml-3 text-app-primary">${item.name}: ${displayQty} ${item.unit}</label>
                    </div>
                `;
            }).join('');
            html += `</div>`;
            
            html += `
                <div class="mt-6 pt-4 border-t border-app">
                    <button id="add-to-inventory-btn" onclick="window.addMissingItemsToInventory('${brew.id}')" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
                        Add Missing Items to Inventory (as 0 qty)
                    </button>
                </div>
            `;

            html += `<div id="start-brew-day-container" class="mt-6 text-center hidden">
                    <p class="text-green-600 dark:text-green-400 font-semibold mb-2">All items acquired!</p>
                    <button onclick="window.startActualBrewDay('${brew.id}')" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 btn">Let's Start Brewing!</button>
                 </div>`;
    } else {
            html += `<p class="text-green-600 dark:text-green-400 font-semibold mb-4">You have all the ingredients you need!</p>`;
            html += `<button onclick="window.startActualBrewDay('${brew.id}')" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 btn">Let's Start Brewing!</button>`;
    }

    contentDiv.innerHTML = html;
    
    if (navigate) {
        switchMainView('brewing');
        switchSubView('shopping-list', 'brewing-main-view');
    }
    
    checkShoppingList(brewId);
}

            window.updateShoppingListItemStatus = async function(brewId, ingredientName, isChecked) {
                if (!userId) return;
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                // Initialiseer de shoppingListState als deze nog niet bestaat
                if (!brew.shoppingListState) {
                    brew.shoppingListState = {};
                }
                // Update de status voor het specifieke ingredint
                brew.shoppingListState[ingredientName] = isChecked;

                try {
                    // Sla de bijgewerkte staat op in Firestore
                    const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, {
                        shoppingListState: brew.shoppingListState
                    });
                    
                    // Roep de bestaande functie aan om te controleren of de "Start Brew Day" knop getoond moet worden
                    checkShoppingList(brewId);

                } catch (error) {
                    console.error("Error updating shopping list state:", error);
                    showToast("Could not save shopping list status.", "error");
                }
            }

            window.addMissingItemsToInventory = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew || !userId) return;

                const addButton = document.getElementById('add-to-inventory-btn');
                addButton.disabled = true;
                addButton.textContent = 'Adding...';

                const requiredIngredients = parseIngredientsFromMarkdown(brew.recipeMarkdown);
                const missingItems = [];

                requiredIngredients.forEach(req => {
                    const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
                    // Voeg enkel toe als het item VOLLEDIG ontbreekt in de inventaris
                    if (!invItem) {
                        missingItems.push({ name: req.name, unit: req.unit });
                    }
                });

                if (missingItems.length === 0) {
                    showToast("All items already exist in your inventory.", "info");
                    addButton.textContent = 'No New Items to Add';
                    return;
                }

                const batch = writeBatch(db);
                const appId = 'meandery-aa05e';
                const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');

                missingItems.forEach(item => {
                    const newItemRef = doc(invCol);
                    // Probeer een categorie af te leiden, anders gebruik 'Adjunct'
                    let category = 'Adjunct';
                    const nameLower = item.name.toLowerCase();
                    if (nameLower.includes('honey')) category = 'Honey';
                    else if (nameLower.includes('yeast')) category = 'Yeast';
                    else if (nameLower.includes('malt')) category = 'Malt Extract';
                    else if (nameLower.includes('fermaid') || nameLower.includes('go-ferm')) category = 'Nutrient';
                    
                    const newItemData = {
                        userId: userId,
                        name: item.name,
                        qty: 0,
                        unit: item.unit.toLowerCase(),
                        price: 0,
                        category: category,
                        expirationDate: null
                    };
                    batch.set(newItemRef, newItemData);
                });

                try {
                    await batch.commit();
                    showToast(`${missingItems.length} missing item(s) added to inventory. You can now update their quantity and price.`, 'success');
                    addButton.textContent = 'Added to Inventory!';
                    generateShoppingList(brewId, false); 
                } catch (error) {
                    console.error("Error adding missing items to inventory:", error);
                    showToast("Could not add items to inventory.", "error");
                    addButton.disabled = false;
                    addButton.textContent = 'Add Missing Items to Inventory (as 0 qty)';
                }
            } 

window.checkShoppingList = function(brewId) {
    const checkboxes = document.querySelectorAll('#shopping-list-items input[type="checkbox"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    const container = document.getElementById('start-brew-day-container');
    if (container) { // Voer de code enkel uit als de container bestaat
        container.classList.toggle('hidden', !allChecked);
    }
}

window.startActualBrewDay = async function(brewId) {
    const brew = brews.find(b => b.id === brewId);
    if (!brew) return;

    // --- (Datum logica blijft hetzelfde) ---
    if (!brew.logData.brewDate) {
        brew.logData.brewDate = new Date().toISOString().split('T')[0];
        try {
            const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
            await updateDoc(brewDocRef, { logData: brew.logData });
            const brewIndex = brews.findIndex(b => b.id === brewId);
            if (brewIndex > -1) {
                brews[brewIndex].logData.brewDate = brew.logData.brewDate;
            }
            showToast("Brew date set to today!", "info");
        } catch (error) {
            console.error("Could not auto-set brew date:", error);
        }
    }

    // --- AANGEPAST: Stel de *globale* pointer in...
    currentBrewDay = { brewId: brewId };
    saveUserSettings(); // Sla de *pointer* op

    // --- ...en controleer de *lokale* checklist van het brouwsel.
    const brewIndex = brews.findIndex(b => b.id === brewId);
    if (brewIndex > -1) {
        // We wissen de checklist alleen als de gebruiker dit vraagt.
        // We gaan ervan uit dat als ze "Start" klikken, ze een verse start willen.
        if (brews[brewIndex].checklist && Object.keys(brews[brewIndex].checklist).length > 0) {
            if (confirm("You have existing progress for this brew. Do you want to reset it and start over?")) {
                brews[brewIndex].checklist = {};
                // Sla de lege checklist meteen op
                try {
                    const brewDocRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, { checklist: {} });
                } catch (e) { console.error("Could not reset checklist", e); }
            }
        } else {
             brews[brewIndex].checklist = {}; // Initialiseer als leeg
        }
    }

    window.switchSubView('brew-day-1', 'brewing-main-view');
    renderBrewDay(brewId);
}

            // --- Social Media Functies ---

            window.generateSocialContent = async function(brewId) {
                const socialView = document.getElementById('social-view');
                socialView.dataset.brewId = brewId; // Sla de brewId op voor later gebruik

                switchMainView('tools');
                switchSubView('social', 'tools-main-view');

                runSocialMediaGenerator(); 
            }

            async function runSocialMediaGenerator() {
                const selectedBrewId = document.getElementById('social-recipe-select').value;
                if (!selectedBrewId) {
                    alert("Please select a recipe from the dropdown list first.");
                    return;
                }
                const brew = brews.find(b => b.id === selectedBrewId);
                if (!brew) {
                    alert("Could not find the selected recipe data.");
                    return;
                }
                document.getElementById('social-output-container').classList.remove('hidden');
                const socialContainer = document.getElementById('social-content-container');
                const imageContainer = document.getElementById('social-image-container');
                socialContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Your buddy is writing a post for you...</p>';
                imageContainer.innerHTML = '';
                const persona = document.getElementById('social-persona').value;
                const platform = document.getElementById('social-platform').value;
                const tweak = document.getElementById('social-tweak').value;
                const negativeConstraint = " CRUCIAL: Do not wrap your response in a markdown code block using triple backticks (```).";
                let personaPrompt = "You are an homebrewer sharing your passion.";
                if (persona === 'pro_brewery') personaPrompt = "You are a social media expert for a professional craft brewery.";
                else if (persona === 'sommelier') personaPrompt = "You are a knowledgeable mead sommelier, focusing on tasting notes and pairings.";
                let platformPrompt = "Generate a short, engaging Instagram post. Use relevant emojis and hashtags." + negativeConstraint;
                if (platform === 'untappd_checkin') platformPrompt = "Generate a descriptive PERSONAL check-in description for Untappd. Write from a first-person perspective (e.g., 'I get notes of...'). Focus on aroma, appearance, taste, and mouthfeel. Do not use hashtags." + negativeConstraint;
                else if (platform === 'untappd_description') platformPrompt = "Generate an official, commercial description for a new mead to be added to Untappd. The description should be objective, informative, and appealing, detailing the style, key ingredients, and expected flavor profile. This is NOT a personal check-in. Do not use hashtags." + negativeConstraint;
                let tweakPrompt = tweak.trim() !== '' ? `An additional instruction from the user is: "${tweak}". You must follow this instruction.` : "";
                const finalPrompt = `${personaPrompt} ${platformPrompt} ${tweakPrompt} Base the content on the following mead recipe:\n\n---\n${brew.recipeMarkdown}\n---\nFormat the entire response in Markdown.`;
                try {
                    const socialMarkdown = await performApiCall(finalPrompt);
                    let processedMarkdown = socialMarkdown.trim();
                    if (processedMarkdown.startsWith("```markdown")) processedMarkdown = processedMarkdown.substring(10, processedMarkdown.lastIndexOf("```")).trim();
                    else if (processedMarkdown.startsWith("```")) processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
                    const socialHtml = marked.parse(processedMarkdown);
                    
                    // AANGEPAST: Voeg de save knop toe
                    // PLAK DEZE NIEUWE CODE
socialContainer.innerHTML = `
    <div>${socialHtml}</div>
    <div class="mt-6 space-y-2">
        <button id="trigger-image-generation-btn" class="w-full bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">
            Generate Image (Uses Credits)
        </button>
        <button id="save-social-post-btn" onclick="window.saveSocialPost()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
            Save Post to Recipe Notes
        </button>
    </div>
`;

document.getElementById('trigger-image-generation-btn').addEventListener('click', function(e) {
    generateSocialImage(brew.recipeName, processedMarkdown);
    e.target.style.display = 'none'; // Verberg de knop na het klikken
});
                } catch (error) {
                    console.error("Error generating social content:", error);
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Could not generate social post: ${error.message}</p>`;
                }
            }

            async function runManualSocialMediaGenerator() {
                const socialContainer = document.getElementById('social-content-container');
                const imageContainer = document.getElementById('social-image-container');
                const manualInput = document.getElementById('manual-social-input').value;
                if (!manualInput.trim()) {
                    alert("Voer eerst een onderwerp in om een post te genereren.");
                    return;
                }
                document.getElementById('social-output-container').classList.remove('hidden');
                socialContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Je buddy schrijft een nieuw bericht voor je...</p>';
                imageContainer.innerHTML = '';
                const persona = document.getElementById('social-persona').value;
                const platform = document.getElementById('social-platform').value;
                const tweak = document.getElementById('social-tweak').value;
                const negativeConstraint = " CRUCIAL: Do not wrap your response in a markdown code block using triple backticks (```).";
                let personaPrompt = "You are an enthusiastic homebrewer sharing your passion.";
                if (persona === 'pro_brewery') personaPrompt = "You are a social media expert for a professional craft brewery.";
                else if (persona === 'sommelier') personaPrompt = "You are a knowledgeable mead sommelier, focusing on tasting notes and pairings.";
                let platformPrompt = "Generate a short, engaging Instagram post. Use relevant emojis and hashtags." + negativeConstraint;
                if (platform === 'untappd_checkin') platformPrompt = "Generate a descriptive PERSONAL check-in description for Untappd. Write from a first-person perspective. Focus on aroma, appearance, taste, and mouthfeel. Do not use hashtags." + negativeConstraint;
                else if (platform === 'untappd_description') platformPrompt = "Generate an official, commercial description for a new mead to be added to Untappd. The description should be objective and informative. This is NOT a personal check-in. Do not use hashtags." + negativeConstraint;
                let tweakPrompt = tweak.trim() !== '' ? `An additional instruction from the user is: "${tweak}". You must follow this instruction.` : "";
                const finalPrompt = `${personaPrompt} ${platformPrompt} ${tweakPrompt} Base the content on the following topic or description provided by the user:\n\n---\n${manualInput}\n---\nFormat the entire response in Markdown.`;
                try {
                    const socialMarkdown = await performApiCall(finalPrompt);
                    let processedMarkdown = socialMarkdown.trim();
                    if (processedMarkdown.startsWith("```markdown")) processedMarkdown = processedMarkdown.substring(10, processedMarkdown.lastIndexOf("```")).trim();
                    else if (processedMarkdown.startsWith("```")) processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
                    const socialHtml = marked.parse(processedMarkdown);

                    // AANGEPAST: Voeg de save knop toe
                    // PLAK DEZE NIEUWE CODE
socialContainer.innerHTML = `
    <div>${socialHtml}</div>
    <div class="mt-6 space-y-2">
        <button id="trigger-image-generation-btn" class="w-full bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">
            Generate Image (Uses Credits)
        </button>
        <button id="save-social-post-btn" onclick="window.saveSocialPost()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn text-sm">
            Save Post to Recipe Notes
        </button>
    </div>
`;

document.getElementById('trigger-image-generation-btn').addEventListener('click', function(e) {
    generateSocialImage(manualInput, processedMarkdown);
    e.target.style.display = 'none'; // Verberg de knop na het klikken
});
                } catch (error) {
                    console.error("Error generating manual social content:", error);
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Kon geen social media post genereren: ${error.message}</p>`;
                }
            }

function populateSocialRecipeDropdown() {
    const select = document.getElementById('social-recipe-select');
    if (!select) return;

    // Bewaar de huidige selectie
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">-- Choose a Recipe --</option>'; // Reset
    
    brews.forEach(brew => {
        const option = document.createElement('option');
        option.value = brew.id;
        option.textContent = brew.recipeName;
        select.appendChild(option);
    });

    // Herstel de selectie indien mogelijk
    select.value = currentValue;
}

            async function generateSocialImage(title, description) {
    const imageContainer = document.getElementById('social-image-container');
    imageContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Your buddy is painting a masterpiece...</p>';

    const imageApiKey = userSettings.imageApiKey;
    if (!imageApiKey) {
        imageContainer.innerHTML = `<p class="text-center text-red-500">Please enter your Image Generation API key in the Settings page first.</p>`;
        return;
    }

    const imagePrompt = `You are an AI image generation expert. Create a short, descriptive, powerful prompt for an image generator based on the following mead. The prompt should be in English. The final image should be a high-quality, photorealistic shot of the mead in a bottle or glass, styled for a professional product advertisement.
    
    Mead Title: "${title}"
    Description: "${description}"

    Generate ONLY the image prompt itself, focusing on visual elements.`;

    try {
        const generatedImagePrompt = await performApiCall(imagePrompt);
        
        const engineId = 'stable-diffusion-xl-1024-v1-0';
        const apiHost = 'https://api.stability.ai';
        const apiUrl = `${apiHost}/v1/generation/${engineId}/text-to-image`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${imageApiKey}`
            },
            body: JSON.stringify({
                text_prompts: [
                    {
                        "text": `A photorealistic image of: ${generatedImagePrompt}, cinematic lighting, high detail, commercial photography`
                    }
                ],
                cfg_scale: 7,
                height: 1024,
                width: 1024,
                steps: 30,
                samples: 1,
            }),
        });

        if (!response.ok) {
            throw new Error(`Stability AI request failed with status ${response.status}: ${await response.text()}`);
        }

        const result = await response.json();

        if (result.artifacts && result.artifacts[0] && result.artifacts[0].base64) {
            const imageData = result.artifacts[0].base64;
            const imageSrc = `data:image/png;base64,${imageData}`;

            imageContainer.innerHTML = `
                <img src="${imageSrc}" alt="AI-generated image for ${title}" class="rounded-lg mx-auto shadow-lg">
                <p class="text-xs text-app-secondary/80 mt-2"><strong>Image Prompt:</strong> ${generatedImagePrompt}</p>
                <p class="text-xs text-app-secondary/60 mt-1">Generated with Stable Diffusion</p>
            `;
        } else {
            throw new Error("Invalid image data in Stability AI response.");
        }

    } catch (error) {
        console.error("Error generating social image:", error);
        imageContainer.innerHTML = `<p class="text-center text-red-500">Could not generate image: ${error.message}</p>`;
    }
}

// --- VERVANG JE VOLLEDIGE parseIngredientsFromMarkdown FUNCTIE MET DEZE ---
function parseIngredientsFromMarkdown(markdown) {
    const ingredients = [];

    // Poging 1: Zoek naar een JSON-blok (de nieuwe, robuuste methode)
    const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
    const jsonMatch = markdown.match(jsonRegex);

    if (jsonMatch && jsonMatch[1]) {
        try {
            const ingredientsArray = JSON.parse(jsonMatch[1]);
            return ingredientsArray.map(item => ({
                name: (item.ingredient || '').trim(),
                quantity: parseFloat(item.quantity) || 0,
                unit: (item.unit || '').trim()
            }));
        } catch (e) {
            console.error("Failed to parse JSON block, falling back to table parser.", e);
        }
    }

    // Poging 2: Fallback naar de oude tabel-parser
    const tableContentRegex = /\|-+\|.*\n([\s\S]*?)(?:\n\n|##|$)/;
    const match = markdown.match(tableContentRegex);

    if (!match || !match[1]) {
        console.warn("Definitive parser could not find ingredient table content.");
        return ingredients; // Geef lege lijst terug als beide methodes falen
    }

    const rows = match[1].trim().split('\n').filter(row => row.trim().startsWith('|'));
    rows.forEach(row => {
        const columns = row.split('|').map(c => c.trim()).slice(1, 4);
        if (columns.length === 3) {
            const [name, quantityStr, unit] = columns;
            const quantity = parseFloat(quantityStr);
            if (name && !isNaN(quantity)) {
                ingredients.push({ name: name.trim(), quantity: quantity, unit: (unit || '').trim() });
            }
        }
    });

    return ingredients;
}

            // getPackagingCosts FUNCTIE
            function getPackagingCosts() {
                const calculatedCosts = {};
    
                PACKAGING_ITEMS.forEach(item => {
                    const itemData = packagingCosts[item.id];
                    let costPerUnit = 0;
                    if (itemData && itemData.qty > 0 && itemData.price > 0) {
                        costPerUnit = itemData.price / itemData.qty;
                    }
        
                    // Specifieke mapping voor de bottel-logica
                    if (item.id === 'bottle_750') calculatedCosts['750'] = costPerUnit;
                    if (item.id === 'bottle_500') calculatedCosts['500'] = costPerUnit;
                    if (item.id === 'bottle_450') calculatedCosts['450'] = costPerUnit; // <-- NIEUW
                    if (item.id === 'bottle_330') calculatedCosts['330'] = costPerUnit;
                    if (item.id === 'bottle_250') calculatedCosts['250'] = costPerUnit;
                    if (item.id === 'cork') calculatedCosts['cork'] = costPerUnit;
                    if (item.id === 'crown_cap_26') calculatedCosts['crown_cap_26'] = costPerUnit; // <-- AANGEPAST
                    if (item.id === 'crown_cap_29') calculatedCosts['crown_cap_29'] = costPerUnit; // <-- NIEUW
                    if (item.id === 'label') calculatedCosts['label'] = costPerUnit;
                });
 
                return calculatedCosts;
            }

            function updateCostAnalysis() {
    const currency = userSettings.currencySymbol || '';
    // Berekening inventariswaarde blijft hetzelfde
    const totalSpend = inventory.reduce((acc, item) => acc + (item.price || 0), 0);
    document.getElementById('total-spend').textContent = `${currency}${totalSpend.toFixed(2)}`;

    // NIEUW: Bereken de totale kelderwaarde
    const packagingCostsPerUnit = getPackagingCosts();

const totalCellarValue = cellar.reduce((totalValue, cellarItem) => {
    const originalBrew = brews.find(b => b.id === cellarItem.brewId);
    if (!originalBrew) return totalValue; // Sla over als het originele brouwsel niet is gevonden

    const ingredientCostPerLiter = (cellarItem.ingredientCost || 0) / (originalBrew.batchSize || 1);

    const valueOfThisCellarItem = cellarItem.bottles.reduce((itemValue, bottle) => {
        if (bottle.quantity <= 0) return itemValue; // Sla flessen over die niet meer op voorraad zijn

        const meadCostInBottle = ingredientCostPerLiter * (bottle.size / 1000);

        const bottleCost = packagingCostsPerUnit[bottle.size.toString()] || 0;
        let closureCost = 0;
        if (bottle.size >= 750) { closureCost = packagingCostsPerUnit.cork || 0; }
        else if (bottle.size >= 500) { closureCost = packagingCostsPerUnit.crown_cap_29 || 0; }
        else { closureCost = packagingCostsPerUnit.crown_cap_26 || 0; }
        const labelCost = packagingCostsPerUnit.label || 0;

        const singleBottleTotalCost = meadCostInBottle + bottleCost + closureCost + labelCost;

        return itemValue + (singleBottleTotalCost * bottle.quantity);
    }, 0);

    return totalValue + valueOfThisCellarItem;
}, 0);

document.getElementById('total-cellar-value').textContent = `${currency}${totalCellarValue.toFixed(2)}`;
    document.getElementById('total-cellar-value').textContent = `${currency}${totalCellarValue.toFixed(2)}`;

    // De rest van de functie (grafiek) blijft hetzelfde
    const spendByCategory = inventory.reduce((acc, item) => {
        acc[item.category] = (acc[item.category] || 0) + (item.price || 0);
        return acc;
    }, {});
    const ctx = document.getElementById('cost-chart').getContext('2d');
    const chartData = {
        labels: Object.keys(spendByCategory),
        datasets: [{
            label: 'Spend by Category',
            data: Object.values(spendByCategory),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#7BC225'],
        }]
    };
    if (costChart) { costChart.destroy(); }
    costChart = new Chart(ctx, { type: 'doughnut', data: chartData, options: { /* ... */ } });
}

            function renderFermentationGraph(brewId) {
                const brew = brews.find(b => b.id === brewId);
                // Zorg ervoor dat er logdata is met geldige waarden
                if (!brew || !brew.logData || !brew.logData.fermentationLog) return;

                const logData = brew.logData.fermentationLog
                    .filter(entry => entry.date && entry.sg) // Filter op entries die een datum en SG hebben
                    .sort((a, b) => new Date(a.date) - new Date(b.date)); // Sorteer op datum

                if (logData.length < 2) return; // We hebben minstens 2 punten nodig voor een lijn

                const labels = logData.map(entry => new Date(entry.date).toLocaleDateString());
                const sgData = logData.map(entry => parseFloat(entry.sg));

                const canvasId = `fermChart-${brewId}`;
                const ctx = document.getElementById(canvasId);
                if (!ctx) return; // Stop als de canvas niet gevonden kan worden

                // Verwijder een eventuele oude grafiek voordat we een nieuwe tekenen
                if (window.fermChartInstances && window.fermChartInstances[canvasId]) {
                window.fermChartInstances[canvasId].destroy();
                }
                if (!window.fermChartInstances) {
                window.fermChartInstances = {};
           }

                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');

                window.fermChartInstances[canvasId] = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                        label: 'Specific Gravity (SG)',
                        data: sgData,
                        borderColor: brandColor,
                        backgroundColor: brandColor + '33', // Transparante vulling
                        tension: 0.1,
                        fill: true,
                    }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         title: { display: false },
                         legend: { display: false }
                     },
                     scales: {
                         x: {
                             ticks: { color: textColor },
                             grid: { color: borderColor }
                         },
                         y: {
                            title: {
                                display: true,
                                text: 'Specific Gravity',
                                color: textColor
                     },
                     ticks: { 
                         color: textColor,
                         // Formatteer de y-as labels (bv. 1.050)
                         callback: function(value) { return value.toFixed(3); }
                     },
                     grid: { color: borderColor }
                 }
             }
         }
     });
 }

            // --- Troubleshooter Functions ---
            async function getTroubleshootingAdvice() {
                const description = document.getElementById('troubleshoot-description').value;
                const outputDiv = document.getElementById('troubleshoot-output');

                if (!description.trim()) {
                    outputDiv.innerHTML = `<p class="text-red-500">Please describe your problem first.</p>`;
                    return;
                }

                outputDiv.innerHTML = '<div class="loader"></div>';
                
                const prompt = `You are an expert mead maker and troubleshooter. A user is having a problem with their mead. Their description of the problem is: "${description}". Provide a step-by-step guide to help them diagnose the issue. Ask clarifying questions they should answer for themselves, suggest potential causes, and offer clear, actionable solutions. Format the response in Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    outputDiv.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting troubleshooting advice:", error);
                    outputDiv.innerHTML = `<p class="text-center text-red-500">Could not get advice: ${error.message}</p>`;
                }
            }

            // --- Label Generator Functies ---
            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoPreview = document.getElementById('label-logo-preview');
                        logoPreview.src = e.target.result;
                        logoPreview.classList.remove('hidden');
                        
                        // Maak de 'verwijder' knop zichtbaar
                        document.getElementById('removeLogoBtn').classList.remove('hidden');

                        updateLabelPreview();
                    }
                    reader.readAsDataURL(file);
                }
            }

            function removeLogo() {
                const logoPreview = document.getElementById('label-logo-preview');
                const logoUploadInput = document.getElementById('logoUpload');
                const removeBtn = document.getElementById('removeLogoBtn');

                // Verberg de preview en reset de bron
                logoPreview.src = '';
                logoPreview.classList.add('hidden');

                // Reset de waarde van het file input veld
                logoUploadInput.value = '';

                // Verberg de 'verwijder' knop weer
                removeBtn.classList.add('hidden');
                
                updateLabelPreview();
            }  

            function updateLabelPreview() {
                const select = document.getElementById('labelRecipeSelect');
                const selectedBrew = brews.find(b => b.id === select.value);
                const fullTitle = (select.options[select.selectedIndex] && select.value) ? select.options[select.selectedIndex].text : 'Mead Name';

                let namePart = fullTitle;
                if (fullTitle.includes(':')) { namePart = fullTitle.split(':')[0]; } 
                else if (fullTitle.includes(' - ')) { namePart = fullTitle.split(' - ')[0]; }
                
                document.getElementById('label-name-preview').textContent = namePart;
                document.getElementById('label-style-preview').textContent = document.getElementById('labelStyle').value || 'Style / Subtitle';
                
                const date = document.getElementById('labelDate').value || 'Bottling Date';
                const abv = document.getElementById('labelAbv').value || 'ABV';
                const volValue = parseFloat(document.getElementById('labelVol').value);
                const vol = !isNaN(volValue) ? (volValue >= 1000 ? `${(volValue / 1000).toFixed(1)} L` : `${volValue} ml`) : 'VOL';

                document.getElementById('label-date-preview').textContent = date;
                document.getElementById('label-abv-preview').textContent = abv;
                document.getElementById('label-vol-preview').textContent = vol;

                const allergensContainer = document.getElementById('label-allergens-container');
                const ogContainer = document.getElementById('label-og-preview');
                const fgContainer = document.getElementById('label-fg-preview');
                const yeastContainer = document.getElementById('label-yeast-preview');

                if (selectedBrew) {
                    ogContainer.textContent = selectedBrew.logData?.targetOG || 'N/A';
                    fgContainer.textContent = selectedBrew.logData?.actualFG || selectedBrew.logData?.targetFG || 'N/A';
                    const ingredients = parseIngredientsFromMarkdown(selectedBrew.recipeMarkdown);
                    yeastContainer.textContent = ingredients.find(i => i.name.toLowerCase().includes('yeast'))?.name.replace('Yeast','').trim() || 'N/A';

                    const allergens = [];
                    const markdown = selectedBrew.recipeMarkdown.toLowerCase();
                    if (markdown.includes('metabisulfite')) allergens.push('sulfites');
                    if (markdown.includes('lactose')) allergens.push('lactose');
                    if (markdown.includes('barley') || markdown.includes('malt')) allergens.push('gluten');

                    if (allergens.length > 0) {
                        allergensContainer.innerHTML = `Contains: <strong>${allergens.join(', ')}</strong>`;
                        allergensContainer.classList.remove('hidden');
                    } else {
                        allergensContainer.classList.add('hidden');
                    }
                } else {
                    if (allergensContainer) allergensContainer.classList.add('hidden');
                }
            }

            function switchLabelStyle(styleName) {
                const labelPreview = document.getElementById('label-preview');
                
                // Wissel de stijl-class op de preview zelf
                labelPreview.classList.remove('label-minimalist', 'label-industrial', 'label-professional');
                labelPreview.classList.add(`label-${styleName}`);

                // Werk de actieve status van de knoppen bij
                document.querySelectorAll('.label-style-btn').forEach(btn => {
                    const isSelected = btn.dataset.style === styleName;
                    
                    // Verwijder eerst alle mogelijke status-classes
                    btn.classList.remove('border-2', 'border-app-brand', 'text-app-brand', 'border', 'border-app');
                    
                    if (isSelected) {
                        // Voeg de 'actieve' classes toe aan de geselecteerde knop
                        btn.classList.add('border-2', 'border-app-brand', 'text-app-brand');
                    } else {
                        // Voeg de standaard 'inactieve' classes toe aan de andere knoppen
                        btn.classList.add('border', 'border-app');
                    }
                });
            }

            function setLabelOrientation(orientation) {
                // Update de actieve status van de knoppen
                document.querySelectorAll('.orientation-btn').forEach(btn => {
                    const isSelected = btn.dataset.orientation === orientation;
                    btn.classList.toggle('active', isSelected);
                    btn.classList.toggle('border-2', isSelected);
                    btn.classList.toggle('border-app-brand', isSelected);
                    btn.classList.toggle('text-app-brand', isSelected);
                    btn.classList.toggle('border', !isSelected);
                    btn.classList.toggle('border-app', !isSelected);
                });
                // Roep de functie aan die de preview bijwerkt
                updatePreviewAspectRatio();
            }

            function updatePreviewAspectRatio() {
                const previewDiv = document.getElementById('label-preview');
                const formatSelector = document.getElementById('labelFormatSelect');
                if (!previewDiv || !formatSelector) return;

                // Bepaal de actieve orintatie
                const orientation = document.querySelector('.orientation-btn.active')?.dataset.orientation || 'vertical';

                let format;
                if (formatSelector.value === 'custom') {
                    format = {
                        width_mm: parseFloat(document.getElementById('customWidth').value) || 1,
                        height_mm: parseFloat(document.getElementById('customHeight').value) || 1,
                    };
                } else {
                    format = labelFormats[formatSelector.value];
                }

                if (format && format.width_mm && format.height_mm) {
                    if (orientation === 'horizontal') {
                        // Gebruik de normale verhouding voor een liggende (horizontale) weergave
                        previewDiv.style.aspectRatio = `${format.width_mm} / ${format.height_mm}`;
                    } else {
                        // Wissel de breedte en hoogte voor een staande (verticale) weergave
                        previewDiv.style.aspectRatio = `${format.height_mm} / ${format.width_mm}`;
                    }
                }
            }

            function generatePrintPage() {
                const labelHTML = document.getElementById('label-preview').outerHTML;
                const formatSelector = document.getElementById('labelFormatSelect');
                let format;

                if (formatSelector.value === 'custom') {
                    format = {
                        width_mm: parseFloat(document.getElementById('customWidth').value),
                        height_mm: parseFloat(document.getElementById('customHeight').value),
                        cols: parseInt(document.getElementById('customCols').value),
                        rows: parseInt(document.getElementById('customRows').value),
                        top_margin_mm: parseFloat(document.getElementById('customMarginTop').value),
                        left_margin_mm: parseFloat(document.getElementById('customMarginLeft').value),
                    }
                } else {
                    format = labelFormats[formatSelector.value];
                }

                const totalLabels = format.cols * format.rows;
                let printContent = '';
                for (let i = 0; i < totalLabels; i++) {
                    printContent += labelHTML.replace('id="label-preview"', `class="print-label ${labelPreview.className}"`);
                }

                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>Print Labels - ${format.name || 'Custom'}</title>
                            <style>
                                @page { size: A4; margin: 0; }
                                body { margin: 0; }
                                .print-container {
                                    display: grid;
                                    grid-template-columns: repeat(${format.cols}, 1fr);
                                    gap: 0;
                                    padding-top: ${format.top_margin_mm}mm;
                                    padding-left: ${format.left_margin_mm}mm;
                                    width: 210mm;
                                    height: 297mm;
                                    box-sizing: border-box;
                                }
                                .print-label {
                                    width: ${format.width_mm}mm;
                                    height: ${format.height_mm}mm;
                                    box-sizing: border-box;
                                    overflow: hidden;
                                }
                                ${document.querySelector('style').innerHTML}
                            </style>
                        </head>
                        <body>
                            <div class="print-container">${printContent}</div>
                        </body>
                    </html>
                `);
                newWindow.document.close();
                newWindow.focus();
                setTimeout(() => { newWindow.print(); }, 500);
            }


function populateLabelRecipeDropdown() {
    const select = document.getElementById('labelRecipeSelect');
    if (!select) return;
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Choose a Saved Recipe --</option>';
    brews.forEach(brew => {
        const option = document.createElement('option');
        option.value = brew.id;

        // Splits de titel en gebruik alleen het deel vr de dubbele punt of het streepje.
        let displayName = brew.recipeName || 'Untitled Brew';
        if (displayName.includes(':')) {
            displayName = displayName.split(':')[0].trim();
        } else if (displayName.includes(' - ')) {
            displayName = displayName.split(' - ')[0].trim();
        }
        option.textContent = displayName;
        
        select.appendChild(option);
    });
    select.value = currentValue;
}

            // --- VERVANG JE VOLLEDIGE handleLabelRecipeSelect FUNCTIE MET DEZE ---
function handleLabelRecipeSelect(event) {
    const brewId = event.target.value;
    const styleInput = document.getElementById('labelStyle');
    const abvInput = document.getElementById('labelAbv');
    const volInput = document.getElementById('labelVol');
    const dateInput = document.getElementById('labelDate');
    
    if (!brewId) {
        // Maak velden leeg als de gebruiker "-- Choose --" selecteert
        if(styleInput) styleInput.value = '';
        if(abvInput) abvInput.value = '';
        if(volInput) volInput.value = '';
        if(dateInput) dateInput.value = '';
        updateLabelPreview();
        return;
    }

    const selectedBrew = brews.find(b => b.id === brewId);
    if (!selectedBrew) return;

    // Haal de volledige titel uit de originele data, niet uit de dropdown.
    const fullTitle = selectedBrew.recipeName;
    let subtitlePart = '';

    if (fullTitle.includes(':')) {
        const parts = fullTitle.split(/:\s*(.*)/s);
        subtitlePart = parts[1] || '';
    } else if (fullTitle.includes(' - ')) {
        const parts = fullTitle.split(/\s*-\s*(.*)/s);
        subtitlePart = parts[1] || '';
    }

    // Vul de input-velden in
    if(styleInput) styleInput.value = subtitlePart;
    if(abvInput) abvInput.value = selectedBrew.logData?.finalABV?.replace('%','') || selectedBrew.logData?.targetABV?.replace('%','') || '';
    if(volInput) volInput.value = selectedBrew.batchSize ? selectedBrew.batchSize * 1000 : '750';
    if(dateInput) dateInput.value = selectedBrew.createdAt ? selectedBrew.createdAt.toDate().toLocaleDateString('en-GB', { month: 'long', year: 'numeric' }) : '';
    
    // Update de visuele preview
    updateLabelPreview();
}

            function updateLabelPreview() {
                // Haal alle elementen op
                const namePreview = document.getElementById('label-name-preview');
                const stylePreview = document.getElementById('label-style-preview');
                const abvPreview = document.getElementById('label-abv-preview');
                const volPreview = document.getElementById('label-vol-preview');
                const datePreview = document.getElementById('label-date-preview');
                const ogPreview = document.getElementById('label-og-preview');
                const fgPreview = document.getElementById('label-fg-preview');
                const allergensContainer = document.getElementById('label-allergens-container');
                const select = document.getElementById('labelRecipeSelect');
                const styleInput = document.getElementById('labelStyle');
                
                // --- Update naam en ondertitel ---
                const selectedOption = select.options[select.selectedIndex];
                const fullTitle = (selectedOption && selectedOption.value) ? selectedOption.text : 'Mead Name';
                let namePart = fullTitle;

                if (fullTitle.includes(':')) {
                    namePart = fullTitle.split(':')[0];
                } else if (fullTitle.includes(' - ')) {
                    namePart = fullTitle.split(' - ')[0];
                }
                
                if(namePreview) namePreview.textContent = namePart;
                if(stylePreview) stylePreview.textContent = styleInput.value || 'Style / Subtitle';
                
                // --- Update overige details ---
                if(abvPreview) abvPreview.textContent = document.getElementById('labelAbv').value || 'ABV';
                if(volPreview) {
                    const volInput = document.getElementById('labelVol');
                    const volValue = parseFloat(volInput.value);
                    if (!isNaN(volValue)) {
                        volPreview.textContent = volValue >= 1000 ? `${(volValue / 1000).toFixed(1)} L` : `${volValue} ml`;
                    } else {
                        volPreview.textContent = 'VOL';
                    }
                }
                if(datePreview) datePreview.textContent = document.getElementById('labelDate').value || 'Bottling Date';

                // --- Update Professional velden en Allergenen ---
                const selectedBrew = brews.find(b => b.id === select.value);
                if (selectedBrew) {
                    if(ogPreview) ogPreview.textContent = selectedBrew.logData?.targetOG || 'N/A';
                    if(fgPreview) fgPreview.textContent = selectedBrew.logData?.actualFG || selectedBrew.logData?.targetFG || 'N/A';
                    
                    // --- Allergenen logica ---
                    const allergens = [];
                    const markdown = selectedBrew.recipeMarkdown.toLowerCase();
                    if (markdown.includes('metabisulfite')) allergens.push('sulfites');
                    if (markdown.includes('lactose') || markdown.includes('milk sugar')) allergens.push('lactose');
                    if (markdown.includes('barley') || markdown.includes('wheat') || markdown.includes('malt')) allergens.push('gluten');

                    if (allergens.length > 0 && allergensContainer) {
                        allergensContainer.innerHTML = `Contains: <strong>${allergens.join(', ')}</strong>`;
                        allergensContainer.classList.remove('hidden');
                    } else if (allergensContainer) {
                        allergensContainer.innerHTML = '';
                        allergensContainer.classList.add('hidden');
                    }
                } else {
                    if(ogPreview) ogPreview.textContent = 'OG';
                    if(fgPreview) fgPreview.textContent = 'FG';
                    if(allergensContainer) allergensContainer.classList.add('hidden');
                }
            }

// Toont het invoerveld en verbergt de titel
window.showTitleEditor = function(brewId) {
    document.getElementById(`title-display-${brewId}`).classList.add('hidden');
    document.getElementById(`title-editor-${brewId}`).classList.remove('hidden');
    document.getElementById(`title-input-${brewId}`).focus();
}

// Verbergt het invoerveld en toont de titel weer
window.hideTitleEditor = function(brewId) {
    document.getElementById(`title-display-${brewId}`).classList.remove('hidden');
    document.getElementById(`title-editor-${brewId}`).classList.add('hidden');
}

window.saveNewTitle = async function(brewId) {
    if (!userId) return;
    const newTitle = document.getElementById(`title-input-${brewId}`).value.trim();
    if (!newTitle) {
        showToast("Title cannot be empty.", "error");
        return;
    }

    try {
        const appId = 'meandery-aa05e';
        const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
        
        // --- AANGEPAST: Update de hoofdtitel EN de log-titel ---
        await updateDoc(brewDocRef, { 
            recipeName: newTitle,
            'logData.recipeName': newTitle // Update ook het veld in de logData
        });

        // Update de lokale data en UI onmiddellijk voor een snelle respons
        const brew = brews.find(b => b.id === brewId);
        if (brew) {
            brew.recipeName = newTitle;
            if (brew.logData) {
                brew.logData.recipeName = newTitle; // Update ook de lokale logData
            }
        }
        
        document.querySelector(`#title-display-${brewId} h2`).textContent = newTitle;
        hideTitleEditor(brewId);
        renderHistoryList(); // Ververs de lijstweergave
        showToast("Recipe title updated!", "success");

    } catch (error) {
        console.error("Error updating title:", error);
        showToast("Could not update title.", "error");
    }
}            
            // --- Start the App ---
            // Wacht tot de volledige HTML-pagina is geladen voordat het script wordt uitgevoerd.
            document.addEventListener('DOMContentLoaded', (event) => {
                initApp();
            });

        })(); // End of IIFE
    </script>
   <div id="bottling-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-app-tertiary p-8 rounded-lg shadow-xl w-full max-w-lg"> <h3 class="text-2xl font-header font-bold mb-6">Bottle Batch</h3>
        <form id="bottling-form">
    <div class="space-y-6">
        <div>
            <label for="bottlingDate" class="block text-sm font-bold mb-2">Bottling Date</label>
            <input type="date" id="bottlingDate" required class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="closureTypeSelect" class="block text-sm font-bold mb-2">Closure Type</label>
            <select id="closureTypeSelect" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
                <option value="auto" selected>Automatic (based on size)</option>
                <option value="cork">Cork</option>
                <option value="crown_cap_26">Crown Cap 26mm</option>
                <option value="crown_cap_29">Crown Cap 29mm</option>
            </select>
        </div>
        <div>
    <label class="block text-sm font-bold mb-2">Number of Bottles (Standard Sizes)</label>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
            <label for="qty750" class="block text-xs text-app-secondary">750ml</label>
            <input type="number" id="qty750" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="qty500" class="block text-xs text-app-secondary">500ml</label>
            <input type="number" id="qty500" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="qty330" class="block text-xs text-app-secondary">330ml</label>
            <input type="number" id="qty330" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
        <div>
            <label for="qty250" class="block text-xs text-app-secondary">250ml</label>
            <input type="number" id="qty250" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
        </div>
    </div>
</div>

        <div class="border-t border-app pt-4 space-y-4">
    <div>
        <label class="block text-sm font-bold mb-2">Add Custom Bottle Sizes</label>
        <div class="grid grid-cols-3 gap-4">
            <div>
                <label for="customSize" class="block text-xs text-app-secondary">Size (ml)</label>
                <input type="number" id="customSize" min="0" step="1" placeholder="650" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
            </div>
            <div>
                <label for="customQty" class="block text-xs text-app-secondary">Quantity</label>
                <input type="number" id="customQty" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
            </div>
            <div>
                <label for="customPrice" class="block text-xs text-app-secondary">Cost/Bottle ()</label>
                <input type="number" id="customPrice" min="0" step="0.01" placeholder="0.65" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-primary">
            </div>
        </div>
        <button type="button" onclick="window.addCustomBottleToList()" class="w-full mt-3 bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-700 btn text-sm">
            + Add This Custom Bottle to List
        </button>
    </div>
    <div id="custom-bottles-list" class="space-y-2"></div>
</div>
    </div>
    <div class="flex justify-end gap-4 mt-8">
        <button type="button" onclick="window.hideBottlingModal()" class="px-6 py-2 rounded-lg bg-gray-600 text-gray-300 hover:bg-gray-500 btn">Cancel</button>
        <button type="submit" class="px-6 py-2 rounded-lg bg-app-action text-white font-bold hover:opacity-90 btn">Add to Cellar</button>
    </div>
</form>
    </div>
</div>
<div id="prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-app-tertiary p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-header font-bold">AI Prompt Details</h3>
            <button id="close-prompt-modal-btn" class="text-2xl font-bold hover:text-red-500">&times;</button>
        </div>
        <pre id="prompt-modal-content" class="whitespace-pre-wrap text-sm bg-app-primary p-4 rounded text-app-primary" style="font-family: monospace;"></pre>
    </div>
</div>
<div id="danger-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-app-tertiary p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-xl font-header font-bold text-red-600 mb-4">Are you absolutely sure?</h3>
        <p class="text-app-secondary mb-4">This action is irreversible. All associated data will be permanently deleted. To confirm, please type "<strong id="danger-confirm-text" class="text-red-500"></strong>" in the box below.</p>
        <input type="text" id="danger-confirm-input" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-red-500 text-app-primary mb-4">
        <div class="flex justify-end gap-4">
            <button id="danger-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500 btn">Cancel</button>
            <button id="danger-confirm-btn" class="px-6 py-2 rounded-lg bg-red-700 text-white font-bold btn opacity-50 cursor-not-allowed" disabled>Confirm Deletion</button>
        </div>
    </div>
</div>
</body>
</html>