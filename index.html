<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEA(N)DERY - AI Mead Recipe Creator</title>
    <meta name="theme-color" content="#a89a87"/>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="app-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Zorgt dat de toggle werkt
            theme: {
                extend: {
                    colors: {
                        // We koppelen Tailwind namen aan jouw bestaande CSS variabelen
                        app: { 
                            primary: 'var(--bg-primary)',
                            secondary: 'var(--bg-secondary)',
                            tertiary: 'var(--bg-tertiary)',
                            brand: 'var(--brand-color)',
                            action: 'var(--action-color)',
                            header: 'var(--text-primary)' // Gebruik text-primary voor de koptekst kleur
                        } 
                    },
                    fontFamily: {
                        header: ['"Barlow Semi Condensed"', 'sans-serif'],
                        sans: ['"Barlow Semi Condensed"', 'sans-serif'] // Zorgt dat alles Barlow is
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="style.css">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker Registered! üöÄ', reg.scope))
                    .catch(err => console.error('SW Fail:', err));
            });
        }
    </script>

</head>

<body class="bg-app-primary text-app-header">

    <div id="login-view" class="fixed inset-0 bg-[#fdfbf7] dark:bg-[#1a1a1a] flex items-center justify-center z-50">
        <div class="text-center p-8 max-w-md mx-auto w-full">
            
    <img src="logo.png" 
         class="h-48 w-auto mx-auto mb-4 object-contain drop-shadow-2xl hover:scale-105 transition-transform duration-500" 
         alt="Meandery Logo"
         onerror="this.style.display='none'; document.getElementById('login-brand-text').classList.remove('hidden')">
    
    <h1 id="login-brand-text" class="hidden text-6xl font-header text-app-header mb-8 text-center">
        MEA<span class="text-app-brand">(N)</span>DERY
    </h1>
    
    <div class="card p-8 rounded-xl shadow-2xl bg-white dark:bg-[#2a2a2a] border border-gray-100 dark:border-gray-700">
                <h2 class="text-3xl font-header font-bold mb-4 text-app-header">Welcome</h2>
                <p class="text-app-secondary mb-6 text-sm">Please sign in to access your brewing data.</p>
                <button id="google-login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 btn flex items-center justify-center transition-colors shadow-md">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mt-0 mb-1 no-print flex justify-center items-center py-0">
    <img src="logo.png" 
         class="h-20 w-auto object-contain hover:scale-105 transition-transform duration-500 drop-shadow-sm dark:invert dark:opacity-90" 
         alt="Meandery Brewbuddy">
</header>

        <div id="dashboard-main-view">
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 88vh;">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    
    <div onclick="switchMainView('brewing'); switchSubView('brew-day-1', 'brewing-main-view')" 
         class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200 group">
        <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-header transition-colors">Primary</p>
        <p id="stat-primary-batches" class="text-2xl font-header font-bold text-app-brand transition-colors">--</p>
    </div>

    <div onclick="switchMainView('brewing'); switchSubView('brew-day-2', 'brewing-main-view')" 
         class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200 group">
        <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-header transition-colors">Aging</p>
        <p id="stat-aging-batches" class="text-2xl font-header font-bold text-app-brand transition-colors">--</p>
    </div>

    <div onclick="switchMainView('management'); switchSubView('cellar', 'management-main-view')" 
         class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200 group">
        <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-header transition-colors">In Cellar</p>
        <p id="stat-bottles" class="text-2xl font-header font-bold text-app-brand transition-colors">--</p>
    </div>

    <div onclick="switchMainView('management'); switchSubView('financials', 'management-main-view')" 
         class="card p-3 text-center border-l-4 border-app-brand bg-app-tertiary cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200 group">
        <p class="text-xs text-app-secondary uppercase font-bold tracking-wider group-hover:text-app-header transition-colors">Value</p>
        <p id="stat-spent" class="text-xl font-header font-bold text-app-brand transition-colors">--</p>
    </div>
</div>

                <div id="current-brew-card" class="card p-6 rounded-lg mb-6 hidden border-2 border-app-brand/20 bg-app-tertiary"></div>

                <div id="next-action-widget" class="card p-5 rounded-lg mb-6 hidden border border-app-brand/30 bg-app-secondary shadow-sm">
                    <h3 class="text-lg font-header font-bold mb-3 text-app-brand flex items-center gap-2 uppercase tracking-wider">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Insight
                    </h3>
                    <ul id="next-action-list" class="list-disc pl-5 space-y-2 text-app-header text-sm leading-relaxed"></ul>
                </div>

                <h3 class="text-sm font-bold text-app-secondary uppercase mb-3 ml-1">Quick Access</h3>
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <button data-view="brewing" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1">
                        <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        <span class="text-xs font-bold">Brew</span>
                    </button>
                    <button data-view="management" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1">
                        <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="text-xs font-bold">Manage</span>
                    </button>
                    <button data-view="tools" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1">
                        <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="text-xs font-bold">Tools</span>
                    </button>
                    <button data-view="settings" class="main-nav-btn card p-3 rounded-lg text-center hover:shadow-md transition-all btn flex flex-col items-center justify-center gap-1">
                        <svg class="w-6 h-6 text-app-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        <span class="text-xs font-bold">Settings</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="brewing-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap no-scrollbar"> 
                    <button id="creator-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Creator</button>
                    <button id="shopping-list-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Shopping List</button>
                    <button id="brew-day-1-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day 1</button>
                    <button id="brew-day-2-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day 2</button>
                    <button id="history-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">History</button>
                </nav>
            </div>
            
            <div id="creator-view">
                <div class="flex flex-col lg:flex-row gap-8 mt-4">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg control-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Craft Your Mead</h2>
                        <div class="mb-6">
                            <label for="customDescription" class="block text-sm font-bold mb-2">Describe Your Dream Mead</label>
                            <textarea id="customDescription" rows="4" placeholder="Be descriptive! e.g., 'A dry, sparkling mead with lavender and lemon, around 8% ABV, perfect for summer.'" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-header"></textarea>
                            <p id="description-priority-warning" class="hidden text-xs text-center text-amber-600 dark:text-amber-400 mt-2">U gebruikt de vrije beschrijving. De onderstaande opties worden genegeerd.</p>
                        </div>

                        <details class="group bg-app-tertiary rounded-lg open:ring-2 open:ring-app-brand/20 transition-all" open>
    <summary class="font-bold text-sm cursor-pointer p-3 flex justify-between items-center select-none text-app-header hover:bg-app-brand/5 rounded-t-lg">
        <span class="flex items-center gap-2">üß™ Base Stats</span>
        <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
    </summary>
    <div class="p-3 pt-0 space-y-3 border-t border-app-brand/10">
        <div>
            <label class="text-xs font-bold uppercase text-app-secondary">Batch Size (L)</label>
            <input type="number" id="batchSize" placeholder="5" class="mt-1 w-full p-2 border rounded-md bg-app-secondary text-app-header">
        </div>
        <div>
            <label class="text-xs font-bold uppercase text-app-secondary">Target ABV (%)</label>
            <input type="number" id="abv" placeholder="12" class="mt-1 w-full p-2 border rounded-md bg-app-secondary text-app-header">
        </div>
        <div>
            <label class="text-xs font-bold uppercase text-app-secondary">Style</label>
            <select id="style" class="mt-1 w-full p-2 border rounded-md bg-app-secondary text-app-header">
                <option value="Traditional">Traditional</option>
                <option value="Melomel">Melomel (Fruit)</option>
                <option value="Metheglin">Metheglin (Spices)</option>
                <option value="Bochet">Bochet (Caramelized)</option>
                <option value="Cyser">Cyser (Apple)</option>
                <option value="Pyment">Pyment (Grape)</option>
                <option value="Braggot">Braggot (Malt)</option>
                <option value="Hydromel">Hydromel (Low ABV)</option>
            </select>
        </div>
        <div>
            <label class="text-xs font-bold uppercase text-app-secondary">Sweetness</label>
            <select id="sweetness" class="mt-1 w-full p-2 border rounded-md bg-app-secondary text-app-header">
                <option value="dry">Dry</option>
                <option value="semi-sweet">Semi-Sweet</option>
                <option value="sweet">Sweet</option>
                <option value="dessert">Dessert</option>
            </select>
        </div>
    </div>
</details>

<details class="group bg-app-tertiary rounded-lg open:ring-2 open:ring-app-brand/20 transition-all">
    <summary class="font-bold text-sm cursor-pointer p-3 flex justify-between items-center select-none text-app-header hover:bg-app-brand/5 rounded-t-lg">
        <span class="flex items-center gap-2">üçØ Ingredients</span>
        <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
    </summary>
    <div class="p-3 pt-0 space-y-3 border-t border-app-brand/10">
        <div>
            <label class="text-xs font-bold uppercase text-app-secondary">Honey Variety</label>
            <select id="honeyVariety" class="mt-1 w-full p-2 border rounded-md bg-app-secondary text-app-header">
                <option value="Wildflower">Wildflower</option>
                <option value="Acacia">Acacia</option>
                <option value="Orange Blossom">Orange Blossom</option>
                <option value="Clover">Clover</option>
                <option value="Buckwheat">Buckwheat</option>
                <option value="Linden">Linden (Lime)</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="honeyVarietyOther" placeholder="Specify honey..." class="hidden mt-2 w-full p-2 border rounded-md bg-app-secondary text-sm">
        </div>

        <div id="fruit-section" class="hidden p-3 bg-app-secondary rounded border border-app-brand/20 mt-2">
            <label class="block text-xs font-bold mb-2 uppercase text-app-brand">Fruit Selection</label>
            <div class="grid grid-cols-2 gap-2 text-xs text-app-header">
                <label class="flex items-center"><input type="checkbox" id="fruit_apples" class="mr-2 rounded text-app-brand focus:ring-app-brand"> Apples</label>
                <label class="flex items-center"><input type="checkbox" id="fruit_cherries" class="mr-2 rounded text-app-brand focus:ring-app-brand"> Cherries</label>
                <label class="flex items-center"><input type="checkbox" id="fruit_berries" class="mr-2 rounded text-app-brand focus:ring-app-brand"> Berries</label>
                <label class="flex items-center"><input type="checkbox" id="fruit_citrus" class="mr-2 rounded text-app-brand focus:ring-app-brand"> Citrus</label>
                <label class="flex items-center"><input type="checkbox" id="fruit_stone" class="mr-2 rounded text-app-brand focus:ring-app-brand"> Stone Fruit</label>
            </div>
            <input type="text" id="fruitOther" placeholder="Other fruits..." class="mt-2 w-full p-2 text-sm border rounded bg-app-tertiary">
            
            <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                <label class="flex items-center text-xs font-bold text-red-500">
                    <input type="checkbox" id="isNoWaterCheckbox" class="mr-2 rounded text-red-500 focus:ring-red-500"> 
                    No-Water Method (Pure Juice)
                </label>
            </div>
        </div>

        <div id="spice-section" class="hidden p-3 bg-app-secondary rounded border border-app-brand/20 mt-2">
            <label class="block text-xs font-bold mb-2 uppercase text-app-brand">Spices & Herbs</label>
            <div class="grid grid-cols-2 gap-2 text-xs text-app-header">
                <label class="flex items-center"><input type="checkbox" id="spice_cinnamon" class="mr-2 rounded text-app-brand"> Cinnamon</label>
                <label class="flex items-center"><input type="checkbox" id="spice_vanilla" class="mr-2 rounded text-app-brand"> Vanilla</label>
                <label class="flex items-center"><input type="checkbox" id="spice_cloves" class="mr-2 rounded text-app-brand"> Cloves</label>
                <label class="flex items-center"><input type="checkbox" id="spice_ginger" class="mr-2 rounded text-app-brand"> Ginger</label>
            </div>
            <input type="text" id="spiceOther" placeholder="Other spices (e.g. Lavender)..." class="mt-2 w-full p-2 text-sm border rounded bg-app-tertiary">
        </div>

        <div id="braggot-section" class="hidden p-3 bg-app-secondary rounded border border-app-brand/20 mt-2">
             <label class="block text-xs font-bold mb-2 uppercase text-app-brand">Beer Style Base</label>
             <input type="text" id="braggotStyle" placeholder="e.g. Stout, IPA, Wheat..." class="w-full p-2 border rounded-md bg-app-tertiary text-sm">
        </div>
        
        <div class="flex items-center mt-3 pt-2 border-t border-app-brand/10">
            <input type="checkbox" id="addOak" class="h-4 w-4 text-app-brand rounded focus:ring-app-brand border-gray-300">
            <label for="addOak" class="ml-2 text-sm font-medium text-app-header">Include Oak Aging</label>
        </div>
        
        <div class="mt-2">
             <label class="text-xs font-bold uppercase text-app-secondary">Special / Other</label>
             <input type="text" id="specialIngredients" placeholder="e.g. Maple Syrup, Coffee..." class="mt-1 w-full p-2 border rounded-md bg-app-secondary text-app-header text-sm">
        </div>
    </div>
</details>

<details class="group bg-app-tertiary rounded-lg open:ring-2 open:ring-app-brand/20 transition-all">
    <summary class="font-bold text-sm cursor-pointer p-3 flex justify-between items-center select-none text-app-header hover:bg-app-brand/5 rounded-t-lg">
        <span class="flex items-center gap-2">üì¶ Stock & Budget</span>
        <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
    </summary>
    <div class="p-3 pt-0 space-y-3 border-t border-app-brand/10">
        <p class="text-xs text-app-secondary mb-2">Check to prioritize using from inventory:</p>
        <div id="inventory-options-container" class="grid grid-cols-2 gap-2 text-xs text-app-header">
            <label class="flex items-center"><input type="checkbox" id="useInventory_Honey" class="mr-2 inventory-toggle rounded text-app-brand"> Honey</label>
            <label class="flex items-center"><input type="checkbox" id="useInventory_Yeast" class="mr-2 inventory-toggle rounded text-app-brand"> Yeast</label>
            <label class="flex items-center"><input type="checkbox" id="useInventory_Nutrients" class="mr-2 inventory-toggle rounded text-app-brand"> Nutrients</label>
            <label class="flex items-center"><input type="checkbox" id="useInventory_Fruits" class="mr-2 inventory-toggle rounded text-app-brand"> Fruit</label>
            <label class="flex items-center"><input type="checkbox" id="useInventory_Spices" class="mr-2 inventory-toggle rounded text-app-brand"> Spices</label>
            <label class="flex items-center"><input type="checkbox" id="useInventory_Other" class="mr-2 inventory-toggle rounded text-app-brand"> Other</label>
        </div>
        
        <div id="budget-section" class="hidden mt-2 pt-2 border-t border-gray-300 dark:border-gray-600">
            <label class="flex items-center text-xs font-bold mb-2 text-app-header">
                <input type="checkbox" id="useBudget" class="mr-2 rounded text-app-brand"> 
                Set Budget Limit
            </label>
            <div id="budget-input-container" class="hidden">
                <input type="number" id="maxBudget" placeholder="‚Ç¨20.00" class="w-full p-2 border rounded-md bg-app-secondary text-app-header">
            </div>
        </div>
    </div>
</details>

                        <div class="mt-8"><button id="generateBtn" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">GENERATE RECIPE</button></div>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                        <div id="recipe-output" class="prose max-w-none text-app-header"></div>
                    </main>
                </div>
            </div>

            <div id="brew-day-1-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: calc(100vh - 120px);">
                    <div id="brew-day-content"></div>
                </div>
            </div>

            <div id="brew-day-2-view" class="hidden mt-4"></div>
            
            <div id="history-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <div id="history-list-container">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew History</h2>                        
                        <div class="mb-4"><input type="text" id="history-search-input" placeholder="Search..." class="w-full p-3 border rounded-md bg-app-tertiary border-app text-app-header"></div>                        
                        <div id="history-list" class="space-y-4"></div>
                    </div>
                    <div id="history-detail-container" class="hidden"></div>
                 </div>
            </div>
            
            <div id="shopping-list-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
                      <h2 class="text-3xl font-header font-bold mb-6 text-center">Shopping List</h2>
                      <div id="shopping-list-container" class="mb-8">
                         <div id="shopping-list-content" class="p-4 card rounded-lg"></div>
                      </div>
                </div>
            </div>
        </div>

        <div id="management-main-view" class="hidden">
             <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
             <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap no-scrollbar">
                    <button id="inventory-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Inventory</button>
                    <button id="equipment-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Equipment</button>
                    <button id="packaging-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Packaging</button>
                    <button id="cellar-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Cellar</button>
                    <button id="financials-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Financials</button>
                </nav>
            </div>
            <div id="inventory-view" class="mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <div id="barcode-scanner-container" class="relative hidden mb-4">
                            <div id="barcode-reader" class="w-full rounded-lg"></div>
                            <button id="close-scanner-btn" class="absolute top-2 right-2 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold btn">&times;</button>
                        </div>
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add to Inventory</h2>
                        <button id="scan-barcode-btn" class="w-full mb-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn flex items-center justify-center">Scan Barcode</button>
                        <form id="inventory-form" class="space-y-4">
                            <div><label class="block text-sm font-bold mb-2">Name</label><input type="text" id="itemName" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold mb-2">Qty</label><input type="number" id="itemQty" step="0.01" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                                <div><label class="block text-sm font-bold mb-2">Unit</label><select id="itemUnit" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"><option>kg</option><option>g</option><option>L</option><option>ml</option><option>packets</option><option>items</option></select></div>
                            </div>
                             <div><label class="block text-sm font-bold mb-2">Price (‚Ç¨)</label><input type="number" id="itemPrice" step="0.01" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                            <div><label class="block text-sm font-bold mb-2">Category</label><select id="itemCategory" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"><option>Honey</option><option>Yeast</option><option>Nutrient</option><option>Malt Extract</option><option>Fruit</option><option>Spice</option><option>Adjunct</option><option>Chemical</option><option>Water</option></select></div>
                            <div><label class="block text-sm font-bold mb-2">Exp. Date</label><input type="date" id="itemExpirationDate" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">Add Ingredient</button>
                        </form>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Current Stock</h2>
                        <div id="inventory-list"></div>
                    </main>
                </div>
            </div>
            <div id="packaging-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Packaging Stock</h2>
                        <form id="packaging-add-form" class="space-y-4">
                            <div><label class="block text-sm font-bold mb-2">Material</label><select id="packaging-item-select" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></select></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold mb-2">Qty</label><input type="number" id="packaging-item-qty" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                               <div><label class="block text-sm font-bold mb-2">Price (‚Ç¨)</label><input type="number" id="packaging-item-price" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                            </div>
                            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">Add</button>
                        </form>
                    </aside>
                    <main id="packaging-stock-container" class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel"><h2 class="text-3xl font-header font-bold mb-4 text-center">Packaging Stock</h2><div id="packaging-list"></div></main>
                </div>
            </div>             
            <div id="equipment-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8"><aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Equipment</h2><form id="equipment-profile-form" class="space-y-4"><div><label class="block text-sm font-bold mb-2">Name</label><input type="text" id="equipProfileName" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-2">Type</label><select id="equipProfileType" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"><option value="Fermenter">Fermenter</option><option value="Kettle">Kettle</option></select></div><div><label class="block text-sm font-bold mb-2">Qty</label><input type="number" id="equipProfileQuantity" value="1" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-2">Capacity (L)</label><input type="number" id="equipCapacityLiters" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div><div><label class="block text-sm font-bold mb-2">Loss (L)</label><input type="number" id="trubLossLiters" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div></div><div id="boil-off-rate-container" class="hidden"><label class="block text-sm font-bold mb-2">Boil-Off (L/hr)</label><input type="number" id="boilOffRateLitersPerHour" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div><button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">Add</button></form></aside><main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel"><h2 class="text-3xl font-header font-bold mb-4 text-center">Equipment Profiles</h2><div id="equipment-profiles-list"></div></main></div>
            </div>
            <div id="cellar-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">My Cellar</h2>
                    <div id="cellar-list" class="space-y-4"></div>
                </div>
            </div>
            <div id="financials-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                     <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Financial Overview</h2>
                     
                     <div id="cost-analysis-container">
                        <div class="mb-8 p-6 rounded-lg bg-app-tertiary border-2 border-app-brand text-center shadow-md">
                            <h4 class="text-sm font-bold text-app-secondary uppercase tracking-widest mb-1">Total Brewery Asset Value</h4>
                            <p id="grand-total-value" class="text-5xl font-header font-bold text-app-brand">‚Ç¨0.00</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            
                            <div onclick="switchMainView('management'); switchSubView('inventory', 'management-main-view')" 
                                 class="card p-4 rounded-lg text-center border-t-4 border-blue-500 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                                <h4 class="text-sm font-bold text-app-secondary uppercase">Inventory</h4>
                                <p id="total-inventory-value" class="text-2xl font-bold text-app-header mt-2">‚Ç¨0.00</p>
                                <p class="text-[10px] text-blue-500 mt-1 uppercase font-bold">Go to Stock &rarr;</p>
                            </div>

                            <div onclick="switchMainView('brewing'); switchSubView('history', 'brewing-main-view')" 
                                 class="card p-4 rounded-lg text-center border-t-4 border-purple-500 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                                <h4 class="text-sm font-bold text-app-secondary uppercase">In Progress</h4>
                                <p id="total-active-value" class="text-2xl font-bold text-app-header mt-2">‚Ç¨0.00</p>
                                <p class="text-[10px] text-purple-500 mt-1 uppercase font-bold">View Active Batches &rarr;</p>
                            </div>

                            <div onclick="switchMainView('management'); switchSubView('cellar', 'management-main-view')" 
                                 class="card p-4 rounded-lg text-center border-t-4 border-green-600 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                                <h4 class="text-sm font-bold text-app-secondary uppercase">Cellar</h4>
                                <p id="total-cellar-value" class="text-2xl font-bold text-app-header mt-2">‚Ç¨0.00</p>
                                <p class="text-[10px] text-green-600 mt-1 uppercase font-bold">Open Wine Cellar &rarr;</p>
                            </div>

                        </div>

                        <div class="card p-4 rounded-lg mt-6">
                            <h4 class="text-lg font-bold text-app-secondary text-center mb-4">Spend by Category</h4>
                            <div class="h-64"><canvas id="cost-chart"></canvas></div>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <div id="tools-main-view" class="hidden">
    <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
    
    <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner mb-6">
        <nav class="flex space-x-2 overflow-x-auto whitespace-nowrap no-scrollbar">
            <button id="calculators-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Calculators</button>
            <button id="labels-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Labels</button>
            <button id="water-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Water</button>
            <button id="troubleshoot-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Mead Medic</button>
            <button id="social-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Social</button>
            <button id="library-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Library</button>
        </nav>
    </div>
    
    <div id="calculators-view" class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg calculator-panel overflow-y-auto" style="max-height: 80vh;">
        <h2 class="text-3xl font-header font-bold mb-6 text-center">Calculators</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            
            <div class="p-5 card rounded-xl border-l-4 border-blue-500 shadow-sm bg-app-secondary hover:shadow-md transition-shadow">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    ABV Calculator
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">OG (Start)</label>
                            <input type="number" id="og" step="0.001" placeholder="1.100" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">FG (End)</label>
                            <input type="number" id="fg" step="0.001" placeholder="1.000" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                    </div>
                    <button id="calcAbvBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn transition-colors">Calculate ABV</button>
                    <div id="abvResult" class="text-center font-bold text-xl text-blue-600 dark:text-blue-400 mt-2 h-8 flex items-center justify-center bg-blue-50 dark:bg-blue-900/20 rounded">
                    </div>
                </div>
            </div>

            <div class="p-5 card rounded-xl border-l-4 border-amber-500 shadow-sm bg-app-secondary hover:shadow-md transition-shadow">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    Hydro Correction
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Measured SG</label>
                        <input type="number" id="sgReading" step="0.001" placeholder="1.050" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Temp (¬∞C)</label>
                            <input type="number" id="tempReading" placeholder="25" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Calib (¬∞C)</label>
                            <input type="number" id="calTemp" value="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                    </div>
                    <button id="correctSgBtn" class="w-full bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700 btn transition-colors">Correct SG</button>
                    <div id="sgResult" class="text-center font-bold text-xl text-amber-600 dark:text-amber-400 mt-2 h-8 flex items-center justify-center bg-amber-50 dark:bg-amber-900/20 rounded">
                    </div>
                </div>
            </div>

            <div class="p-5 card rounded-xl border-l-4 border-purple-500 shadow-sm bg-app-secondary hover:shadow-md transition-shadow">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    Refractometer
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Original Brix (Start)</label>
                        <input type="number" id="refract_ob" placeholder="e.g. 22" step="0.1" class="w-full p-2 border rounded bg-app-tertiary border-app text-app-header">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Current Brix (Now)</label>
                        <input type="number" id="refract_cb" placeholder="e.g. 9" step="0.1" class="w-full p-2 border rounded bg-app-tertiary border-app text-app-header">
                    </div>
                    <button id="calcRefractBtn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 btn transition-colors">Calculate True Gravity</button>
                    
                    <div id="refractResult" class="hidden mt-2 p-3 bg-purple-50 dark:bg-purple-900/20 rounded border border-purple-100 dark:border-purple-800 text-center">
                    </div>
                </div>
            </div>

            <div class="p-5 card rounded-xl border-l-4 border-green-600 shadow-sm bg-app-secondary hover:shadow-md transition-shadow md:col-span-2 xl:col-span-3">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    TOSNA 2.0 (Nutrients)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Original Gravity</label>
                        <input type="number" id="tosna_og" step="0.001" placeholder="1.100" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Batch Volume (L)</label>
                        <input type="number" id="tosna_vol" placeholder="5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Yeast Requirement</label>
                        <select id="tosna_yeast" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                            <option value="low">Low (e.g. 71B)</option>
                            <option value="medium" selected>Medium (e.g. D47, EC-1118)</option>
                            <option value="high">High (e.g. RC-212)</option>
                        </select>
                    </div>
                </div>
                <button id="calcTosnaBtn" class="w-full mt-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 btn transition-colors">Calculate Schedule</button>
                <div id="tosnaResult" class="prose max-w-none text-app-header mt-4 bg-green-50 dark:bg-green-900/10 p-4 rounded-lg hidden empty:hidden">
                </div>
            </div>

            <div class="p-5 card rounded-xl border-l-4 border-pink-500 shadow-sm bg-app-secondary hover:shadow-md transition-shadow">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    Blend / Fortify
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Base Vol (L)</label>
                            <input type="number" id="vol1" step="0.1" placeholder="e.g. 5.0" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Base ABV %</label>
                            <input type="number" id="abv1" step="0.1" placeholder="e.g. 12.0" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Add Vol (L)</label>
                            <input type="number" id="vol2" step="0.01" placeholder="e.g. 0.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Add ABV %</label>
                            <input type="number" id="abv2" step="0.1" placeholder="e.g. 40" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                    </div>
                    <button id="calcBlendBtn" class="w-full bg-pink-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-700 btn transition-colors">Calculate New ABV</button>
                    <div id="blendResult" class="text-center font-bold text-sm text-pink-600 dark:text-pink-400 mt-2 h-8 flex items-center justify-center bg-pink-50 dark:bg-pink-900/20 rounded"></div>
                </div>
            </div>

            <div class="p-5 card rounded-xl border-l-4 border-yellow-500 shadow-sm bg-app-secondary hover:shadow-md transition-shadow">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    Backsweetening
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Current Volume (L)</label>
                        <input type="number" id="bs_current_vol" step="0.1" placeholder="e.g. 5.0" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Current SG</label>
                            <input type="number" id="bs_current_sg" step="0.001" placeholder="1.000" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Target SG</label>
                            <input type="number" id="bs_target_sg" step="0.001" placeholder="1.020" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                    </div>
                    <button id="calcBacksweetenBtn" class="w-full bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 btn transition-colors">Calculate Honey</button>
                    <div id="backsweetenResult" class="text-center font-bold text-sm text-yellow-600 dark:text-yellow-400 mt-2 h-8 flex items-center justify-center bg-yellow-50 dark:bg-yellow-900/20 rounded"></div>
                </div>
            </div>

            <div class="p-5 card rounded-xl border-l-4 border-cyan-500 shadow-sm bg-app-secondary hover:shadow-md transition-shadow">
                <h3 class="text-xl font-header font-bold text-app-header mb-4 flex items-center gap-2">
                    Dilution
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Current Volume (L)</label>
                        <input type="number" id="dil_start_vol" step="0.1" placeholder="e.g. 5.0" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Start SG</label>
                            <input type="number" id="dil_start_sg" step="0.001" placeholder="1.120" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Target SG</label>
                            <input type="number" id="dil_target_sg" step="0.001" placeholder="1.100" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        </div>
                    </div>
                    <button id="calcDilutionBtn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 btn transition-colors">Calculate Water</button>
                    <div id="dilutionResult" class="text-center font-bold text-sm text-cyan-600 dark:text-cyan-400 mt-2 h-8 flex items-center justify-center bg-cyan-50 dark:bg-cyan-900/20 rounded"></div>
                </div>
            </div>

        </div>
    </div> 
    <div id="labels-view" class="hidden mt-4">
    <span id="displayLabelYeast" class="hidden"></span>
    <span id="displayLabelHoney" class="hidden"></span>

    <input type="hidden" id="labelDetails">

    <div class="flex flex-col lg:flex-row gap-8 h-full">
        <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg overflow-y-auto" style="max-height: 85vh;">
            <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app flex items-center gap-2">
                Label Forge
            </h2>
            
            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-bold text-app-brand uppercase tracking-wider">1. Data Source</h3>
                <div>
                    <label class="text-xs">Select Batch</label>
                    <select id="labelRecipeSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header text-sm">
                        <option value="">-- Load from History --</option>
                    </select>
                </div>
            </div>

            <div class="space-y-4 mb-6 pt-4 border-t border-app">
                <h3 class="text-sm font-bold text-app-brand uppercase tracking-wider">2. Design</h3>
                <div>
                    <label class="text-xs">Visual Theme</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <button class="label-theme-btn active btn border border-app-brand text-app-brand text-xs py-2 font-bold uppercase tracking-wider" data-theme="standard">
                            Standard
                        </button>
                        
                        <button class="label-theme-btn btn border border-gray-400 text-gray-500 text-xs py-2 font-bold uppercase tracking-wider hover:bg-gray-100 dark:hover:bg-gray-700" data-theme="special">
                            Special
                        </button>
                    </div>
                </div>
                <div>
                    <label class="text-xs">Label Artwork</label>
                    <div class="flex gap-2 mt-1">
                        <button id="ai-label-art-btn" class="flex-grow bg-purple-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-purple-700 btn flex items-center justify-center gap-1">
                            ‚ú® Generate Art
                        </button>
                        <label class="cursor-pointer bg-app-tertiary border border-app text-app-header text-xs py-2 px-3 rounded hover:bg-app-secondary btn">
                            üìÇ Upload <input type="file" id="logoUpload" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <p class="text-[10px] text-app-secondary mt-1">Uses your "Image Generation Engine" setting.</p>
                </div>
            </div>

            <div class="space-y-3 mb-6 pt-4 border-t border-app">
                <h3 class="text-sm font-bold text-app-brand uppercase tracking-wider">3. Content</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs">Title</label><input type="text" id="labelTitle" class="w-full p-1 border rounded bg-app-tertiary text-sm"></div>
                    <div><label class="text-xs">Style</label><input type="text" id="labelSubtitle" class="w-full p-1 border rounded bg-app-tertiary text-sm"></div>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div>
                        <label class="text-xs">ABV %</label>
                        <input type="text" id="labelAbv" class="w-full p-1 border rounded bg-app-tertiary text-sm">
                    </div>
                    <div>
                        <label class="text-xs">FG</label>
                        <input type="text" id="labelFg" class="w-full p-1 border rounded bg-app-tertiary text-sm" placeholder="1.000">
                    </div>
                    <div>
                        <label class="text-xs">Vol (ml)</label>
                        <input type="text" id="labelVol" class="w-full p-1 border rounded bg-app-tertiary text-sm">
                    </div>
                    <div>
                        <label class="text-xs">Date</label>
                        <input type="text" id="labelDate" class="w-full p-1 border rounded bg-app-tertiary text-sm">
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-end mb-2">
    <label class="block text-xs font-bold uppercase text-app-secondary">Back Label Story</label>
    
    <div class="flex items-center gap-2">
        <div class="relative group">
            <select id="label-persona-select" class="appearance-none bg-app-tertiary hover:bg-white transition-colors border border-app-brand/20 text-app-header text-[10px] font-bold uppercase rounded-lg py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-purple-500/50 cursor-pointer shadow-sm">
                <option value="Witty">Witty (Default)</option>
                <option value="Ryan Reynolds">Ryan Reynolds</option>
                <option value="The Sommelier">The Sommelier</option>
                <option value="Dry British">Dry British</option>
                <option value="The Viking">The Viking</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-app-secondary group-hover:text-purple-600 transition-colors">
                <svg class="h-3 w-3 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
            </div>
        </div>

        <button id="ai-label-desc-btn" class="flex h-10 items-center gap-1.5 bg-purple-600 hover:bg-purple-700 text-white text-[10px] font-bold uppercase py-2 px-3 rounded-lg shadow-sm transition-all active:scale-95">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            Write
        </button>
    </div>
</div>
<textarea id="labelDescription" rows="3" class="w-full p-3 rounded-lg bg-app-tertiary border border-app-brand/10 text-app-header text-sm placeholder-gray-400 focus:ring-2 focus:ring-purple-500/50 focus:border-transparent transition-all shadow-inner mb-6" placeholder="e.g. A rich, dark bochet with notes of caramel..."></textarea>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
    <details class="group">
        <summary class="flex justify-between items-center cursor-pointer text-xs font-bold text-app-brand uppercase tracking-wider select-none list-none outline-none">
            <span>Extra Info on Label</span>
            <svg class="w-4 h-4 transition-transform duration-200 group-open:rotate-180 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </summary>
        
        <div class="space-y-3 mb-4">
    <div class="flex items-center gap-2">
        <input type="checkbox" id="labelShowYeast" checked class="rounded text-app-brand focus:ring-app-brand">
        <label for="labelShowYeast" class="text-xs text-app-header">Yeast Strain</label>
    </div>
    <div class="flex items-center gap-2">
        <input type="checkbox" id="labelShowHoney" checked class="rounded text-app-brand focus:ring-app-brand">
        <label for="labelShowHoney" class="text-xs text-app-header">Honey Source</label>
    </div>
    <div class="flex items-center gap-2">
        <input type="checkbox" id="labelShowDetails" class="rounded text-app-brand focus:ring-app-brand">
        <label for="labelShowDetails" class="text-xs text-app-header">Full Ingredients List</label>
    </div>
    
    <div>
        <label class="block text-[10px] font-bold uppercase text-app-secondary mb-1">Allergens / Warnings</label>
        <input type="text" id="labelAllergens" class="w-full p-2 text-xs border rounded bg-app-tertiary border-app-brand/20 text-app-header" placeholder="e.g. Contains Sulfites, Lactose">
    </div>
</div>
    </details>
</div>

<div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
    <details class="group">
        <summary class="flex justify-between items-center cursor-pointer text-xs font-bold text-app-brand uppercase tracking-wider select-none list-none outline-none">
            <span>Fine-Tune Layout</span>
            <svg class="w-4 h-4 transition-transform duration-200 group-open:rotate-180 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </summary>
        
        <div class="pt-4 space-y-5 px-1">
    
    <div class="p-2 bg-app-tertiary/50 rounded-lg border border-app-brand/5 space-y-3">
        <p class="text-[10px] font-bold uppercase text-app-secondary">Title Tuning</p>
        <div class="grid grid-cols-2 gap-2">
            <div>
                <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Size L1</label>
                <span id="disp-title-size" class="font-mono text-[10px] text-gray-400">100px</span>
            </div>
                <input type="range" id="tuneTitleSize" min="5" max="180" value="100" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Size L2</label>
                <span id="disp-title-size-2" class="font-mono text-[10px] text-gray-400">60px</span>
            </div>
                <input type="range" id="tuneTitleSize2" min="5" max="180" value="60" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Pos X (0-100%)</label>
                <input type="range" id="tuneTitleX" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Pos Y (0-100%)</label>
                <input type="range" id="tuneTitleY" min="0" max="100" value="40" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

       <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header text-[10px]">Break Line After Word...</label>
                <span id="disp-title-break" class="font-mono text-[10px] text-gray-400">All</span>
            </div>
            <input type="range" id="tuneTitleBreak" min="1" max="8" value="8" step="1" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

       <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header text-[10px]">L2 Offset (Links/Rechts)</label>
                <span id="disp-title-offset" class="font-mono text-[10px] text-gray-400">0%</span>
            </div>
            <input type="range" id="tuneTitleOffset" min="-100" max="100" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Rotation</label>
                <span id="disp-title-rotate" class="font-mono text-xs text-gray-400">0¬∞</span>
            </div>
            <input type="range" id="tuneTitleRotate" min="-180" max="180" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div class="flex justify-between items-center mb-2">
            <label class="font-semibold text-app-header text-xs">Title Color</label>
            <input type="color" id="tuneTitleColor" value="#8F8C79" class="w-6 h-6 p-0 border-0 rounded cursor-pointer">
        </div>
    </div>

    <div class="p-2 bg-app-tertiary/50 rounded-lg border border-app-brand/5 space-y-3">
        <p class="text-[10px] font-bold uppercase text-app-secondary">Style Tuning</p>
        <div class="grid grid-cols-2 gap-2">
            <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Size L1</label>
                <span id="disp-style-size" class="font-mono text-[10px] text-gray-400">14px</span>
            </div>
            <input type="range" id="tuneStyleSize" min="3" max="60" value="14" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Size L2</label>
                <span id="disp-style-size-2" class="font-mono text-[10px] text-gray-400">10px</span>
            </div>
            <input type="range" id="tuneStyleSize2" min="3" max="60" value="10" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Pos X (0-100%)</label>
                <input type="range" id="tuneStyleGap" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Pos Y (0-100%)</label>
                <input type="range" id="tuneStyleY" min="0" max="100" value="55" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header text-[10px]">Break Line After Word...</label>
                <span id="disp-style-break" class="font-mono text-[10px] text-gray-400">All</span>
            </div>
            <input type="range" id="tuneStyleBreak" min="1" max="8" value="8" step="1" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header text-[10px]">L2 Offset (Links/Rechts)</label>
                <span id="disp-style-offset" class="font-mono text-[10px] text-gray-400">0%</span>
            </div>
            <input type="range" id="tuneStyleOffset" min="-100" max="100" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Rotation</label>
                <span id="disp-style-rotate" class="font-mono text-xs text-gray-400">0¬∞</span>
           </div>
           <input type="range" id="tuneStyleRotate" min="-180" max="180" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div class="flex justify-between items-center mb-2">
            <label class="font-semibold text-app-header text-xs">Style Color</label>
            <input type="color" id="tuneStyleColor" value="#9ca3af" class="w-6 h-6 p-0 border-0 rounded cursor-pointer">
        </div>
    </div>

    <div class="p-2 bg-app-tertiary/50 rounded-lg border border-app-brand/5 space-y-3 mt-4">
        <p class="text-[10px] font-bold uppercase text-app-secondary">Specs / Data Position</p>
        
        <div class="grid grid-cols-2 gap-2">
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Pos X (0-100%)</label>
                <input type="range" id="tuneSpecsX" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Pos Y (0-100%)</label>
                <input type="range" id="tuneSpecsY" min="0" max="100" value="85" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Rotation</label>
                <span id="disp-specs-rotate" class="font-mono text-xs text-gray-400">0¬∞</span>
            </div>
            <input type="range" id="tuneSpecsRotate" min="-180" max="180" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Font Size</label>
                <span id="disp-specs-size" class="font-mono text-xs text-gray-400">5px</span>
            </div>
            <input type="range" id="tuneSpecsSize" min="2" max="30" value="4" step="0.1" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div class="flex justify-between items-center mb-2">
                <label class="font-semibold text-app-header text-[10px]">Text Color</label>
                <input type="color" id="tuneSpecsColor" value="#ffffff" class="w-6 h-6 p-0 border-0 rounded cursor-pointer">
            </div>
            <div class="flex justify-between items-center mb-2">
                <label class="font-semibold text-app-header text-[10px]">Allergen Color</label>
                <input type="color" id="tuneAllergenColor" value="#ffffff" class="w-6 h-6 p-0 border-0 rounded cursor-pointer">
            </div>
        </div>
    </div>

    <div class="p-2 bg-app-tertiary/50 rounded-lg border border-app-brand/5 space-y-3 mt-4">
        <p class="text-[10px] font-bold uppercase text-app-secondary">Artwork Adjustment</p>
        
        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Border Width</label>
                <span id="disp-border-width" class="font-mono text-xs text-gray-400">5mm</span>
            </div>
            <input type="range" id="tuneBorderWidth" min="0" max="10" value="0" step="0.5" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Zoom</label>
                <span id="disp-art-zoom" class="font-mono text-xs text-gray-400">1.0x</span>
            </div>
            <input type="range" id="tuneArtZoom" min="0.1" max="3.0" value="1.0" step="0.1" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Move X (0-100%)</label>
                <input type="range" id="tuneArtX" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Move Y (0-100%)</label>
                <input type="range" id="tuneArtY" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Rotation</label>
                <span id="disp-art-rotate" class="font-mono text-xs text-gray-400">0¬∞</span>
            </div>
            <input type="range" id="tuneArtRotate" min="-180" max="180" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <label class="font-semibold text-app-header">Transparency</label>
                    <span id="disp-art-opacity" class="font-mono text-[10px] text-gray-400">100%</span>
                </div>
                <input type="range" id="tuneArtOpacity" min="0" max="1.0" value="1" step="0.05" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <label class="font-semibold text-app-header">Dimmer (Black)</label>
                    <span id="disp-art-overlay" class="font-mono text-[10px] text-gray-400">20%</span>
                </div>
                <input type="range" id="tuneArtOverlay" min="0" max="1.0" value="0" step="0.05" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>
    </div>

    <div class="p-2 bg-app-tertiary/50 rounded-lg border border-app-brand/5 space-y-3">
        <p class="text-[10px] font-bold uppercase text-app-secondary">Logo Adjustment</p>
        
        <div>
            <div class="flex justify-between text-xs mb-1">
                <label class="font-semibold text-app-header">Size</label>
                <span id="disp-logo-size" class="font-mono text-xs text-gray-400">100px</span>
            </div>
            <input type="range" id="tuneLogoSize" min="20" max="250" value="100" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Move X (0-100%)</label>
                <input type="range" id="tuneLogoX" min="0" max="100" value="50" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <label class="block text-[10px] font-semibold text-app-header mb-1">Move Y (0-100%)</label>
                <input type="range" id="tuneLogoY" min="0" max="100" value="15" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <label class="font-semibold text-app-header">Rotation</label>
                    <span id="disp-logo-rotate" class="font-mono text-[10px] text-gray-400">0¬∞</span>
                </div>
                <input type="range" id="tuneLogoRotate" min="-180" max="180" value="0" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <label class="font-semibold text-app-header">Opacity</label>
                    <span id="disp-logo-opacity" class="font-mono text-[10px] text-gray-400">100%</span>
                </div>
                <input type="range" id="tuneLogoOpacity" min="0" max="1.0" value="1.0" step="0.1" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-app-brand">
            </div>
        </div>

        <div class="border-t border-app-brand/10 pt-2 mt-1">
            <div class="flex justify-between items-center mb-2">
                <label class="font-semibold text-app-header text-xs">Flat Color Mode</label>
                <input type="checkbox" id="logoColorMode" class="rounded text-app-brand focus:ring-app-brand">
            </div>
            <div class="flex justify-between items-center">
                <label class="font-semibold text-app-header text-[10px] text-app-secondary">Pick Color</label>
                <input type="color" id="tuneLogoColor" value="#ffffff" class="w-6 h-6 p-0 border-0 rounded cursor-pointer">
            </div>
        </div>
    </div>

</div>
    </details>
</div>

            <div class="pt-4 border-t border-gray-300 dark:border-gray-700 mt-4">
    
    <div class="flex justify-between items-end mb-2">
        <h3 class="text-sm font-bold text-app-brand uppercase tracking-wider">4. Print Layout</h3>
        
        <div class="flex gap-2">
            <button onclick="window.saveLabelToBrew()" class="text-[10px] bg-green-100 text-green-700 border border-green-200 px-2 py-1 rounded hover:bg-green-200 font-bold uppercase flex items-center gap-1 transition-colors">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                Save Design
            </button>

            <button onclick="window.openLabelFormatModal()" class="text-[10px] bg-blue-100 text-blue-700 border border-blue-200 px-2 py-1 rounded hover:bg-blue-200 font-bold uppercase flex items-center gap-1 transition-colors">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Add Custom Size
            </button>
        </div>
    </div>
    
    <div class="grid grid-cols-2 gap-2 mb-4 items-end">
        <div>
            <label class="block text-xs font-bold text-app-secondary mb-1">Paper Format</label>
            <div class="flex gap-1">
                <select id="labelPaper" class="w-full p-2 border rounded bg-app-tertiary text-sm text-app-header focus:ring-1 focus:ring-app-brand">
                    </select>
                <button onclick="window.deleteCustomLabelFormat()" id="deleteLabelFormatBtn" class="hidden text-red-500 hover:text-red-700 px-1 font-bold text-lg" title="Delete selected format">&times;</button>
            </div>
        </div>
        <div>
            <button id="printLabelsBtn" class="h-10 bg-app-action text-white text-xs font-bold py-2.5 rounded hover:opacity-90 btn shadow-sm flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Print Sheet
            </button>
        </div>
    </div>
</div>
        </aside>
        
        <main class="lg:w-2/3 bg-gray-200 dark:bg-gray-800 p-8 rounded-lg shadow-inner flex flex-col items-center justify-center relative">
            <p class="absolute top-4 left-4 text-xs font-bold text-gray-400 uppercase tracking-widest">Live Preview</p>
            
            <div id="label-preview-container" class="bg-white text-black shadow-2xl relative overflow-hidden transition-all duration-300 transform hover:scale-105 flex-shrink-0" 
     style="width: 99.1mm; height: 67.7mm; padding: 0;">
                
                <div id="label-content" class="relative w-full h-full bg-white overflow-hidden flex font-sans">
    
    <div class="h-full w-[35%] bg-gray-50/80 border-r border-dashed border-gray-300 pt-4 pb-2 px-3 flex flex-col text-right z-20 relative">
        
        <div class="flex flex-col gap-1 overflow-hidden">
            <p id="prev-desc" class="text-[6px] leading-relaxed text-gray-600 italic font-serif text-justify">
                </p>
            <p id="prev-details" class="hidden text-[4px] text-gray-400 leading-tight text-justify mt-1 pt-1 border-t border-gray-200 uppercase tracking-wide font-sans">
            </p>
        </div>

        <div class="flex-grow"></div>

        <div class="text-[#8F8C79]">
            
            <div id="label-specs-container"></div>

            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[6px] font-bold uppercase tracking-wider">
                <div class="text-gray-400">ABV</div> 
                <div class="text-black text-right"><span id="prev-abv">12</span>%</div>
                
                <div class="text-gray-400">FG</div> 
                <div class="text-black text-right"><span id="prev-fg">1.000</span></div>
                
                <div class="text-gray-400">Vol</div> 
                <div class="text-black text-right"><span id="prev-vol">750</span>ml</div>
                
                <div class="text-gray-400">Bottled</div> 
                <div class="text-black text-right"><span id="prev-date">2025</span></div>
                
                <div class="text-gray-400">Peak</div> 
                <div class="text-black text-right"><span id="prev-peak">--</span></div>
            </div>
            
            <p id="prev-warning" class="hidden text-[4px] uppercase opacity-40 leading-tight mt-1">
                Contains Sulfites
            </p>
        </div>
    </div>

    <div class="h-full w-[65%] relative p-2 overflow-hidden">
        <div id="text-group" class="absolute top-0 bottom-0 flex flex-row items-end" style="left: 0px; padding-left: 2px;">
            <div id="title-container" class="h-full flex flex-col justify-end">
                <h1 id="prev-title" class="font-header font-bold uppercase tracking-widest text-[#8F8C79] text-left leading-[0.9] whitespace-normal line-clamp-2 text-ellipsis overflow-hidden" 
                    style="writing-mode: vertical-rl; transform: rotate(180deg); font-size: 100px;">
                    MEAD NAME
                </h1>
            </div>
            <div id="style-container" class="h-[50%] flex flex-col justify-end overflow-hidden" style="margin-left: 5px;">
                 <p id="prev-subtitle" class="font-bold uppercase tracking-[0.3em] text-gray-400 whitespace-normal leading-none line-clamp-3 text-ellipsis" 
                    style="writing-mode: vertical-rl; transform: rotate(180deg); font-size: 14px;">
                    STYLE DESCRIPTION
                 </p>
            </div>
        </div>
        <div class="absolute -top-6 -right-6 z-10">
            <img id="label-logo-img" src="logo.png" onerror="this.src='favicon.png'" class="w-32 h-32 object-contain object-center opacity-90">
            <img id="label-img-display" src="" class="hidden w-full h-full object-cover">
        </div>
    </div>
</div>
     
        </main>
    </div>
</div>

    <div id="water-view" class="hidden mt-4">
        <div class="flex flex-col lg:flex-row gap-8 lg:items-start">
            <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Water Chemistry</h2>
                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2">Current Source</label>
                    <select id="waterSource" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></select>
                </div>
                <div id="waterProfileDisplay" class="mb-6 p-4 card rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
                    <h4 class="text-sm font-bold text-blue-800 dark:text-blue-300 mb-2 uppercase tracking-wider">Active Profile (ppm)</h4>
                    <div class="grid grid-cols-3 gap-2 text-sm text-app-header">
                        <div class="text-center"><span class="block font-bold text-xs text-app-secondary">Ca</span><span id="val-ca">--</span></div>
                        <div class="text-center"><span class="block font-bold text-xs text-app-secondary">Mg</span><span id="val-mg">--</span></div>
                        <div class="text-center"><span class="block font-bold text-xs text-app-secondary">Na</span><span id="val-na">--</span></div>
                        <div class="text-center"><span class="block font-bold text-xs text-app-secondary">SO4</span><span id="val-so4">--</span></div>
                        <div class="text-center"><span class="block font-bold text-xs text-app-secondary">Cl</span><span id="val-cl">--</span></div>
                        <div class="text-center"><span class="block font-bold text-xs text-app-secondary">HCO3</span><span id="val-hco3">--</span></div>
                    </div>
                </div>
                <div class="mb-6 pt-6 border-t border-app">
                    <label class="block text-sm font-bold mb-2">AI Lookup (Bottled Water)</label>
                    <div class="flex gap-2">
                        <input type="text" id="ai-water-search-name" placeholder="e.g. Spa Reine, Evian..." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header">
                        <button id="ai-water-search-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 btn font-bold">Find</button>
                    </div>
                    <p class="text-xs text-app-secondary mt-1">Found profiles will auto-fill the form below.</p>
                </div>
                <form id="water-profile-form" class="space-y-3 pt-6 border-t border-app">
                    <h4 class="font-bold text-app-header">Add / Edit Profile</h4>
                    <input type="hidden" id="water-profile-id">
                    <div><input type="text" id="water-profile-name" placeholder="Profile Name (e.g. My Tap Water)" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-header"></div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="manual_ca" placeholder="Ca" class="p-2 border rounded bg-app-tertiary border-app text-app-header text-sm">
                        <input type="number" id="manual_mg" placeholder="Mg" class="p-2 border rounded bg-app-tertiary border-app text-app-header text-sm">
                        <input type="number" id="manual_na" placeholder="Na" class="p-2 border rounded bg-app-tertiary border-app text-app-header text-sm">
                        <input type="number" id="manual_so4" placeholder="SO4" class="p-2 border rounded bg-app-tertiary border-app text-app-header text-sm">
                        <input type="number" id="manual_cl" placeholder="Cl" class="p-2 border rounded bg-app-tertiary border-app text-app-header text-sm">
                        <input type="number" id="manual_hco3" placeholder="HCO3" class="p-2 border rounded bg-app-tertiary border-app text-app-header text-sm">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 btn">Save Profile</button>
                </form>
                <div id="user-water-profiles-list" class="mt-4 space-y-2"></div>
            </aside>
            <main class="lg:w-2/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                <h2 class="text-3xl font-header font-bold mb-6 text-center text-app-header">Water Sommelier</h2>
                <div class="mb-6 card p-6 rounded-lg bg-app-tertiary">
                    <p class="mb-4 text-app-header">Select your water source on the left, then choose your target mead style below. The AI will calculate the necessary salt additions.</p>
                    <div class="flex gap-4 items-end">
                        <div class="flex-grow">
                            <label class="block text-sm font-bold mb-2">Target Profile</label>
                            <select id="meadTargetProfile" class="w-full p-3 border rounded-md bg-app-secondary border-app text-app-header">
                                <option value="balanced">Balanced Mead (Standard)</option>
                                <option value="dry_traditional">Dry Traditional (Crisp)</option>
                                <option value="sweet_dessert">Sweet / Dessert (Soft)</option>
                                <option value="melomel">Melomel (Fruit Enhancing)</option>
                                <option value="metheglin">Metheglin (Spice Forward)</option>
                            </select>
                        </div>
                        <button id="getWaterAdviceBtn" class="bg-app-action text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 btn shadow-lg flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            Analyze & Adjust
                        </button>
                    </div>
                </div>
                <div id="water-advice-output" class="prose max-w-none text-app-header"></div>
            </main>
        </div>
    </div>

    <div id="troubleshoot-view" class="hidden h-full flex flex-col h-[70vh]">
    <div class="flex justify-between items-center mb-4 border-b border-app-brand/10 pb-2">
    <h3 class="text-xl font-header font-bold text-app-brand flex items-center gap-2">
        </h3>
        <button onclick="window.resetTroubleshootChat()" class="text-xs text-red-500 hover:text-red-700 font-bold uppercase">
            Clear Chat
        </button>
    </div>

    <div id="chat-history" class="flex-grow overflow-y-auto mb-4 p-4 bg-app-tertiary/30 rounded-lg border border-app-brand/10 space-y-4 shadow-inner custom-scrollbar">
        <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-app-brand text-white flex items-center justify-center font-bold text-xs">DOC</div>
            <div class="bg-white dark:bg-gray-800 p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-app-header border border-gray-100 dark:border-gray-700 max-w-[85%]">
                Hi! I'm your Mead Medic. What seems to be the problem? (You can upload a photo too!)
            </div>
        </div>
    </div>

    <div class="mt-auto">
        <div id="chat-image-preview" class="hidden mb-2 relative w-fit">
            <img id="chat-preview-img" class="h-20 rounded border border-app-brand/20">
            <button onclick="window.clearChatImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md">&times;</button>
        </div>

        <div class="flex gap-2">
            <label class="cursor-pointer flex items-center justify-center w-10 h-10 bg-app-tertiary hover:bg-app-secondary rounded-lg border border-app-brand/20 transition-colors">
                <svg class="w-5 h-5 text-app-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <input type="file" id="chat-image-input" accept="image/*" class="hidden" onchange="window.handleChatImageSelect(this)">
            </label>

            <input type="text" id="chat-input" class="flex-grow p-2 border rounded-lg bg-app-secondary border-app text-app-header focus:ring-2 focus:ring-app-brand" placeholder="Describe the issue..." onkeypress="if(event.key === 'Enter') window.sendTroubleshootMessage()">
            
            <button onclick="window.sendTroubleshootMessage()" id="chat-send-btn" class="bg-app-action text-white px-4 rounded-lg hover:opacity-90 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </div>
    </div>
</div>

    <div id="social-view" class="hidden mt-4">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app text-app-header">Social Studio</h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-app-secondary mb-2">1. Select Recipe</label>
                        <select id="social-recipe-select" class="w-full p-3 border rounded-md bg-app-tertiary border-app text-app-header focus:ring-2 focus:ring-app-brand">
                            <option value="">-- Choose a Brew --</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wider text-app-secondary mb-2">2. Vibe / Persona</label>
                            <select id="social-persona" class="w-full p-3 border rounded-md bg-app-tertiary border-app text-app-header">
                                <option value="Ryan Reynolds">Ryan Reynolds (Witty & Sarcastic)</option>
                                <option value="Dry British">Dry British Humor (Deadpan)</option>
                                <option value="The Sommelier">The Sommelier (Serious & Descriptive)</option>
                                <option value="The Viking">The Viking (Bold & Loud)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wider text-app-secondary mb-2">3. Platform</label>
                            <select id="social-platform" class="w-full p-3 border rounded-md bg-app-tertiary border-app text-app-header">
                                <option value="Instagram">Instagram</option>
                                <option value="Untappd">Untappd (Brewery Description)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-app-secondary mb-2">4. Special Focus (Optional)</label>
                        <textarea id="social-tweak" rows="2" class="w-full p-3 border rounded-md bg-app-tertiary border-app text-app-header" placeholder="e.g. Mention it's for a wedding, or highlight the honey source..."></textarea>
                    </div>
                    <div class="pt-4 border-t border-app space-y-3">
                        <button id="generate-social-from-recipe-btn" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            Draft Post & Prompt
                        </button>
                    </div>
                </div>
            </aside>
            <main class="lg:w-2/3 flex justify-center items-start">
                <div class="relative w-full max-w-sm bg-gray-900 rounded-[2.5rem] p-4 shadow-2xl border-4 border-gray-800">
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-6 bg-gray-800 rounded-b-xl z-10"></div>
                    <div class="bg-white dark:bg-gray-900 rounded-[2rem] overflow-hidden h-[600px] flex flex-col relative text-gray-800 dark:text-gray-100">
                        <div class="h-14 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 mt-2">
                             <span class="font-bold text-sm">Meandery</span>
                             <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                        </div>
                        <div id="social-image-container" class="w-full aspect-square bg-gray-100 dark:bg-gray-800 flex flex-col items-center justify-center text-gray-400 relative">
                            <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="text-xs">Image Preview</span>
                            <button id="generate-social-image-btn" class="hidden absolute bottom-4 right-4 bg-white/90 text-black text-xs font-bold py-2 px-3 rounded-full shadow-lg hover:bg-white flex items-center gap-1">
                                ‚ú® AI Generate
                            </button>
                        </div>
                        <div class="p-4 overflow-y-auto flex-grow">
                            <div id="social-content-container" class="text-sm leading-relaxed whitespace-pre-wrap">
                                <span class="text-gray-400 italic">Your generated caption will appear here...</span>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex gap-2">
                            <button onclick="window.copySocialPost()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-3 rounded-lg transition-colors flex justify-center items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                Copy Text
                            </button>
                            <button onclick="window.saveSocialPost()" class="flex-1 bg-app-tertiary border border-app hover:bg-app-secondary text-app-header text-xs font-bold py-3 rounded-lg transition-colors">
                                Save to Log
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="library-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
                    <h2 class="text-3xl font-header font-bold mb-2 text-center text-app-header">The Great Library</h2>
                    <p class="text-center text-app-secondary mb-8 text-sm uppercase tracking-widest">Mastery through Knowledge</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <a href="https://scottlab.com/content/files/documents/handbooks/Scott-Labs-Handbook-2024.pdf" target="_blank" class="card p-6 hover:border-app-brand transition-all group flex flex-col h-full relative overflow-hidden no-underline">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 rounded-full bg-app-tertiary text-app-brand group-hover:bg-app-brand group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                </div>
                                <h4 class="text-xl font-header font-bold text-app-header">Scott Labs Handbook</h4>
                            </div>
                            <p class="text-sm text-app-secondary mb-4 flex-grow">The fermentation bible. Detailed data on yeast strains, nutrients (Go-Ferm/Fermaid), and enzymes. Essential for scientific brewing.</p>
                            <div class="text-xs font-bold text-app-brand uppercase tracking-wider flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                Open PDF <span>&rarr;</span>
                            </div>
                        </a>
                        <a href="https://denardbrewing.com/blog/post/BOMM5-acres/" target="_blank" class="card p-6 hover:border-amber-500 transition-all group flex flex-col h-full relative overflow-hidden no-underline">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 rounded-full bg-app-tertiary text-amber-600 group-hover:bg-amber-500 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                </div>
                                <h4 class="text-xl font-header font-bold text-app-header">BOMM Protocol</h4>
                            </div>
                            <p class="text-sm text-app-secondary mb-4 flex-grow">"Bray's One Month Mead". The gold standard for fast, clean fermentation using Wyeast 1388 and specific nutrient staggering.</p>
                            <div class="text-xs font-bold text-amber-600 uppercase tracking-wider flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                Read Protocol <span>&rarr;</span>
                            </div>
                        </a>
                        <a href="https://www.bjcp.org/style/2015/m/" target="_blank" class="card p-6 hover:border-purple-500 transition-all group flex flex-col h-full relative overflow-hidden no-underline">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 rounded-full bg-app-tertiary text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                                </div>
                                <h4 class="text-xl font-header font-bold text-app-header">BJCP Style Guidelines</h4>
                            </div>
                            <p class="text-sm text-app-secondary mb-4 flex-grow">The official definition of every mead style (M1-M4). Use this when designing recipes for competitions to hit the right notes.</p>
                            <div class="text-xs font-bold text-purple-600 uppercase tracking-wider flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                View Guidelines <span>&rarr;</span>
                            </div>
                        </a>
                        <a href="https://gotmead.com/blog/the-mead-calculator/" target="_blank" class="card p-6 hover:border-green-600 transition-all group flex flex-col h-full relative overflow-hidden no-underline">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 rounded-full bg-app-tertiary text-green-600 group-hover:bg-green-600 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                </div>
                                <h4 class="text-xl font-header font-bold text-app-header">GotMead Calculator</h4>
                            </div>
                            <p class="text-sm text-app-secondary mb-4 flex-grow">The legendary complex calculator for estimating specific gravity when using fruit, sugar, and honey in varying stages.</p>
                            <div class="text-xs font-bold text-green-600 uppercase tracking-wider flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                Open Tool <span>&rarr;</span>
                            </div>
                        </a>
                        <a href="https://www.meadmakr.com/batch-buildr/" target="_blank" class="card p-6 hover:border-blue-500 transition-all group flex flex-col h-full relative overflow-hidden no-underline">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-3 rounded-full bg-app-tertiary text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                                </div>
                                <h4 class="text-xl font-header font-bold text-app-header">BatchBuildr</h4>
                            </div>
                            <p class="text-sm text-app-secondary mb-4 flex-grow">A specialized calculator specifically for determining TOSNA nutrient schedules based on your yeast strain.</p>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                Plan Nutrients <span>&rarr;</span>
                            </div>
                        </a>
                    </div>
                    <div class="mt-8 p-6 bg-app-tertiary rounded-lg border border-app-brand/20">
                        <h3 class="font-bold text-app-brand mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Internal BrewBuddy Tools
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="window.switchMainView('tools'); window.switchSubView('calculators', 'tools-main-view')" class="p-3 bg-app-secondary rounded hover:bg-white dark:hover:bg-gray-800 text-left text-sm font-semibold shadow-sm transition-colors text-app-header">
                                üî¢ Built-in Calculators (ABV, Dilution)
                            </button>
                            <button onclick="window.switchMainView('tools'); window.switchSubView('troubleshoot', 'tools-main-view')" class="p-3 bg-app-secondary rounded hover:bg-white dark:hover:bg-gray-800 text-left text-sm font-semibold shadow-sm transition-colors text-app-header">
                                ü©∫ AI Troubleshooter & Diagnosis
                            </button>
                        </div>
                    </div>
                </div>
            </div> 
        </div>

     <div id="settings-main-view" class="hidden">
        <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
        
        <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg settings-panel overflow-y-auto" style="max-height: 80vh;">
            <h2 class="text-3xl font-header font-bold mb-6 text-center">Settings</h2>
            
            <div class="max-w-xl mx-auto space-y-6">
                
                <div class="card p-6 rounded-lg">
                    <h3 class="text-xl font-header font-bold mb-4">API Keys</h3>
                    <div>
                        <label class="block text-sm font-bold mb-2">Google AI Key</label>
                        <input type="password" id="apiKeyInput" class="w-full p-2 border rounded-md bg-app-tertiary text-app-header">
                    </div>
                </div>

                <div class="card p-6 rounded-lg">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-xl font-header font-bold">AI Models</h3>
                        <button id="fetchModelsBtn" class="bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-700 btn">
                            üîÑ Scan & Update
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <p class="text-xs text-app-secondary mb-1 font-bold">Recipe Engine</p>
                            <select id="aiModelInput" class="w-full p-2 border rounded bg-app-tertiary text-app-header text-sm">
                                <option value="gemini-2.5-flash">gemini-2.5-flash (Default)</option>
                            </select>
                        </div>
                        <div>
                            <p class="text-xs text-app-secondary mb-1 font-bold">Chat Engine</p>
                            <select id="chatModelInput" class="w-full p-2 border rounded bg-app-tertiary text-app-header text-sm">
                                <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                            </select>
                        </div>
                        <div>
                            <p class="text-xs text-app-secondary mb-1 font-bold">Image Engine</p>
                            <select id="imageModelInput" class="w-full p-2 border rounded bg-app-tertiary text-app-header text-sm">
                                <option value="imagen-3.0-generate-001">imagen-3.0-generate-001</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card p-6 rounded-lg">
                    <h3 class="text-xl font-header font-bold mb-4">Defaults</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Batch Size (L)</label>
                        <input type="number" id="defaultBatchSizeInput" class="w-full p-2 border rounded-md bg-app-tertiary text-app-header">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Currency</label>
                        <input type="text" id="defaultCurrencyInput" class="w-full p-2 border rounded-md bg-app-tertiary text-app-header">
                    </div>
                </div>

                <div class="card p-6 rounded-lg">
                    <h3 class="text-xl font-header font-bold mb-4">UI</h3>
                    <div class="flex justify-between items-center">
                        <label class="font-bold">Dark Mode</label>
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle-checkbox">
                            <div class="slider round"></div>
                        </label>
                    </div>
                </div>

                <div class="card p-6 rounded-lg border-2 border-purple-500/20">
                    <h3 class="text-xl font-header font-bold mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Label Studio Assets
                    </h3>

                    <div class="mb-6">
                        <h4 class="font-bold text-sm text-app-brand uppercase mb-2">A. Art Styles (Prompts)</h4>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="newStyleName" placeholder="Name (e.g. Dark Fantasy)" class="w-1/3 p-2 border rounded bg-app-tertiary text-xs text-app-header">
                            <input type="text" id="newStylePrompt" placeholder="Prompt suffix..." class="flex-grow p-2 border rounded bg-app-tertiary text-xs text-app-header">
                            <button id="addStyleBtn" class="bg-purple-600 text-white px-3 rounded text-xs font-bold hover:bg-purple-700">+</button>
                        </div>
                        <div id="settings-styles-list" class="space-y-1 max-h-40 overflow-y-auto custom-scrollbar bg-app-primary p-2 rounded border border-app-brand/10"></div>
                    </div>

                    <div>
                        <h4 class="font-bold text-sm text-app-brand uppercase mb-2">B. Typography (Google Fonts)</h4>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="newFontName" placeholder="Font Name (e.g. Playfair Display)" class="flex-grow p-2 border rounded bg-app-tertiary text-xs text-app-header">
                            <button id="addFontBtn" class="bg-purple-600 text-white px-3 rounded text-xs font-bold hover:bg-purple-700">+</button>
                        </div>
                        <div id="settings-fonts-list" class="space-y-1 max-h-40 overflow-y-auto custom-scrollbar bg-app-primary p-2 rounded border border-app-brand/10"></div>
                    </div>
                </div>

                <button id="saveSettingsBtn" class="w-full bg-blue-700 text-white font-bold py-3 px-4 rounded-lg btn shadow-md hover:bg-blue-800 transition-colors">
                    Save Settings
                </button>

                <div class="mt-8 p-6 rounded-lg border-2 border-red-400 bg-app-tertiary">
                    <h3 class="text-xl font-header text-red-600 mb-4 font-bold">Data Management</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="exportHistoryBtn" class="btn bg-gray-600 text-white hover:bg-gray-700">Export History</button>
                        <button id="exportInventoryBtn" class="btn bg-gray-600 text-white hover:bg-gray-700">Export Inv</button>
                    </div>
                    <div class="mt-4 border-t-2 border-red-400 pt-4 space-y-2">
                        <button id="clearHistoryBtn" class="w-full bg-red-700 text-white btn hover:bg-red-800">Delete History</button>
                        <button id="clearInventoryBtn" class="w-full bg-red-700 text-white btn hover:bg-red-800">Delete Inventory</button>
                    </div>
                </div>

            </div> 
        </div>
    </div> 
        <p class="text-center text-sm text-app-secondary/60 mt-8">
            MEA(N)DERY - V2.2 Dual Engine - ¬© 2025 - 2026
        </p>
    </div>
</div>

    <div id="bottling-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-app-tertiary p-8 rounded-lg shadow-xl w-full max-w-lg"> <h3 class="text-2xl font-header font-bold mb-6">Bottle Batch</h3>
            <form id="bottling-form">
                <div class="space-y-6">
                    
                    <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-purple-800 dark:text-purple-300 text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                                Peak Flavor Forecast
                            </h4>
                            <button type="button" id="analyze-aging-btn" onclick="window.analyzeAgingPotential()" class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 btn shadow-sm transition-colors flex items-center gap-1">
                                ‚ú® AI Analyze Log
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Estimated Peak Date</label>
                                <input type="date" id="peakFlavorDate" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header font-bold text-purple-700 dark:text-purple-300">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-app-secondary mb-1">Reasoning</label>
                                <textarea id="peakFlavorReason" rows="1" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header text-xs" placeholder="Click analyze to generate..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">Bottling Date</label>
                            <input type="date" id="bottlingDate" required class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Closure Type</label>
                            <select id="closureTypeSelect" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header">
                                <option value="auto" selected>Automatic (based on size)</option>
                                <option value="cork">Cork</option>
                                <option value="crown_cap_26">Crown Cap 26mm</option>
                                <option value="crown_cap_29">Crown Cap 29mm</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2">Number of Bottles</label>
                        <div class="grid grid-cols-4 gap-2">
                            <div>
                                <label class="block text-xs text-app-secondary mb-1">750ml</label>
                                <input type="number" id="qty750" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-app-secondary mb-1">500ml</label>
                                <input type="number" id="qty500" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-app-secondary mb-1">330ml</label>
                                <input type="number" id="qty330" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-app-secondary mb-1">250ml</label>
                                <input type="number" id="qty250" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header text-center">
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-app pt-4">
                        <label class="block text-sm font-bold mb-2">Custom Sizes</label>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="number" id="customSize" min="0" step="1" placeholder="ml" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header">
                            <input type="number" id="customQty" min="0" step="1" placeholder="Qty" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header">
                            <input type="number" id="customPrice" min="0" step="0.01" placeholder="‚Ç¨ cost" class="w-full p-2 border rounded-md bg-app-primary border-app text-app-header">
                        </div>
                        <button type="button" onclick="window.addCustomBottleToList()" class="w-full mt-2 bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-700 btn text-sm">
                            + Add Custom Bottle
                        </button>
                        <div id="custom-bottles-list" class="mt-2 space-y-1"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-4 mt-8 pt-4 border-t border-app">
                    <button type="button" onclick="window.hideBottlingModal()" class="px-6 py-2 rounded-lg bg-gray-600 text-gray-300 hover:bg-gray-500 btn">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-app-action text-white font-bold hover:opacity-90 btn shadow-lg">Confirm Bottling</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>