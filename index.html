<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEA(N)DERY - AI Mead Recipe Creator</title>
    
    <meta name="theme-color" content="#a89a87"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --bg-primary: #f3f0e9;
            --bg-secondary: #fdfaf2;
            --bg-tertiary: #ffffff;
            --text-primary: #4a3c2c;
            --text-secondary: #5a4a3a;
            --border-color: #dcd0c0;
            --accent-color: #a89a87;
            --header-color: #4a3c2c;
            --brand-color: #8F8C79;
            --action-color: #b45309; /* Stronger action color */
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --info-color: #3b82f6;
        }

        .dark {
            --bg-primary: #000000;         /* ECHT ZWART: voor de hoofdachtergrond */
            --bg-secondary: #121212;      /* BIJNA ZWART: voor panelen en achtergronden */
            --bg-tertiary: #1e1e1e;       /* DONKERGRIJS: voor kaarten en knoppen */
            --text-primary: #e0e0e0;      /* Iets zachter wit voor minder hard contrast */
            --text-secondary: #b3b3b3;    /* Leesbaar secundair grijs */
            --border-color: #2e2e2e;      /* Subtiele randen */
            --accent-color: #c7c4b6; 
            --header-color: #ffffff;
            --brand-color: #adaa9a; 
            --action-color: #f59e0b; 
            --danger-color: #f87171;
            --success-color: #4ade80;
            --info-color: #60a5fa;
        }

        body {
            font-family: 'Barlow Semi Condensed', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-app-primary { background-color: var(--bg-primary); }
        .bg-app-secondary { background-color: var(--bg-secondary); }
        .bg-app-tertiary { background-color: var(--bg-tertiary); }
        .text-app-primary { color: var(--text-primary); }
        .text-app-secondary { color: var(--text-secondary); }
        .border-app { border-color: var(--border-color); }
        .text-app-header { color: var(--header-color); }
        .text-app-brand { color: var(--brand-color); }
        .bg-app-action { background-color: var(--action-color); }
        .tab.active { border-bottom-color: var(--brand-color); color: var(--brand-color); }
        .sub-tab.active { background-color: var(--brand-color); color: var(--bg-secondary); }


        .font-header {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        .control-panel::-webkit-scrollbar, main::-webkit-scrollbar, .inventory-panel::-webkit-scrollbar, .calculator-panel::-webkit-scrollbar, .settings-panel::-webkit-scrollbar {
            width: 8px;
        }
        .control-panel::-webkit-scrollbar-track, main::-webkit-scrollbar-track, .inventory-panel::-webkit-scrollbar-track, .calculator-panel::-webkit-scrollbar-track, .settings-panel::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .control-panel::-webkit-scrollbar-thumb, main::-webkit-scrollbar-thumb, .inventory-panel::-webkit-scrollbar-thumb, .calculator-panel::-webkit-scrollbar-thumb, .settings-panel::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }
        .recipe-content h1, .recipe-content h2, .recipe-content h3 {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.25rem;
        }
        .recipe-content h2 { font-size: 1.5rem; }
        .recipe-content h3 { font-size: 1.25rem; }
        .recipe-content ul, .recipe-content ol {
            padding-left: 20px;
            margin-bottom: 1rem;
        }
        .recipe-content p { line-height: 1.7; margin-bottom: 1.25rem; }
        .recipe-content li { margin-bottom: 0.75rem; line-height: 1.6; }
        .recipe-content strong { font-weight: 600; color: var(--text-primary); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .brew-log-section { padding-top: 1rem; }
        .brew-log-section h3 {
             font-family: 'Barlow Semi Condensed', sans-serif;
             font-weight: 600;
             font-size: 1.5rem;
             text-align: center;
             border-bottom: 2px solid var(--text-primary);
             padding-bottom: 0.5rem;
             margin-bottom: 1rem;
        }
        .brew-log-section .log-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
         .brew-log-section .log-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .brew-log-section .log-item input, .brew-log-section .log-item textarea {
            width: 100%; padding: 8px; border: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0; background-color: transparent;
            font-family: 'Barlow Semi Condensed', sans-serif;
            transition: border-color 0.3s;
            color: var(--text-primary);
        }
        .brew-log-section .log-item input:focus, .brew-log-section .log-item textarea:focus {
            outline: none; border-bottom: 1px solid var(--accent-color);
        }
        .fermentation-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .fermentation-table th, .fermentation-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .fermentation-table th { background-color: var(--bg-primary); }
        .fermentation-table input { width: 100%; border: none; background: transparent; padding: 4px; color: var(--text-primary); }
        
        .tab {
            transition: color 0.2s, border-color 0.2s;
            padding: 10px 16px; /* Added padding for spacing */
        }
        
        .btn {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .dark .btn:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        /* Theme Toggle Slider */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
        }
        input:checked + .slider {
            background-color: var(--brand-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        /* DEFINITIEVE STIJLEN VOOR SOCIAL MEDIA OUTPUT (FINALE VERSIE) */
        #social-content-container, 
        #social-content-container code, 
        #social-content-container pre {
            font-family: 'Barlow Semi Condensed', sans-serif;
        }
        #social-content-container h1, 
        #social-content-container h2, 
        #social-content-container h3 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        #social-content-container h2 { font-size: 1.5rem; }
        #social-content-container h3 { font-size: 1.25rem; }
        #social-content-container p { line-height: 1.6; margin-bottom: 1rem; }
        #social-content-container strong { font-weight: 700; color: var(--text-primary); }
        #social-content-container ul, #social-content-container ol {
            padding-left: 20px;
            margin-bottom: 1rem;
        }
        #social-content-container li { 
            margin-bottom: 0.5rem; 
            line-height: 1.6; 
        }
        #social-content-container code, #social-content-container pre {
             background-color: transparent;
             padding: 0;
             white-space: pre-wrap;
        }

        /* START: STIJLEN VOOR LABEL GENERATOR */
        #label-preview { border: 2px dashed var(--border-color); transition: all 0.3s; }
        .label-minimalist { background-color: #ffffff; color: #333; font-family: sans-serif; }
        .label-minimalist h3 { letter-spacing: 1px; }
        .label-rustic { background-color: #f4f1e9; color: #5a4a3a; border: 1px solid #dcd0c0; font-family: serif; }
        .label-rustic h3 { font-weight: normal; font-style: italic; font-size: 1.75rem; }
        .label-detailed { background-color: #1e1e1e; color: #e0e0e0; text-align: left; align-items: flex-start; }
        .label-detailed h3 { border-bottom: 2px solid #f59e0b; padding-bottom: 4px; }

        .timeline-container {
    position: relative;
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
}
.timeline-connector {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 4px;
    background-color: var(--border-color);
    transform: translateY(-50%);
    z-index: 1;
}
.timeline-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: var(--brand-color);
    transition: width 0.5s ease-in-out;
}
.timeline-item {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 25%; /* 4 items */
}
.timeline-node {
    width: 20px;
    height: 20px;
    background-color: var(--bg-tertiary);
    border: 4px solid var(--border-color);
    border-radius: 50%;
    transition: all 0.3s;
}
.timeline-item.active .timeline-node {
    background-color: var(--brand-color);
    border-color: var(--brand-color);
}
.timeline-label {
    margin-top: 0.75rem;
    font-size: 0.8rem;
    text-align: center;
    font-weight: 600;
}
.timeline-item.active .timeline-label {
    color: var(--text-primary);
}
.timeline-item .timeline-label {
    color: var(--text-secondary);
}

        /* GECOMBINEERDE PRINT STIJLEN */
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .container { max-width: 100%; padding: 1cm; margin: 0; }
            .lg\:w-1\/3, .lg\:w-2\/3 { width: 100%; }
            .flex-col { flex-direction: column; }
            main, .page-container { box-shadow: none; border: none; height: auto; max-height: none; padding: 0; }
            .recipe-output.printing-log .recipe-content { display: none; }
            .brew-log-section { page-break-before: always; margin-top: 0; padding-top: 0; border-top: none; }
            .brew-log-section .log-item input, .brew-log-section .log-item textarea { border-bottom: 1px dotted #999; }
            .fermentation-table th, .fermentation-table td { border: 1px solid #999; }
            
            /* Print stijlen voor de labels */
            .print-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10mm;
                width: 210mm; /* A4 Breedte */
                height: 297mm; /* A4 Hoogte */
            }
            .print-label {
                width: 90mm;
                height: 120mm;
                outline: 1px solid #ccc; /* Snijlijnen */
            }
        }
  
</style>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</head>
<body class="bg-app-primary text-app-primary">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-4 no-print">
            <h1 class="text-5xl font-header text-app-header">MEA<span class="text-app-brand">(N)</span>DERY</h1>
            <p class="text-app-secondary mt-2">AI Brewbuddy</p>
        </header>

        <!-- Main Content Area -->
        <div id="dashboard-main-view">
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
                
                <div id="current-brew-card" class="card p-6 rounded-lg mb-6 hidden">
                    <!-- Content injected by JS -->
                </div>

               <div id="next-action-widget" class="card p-6 rounded-lg mb-6 hidden bg-amber-50 dark:bg-amber-900/20 border-amber-300 dark:border-amber-700">
                    <h3 class="text-xl font-header font-bold mb-3 text-amber-800 dark:text-amber-200">Wat nu doen?</h3>
                    <ul id="next-action-list" class="list-disc pl-5 space-y-2 text-amber-700 dark:text-amber-300">
                        <!-- Dynamische suggesties komen hier -->
                    </ul>
               </div>

               <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <button data-view="brewing" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <path d="M10 2v7.31"></path><path d="M14 9.31V2"></path><path d="M8.5 2h7"></path><path d="M14 9.31C16.57 10.92 18 14.11 18 17.69V20a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-2.31C6 14.11 7.43 10.92 10 9.31Z"></path>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Brewing</h3>
                        <p class="text-app-secondary/80 text-sm">Creator, Brew Day, History</p>
                    </button>
                    <button data-view="management" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <rect width="20" height="5" x="2" y="3" rx="1"></rect><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path><path d="M10 12h4"></path>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Management</h3>
                        <p class="text-app-secondary/80 text-sm">Inventory, Planning, Financials</p>
                    </button>
                    <button data-view="tools" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Tools</h3>
                        <p class="text-app-secondary/80 text-sm">Calculators, Water, Social</p>
                    </button>
                    <button data-view="settings" class="main-nav-btn card p-6 rounded-lg text-center hover:shadow-lg transition-shadow btn flex flex-col items-center justify-center">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 text-app-brand">
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.4l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <h3 class="text-xl font-header font-bold">Settings</h3>
                        <p class="text-app-secondary/80 text-sm">Configure your app</p>
                    </button>
                </div>

                <div id="low-stock-card" class="card p-6 rounded-lg mb-6 hidden">
                     <h3 class="text-xl font-header font-bold mb-2 text-red-500">Low Stock Alerts</h3>
                     <ul id="low-stock-list" class="list-disc pl-5 text-app-secondary">
                        <!-- Content injected by JS -->
                     </ul>
                </div>

            </div>
        </div>

        <div id="brewing-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto">
                    <button id="creator-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Creator</button>
                    <button id="brewing-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Brew Day</button>
                    <button id="history-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">History</button>
                </nav>
            </div>
            <div id="creator-view">
                <div class="flex flex-col lg:flex-row gap-8 mt-4">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg control-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Craft Your Mead</h2>
                        
                        <div class="mb-6">
                            <label for="customDescription" class="block text-sm font-bold mb-2">Describe Your Dream Mead</label>
                            <textarea id="customDescription" rows="4" placeholder="Be descriptive! e.g., 'A dry, sparkling mead with lavender and lemon, around 8% ABV, perfect for summer.'" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary"></textarea>
                            <p class="text-xs text-center text-app-secondary/80 mt-2">Or, use the options below for a more structured recipe.</p>
                        </div>

                        <div class="space-y-6 pt-6 border-t border-app">
                            <div>
                                <label for="batchSize" class="block text-sm font-bold mb-2">Batch Size (Liters)</label>
                                <input type="number" id="batchSize" value="5" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="equipmentProfileSelect" class="block text-sm font-bold mb-2">Equipment Profile</label>
                                <select id="equipmentProfileSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="">None (Use default values)</option>
                                    <!-- Profielen worden hier geladen door JS -->
                                </select>
                            </div>
                            <div>
                                <label for="abv" class="block text-sm font-bold mb-2">Target ABV (%)</label>
                                <input type="number" id="abv" value="12" min="5" max="18" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                            </div>
                            <div>
                                <label for="sweetness" class="block text-sm font-bold mb-2">Final Sweetness</label>
                                <select id="sweetness" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="dry">Dry (FG ~1.000)</option>
                                    <option value="semi-sweet" selected>Semi-Sweet (FG ~1.015)</option>
                                    <option value="sweet">Sweet (FG ~1.030)</option>
                                </select>
                            </div>
                            <div>
                                <label for="style" class="block text-sm font-bold mb-2">Base Style</label>
                                <select id="style" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <optgroup label="Standard Styles">
                                        <option value="bochet">Bochet (Caramelized Honey)</option>
                                        <option value="braggot">Braggot (Beer/Mead Hybrid)</option>
                                        <option value="capsicumel">Capsicumel (Chili Mead)</option>
                                        <option value="cyser">Cyser (Apple Mead)</option>
                                        <option value="melomel">Melomel (Fruit Mead)</option>
                                        <option value="metheglin">Metheglin (Spiced Mead)</option>
                                        <option value="pyment">Pyment (Grape Mead)</option>
                                        <option value="rhodomel">Rhodomel (Rose Mead)</option>
                                        <option value="traditional">Traditional</option>
                                    </optgroup>
                                    <optgroup label="Belgian Specials">
                                        <option value="belgian_dubbel">Dubbel Style</option>
                                        <option value="belgian_gruit">Gruit (Hopless Herb Mead)</option>
                                        <option value="belgian_kriek">Kriek Style</option>
                                        <option value="lambic">Lambic Style</option>
                                        <option value="oud_bruin">Oud Bruin Style</option>
                                        <option value="belgian_quad">Quadrupel (Westvleteren 12 Inspired)</option>
                                        <option value="belgian_saison">Saison de Pipaix Style</option>
                                        <option value="belgian_tripel">Tripel Style</option>
                                        <option value="belgian_wit">Wit Style</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label for="honeyVariety" class="block text-sm font-bold mb-2">Honey Variety</label>
                                <select id="honeyVariety" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="Acacia">Acacia</option>
                                    <option value="Buckwheat">Buckwheat</option>
                                    <option value="Clover">Clover</option>
                                    <option value="Forest/Boshoning">Forest Honey (Boshoning)</option>
                                    <option value="Linden/Linde">Linden Honey (Lindehoning)</option>
                                    <option value="Orange Blossom">Orange Blossom</option>
                                    <option value="Wildflower" selected>Wildflower (Default)</option>
                                </select>
                            </div>
                            <div>
                                <label for="nutrientProtocol" class="block text-sm font-bold mb-2">Nutrient Protocol</label>
                                <select id="nutrientProtocol" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="staggered" selected>Standard Staggered (24/48/72h)</option>
                                    <option value="tosna">TOSNA 2.0 (Organic)</option>
                                    <option value="simple">Simple (All at Pitch)</option>
                                </select>
                            </div>
                            <div id="fruit-section" class="hidden space-y-2">
                                <label class="block text-sm font-bold">Choose Fruits (for Melomel)</label>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_apples" class="mr-2"><label for="fruit_apples">Apples</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_apricots" class="mr-2"><label for="fruit_apricots">Apricots</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blackberries" class="mr-2"><label for="fruit_blackberries">Blackberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blackcurrants" class="mr-2"><label for="fruit_blackcurrants">Blackcurrants</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_blueberries" class="mr-2"><label for="fruit_blueberries">Blueberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_cherries" class="mr-2"><label for="fruit_cherries">Cherries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_gooseberries" class="mr-2"><label for="fruit_gooseberries">Gooseberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_peaches" class="mr-2"><label for="fruit_peaches">Peaches</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_pears" class="mr-2"><label for="fruit_pears">Pears</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_plums" class="mr-2"><label for="fruit_plums">Plums</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_raspberries" class="mr-2"><label for="fruit_raspberries">Raspberries</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="fruit_redcurrants" class="mr-2"><label for="fruit_redcurrants">Redcurrants</label></div>
                                </div>
                            </div>
                             <div id="spice-section" class="hidden space-y-2">
                                <label class="block text-sm font-bold">Choose Spices (for Metheglin)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_cinnamon" class="mr-2"><label for="spice_cinnamon">Cinnamon</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_cloves" class="mr-2"><label for="spice_cloves">Cloves</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_coriander" class="mr-2"><label for="spice_coriander">Coriander</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_nutmeg" class="mr-2"><label for="spice_nutmeg">Nutmeg</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_orange" class="mr-2"><label for="spice_orange">Orange Peel</label></div>
                                    <div class="p-2 rounded hover:bg-app-primary"><input type="checkbox" id="spice_vanilla" class="mr-2"><label for="spice_vanilla">Vanilla</label></div>
                                </div>
                            </div>
                            <div id="braggot-section" class="hidden">
                                <label for="braggotStyle" class="block text-sm font-bold mb-2">Braggot Base Style</label>
                                <select id="braggotStyle" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                    <option value="belgian_blond">Belgian Blond</option>
                                    <option value="dubbel">Belgian Dubbel</option>
                                    <option value="ipa">IPA</option>
                                    <option value="old_ale">Old Ale / Barleywine</option>
                                    <option value="saison">Saison</option>
                                    <option value="scotch_ale">Scotch Ale / Wee Heavy</option>
                                    <option value="stout">Stout</option>
                                </select>
                            </div>
                            <div class="space-y-4 pt-4 border-t border-app">
                                <div class="flex items-center">
                                    <input type="checkbox" id="addOak" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                    <label for="addOak" class="ml-3 block text-sm font-bold">Include Oak Aging?</label>
                                </div>
                                <div>
                                    <label for="specialIngredients" class="block text-sm font-bold mb-2">Special Ingredients (optional)</label>
                                    <input type="text" id="specialIngredients" placeholder="e.g., Rose petals, Lapsang tea..." class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t-2 border-app-brand mt-6">
                             <div class="flex items-center">
                                <input type="checkbox" id="useInventory" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                <label for="useInventory" class="ml-3 block text-sm font-bold text-app-brand">Create recipe from my inventory</label>
                            </div>
                            
                            <div id="budget-section" class="hidden pl-7 space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="useBudget" class="h-4 w-4 rounded border-gray-300 text-app-brand focus:ring-app-brand">
                                    <label for="useBudget" class="ml-3 block text-sm font-bold">Generate within budget?</label>
                                </div>
                                <div id="budget-input-container" class="hidden">
                                    <label for="maxBudget" class="block text-sm font-bold mb-1">Max Budget</label>
                                    <input type="number" id="maxBudget" placeholder="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                            </div>
                            </div>

                        <div class="mt-8">
                            <button id="generateBtn" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">
                                Generate Recipe
                            </button>
                        </div>
                    </aside>

                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                        <div id="recipe-output" class="prose max-w-none text-app-primary">
                        </div>
                    </main>
                </div>
            </div>
            <div id="brewing-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <div id="brew-day-content">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew Day Assistant</h2>
                        <p class="text-center text-app-secondary/80">Generate a recipe or load one from history, then click "Start Brew Day" to begin.</p>
                    </div>
                </div>
            </div>
            <div id="history-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <div id="history-list-container">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Brew History</h2>
                        <div id="history-list" class="space-y-4">
                            </div>
                    </div>
                    <div id="history-detail-container" class="hidden">
                        </div>
                 </div>
            </div>
        </div>

        <div id="management-main-view" class="hidden">
             <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
             <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto">
                    <button id="inventory-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Inventory</button>
                    <button id="equipment-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Equipment Profiles</button>
                    <button id="cellar-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Cellar</button> <button id="planning-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Planning</button>
                    <button id="financials-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Financials</button>
                </nav>
            </div>
            <div id="inventory-view" class="mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
        <div id="barcode-scanner-container" class="relative hidden mb-4">
            <div id="barcode-reader" class="w-full rounded-lg"></div>
            <button id="close-scanner-btn" class="absolute top-2 right-2 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold btn">&times;</button>
        </div>
        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add to Inventory</h2>

        <button id="scan-barcode-btn" class="w-full mb-4 bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                <path d="M7 12h10"></path>
            </svg>
            Scan Barcode
        </button>

        <p class="text-xs text-center text-app-secondary/80 mb-4">- OR -</p>

        <form id="inventory-form" class="space-y-4">
            <div>
                <label for="itemName" class="block text-sm font-bold mb-2">Ingredient Name</label>
                <input type="text" id="itemName" placeholder="e.g., Acacia Honey" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="itemQty" class="block text-sm font-bold mb-2">Quantity</label>
                    <input type="number" id="itemQty" step="0.01" placeholder="e.g., 1.5" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                </div>
                <div>
                    <label for="itemUnit" class="block text-sm font-bold mb-2">Unit</label>
                    <select id="itemUnit" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                        <option>kg</option>
                        <option>g</option>
                        <option>L</option>
                        <option>ml</option>
                        <option>packets</option>
                        <option>items</option>
                    </select>
                </div>
            </div>
             <div>
                <label for="itemPrice" class="block text-sm font-bold mb-2">Price (€)</label>
                <input type="number" id="itemPrice" step="0.01" placeholder="e.g., 12.50" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
            </div>
            <div>
                <label for="itemCategory" class="block text-sm font-bold mb-2">Category</label>
                <select id="itemCategory" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand focus:border-app-brand text-app-primary">
                    <option>Honey</option>
                    <option>Yeast</option>
                    <option>Nutrient</option>
                    <option>Malt Extract</option>
                    <option>Fruit</option>
                    <option>Spice</option>
                    <option>Adjunct</option>
                    <option>Chemical</option>
                </select>
            </div>
            <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">Add Ingredient</button>
        </form>
    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">Current Stock</h2>
                        <div id="inventory-list">
                            </div>
                    </main>
                </div>
            </div>
            <div id="equipment-view" class="hidden mt-4">
    <div class="flex flex-col lg:flex-row gap-8">
        <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Add Equipment Profile</h2>
            <form id="equipment-profile-form" class="space-y-4">
                <div>
                    <label for="equipProfileName" class="block text-sm font-bold mb-2">Profile Name</label>
                    <input type="text" id="equipProfileName" placeholder="e.g., My 30L Fermenter" required class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                </div>
                <div>
                    <label for="equipProfileType" class="block text-sm font-bold mb-2">Equipment Type</label>
                    <select id="equipProfileType" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        <option value="Fermenter">Fermenter</option>
                        <option value="Kettle">Kettle / Boil Pot</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="equipCapacityLiters" class="block text-sm font-bold mb-2">Total Capacity (L)</label>
                        <input type="number" id="equipCapacityLiters" step="0.1" placeholder="30" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                    </div>
                    <div>
                        <label for="trubLossLiters" class="block text-sm font-bold mb-2">Trub/Yeast Loss (L)</label>
                        <input type="number" id="trubLossLiters" step="0.1" placeholder="0.75" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                    </div>
                </div>
                <div id="boil-off-rate-container" class="hidden">
                    <label for="boilOffRateLitersPerHour" class="block text-sm font-bold mb-2">Boil-Off Rate (Liters/Hour)</label>
                    <input type="number" id="boilOffRateLitersPerHour" step="0.1" placeholder="2.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                </div>
                <button type="submit" class="w-full bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-all duration-300 shadow-md btn">Add Profile</button>
            </form>
        </aside>
        <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg inventory-panel overflow-y-auto" style="max-height: 70vh;">
            <h2 class="text-3xl font-header font-bold mb-4 text-center">Saved Equipment Profiles</h2>
            <div id="equipment-profiles-list">
                <!-- Profielen worden hier geladen door JS -->
            </div>
        </main>
    </div>
</div>
            <div id="cellar-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">My Cellar</h2>
                    <div id="cellar-list" class="space-y-4">
                        </div>
                </div>
            </div>
            <div id="planning-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                     <h2 class="text-3xl font-header font-bold mb-6 text-center">Planning</h2>
                     <div id="shopping-list-container" class="mb-8">
                        <h3 class="text-2xl font-header mb-4">Shopping List</h3>
                        <div id="shopping-list-content" class="p-4 card rounded-lg">
                            <p class="text-app-secondary">Load a recipe from your history and click "Generate Shopping List" to see what you need.</p>
                        </div>
                     </div>
                </div>
            </div>
            <div id="financials-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                     <h2 class="text-3xl font-header font-bold mb-6 text-center">Financials</h2>
                     <div id="cost-analysis-container">
                        <h3 class="text-2xl font-header mb-4">Cost Analysis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card p-4 rounded-lg text-center">
                                <h4 class="text-lg font-bold text-app-secondary">Total Inventory Value</h4>
                                <p id="total-spend" class="text-3xl font-bold text-app-brand">€0.00</p>
                            </div>
                            <div class="card p-4 rounded-lg text-center">
                                <h4 class="text-lg font-bold text-app-secondary">Average Cost Per Batch</h4>
                                <p id="avg-cost" class="text-3xl font-bold text-app-brand">€0.00</p>
                            </div>
                        </div>
                        <div class="card p-4 rounded-lg mt-6">
                            <h4 class="text-lg font-bold text-app-secondary text-center mb-4">Spend by Category</h4>
                            <canvas id="cost-chart"></canvas>
                        </div>
                     </div>
                     <div id="overhead-container" class="mt-8">
                        <h3 class="text-2xl font-header mb-4">Utilities & Overhead Cost Calculator</h3>
                        <div class="card p-6 rounded-lg space-y-4">
                            <div>
                                <label for="electricityCost" class="block font-bold mb-1">Electricity Cost (per kWh)</label>
                                <input type="number" id="electricityCost" placeholder="0.35" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <div>
                                <label for="waterCost" class="block font-bold mb-1">Water Cost (per m³)</label>
                                <input type="number" id="waterCost" placeholder="5.00" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <div>
                                <label for="sanitizerCost" class="block font-bold mb-1">Sanitizer Cost (per batch)</label>
                                <input type="number" id="sanitizerCost" placeholder="1.50" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            </div>
                            <button id="calculateOverheadBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Overhead</button>
                            <div id="overheadResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <div id="tools-main-view" class="hidden">
             <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-4 rounded-b-lg shadow-inner">
                <nav class="flex space-x-2 overflow-x-auto">
                    <button id="calculators-sub-tab" class="sub-tab active px-4 py-2 rounded-md text-sm font-semibold">Calculators</button>
                    <button id="labels-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Labels</button>
                    <button id="water-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Water</button>
                    <button id="troubleshoot-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Troubleshoot</button>
                    <button id="social-sub-tab" class="sub-tab px-4 py-2 rounded-md text-sm font-semibold">Social</button>
                </nav>
            </div>
            <div id="calculators-view" class="mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg calculator-panel overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">Brewing Calculators</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">ABV Calculator</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="og" class="block text-sm font-bold mb-1">Original Gravity (OG)</label>
                                    <input type="number" id="og" step="0.001" placeholder="e.g., 1.110" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="fg" class="block text-sm font-bold mb-1">Final Gravity (FG)</label>
                                    <input type="number" id="fg" step="0.001" placeholder="e.g., 1.015" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <button id="calcAbvBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate ABV</button>
                                <div id="abvResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Hydrometer Correction</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="sgReading" class="block text-sm font-bold mb-1">Hydrometer Reading</label>
                                    <input type="number" id="sgReading" step="0.001" placeholder="e.g., 1.052" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="tempReading" class="block text-sm font-bold mb-1">Liquid Temperature (°C)</label>
                                    <input type="number" id="tempReading" placeholder="e.g., 25" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                 <div>
                                    <label for="calTemp" class="block text-sm font-bold mb-1">Hydrometer Calibration Temp (°C)</label>
                                    <input type="number" id="calTemp" value="20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <button id="correctSgBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Correct Gravity</button>
                                <div id="sgResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Priming Sugar Calculator</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="carbVol" class="block text-sm font-bold mb-1">Desired CO2 Volumes</label>
                                    <input type="number" id="carbVol" step="0.1" placeholder="e.g., 2.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="carbTemp" class="block text-sm font-bold mb-1">Mead Temperature (°C)</label>
                                    <input type="number" id="carbTemp" placeholder="e.g., 20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                 <div>
                                    <label for="carbBatchSize" class="block text-sm font-bold mb-1">Batch Size (Liters)</label>
                                    <input type="number" id="carbBatchSize" step="0.1" placeholder="e.g., 5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <button id="calcSugarBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Sugar</button>
                                <div id="sugarResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>
                        <div class="p-4 card rounded-lg">
                            <h3 class="text-xl font-header mb-4">Blending Calculator</h3>
                            <div class="space-y-4">
                                 <div>
                                    <label class="block text-sm font-bold mb-1">Liquid 1</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="vol1" placeholder="Volume (L)" class="w-1/2 p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                        <input type="number" id="sg1" step="0.001" placeholder="SG (e.g. 1.050)" class="w-1/2 p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Liquid 2</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="vol2" placeholder="Volume (L)" class="w-1/2 p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                        <input type="number" id="sg2" step="0.001" placeholder="SG (e.g. 1.000)" class="w-1/2 p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    </div>
                                </div>
                                <button id="calcBlendBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Calculate Blend</button>
                                <div id="blendResult" class="text-center font-bold text-lg mt-2 h-8"></div>
                            </div>
                        </div>
                        <div class="p-4 card rounded-lg md:col-span-2 lg:col-span-3">
                            <h3 class="text-xl font-header mb-4">AI Yeast Starter Calculator</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="starterOG" class="block text-sm font-bold mb-1">Starting Gravity (OG)</label>
                                    <input type="number" id="starterOG" step="0.001" placeholder="e.g., 1.120" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="yeastDate" class="block text-sm font-bold mb-1">Yeast Production Date</label>
                                    <input type="date" id="yeastDate" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                </div>
                                <div>
                                    <label for="yeastType" class="block text-sm font-bold mb-1">Yeast Type</label>
                                    <select id="yeastType" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                        <option value="liquid">Liquid Yeast</option>
                                        <option value="dry">Dry Yeast</option>
                                    </select>
                                </div>
                            </div>
                            <button id="getYeastAdviceBtn" class="w-full mt-4 bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">Get Yeast Advice</button>
                            <div id="yeast-advice-output" class="prose max-w-none text-app-primary mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="labels-view" class="hidden mt-4">
    <div class="flex flex-col lg:flex-row gap-8">
        <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Label Designer</h2>
                <div class="space-y-4">
                    <div>
                        <label for="labelName" class="block text-sm font-bold mb-1">Mead Name</label>
                        <input type="text" id="labelName" placeholder="e.g., Summer Solstice" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                    </div>
                    <div>
                        <label for="labelStyle" class="block text-sm font-bold mb-1">Style / Subtitle</label>
                        <input type="text" id="labelStyle" placeholder="e.g., Lavender & Lemon Melomel" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="labelAbv" class="block text-sm font-bold mb-1">ABV (%)</label>
                            <input type="text" id="labelAbv" placeholder="12.5" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        </div>
                        <div>
                            <label for="labelVol" class="block text-sm font-bold mb-1">Volume (ml)</label>
                            <input type="text" id="labelVol" placeholder="750" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        </div>
                    </div>
                    <div>
                        <label for="labelDate" class="block text-sm font-bold mb-1">Bottling Date</label>
                        <input type="text" id="labelDate" placeholder="August 2025" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                    </div>
                    <div>
                        <label for="logoUpload" class="block text-sm font-bold mb-1">Upload Your Logo</label>
                        <input type="file" id="logoUpload" accept="image/*" class="w-full text-sm text-app-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-app-primary file:text-app-brand hover:file:bg-app-tertiary">
                    </div>

                    <div class="pt-4 border-t border-app space-y-4">
                        <div>
                            <label for="labelFormatSelect" class="block text-sm font-bold mb-2">Label Format</label>
                            <select id="labelFormatSelect" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                <option value="herma_10730">Herma 10730 (99.1 x 139 mm) - 4/pagina</option>
                                <option value="avery_l7165">Avery L7165 (99.1 x 67.7 mm) - 8/pagina</option>
                                <option value="custom">Custom Format...</option>
                            </select>
                        </div>
                        <div id="custom-format-inputs" class="hidden space-y-2 p-3 border rounded-md border-app">
                             <div class="grid grid-cols-2 gap-2 text-sm">
                                <div><label>Width (mm)</label><input type="number" id="customWidth" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                <div><label>Height (mm)</label><input type="number" id="customHeight" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                <div><label>Columns</label><input type="number" id="customCols" class="w-full p-1 border rounded-md bg-app-primary"></div>
                                <div><label>Rows</label><input type="number" id="customRows" class="w-full p-1 border rounded-md bg-app-primary"></div>
                             </div>
                        </div>
                         <div>
                            <label class="block text-sm font-bold mb-2">Choose a Style</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button class="label-style-btn p-2 border-2 border-app-brand rounded-lg text-app-brand btn" data-style="minimalist">Minimalist</button>
                                <button class="label-style-btn p-2 border rounded-lg btn" data-style="rustic">Rustic</button>
                                <button class="label-style-btn p-2 border rounded-lg btn" data-style="detailed">Detailed</button>
                            </div>
                        </div>
                    </div>
                     </div>
            </aside>
        <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-header font-bold mb-2 text-center">Live Preview</h2>
            <p class="text-center text-sm text-app-secondary mb-6">Dit is hoe één etiket eruit zal zien.</p>
            <div class="max-w-xs mx-auto">
                <div id="label-preview" class="label-minimalist aspect-[3/4] p-4 flex flex-col justify-between items-center text-center">
                    <img id="label-logo-preview" src="" class="hidden h-16 w-auto mb-4"/>
                    <div>
                        <h3 id="label-name-preview" class="text-2xl font-bold font-header">Mead Name</h3>
                        <p id="label-style-preview" class="text-sm">Style / Subtitle</p>
                    </div>
                    <div class="w-full border-t border-current mt-4 pt-2 text-xs flex justify-between">
                        <span id="label-date-preview">Bottling Date</span>
                        <span><span id="label-abv-preview">ABV</span>% ABV</span>
                        <span><span id="label-vol-preview">VOL</span>ml</span>
                    </div>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="generate-print-btn" class="w-full max-w-xs bg-app-action text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 btn">
                    Generate Printable Page
                </button>
            </div>
        </main>
    </div>
</div>
            <div id="water-view" class="hidden mt-4">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/3 bg-app-secondary p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-header font-bold mb-6 border-b pb-4 border-app">Water Profile</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="waterSource" class="block text-sm font-bold mb-2">Select Water Profile</label>
                                <select id="waterSource" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    <option value="spa">Spa Reine</option>
                                    <option value="chaudfontaine">Chaudfontaine</option>
                                    <option value="valvert">Valvert</option>
                                    <option value="bru">Bru</option>
                                    <option value="villers">Villers</option>
                                    <option value="manual">Manual Entry</option>
                                </select>
                            </div>
                            <div id="manualWaterProfile" class="hidden space-y-2 pt-4 border-t border-app">
                                 <h4 class="font-bold text-center">Enter Manual Profile (mg/L)</h4>
                                 <div class="grid grid-cols-2 gap-2">
                                    <div><label for="manual_ca">Ca</label><input type="number" id="manual_ca" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                    <div><label for="manual_mg">Mg</label><input type="number" id="manual_mg" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                    <div><label for="manual_na">Na</label><input type="number" id="manual_na" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                    <div><label for="manual_so4">SO4</label><input type="number" id="manual_so4" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                    <div><label for="manual_cl">Cl</label><input type="number" id="manual_cl" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                    <div><label for="manual_hco3">HCO3</label><input type="number" id="manual_hco3" class="w-full p-1 border rounded-md bg-app-tertiary border-app text-app-primary"></div>
                                 </div>
                            </div>
                            <button id="fetchWaterProfileBtn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Fetch Profile</button>
                            <div id="waterProfileDisplay" class="mt-4 p-4 card rounded-lg">
                                <h4 class="font-bold font-header text-lg mb-2">Active Mineral Profile (mg/L)</h4>
                                <ul class="space-y-1 text-sm text-app-primary">
                                    <li><strong>Calcium (Ca):</strong> <span id="val-ca">--</span></li>
                                    <li><strong>Magnesium (Mg):</strong> <span id="val-mg">--</span></li>
                                    <li><strong>Sodium (Na):</strong> <span id="val-na">--</span></li>
                                    <li><strong>Sulfate (SO4):</strong> <span id="val-so4">--</span></li>
                                    <li><strong>Chloride (Cl):</strong> <span id="val-cl">--</span></li>
                                    <li><strong>Bicarbonate (HCO3):</strong> <span id="val-hco3">--</span></li>
                                </ul>
                            </div>
                        </div>
                    </aside>
                    <main class="lg:w-2/3 bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                        <h2 class="text-3xl font-header font-bold mb-4 text-center">AI Adjustment Recommendations</h2>
                        <div class="space-y-4 mb-6">
                            <div>
                                <label for="meadTargetProfile" class="block text-sm font-bold mb-2">Desired Mead Character</label>
                                <select id="meadTargetProfile" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    <option value="balanced">Balanced / All-Purpose</option>
                                    <option value="dry_crisp">Dry & Crisp (e.g., Traditional, Saison)</option>
                                    <option value="rich_full">Rich & Full-bodied (e.g., Sweet Melomel, Quad)</option>
                                    <option value="hoppy_braggot">Hoppy Braggot (IPA style)</option>
                                </select>
                            </div>
                            <button id="getWaterAdviceBtn" class="w-full bg-purple-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-800 btn">Get Brewing Advice</button>
                        </div>
                        <div id="water-advice-output" class="prose max-w-none text-app-primary">
                            <p class="text-center text-app-secondary/80">Select a water source and a desired mead character, then ask the Alchemist for advice.</p>
                        </div>
                    </main>
                </div>
            </div>
            <div id="troubleshoot-view" class="hidden mt-4">
                 <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">AI Troubleshooter</h2>
                    <div class="max-w-xl mx-auto">
                        <div class="card p-6 rounded-lg">
                            <label for="troubleshoot-description" class="block text-lg font-bold mb-2">Describe your brewing problem:</label>
                            <textarea id="troubleshoot-description" rows="5" placeholder="e.g., My fermentation seems to have stopped after only 3 days. The airlock isn't bubbling anymore." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
                            <button id="troubleshoot-btn" class="w-full mt-4 bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 btn">Get Advice</button>
                        </div>
                        <div id="troubleshoot-output" class="mt-6 prose max-w-none text-app-primary"></div>
                    </div>
                 </div>
            </div>
            <div id="social-view" class="hidden mt-4">
                <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg overflow-y-auto" style="max-height: 70vh;">
                    <h2 class="text-3xl font-header font-bold mb-6 text-center">Social Media Assistant</h2>
                    
                    <div class="card p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="social-persona" class="block text-sm font-bold mb-2">AI Persona</label>
                                <select id="social-persona" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    <option value="homebrewer">Enthousiaste Thuisbrouwer</option>
                                    <option value="pro_brewery">Professionele Brouwerij</option>
                                    <option value="sommelier">Mede Connaisseur / Sommelier</option>
                                </select>
                            </div>
                            <div>
                                <label for="social-platform" class="block text-sm font-bold mb-2">Platform</label>
                                <select id="social-platform" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                    <option value="instagram">Instagram Post</option>
                                    <option value="untappd_checkin">Untappd Check-in</option>
                                    <option value="untappd_description">Untappd Mead Description</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                             <label for="social-tweak" class="block text-sm font-bold mb-2">Tweak / Extra Instructie</label>
                             <textarea id="social-tweak" rows="2" placeholder="bv. 'Maak het grappig', 'Focus op de gebruikte honing', etc." class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
                        </div>
                    </div>

                    <div id="social-from-recipe-container">
                        <p class="text-sm font-bold text-center mb-2">Genereer op basis van geladen recept:</p>
                        <button id="regenerate-social-btn" class="w-full bg-app-action text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 btn">Regenerate Post from Recipe</button>
                    </div>

                    <hr class="my-8 border-app">

                    <div id="social-from-manual-container">
                         <label for="manual-social-input" class="block text-sm font-bold mb-2">Of, genereer op basis van uw eigen tekst:</label>
                         <textarea id="manual-social-input" rows="4" placeholder="Typ hier uw onderwerp. Bv: 'Net mijn kersenmede gebotteld. Hij is prachtig helder met een dieprode kleur en ruikt fantastisch!'" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary"></textarea>
                         <button id="generate-manual-social-btn" class="w-full mt-4 bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 btn">Generate Post from Manual Input</button>
                    </div>
                    <div id="social-content-container" class="mt-8 border-t border-app pt-6">
                        <p class="text-center text-app-secondary/80">Load a recipe or type a topic to get started.</p>
                    </div>
                </div>
            </div>
          </div>

          <div id="settings-main-view" class="hidden">
            <button class="back-to-dashboard-btn mb-4 text-app-brand hover:underline no-print">&larr; Back to Dashboard</button>
            <div class="bg-app-secondary p-6 md:p-8 rounded-lg shadow-lg settings-panel overflow-y-auto" style="max-height: 80vh;">
                <h2 class="text-3xl font-header font-bold mb-6 text-center">Settings</h2>
                <div class="max-w-xl mx-auto">
                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">API Key</h3>
                        <label for="apiKeyInput" class="block text-lg font-bold mb-2">Google AI API Key</label>
                        <input type="password" id="apiKeyInput" placeholder="Enter your Google AI API key" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                        <p class="text-sm text-app-secondary mt-3">
                            The AI features of this app require a Google AI API key to function. Your key is saved securely to your user account and is never shared with anyone.
                        </p>
                        <p class="text-sm text-app-secondary mt-2">
                            You can get a free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-app-brand hover:underline font-semibold">Google AI Studio</a>.
                        </p>
                    </div>

                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">Personalization & Defaults</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="defaultBatchSizeInput" class="block text-lg font-bold mb-2">Default Batch Size (Liters)</label>
                                <input type="number" id="defaultBatchSizeInput" placeholder="e.g., 20" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                <p class="text-sm text-app-secondary mt-2">Set the default batch size that appears on the Creator tab.</p>
                            </div>
                            <div>
                                <label for="defaultCurrencyInput" class="block text-lg font-bold mb-2">Currency Symbol</label>
                                <input type="text" id="defaultCurrencyInput" placeholder="e.g., $" class="w-full p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                                 <p class="text-sm text-app-secondary mt-2">Set the currency symbol used for cost calculations.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 card p-6 rounded-lg">
                        <h3 class="text-xl font-header font-bold mb-4">User Interface</h3>
                        <div class="flex items-center justify-between">
                            <label class="text-lg font-bold">Theme</label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch" for="theme-toggle-checkbox">
                                    <input type="checkbox" id="theme-toggle-checkbox" />
                                    <div class="slider round"></div>
                                </label>
                            </div>
                        </div>
                    </div>
              
                    <button id="saveSettingsBtn" class="w-full mt-4 bg-blue-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 btn">Save Settings</button>
                    <div id="settingsMessage" class="text-center font-semibold mt-4 h-6"></div>

                    <div class="mt-10 p-6 rounded-lg border-2 border-red-400">
                        <h3 class="text-xl font-header font-bold mb-4 text-red-600">Data Management</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="exportHistoryBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 btn">Export Brew History</button>
                            <button id="exportInventoryBtn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 btn">Export Inventory</button>
                            <div>
                                <label for="importHistoryFile" class="w-full text-center block bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 cursor-pointer btn">Import Brew History</label>
                                <input type="file" id="importHistoryFile" class="hidden" accept=".json">
                            </div>
                             <div>
                                <label for="importInventoryFile" class="w-full text-center block bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 cursor-pointer btn">Import Inventory</label>
                                <input type="file" id="importInventoryFile" class="hidden" accept=".json">
                            </div>
                        </div>
                        <div class="space-y-4 mt-8 border-t-2 border-red-400 pt-4">
                            <p class="text-sm text-red-500 text-center">Warning: The following actions cannot be undone.</p>
                            <button id="clearHistoryBtn" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 btn">Delete All Brew History</button>
                            <button id="clearInventoryBtn" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 btn">Delete All Inventory</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, deleteDoc, getDoc, setDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IIFE to create a private scope and avoid polluting the global namespace
        (function() {
            // --- App State ---
            let db, auth, userId;
            let brews = []; // Local cache of brews
            let inventory = []; // Local cache of inventory
            let equipmentProfiles = []; // Local cache of equipment profiles
            let cellar = [];    // Local cache of bottled batches
            let userSettings = {}; // Holds settings from Firestore
            let currentBrewDay = { brewId: null, checklist: {} }; // Holds the state for the current brew day
            let currentRecipeMarkdown = ''; // To hold the latest generated recipe markdown
            let currentWaterProfile = null; // To hold the fetched water data
            let costChart = null; // To hold the chart instance
            let fermChartInstance = null;
            let html5QrcodeScanner = null;

            // --- UI Elements ---
            const dashboardMainView = document.getElementById('dashboard-main-view');
            const creatorView = document.getElementById('creator-view');
            const brewingView = document.getElementById('brewing-view');
            const historyView = document.getElementById('history-view');
            const inventoryView = document.getElementById('inventory-view');
            const planningView = document.getElementById('planning-view');
            const financialsView = document.getElementById('financials-view');
            const socialView = document.getElementById('social-view');
            const troubleshootView = document.getElementById('troubleshoot-view');
            const calculatorsView = document.getElementById('calculators-view');
            const waterView = document.getElementById('water-view');
            const settingsView = document.getElementById('settings-main-view');
            
            const brewingMainView = document.getElementById('brewing-main-view');
            const managementMainView = document.getElementById('management-main-view');
            const toolsMainView = document.getElementById('tools-main-view');

            const styleSelect = document.getElementById('style');
            const fruitSection = document.getElementById('fruit-section');
            const spiceSection = document.getElementById('spice-section');
            const braggotSection = document.getElementById('braggot-section');
            const generateBtn = document.getElementById('generateBtn');
            const recipeOutput = document.getElementById('recipe-output');
            const brewDayContent = document.getElementById('brew-day-content');
            const historyList = document.getElementById('history-list');
            const historyDetailContainer = document.getElementById('history-detail-container');
            const historyListContainer = document.getElementById('history-list-container');
            const inventoryForm = document.getElementById('inventory-form');
            const inventoryList = document.getElementById('inventory-list');
            const fetchWaterProfileBtn = document.getElementById('fetchWaterProfileBtn');
            const getWaterAdviceBtn = document.getElementById('getWaterAdviceBtn');
            const getYeastAdviceBtn = document.getElementById('getYeastAdviceBtn');
            const waterSourceSelect = document.getElementById('waterSource');
            const manualWaterProfileDiv = document.getElementById('manualWaterProfile');
            const troubleshootBtn = document.getElementById('troubleshoot-btn');

            
            // Settings UI
            const apiKeyInput = document.getElementById('apiKeyInput');
            const defaultBatchSizeInput = document.getElementById('defaultBatchSizeInput');
            const defaultCurrencyInput = document.getElementById('defaultCurrencyInput');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const settingsMessage = document.getElementById('settingsMessage');
            const themeToggle = document.getElementById('theme-toggle-checkbox');
            const exportHistoryBtn = document.getElementById('exportHistoryBtn');
            const exportInventoryBtn = document.getElementById('exportInventoryBtn');
            const importHistoryFile = document.getElementById('importHistoryFile');
            const importInventoryFile = document.getElementById('importInventoryFile');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const clearInventoryBtn = document.getElementById('clearInventoryBtn');

            // Financials UI
            const calculateOverheadBtn = document.getElementById('calculateOverheadBtn');

            // --- NIEUW: Label Generator UI ---
            const labelsView = document.getElementById('labels-view');
            // --- NIEUW: Data voor label formaten ---
            const labelFormats = {
                'herma_10730': { name: 'Herma 10730', width_mm: 99.1, height_mm: 139, cols: 2, rows: 2, top_margin_mm: 10, left_margin_mm: 5.45 },
                'avery_l7165': { name: 'Avery L7165', width_mm: 99.1, height_mm: 67.7, cols: 2, rows: 4, top_margin_mm: 11.1, left_margin_mm: 5.45 },
            };
            const logoUploadInput = document.getElementById('logoUpload');
            const labelPreview = document.getElementById('label-preview');
            
            // --- Initialization ---
            function initApp() {
                // Your web app's Firebase configuration
                const firebaseConfig = {
                  apiKey: "AIzaSyAhOOrwJCYve5XTGS6oXvhCg_l3_LcK00I",
                  authDomain: "meandery-aa05e.firebaseapp.com",
                  projectId: "meandery-aa05e",
                  storageBucket: "meandery-aa05e.appspot.com",
                  messagingSenderId: "388311971225",
                  appId: "1:388311971225:web:e5b0e81ce18d96b4a88f08",
                  measurementId: "G-S5CPLP80XT"
                };

                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            loadHistory();
                            loadInventory();
                            loadEquipmentProfiles();
                            loadCellar();
                            loadUserSettings(); // Load settings from Firestore
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Anonymous authentication failed:", error);
                                recipeOutput.innerHTML = `<p class="text-red-500">Could not connect to the database. History & Inventory will not be available.</p>`;
                            }
                        }
                    });
                } catch (e) {
                    console.error("Firebase initialization failed. App will run in offline mode.", e);
                    recipeOutput.innerHTML = `<p class="text-orange-600 font-bold">Running in offline mode. History and Inventory are disabled.</p>`;
                }


                // --- Event Listeners ---
                document.querySelectorAll('.main-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => switchMainView(btn.dataset.view));
                });
                document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => {
                    btn.addEventListener('click', () => switchMainView('dashboard'));
                });
                document.querySelectorAll('.sub-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const parentId = e.target.closest('[id$="-main-view"]').id;
                        switchSubView(e.target.id.replace('-sub-tab', ''), parentId);
                    });
                });

                styleSelect.addEventListener('change', handleStyleChange);
                generateBtn.addEventListener('click', generateRecipe);
                inventoryForm.addEventListener('submit', addInventoryItem);
                document.getElementById('equipment-profile-form').addEventListener('submit', addEquipmentProfile);
                document.getElementById('equipProfileType').addEventListener('change', handleEquipmentTypeChange);
                document.getElementById('bottling-form').addEventListener('submit', bottleBatch);
                document.getElementById('scan-barcode-btn').addEventListener('click', startScanner);
                document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
                document.getElementById('useInventory').addEventListener('change', (e) => {
                    document.getElementById('budget-section').classList.toggle('hidden', !e.target.checked);
                });
                document.getElementById('useBudget').addEventListener('change', (e) => {
                    document.getElementById('budget-input-container').classList.toggle('hidden', !e.target.checked);
                });

                // Calculator buttons
                document.getElementById('calcAbvBtn').addEventListener('click', calculateABV);
                document.getElementById('correctSgBtn').addEventListener('click', correctHydrometer);
                document.getElementById('calcSugarBtn').addEventListener('click', calculatePrimingSugar);
                document.getElementById('calcBlendBtn').addEventListener('click', calculateBlend);
                getYeastAdviceBtn.addEventListener('click', getYeastAdvice);

                // Manual social post button
                document.getElementById('generate-manual-social-btn').addEventListener('click', runManualSocialMediaGenerator);
                
                // Water tab buttons
                fetchWaterProfileBtn.addEventListener('click', fetchWaterProfile);
                waterSourceSelect.addEventListener('change', handleWaterSourceChange);
                getWaterAdviceBtn.addEventListener('click', getWaterAdvice);

                // Settings
                saveSettingsBtn.addEventListener('click', saveUserSettings);
                themeToggle.addEventListener('change', (e) => applyTheme(e.target.checked ? 'dark' : 'light'));
                exportHistoryBtn.addEventListener('click', exportHistory);
                exportInventoryBtn.addEventListener('click', exportInventory);
                importHistoryFile.addEventListener('change', importHistory);
                importInventoryFile.addEventListener('change', importInventory);
                clearHistoryBtn.addEventListener('click', clearHistory);
                clearInventoryBtn.addEventListener('click', clearInventory);

                // Financials
                calculateOverheadBtn.addEventListener('click', calculateOverhead);
                
                // Troubleshoot
                troubleshootBtn.addEventListener('click', getTroubleshootingAdvice);
                
                // Label Generator Listeners
                document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
                document.querySelectorAll('.label-style-btn').forEach(btn => btn.addEventListener('click', () => switchLabelStyle(btn.dataset.style)));
                document.getElementById('generate-print-btn').addEventListener('click', generatePrintPage);
                ['labelName', 'labelStyle', 'labelAbv', 'labelVol', 'labelDate'].forEach(id => {
                    document.getElementById(id).addEventListener('keyup', updateLabelPreview);
                }); // <-- DEZE AFSLUITING ONTBRAK

                // Listener voor label formaat dropdown
                document.getElementById('labelFormatSelect').addEventListener('change', (e) => {
                    document.getElementById('custom-format-inputs').classList.toggle('hidden', e.target.value !== 'custom');
                    updateLabelPreview();
                });


                handleStyleChange();
            }

            // --- View Management ---
            function switchMainView(viewName) {
                if (window.hideBottlingModal) hideBottlingModal();
                
                [dashboardMainView, brewingMainView, managementMainView, toolsMainView, settingsView].forEach(v => v.classList.add('hidden'));
                
                const viewToShow = document.getElementById(`${viewName}-main-view`);

                if (viewToShow) {
                    viewToShow.classList.remove('hidden');

                    // --- DE FIX ---
                    // Wanneer we naar de 'Brewing' sectie gaan, vullen we voor de zekerheid
                    // de equipment dropdown met de meest recente data die we lokaal hebben.
                    if (viewName === 'brewing') {
                        populateEquipmentProfilesDropdown();
                    }
                }
            }

            function switchSubView(viewName, parentViewId) {
                const parentView = document.getElementById(parentViewId);
                // Hide all sub-views within this parent
                parentView.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
                // Deactivate all sub-tabs within this parent
                parentView.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));

                const viewToShow = document.getElementById(`${viewName}-view`);
                const tabToActivate = document.getElementById(`${viewName}-sub-tab`);

                if (viewName === 'creator') { // <-- VOEG DEZE IF-STATEMENT TOE
                    populateEquipmentProfilesDropdown();
                } 

                if (viewToShow) viewToShow.classList.remove('hidden');
                if (tabToActivate) tabToActivate.classList.add('active');
            }


            function handleStyleChange() {
                const selectedStyle = styleSelect.value;
                fruitSection.classList.toggle('hidden', selectedStyle !== 'melomel');
                spiceSection.classList.toggle('hidden', selectedStyle !== 'metheglin');
                braggotSection.classList.toggle('hidden', selectedStyle !== 'braggot');
            }

            // --- Settings Management (Firebase) ---
            async function loadUserSettings() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');
                
                try {
                    const docSnap = await getDoc(settingsDocRef);
                    if (docSnap.exists()) {
                        userSettings = docSnap.data();
                        currentBrewDay = userSettings.currentBrewDay || { brewId: null, checklist: {} };
                        if(currentBrewDay.brewId) {
                           renderBrewDay(currentBrewDay.brewId);
                        }
                    } else {
                        // Apply default settings if none exist
                        userSettings = { apiKey: '', defaultBatchSize: 5, currencySymbol: '€', theme: 'light' };
                    }
                    applySettings();
                } catch (error) {
                    console.error("Error loading user settings:", error);
                }
            }
            
            function applySettings() {
                // Apply settings to the UI
                apiKeyInput.value = userSettings.apiKey || '';
                
                // --- FIX: Check if the element exists before changing it ---
                const batchSizeInput = document.getElementById('batchSize');
                if (batchSizeInput) {
                    batchSizeInput.value = userSettings.defaultBatchSize || 5;
                }
                
                defaultBatchSizeInput.value = userSettings.defaultBatchSize || 5;
                defaultCurrencyInput.value = userSettings.currencySymbol || '€';
                themeToggle.checked = (userSettings.theme === 'dark');
                
                const priceLabel = document.querySelector('label[for="itemPrice"]');
                if(priceLabel) {
                    priceLabel.textContent = `Price (${userSettings.currencySymbol || '€'})`;
                }
                
                applyTheme(userSettings.theme);
            }

            async function saveUserSettings() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'main');

                const newSettings = {
                    apiKey: apiKeyInput.value.trim(),
                    defaultBatchSize: parseFloat(defaultBatchSizeInput.value) || 5,
                    currencySymbol: defaultCurrencyInput.value.trim() || '€',
                    theme: themeToggle.checked ? 'dark' : 'light',
                    currentBrewDay: currentBrewDay // Persist brew day state
                };

                try {
                    await setDoc(settingsDocRef, newSettings, { merge: true });
                    userSettings = newSettings; // Update local state
                    applySettings(); // Re-apply settings to UI
                    settingsMessage.textContent = 'Settings saved successfully!';
                    settingsMessage.style.color = 'var(--success-color)';
                    setTimeout(() => { settingsMessage.textContent = ''; }, 3000);
                } catch (error) {
                    console.error("Error saving settings:", error);
                    settingsMessage.textContent = 'Failed to save settings.';
                    settingsMessage.style.color = 'var(--danger-color)';
                    setTimeout(() => { settingsMessage.textContent = ''; }, 3000);
                }
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // --- Data Management Functions ---
            function exportData(data, filename) {
                const dataToExport = data.map(item => {
                    const newItem = {...item};
                    // Convert Firestore Timestamps to a serializable format
                    if (newItem.createdAt && typeof newItem.createdAt.toDate === 'function') {
                        newItem.createdAt = newItem.createdAt.toDate().toISOString();
                    }
                    return newItem;
                });
                const jsonStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportHistory() {
                exportData(brews, 'meandery_history_export.json');
            }

            function exportInventory() {
                exportData(inventory, 'meandery_inventory_export.json');
            }

            function importData(event, collectionName) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error("Invalid JSON format. Expected an array.");

                        if (!confirm(`This will OVERWRITE your current ${collectionName}. This cannot be undone. Are you sure?`)) return;

                        settingsMessage.textContent = `Importing ${collectionName}...`;
                        settingsMessage.style.color = 'var(--info-color)';
                        const appId = 'meandery-aa05e';
                        const collectionRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
                        
                        // Clear existing data first
                        await clearCollection(collectionName, false); // false to suppress confirmation

                        // Batch write new data
                        const batch = writeBatch(db);
                        data.forEach(item => {
                            const { id, ...itemData } = item; // remove id if it exists from export
                            // Convert ISO string date back to Firestore Timestamp object
                            if (itemData.createdAt && typeof itemData.createdAt === 'string') {
                                itemData.createdAt = new Date(itemData.createdAt);
                            }
                            const newDocRef = doc(collectionRef);
                            batch.set(newDocRef, itemData);
                        });
                        await batch.commit();
                        settingsMessage.textContent = `${collectionName} imported successfully!`;
                        settingsMessage.style.color = 'var(--success-color)';
                    } catch (error) {
                        console.error(`Error importing ${collectionName}:`, error);
                        settingsMessage.textContent = `Error: ${error.message}`;
                        settingsMessage.style.color = 'var(--danger-color)';
                    } finally {
                        setTimeout(() => { settingsMessage.textContent = ''; }, 5000);
                        event.target.value = ''; // Reset file input
                    }
                };
                reader.readAsText(file);
            }

            function importHistory(e) {
                importData(e, 'brews');
            }

            function importInventory(e) {
                importData(e, 'inventory');
            }

            async function clearCollection(collectionName, confirmFirst = true) {
                if (confirmFirst && !confirm(`DANGER: This will permanently delete all your ${collectionName}. This cannot be undone. Are you sure?`)) {
                    return false;
                }
                if (!userId) return false;
                const appId = 'meandery-aa05e';
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
                const snapshot = await getDocs(collectionRef);
                if (snapshot.empty) return true; // Nothing to delete
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                return true;
            }

            async function clearHistory() {
                if (await clearCollection('brews')) {
                    settingsMessage.textContent = 'Brew history cleared.';
                    settingsMessage.style.color = 'var(--success-color)';
                    setTimeout(() => { settingsMessage.textContent = ''; }, 3000);
                }
            }
            
            async function clearInventory() {
                if (await clearCollection('inventory')) {
                    settingsMessage.textContent = 'Inventory cleared.';
                    settingsMessage.style.color = 'var(--success-color)';
                    setTimeout(() => { settingsMessage.textContent = ''; }, 3000);
                }
            }


            // --- Core AI Functions ---
            async function performApiCall(prompt) {
                // Haal de API key op die de gebruiker heeft ingevoerd in de instellingen.
                const apiKey = userSettings.apiKey;

                // --- NIEUW: Controleer of er wel een sleutel is ---
                if (!apiKey) {
                    throw new Error("Please enter your Google AI API key in the Settings page first.");
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            }

            // DEFINITIEVE FUNCTIE OM RECEPTGEGEVENS TE PARSEN
            function parseRecipeData(markdown) {
                // Deze regel is voor debuggen. Het toont de volledige tekst van de AI in de browser console.
                console.log("AI Recipe Output:", markdown);

                const data = {};

                // Zoek de titel
                const titleMatch = markdown.match(/^#\s*(.*)/m);
                if (titleMatch && titleMatch[1]) {
                    data.recipeName = titleMatch[1].trim();
                }

                // Zoek Target OG
                const ogMatch = markdown.match(/(?:Target OG|Original Gravity|Start SG|O\.G\.)[\s\w:]*(\d\.\d{3})/i);
                if (ogMatch && ogMatch[1]) {
                    data.targetOG = ogMatch[1];
                }

                // Zoek Target FG
                const fgMatch = markdown.match(/(?:Target FG|Final Gravity|Eind SG|F\.G\.)[\s\w:]*(\d\.\d{3})/i);
                if (fgMatch && fgMatch[1]) {
                    data.targetFG = fgMatch[1];
                }

                // DEFINITIEVE, VEREENVOUDIGDE ZOEKTOCHT NAAR TARGET ABV
                // Dit patroon zoekt nu heel direct naar "keyword: getal".
                const abvMatch = markdown.match(/(?:Target ABV|ABV|Alcoholpercentage):\s*([\d.,]+)/i);
                if (abvMatch && abvMatch[1]) {
                    // Stap 1: Pak het getal (bv. "12.5")
                    const abvValue = abvMatch[1];
                    // Stap 2: Voeg het '%' symbool toe en vul het in
                    data.targetABV = `${abvValue}%`;
                }

                return data;
            }

                async function generateRecipe() {
                recipeOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Consulting the Alchemist... your custom recipe is being crafted.</p>';
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const prompt = buildPrompt();
                    if (!prompt) { // Foutcontrole toegevoegd
                        throw new Error("Could not build the prompt. A required input field might be missing.");
                    }
                    currentRecipeMarkdown = await performApiCall(prompt);
                    
                    const recipeHtml = marked.parse(currentRecipeMarkdown);
                    const parsedData = parseRecipeData(currentRecipeMarkdown);
                    
                    const fullHtml = `
                        <div class="print-button-container text-right mb-4 flex justify-end gap-2 no-print">
                            <button onclick="window.printEmptyLog()" class="bg-stone-500 text-white py-2 px-4 rounded-lg hover:bg-stone-600 transition-colors btn">
                                Print Empty Log
                            </button>
                            <button onclick="window.print()" class="bg-stone-600 text-white py-2 px-4 rounded-lg hover:bg-stone-700 transition-colors btn">
                                Print Recipe & Log
                            </button>
                        </div>
                        <div class="recipe-content">${recipeHtml}</div>
                        <div class="mt-6 no-print">
                            <button id="saveBtn" class="w-full bg-green-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-800 transition-colors btn">
                                Save to Brew History
                            </button>
                        </div>
                        ${getBrewLogHtml(parsedData, 'new')}
                    `;
                    recipeOutput.innerHTML = fullHtml;
                    document.getElementById('saveBtn').addEventListener('click', saveBrewToHistory);

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    recipeOutput.innerHTML = `<p class="text-center text-red-600 font-bold">Sorry, the Alchemist is busy. Please try again.</p><p class="text-center text-sm text-app-secondary/80">${error.message}</p>`;
                } finally {
                    // Deze 'finally' block zorgt ervoor dat de knop altijd weer werkt, ook na een fout.
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }           

            function buildPrompt() {
                // Helper function to safely get values from elements that might not exist in the DOM yet.
                function getValue(id, defaultValue = '') {
                    const element = document.getElementById(id);
                    if (!element) return defaultValue;
                    if (element.type === 'checkbox') return element.checked;
                    if (element.tagName === 'SELECT') return element.selectedOptions[0] ? element.selectedOptions[0].text : defaultValue;
                    return element.value || defaultValue;
                }

                try {
                    const customDescription = getValue('customDescription');
                    const batchSize = getValue('batchSize', '5');
                    const useInventory = getValue('useInventory', false);
                    const nutrientProtocol = getValue('nutrientProtocol', 'Standard Staggered');
                    
                    let prompt;
                    const personaAndConstraints = `You are an expert mead maker named "The MEA(N)DERY Alchemist". All ingredients you recommend (especially yeast strains, honey types, and special adjuncts) must be readily available in Belgium or through common European homebrew suppliers.`;
                    const waterProfilesForPrompt = `
            - Spa Reine: Ca 5, Mg 2, Na 3, SO4 4, Cl 5, HCO3 17
            - Chaudfontaine: Ca 65, Mg 18, Na 44, SO4 40, Cl 35, HCO3 305
            - Valvert: Ca 68, Mg 2, Na 2, SO4 18, Cl 4, HCO3 204
            - Bru: Ca 23, Mg 22, Na 8, SO4 5, Cl 4, HCO3 209
            - Villers: Ca 106, Mg 11, Na 8, SO4 49, Cl 20, HCO3 340`;

                    let equipmentPrompt = '';
                    const selectedProfileId = getValue('equipmentProfileSelect');
                    if (selectedProfileId) {
                        const profile = equipmentProfiles.find(p => p.id === selectedProfileId);
                        if (profile) {
                            equipmentPrompt = `
            CRUCIAL CONSTRAINT: The user is brewing with the "${profile.name}" equipment profile. You MUST adjust the recipe to account for the following losses to ensure the FINAL batch size in the fermenter is exactly ${batchSize} liters.
            - Trub/Yeast Loss: ${profile.trubLossLiters} L (This is loss in the fermenter, so you must add this volume to the starting volume).
            - Boil-Off Rate: ${profile.boilOffRateLitersPerHour} L/hour (This only applies if the recipe requires boiling, like for a braggot. You must calculate the total boil volume loss and add it to the starting water volume).
            In the 'Instructions', explicitly state the calculated starting water volume. For example: "Start with 12.5 liters of water to account for boil-off and trub loss."
                            `;
                        }
                    }

                    if (customDescription.trim() !== '') {
                        prompt = `${personaAndConstraints} ${equipmentPrompt} A user wants to create a unique mead from scratch. Their primary instruction is a text description. You MUST prioritize this description to generate the recipe. Any other form fields should be IGNORED, except for the Batch Size. The user's description is: "${customDescription}" The recipe must be for a ${batchSize}-liter batch. Based ONLY on the user's description and the batch size, create a detailed, world-class mead recipe. Infer the style, ABV, sweetness, honey type, and other ingredients from their text. If they don't specify something like ABV, make an expert recommendation that fits their description.`;
                    } else if (useInventory) {
                        const currency = userSettings.currencySymbol || '€';
                        const useBudget = getValue('useBudget', false);
                        const maxBudget = getValue('maxBudget');

                        const inventoryString = inventory.map(item => {
                            let costPerUnit = 0;
                            let baseUnit = item.unit;
                            if (item.qty > 0 && item.price > 0) { costPerUnit = item.price / item.qty; }
                            if (item.unit === 'kg') { costPerUnit /= 1000; baseUnit = 'g'; } 
                            else if (item.unit === 'L') { costPerUnit /= 1000; baseUnit = 'ml'; }
                            return `${item.name}: ${item.qty} ${item.unit} available (Cost: ${costPerUnit.toFixed(2)} ${currency}/${baseUnit})`;
                        }).join('; ');

                        prompt = `${personaAndConstraints} ${equipmentPrompt} A user wants you to create a recipe using ingredients they already have in stock. Their inventory is: [${inventoryString}]. 
                        
                        Use the following parameters as a creative brief:
                        - Batch Size: ${batchSize} liters
                        - Target ABV: Approximately ${getValue('abv', '12')}%
                        - Desired Final Sweetness: ${getValue('sweetness', 'Semi-Sweet')}
                        - Overall Style Inspiration: ${getValue('style', 'Traditional')}`;
                        
                        if (useBudget && maxBudget) {
                            prompt += `\n\nCRUCIAL CONSTRAINT: The total cost of the ingredients for this recipe MUST NOT EXCEED ${maxBudget} ${currency}. You must use the provided ingredient costs to calculate this and stay within budget. In the Brewer's Notes, briefly state the calculated total cost of the recipe.`;
                        }

                        prompt += `\n\nYour primary goal is to create the best possible recipe that uses the available ingredients. If the inventory is insufficient to make a good recipe matching the style, state that clearly in the Brewer's Notes and list the essential ingredients the user needs to buy.`;
                    
                    } else {
                        const style = getValue('style', 'Traditional');
                        prompt = `${personaAndConstraints} ${equipmentPrompt} Create a detailed, world-class mead recipe from scratch based on the following structured options:
                        - Batch Size: ${batchSize} liters
                        - Target ABV: Approximately ${getValue('abv', '12')}%
                        - Desired Final Sweetness: ${getValue('sweetness', 'Semi-Sweet')}
                        - Overall Style Inspiration: ${style}
                        - Primary Honey: ${getValue('honeyVariety', 'Wildflower')} honey`;

                        if (style.includes('Melomel')) {
                            const fruits = Array.from(document.querySelectorAll('#fruit-section input:checked')).map(el => el.labels[0].innerText);
                            prompt += `\n- Featured Fruits: ${fruits.length > 0 ? fruits.join(', ') : 'Please suggest a classic fruit combination.'}`;
                        } else if (style.includes('Metheglin')) {
                            const spices = Array.from(document.querySelectorAll('#spice-section input:checked')).map(el => el.labels[0].innerText);
                            prompt += `\n- Featured Spices: ${spices.length > 0 ? spices.join(', ') : 'Please suggest a classic spice blend.'}`;
                        } else if (style.includes('Braggot')) {
                            prompt += `\n- Braggot Base: Based on a ${getValue('braggotStyle', 'Belgian Blond')} style. Provide an extract-based recipe.`;
                        }
                        if (getValue('addOak', false)) {
                            prompt += '\n- Oak Aging: The recipe must include a step for aging with oak.';
                        }
                        const specialIngredients = getValue('specialIngredients');
                        if (specialIngredients && specialIngredients.trim() !== '') {
                            prompt += `\n- Special Ingredients: The recipe must creatively incorporate: ${specialIngredients}.`;
                        }
                    }
                    prompt += `\n\nFor the final output, generate a full recipe. It must be suitable for an experienced homebrewer. It must use the "${nutrientProtocol}" nutrient schedule. Provide specific ingredient quantities scaled for the batch size. Detail a no-heat method for must preparation. Include recommendations for a specific yeast strain. Give advice on aging. For the 'Ingredients' section, you MUST format it as a Markdown table with columns: | Ingredient | Quantity | Unit |. This is essential. If applicable, provide carbonation targets and priming sugar amounts. Format the rest of the response in Markdown with a creative title and clear headings for 'Description', 'Ingredients', 'Instructions', and 'Brewer's Notes'.

            You MUST explicitly state the Target OG, Target FG, and Target ABV in the description, for example: 'Target OG: 1.110, Target FG: 1.015, Target ABV: 12.5%'. This is a mandatory part of the output.

            Finally, after the 'Brewer's Notes', add a new heading '## Recommended Water'. Based on the style of the mead recipe you just generated (e.g., dry, sweet, fruity, dark), recommend ONE of the following Belgian bottled waters and briefly explain in 1-2 sentences WHY it is a good choice. Available Belgian Bottled Waters (minerals in mg/L) are: ${waterProfilesForPrompt}.`;
                    
                    return prompt;
                } catch (error) {
                    console.error("Error building prompt:", error);
                    // Geef een duidelijke foutmelding terug die de `generateRecipe` functie kan tonen.
                    throw new Error(`Failed to build the prompt. This can happen if the 'Creator' tab is not fully loaded. Please try again. (Details: ${error.message})`);
                }
            }
            
            // --- Firestore & History Functions ---
            async function saveBrewToHistory() {
                if (!userId || !currentRecipeMarkdown) {
                    console.error("Cannot save. No user identified or no recipe generated.");
                    return;
                }
                const saveButton = document.getElementById('saveBtn');
                saveButton.textContent = 'Saving...';
                saveButton.disabled = true;

                const logData = getLogDataFromDOM('recipe-output');
                const batchSize = parseFloat(document.getElementById('batchSize').value) || 5;

                const brewData = {
                    userId: userId,
                    recipeName: logData.recipeName || "Untitled Brew",
                    recipeMarkdown: currentRecipeMarkdown,
                    logData: logData,
                    createdAt: new Date(),
                    batchSize: batchSize,
                    totalCost: parseIngredientsAndCalculateCost(currentRecipeMarkdown, inventory, batchSize)
                };

                try {
                    const appId = 'meandery-aa05e';
                    const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
                    const docRef = await addDoc(brewsCol, brewData);
                    
                    // Add a button to start brew day right after saving
                    const startBrewDayBtn = document.createElement('button');
                    startBrewDayBtn.textContent = 'Start Brew Day';
                    startBrewDayBtn.className = 'w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors btn';
                    startBrewDayBtn.onclick = () => startBrewDay(docRef.id);
                    saveButton.parentElement.appendChild(startBrewDayBtn);

                    saveButton.textContent = 'Saved!';
                    saveButton.classList.replace('bg-green-700', 'bg-gray-500');
                } catch (error) {
                    console.error("Error saving brew:", error);
                    saveButton.textContent = 'Save to Brew History';
                    saveButton.disabled = false;
                }
            }

            function loadHistory() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
                const q = query(brewsCol);

                onSnapshot(q, (snapshot) => {
                    brews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    brews.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()); // Sort newest first
                    renderHistoryList();
                    updateCostAnalysis();
                    renderActiveBrewTimeline();
                    updateNextActionWidget();
                }, (error) => {
                    console.error("Error loading history: ", error);
                    historyList.innerHTML = `<p class="text-red-500">Could not load brew history.</p>`;
                });
            }

            function renderHistoryList() {
                if (brews.length === 0) {
                    historyList.innerHTML = `<p class="text-center text-app-secondary/80">You haven't saved any brews yet. Go create one!</p>`;
                    return;
                }
                historyList.innerHTML = brews.map(brew => `
                    <div class="p-4 card rounded-lg cursor-pointer hover:bg-app-primary" onclick="window.showBrewDetail('${brew.id}')">
                        <h4 class="font-bold text-lg font-header">${brew.recipeName || 'Untitled Brew'}</h4>
                        <p class="text-sm text-app-secondary/80">Saved on: ${brew.createdAt.toDate().toLocaleDateString()}</p>
                    </div>
                `).join('');
            }

            window.showBrewDetail = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const recipeHtml = marked.parse(brew.recipeMarkdown);
                const logHtml = getBrewLogHtml(brew.logData, brew.id);
                const currency = userSettings.currencySymbol || '€';
                
                let costHtml = '';
                if (brew.totalCost !== undefined && brew.totalCost > 0) {
                    const bottles = brew.batchSize / 0.75; // Assuming 750ml bottles
                    const costPerBottle = brew.totalCost / bottles;
                    costHtml = `
                        <div class="mt-6 p-4 bg-amber-50 rounded-lg dark:bg-opacity-10">
                            <h3 class="font-header text-lg text-stone-800 dark:text-amber-200">Batch Cost Analysis</h3>
                            <p class="text-stone-800 dark:text-amber-200"><strong>Total Batch Cost:</strong> ${currency}${brew.totalCost.toFixed(2)}</p>
                            <p class="text-stone-800 dark:text-amber-200"><strong>Cost Per 750ml Bottle:</strong> ${currency}${costPerBottle.toFixed(2)}</p>
                        </div>
                    `;
                }

                historyDetailContainer.innerHTML = `
                    <button onclick="window.goBackToHistoryList()" class="mb-4 text-app-brand hover:underline no-print">&larr; Back to History</button>
                    <div class="print-button-container text-right mb-4 flex flex-wrap justify-end gap-2 no-print">
                        <button onclick="window.cloneBrew('${brew.id}')" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors btn flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                            Clone Recipe
                        </button>
                        <button onclick="window.startBrewDay('${brew.id}')" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors btn">Start New Batch</button>
                        <button onclick="window.generateShoppingList('${brew.id}')" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn">Shopping List</button>
                        <button onclick="window.generateSocialContent('${brew.id}')" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors btn">Social Post</button>
                        <button onclick="window.showBottlingModal('${brew.id}')" class="bg-amber-600 text-white py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors btn">Bottle Batch</button>
                    </div>
                    <div class="recipe-content">${recipeHtml}</div>
                    ${costHtml}

                    <div class="mt-6 card p-4 rounded-lg">
                        <h3 class="font-header text-lg text-center">Fermentation Progress</h3>
                        <canvas id="fermChart-${brew.id}"></canvas>
                    </div>
                    ${logHtml}
                    <div id="log-update-message-${brew.id}" class="text-center text-blue-700 font-semibold mt-4 h-6"></div>
                    <div class="mt-2 flex flex-col md:flex-row gap-4 no-print">
                        <button onclick="window.updateBrewLog('${brew.id}')" class="flex-1 bg-blue-700 text-white py-3 px-4 rounded-lg hover:bg-blue-800 transition-colors btn">
                            Save Log Changes
                        </button>
                        <button onclick="window.tweakRecipe('${brew.id}')" class="flex-1 bg-purple-700 text-white py-3 px-4 rounded-lg hover:bg-purple-800 transition-colors btn">
                            Tweak from Tasting Notes
                        </button>
                        <button id="scale-recipe-btn-${brew.id}" onclick="window.toggleScaleUI('${brew.id}')" class="flex-1 bg-teal-700 text-white py-3 px-4 rounded-lg hover:bg-teal-800 transition-colors btn">
                            Scale Recipe
                        </button>
                    </div>
                    <div id="scale-ui-${brew.id}" class="hidden mt-4 p-4 card no-print">
                        <label for="new-batch-size-${brew.id}" class="block font-bold">New Batch Size (Liters):</label>
                        <input type="number" id="new-batch-size-${brew.id}" class="w-full p-2 border rounded mt-2 text-app-primary bg-app-tertiary border-app" placeholder="e.g., 20">
                        <button onclick="window.scaleRecipe('${brew.id}')" class="w-full mt-2 bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 btn">Generate Scaled Recipe</button>
                    </div>

                    <!-- START: Advanced AI Tweaks Section -->
                    <div class="mt-6 pt-4 border-t-2 border-app-brand no-print">
                        <h3 class="text-2xl font-header font-bold text-center mb-4">Advanced AI Adjustments</h3>
                        <div class="card p-4 rounded-lg">
                            <h4 class="font-bold mb-3 text-app-secondary">Quick Tweaks</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                                <button onclick="window.quickTweakRecipe('${brew.id}', 'make_dryer')" class="text-sm bg-stone-500 text-white py-2 px-3 rounded-lg hover:bg-stone-600 btn">Make Dryer</button>
                                <button onclick="window.quickTweakRecipe('${brew.id}', 'increase_abv')" class="text-sm bg-stone-500 text-white py-2 px-3 rounded-lg hover:bg-stone-600 btn">Increase ABV by 2%</button>
                                <button onclick="window.quickTweakRecipe('${brew.id}', 'add_oak')" class="text-sm bg-stone-500 text-white py-2 px-3 rounded-lg hover:bg-stone-600 btn">Add Light Oak</button>
                            </div>
                            <h4 class="font-bold mb-2 mt-4 text-app-secondary">Ingredient Swapper</h4>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="ingredient-swap-input-${brew.id}" class="flex-grow p-2 border rounded-md bg-app-tertiary border-app text-app-primary" placeholder="e.g., Replace Acacia Honey with Forest Honey">
                                <button onclick="window.swapIngredient('${brew.id}')" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 btn">Swap</button>
                            </div>
                        </div>
                    </div>
                    <!-- END: Advanced AI Tweaks Section -->

                    <div id="tweak-output-${brew.id}" class="mt-6"></div>
                `;
                historyListContainer.classList.add('hidden');
                historyDetailContainer.classList.remove('hidden');

                renderFermentationGraph(brewId);
            }
            
            window.toggleScaleUI = function(brewId) {
                const scaleUI = document.getElementById(`scale-ui-${brew.id}`);
                scaleUI.classList.toggle('hidden');
            }
            
            window.scaleRecipe = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                const newSize = document.getElementById(`new-batch-size-${brew.id}`).value;
                if (!brew || !newSize || isNaN(parseFloat(newSize))) {
                    console.error("Invalid new batch size.");
                    return;
                }

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">The Alchemist is scaling your recipe...</p>';

                const prompt = `You are an expert mead maker. Take the following mead recipe and scale it to a new batch size of ${newSize} liters. Adjust all ingredient quantities proportionally. Keep the instructions and brewer's notes the same, but update any references to volume. Format the response in Markdown, making sure the ingredients list is a Markdown table with columns: | Ingredient | Quantity | Unit |. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;
                
                try {
                    const scaledMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 border-t-2 border-teal-700">${marked.parse(scaledMarkdown)}</div>`;
                } catch (error) {
                    console.error("Error scaling recipe:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not scale the recipe: ${error.message}</p>`;
                }
            }

            window.cloneBrew = async function(brewId) {
                const originalBrew = brews.find(b => b.id === brewId);
                if (!originalBrew) {
                    alert("Could not find the original recipe to clone.");
                    return;
                }

                // Create a copy of the logbook and reset the values for a new start
                const newLogData = JSON.parse(JSON.stringify(originalBrew.logData));
                newLogData.brewDate = '';
                newLogData.actualOG = '';
                newLogData.actualFG = '';
                newLogData.finalABV = '';
                newLogData.fermentationLog = Array.from({ length: 8 }, () => ({ date: '', temp: '', sg: '', notes: '' }));
                newLogData.agingNotes = '';
                newLogData.bottlingNotes = '';
                newLogData.tastingNotes = '';
                
                const newBrewData = {
                    userId: userId,
                    recipeName: `Clone of ${originalBrew.recipeName}`,
                    recipeMarkdown: originalBrew.recipeMarkdown,
                    logData: newLogData,
                    createdAt: new Date(),
                    batchSize: originalBrew.batchSize,
                    totalCost: originalBrew.totalCost, // Copy cost for reference
                    isBottled: false // Ensure it's not marked as bottled
                };

                try {
                    const appId = 'meandery-aa05e';
                    const brewsCol = collection(db, 'artifacts', appId, 'users', userId, 'brews');
                    await addDoc(brewsCol, newBrewData);
                    
                    alert(`'${newBrewData.recipeName}' has been created and is now at the top of your history.`);
                    goBackToHistoryList(); // Go back to the list where the clone is now at the top

                } catch (error) {
                    console.error("Error cloning brew:", error);
                    alert("An error occurred while cloning the recipe.");
                }
            }

            window.goBackToHistoryList = function() {
                historyDetailContainer.classList.add('hidden');
                historyListContainer.classList.remove('hidden');
            }
            
            window.updateBrewLog = async function(brewId) {
                 if (!userId || !brewId) return;
                 const logData = getLogDataFromDOM(`history-detail-container`);
                 const messageDiv = document.getElementById(`log-update-message-${brew.id}`);
                 try {
                    const appId = 'meandery-aa05e';
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, { logData: logData });
                    messageDiv.textContent = 'Log updated successfully!';
                 } catch(error) {
                    console.error("Error updating log:", error);
                    messageDiv.textContent = 'Failed to update log.';
                    messageDiv.classList.replace('text-blue-700', 'text-red-700');
                 } finally {
                    setTimeout(() => { 
                        messageDiv.textContent = ''; 
                        messageDiv.classList.replace('text-red-700', 'text-blue-700');
                    }, 3000);
                 }
            }
            
            window.tweakRecipe = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;
                
                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">The Alchemist is rethinking your recipe...</p>';

                const tastingNotes = document.getElementById(`tastingNotes-${brew.id}`).value;
                if (!tastingNotes.trim()) {
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Please enter some tasting notes before tweaking!</p>`;
                    return;
                }

                const prompt = `You are an expert mead maker. A user has brewed the following mead recipe:\n\n---\n${brew.recipeMarkdown}\n---\n\nThey have provided these tasting notes on the finished product: "${tastingNotes}".\n\nBased on their notes, provide specific suggestions for improvement and generate a new, revised recipe that addresses their feedback. Format the response in Markdown.`;

                try {
                    const tweakedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 border-t-2 border-amber-700">${marked.parse(tweakedMarkdown)}</div>`;
                } catch (error) {
                    console.error("Error tweaking recipe:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not get a tweaked recipe: ${error.message}</p>`;
                }
            }

            window.quickTweakRecipe = async function(brewId, tweakType) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Applying quick tweak...</p>';

                let tweakInstruction = '';
                switch (tweakType) {
                    case 'make_dryer':
                        tweakInstruction = "make the final mead dryer by adjusting the honey quantity or yeast choice to achieve a lower final gravity.";
                        break;
                    case 'increase_abv':
                        tweakInstruction = "increase the final ABV by approximately 2%. You must adjust the initial honey quantity to provide more fermentable sugar.";
                        break;
                    case 'add_oak':
                        tweakInstruction = "add a step for aging with a light touch of oak cubes or chips. Specify the type, amount, and contact time.";
                        break;
                    default:
                        tweakOutput.innerHTML = `<p class="text-center text-red-500">Unknown tweak type.</p>`;
                        return;
                }

                const prompt = `You are an expert mead maker. Take the following mead recipe and apply this specific modification: ${tweakInstruction}. You must generate the complete, updated recipe, including a regenerated ingredient table and instructions. Explain your changes briefly in the 'Brewer's Notes'. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;

                try {
                    const tweakedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 card rounded-lg">${marked.parse(tweakedMarkdown)}</div>`;
                } catch (error) {
                    console.error("Error during quick tweak:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not perform tweak: ${error.message}</p>`;
                }
            }

            window.swapIngredient = async function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const swapInput = document.getElementById(`ingredient-swap-input-${brew.id}`);
                const swapRequest = swapInput.value;
                if (!swapRequest.trim()) {
                    alert("Please describe the ingredient swap you want to make.");
                    return;
                }

                const tweakOutput = document.getElementById(`tweak-output-${brew.id}`);
                tweakOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Calculating ingredient swap...</p>';

                const prompt = `You are an expert mead maker. Take the following mead recipe. A user wants to make an ingredient substitution. Their request is: "${swapRequest}". 
                
                Please analyze this request. Adjust ingredient quantities if necessary (e.g., accounting for different sugar content in a new honey type). Modify the instructions where needed. In the 'Brewer's Notes', you MUST explain the likely impact of this swap on the final flavor profile. 
                
                Generate the complete, updated recipe with the swap integrated. Here is the original recipe:\n\n---\n${brew.recipeMarkdown}`;
                
                try {
                    const swappedMarkdown = await performApiCall(prompt);
                    tweakOutput.innerHTML = `<div class="mt-4 p-4 card rounded-lg">${marked.parse(swappedMarkdown)}</div>`;
                    swapInput.value = ''; // Clear input after successful swap
                } catch (error) {
                    console.error("Error swapping ingredient:", error);
                    tweakOutput.innerHTML = `<p class="text-center text-red-500">Could not perform swap: ${error.message}</p>`;
                }
            }
            
            // --- Inventory Functions ---
            async function addInventoryItem(e) {
                e.preventDefault();
                if (!userId) {
                    console.error("You must be logged in to manage inventory.");
                    return;
                }

                const name = document.getElementById('itemName').value;
                const qty = parseFloat(document.getElementById('itemQty').value);
                const unit = document.getElementById('itemUnit').value;
                const price = parseFloat(document.getElementById('itemPrice').value);
                const category = document.getElementById('itemCategory').value;

                if (!name || isNaN(qty) || isNaN(price)) {
                    console.error("Please fill out all fields correctly.");
                    return;
                }

                const itemData = { userId, name, qty, unit, price, category };
                
                try {
                    const appId = 'meandery-aa05e';
                    const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
                    await addDoc(invCol, itemData);
                    inventoryForm.reset();
                } catch (error) {
                    console.error("Error adding inventory item:", error);
                }
            }

            function loadInventory() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const invCol = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
                const q = query(invCol);

                onSnapshot(q, (snapshot) => {
                    inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInventory();
                    updateCostAnalysis();
                }, (error) => {
                    console.error("Error loading inventory: ", error);
                    inventoryList.innerHTML = `<p class="text-red-500">Could not load inventory.</p>`;
                });
            }

            window.renderInventory = function() { // <-- DEZE REGEL IS AANGEPAST
                const grouped = inventory.reduce((acc, item) => {
                    (acc[item.category] = acc[item.category] || []).push(item);
                    return acc;
                }, {});

                const categories = ['Honey', 'Yeast', 'Nutrient', 'Malt Extract', 'Fruit', 'Spice', 'Adjunct', 'Chemical'];
                const currency = userSettings.currencySymbol || '€';
                let html = '';

                for (const category of categories) {
                    if (grouped[category]) {
                        html += `<h3 class="text-xl font-header mt-4 mb-2">${category}</h3>`;
                        html += `<div class="space-y-2">`;
                        grouped[category].forEach(item => {
                            html += `<div id="item-${item.id}" class="flex justify-between items-center p-2 card rounded-md">
                                <span>${item.name}</span>
                                <div class="flex items-center gap-4">
                                    <span class="font-semibold">${item.qty} ${item.unit} - ${currency}${(item.price || 0).toFixed(2)}</span>
                                    <div class="flex gap-2">
                                        <button onclick="window.editInventoryItem('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                        <button onclick="window.deleteInventoryItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                    </div>
                                </div>
                            </div>`;
                        });
                        html += `</div>`;
                    }
                }
                
                if (inventory.length === 0) {
                    html = `<p class="text-center text-app-secondary/80">Your inventory is empty. Add your first ingredient!</p>`;
                }

                inventoryList.innerHTML = html;
            }

            window.deleteInventoryItem = async function(itemId) {
                if (!userId) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting item:", error);
                }
            }

            window.editInventoryItem = function(itemId) {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;

                const itemDiv = document.getElementById(`item-${itemId}`);
                itemDiv.innerHTML = `
                    <div class="w-full space-y-2">
                         <input type="text" id="edit-name-${itemId}" value="${item.name}" placeholder="Name" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                         <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="number" id="edit-qty-${itemId}" value="${item.qty}" placeholder="Qty" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="text" id="edit-unit-${itemId}" value="${item.unit}" placeholder="Unit" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-price-${itemId}" value="${(item.price || 0).toFixed(2)}" placeholder="Price" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary" step="0.01">
                            <div class="flex gap-2">
                                <button onclick="window.updateInventoryItem('${itemId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                                <button onclick="renderInventory()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            window.updateInventoryItem = async function(itemId) {
                if (!userId) return;
                const newName = document.getElementById(`edit-name-${itemId}`).value;
                const newQty = parseFloat(document.getElementById(`edit-qty-${itemId}`).value);
                const newUnit = document.getElementById(`edit-unit-${itemId}`).value;
                const newPrice = parseFloat(document.getElementById(`edit-price-${itemId}`).value);

                if (!newName || isNaN(newQty) || isNaN(newPrice)) {
                    console.error("Please provide a valid name, quantity, and price.");
                    return;
                }

                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemId);
                    await updateDoc(itemDocRef, { name: newName, qty: newQty, unit: newUnit, price: newPrice });
                } catch (error) {
                    console.error("Error updating item:", error);
                }
            }

            // --- Equipment Profile Functions ---
            async function addEquipmentProfile(e) {
                e.preventDefault();
                if (!userId) return;

                const name = document.getElementById('equipProfileName').value;
                const type = document.getElementById('equipProfileType').value;
                const capacityLiters = parseFloat(document.getElementById('equipCapacityLiters').value) || null;
                const trubLossLiters = parseFloat(document.getElementById('trubLossLiters').value) || 0;
                const boilOffRateLitersPerHour = (type === 'Kettle') ? parseFloat(document.getElementById('boilOffRateLitersPerHour').value) || 0 : 0;
                
                if (!name) {
                    alert("Profile Name is required.");
                    return;
                }

                const profileData = { userId, name, type, capacityLiters, trubLossLiters, boilOffRateLitersPerHour };
                
                try {
                    const appId = 'meandery-aa05e';
                    const equipCol = collection(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles');
                    await addDoc(equipCol, profileData);
                    document.getElementById('equipment-profile-form').reset();
                    handleEquipmentTypeChange(); // Reset visibility
                } catch (error) {
                    console.error("Error adding equipment profile:", error);
                }
            }

            function loadEquipmentProfiles() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const equipCol = collection(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles');
                const q = query(equipCol);

                onSnapshot(q, (snapshot) => {
                    equipmentProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEquipmentProfiles();
                    populateEquipmentProfilesDropdown();
                }, (error) => {
                    console.error("Error loading equipment profiles: ", error);
                    document.getElementById('equipment-profiles-list').innerHTML = `<p class="text-red-500">Could not load equipment profiles.</p>`;
                });
            }

            window.renderEquipmentProfiles = function() {
                const listDiv = document.getElementById('equipment-profiles-list');
                if (equipmentProfiles.length === 0) {
                    listDiv.innerHTML = `<p class="text-center text-app-secondary/80">You have no saved equipment profiles. Add one to get started!</p>`;
                    return;
                }
                
                listDiv.innerHTML = equipmentProfiles.map(p => `
                    <div id="equip-item-${p.id}" class="p-3 card rounded-md mb-2">
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="font-bold">${p.name} <span class="text-sm font-normal text-app-secondary/80">(${p.type})</span></p>
                                <p class="text-sm text-app-secondary">Capacity: ${p.capacityLiters || 'N/A'}L | Trub Loss: ${p.trubLossLiters || 0}L ${p.type === 'Kettle' ? `| Boil-off: ${p.boilOffRateLitersPerHour || 0}L/hr` : ''}</p>
                            </div>
                            <div class="flex items-center gap-4 flex-shrink-0 ml-2">
                                <button onclick="window.editEquipmentProfile('${p.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Edit</button>
                                <button onclick="window.deleteEquipmentProfile('${p.id}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            window.editEquipmentProfile = function(profileId) {
                const p = equipmentProfiles.find(i => i.id === profileId);
                if (!p) return;

                const itemDiv = document.getElementById(`equip-item-${profileId}`);
                itemDiv.innerHTML = `
                    <div class="w-full space-y-2 p-2 bg-app-primary rounded">
                        <input type="text" id="edit-equip-name-${p.id}" value="${p.name}" placeholder="Name" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="number" id="edit-equip-cap-${p.id}" value="${p.capacityLiters || ''}" placeholder="Capacity (L)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-trub-${p.id}" value="${p.trubLossLiters || '0'}" placeholder="Trub Loss (L)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="edit-equip-boiloff-${p.id}" value="${p.boilOffRateLitersPerHour || '0'}" placeholder="Boil-off (L/hr)" class="w-full p-1 border rounded bg-app-tertiary border-app text-app-primary ${p.type !== 'Kettle' ? 'hidden' : ''}">
                            <div class="flex gap-2 col-span-2 md:col-span-1">
                                <button onclick="window.updateEquipmentProfile('${p.id}', '${p.type}')" class="w-full bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm btn">Save</button>
                                <button onclick="renderEquipmentProfiles()" class="w-full bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            window.updateEquipmentProfile = async function(profileId, type) {
                if (!userId) return;
                const updatedData = {
                    name: document.getElementById(`edit-equip-name-${profileId}`).value,
                    capacityLiters: parseFloat(document.getElementById(`edit-equip-cap-${profileId}`).value) || null,
                    trubLossLiters: parseFloat(document.getElementById(`edit-equip-trub-${profileId}`).value) || 0,
                    boilOffRateLitersPerHour: (type === 'Kettle') ? parseFloat(document.getElementById(`edit-equip-boiloff-${profileId}`).value) || 0 : 0
                };

                if (!updatedData.name) {
                    alert("Profile name cannot be empty.");
                    return;
                }

                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles', profileId);
                    await updateDoc(itemDocRef, updatedData);
                } catch (error) {
                    console.error("Error updating equipment profile:", error);
                }
            }

            window.deleteEquipmentProfile = async function(profileId) {
                if (!userId) return;
                if (!confirm('Are you sure you want to delete this equipment profile?')) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'equipmentProfiles', profileId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting equipment profile:", error);
                }
            }
            
            function handleEquipmentTypeChange() {
                 const type = document.getElementById('equipProfileType').value;
                 document.getElementById('boil-off-rate-container').classList.toggle('hidden', type !== 'Kettle');
            }

            function populateEquipmentProfilesDropdown() {
                const select = document.getElementById('equipmentProfileSelect');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">None (Use default values)</option>'; // Reset
                
                equipmentProfiles.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
                select.value = currentValue; // Probeer de selectie te behouden
            }

            // --- Cellar Functions ---

            function loadCellar() {
                if (!userId) return;
                const appId = 'meandery-aa05e';
                const cellarCol = collection(db, 'artifacts', appId, 'users', userId, 'cellar');
                const q = query(cellarCol);

                onSnapshot(q, (snapshot) => {
                    cellar = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sorteer op botteldatum, nieuwste eerst
                    if (cellar.length > 0 && cellar[0].bottlingDate) {
                        cellar.sort((a, b) => b.bottlingDate.toDate() - a.bottlingDate.toDate());
                    }
                    renderCellar();
                    updateNextActionWidget();
                }, (error) => {
                    console.error("Error loading cellar: ", error);
                    document.getElementById('cellar-list').innerHTML = `<p class="text-red-500">Could not load cellar.</p>`;
                });
            }

            function renderCellar() {
                const listDiv = document.getElementById('cellar-list');
                if (cellar.length === 0) {
                    listDiv.innerHTML = `<p class="text-center text-app-secondary/80">Your cellar is empty. Bottle a batch from your history to add it here!</p>`;
                    return;
                }
                
                listDiv.innerHTML = cellar.map(item => {
                    const totalBottles = (item.bottles && Array.isArray(item.bottles)) ? item.bottles.reduce((acc, b) => acc + b.quantity, 0) : (item.initialQuantity || 0);
                    const bottlingDateStr = item.bottlingDate ? item.bottlingDate.toDate().toLocaleDateString() : 'No date';

                    const bottleDetailsHtml = (item.bottles && Array.isArray(item.bottles)) ? item.bottles.map(b => `
                        <div class="flex items-center justify-between text-sm py-1">
                            <span>${b.quantity} x ${b.size}ml</span>
                            <button onclick="window.consumeBottle('${item.id}', ${b.size})" class="text-xs bg-app-action text-white px-2 py-1 rounded hover:opacity-80 btn">-1 Bottle</button>
                        </div>
                    `).join('') : `<p class="text-sm">${totalBottles} bottles (old format)</p>`;

                    const adviceHtml = item.peakFlavorDate ? `
                        <div class="mt-3 pt-3 border-t border-app">
                            <p class="text-sm font-bold text-app-primary">Alchemist's Aging Advice:</p>
                            <p class="text-sm text-app-secondary/90">
                                <span class="font-semibold">Peak Flavor around: ${item.peakFlavorDate}.</span> ${item.peakFlavorJustification || ''}
                            </p>
                        </div>
                    ` : '';

                    return `
                    <div class="p-4 card rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg font-header">${item.recipeName}</h4>
                                <p class="text-sm text-app-secondary">Bottled on: ${bottlingDateStr}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <p class="text-2xl font-bold text-app-brand">${totalBottles} <span class="text-base font-normal">total</span></p>
                            </div>
                        </div>
                        <div class="mt-3 space-y-2">${bottleDetailsHtml}</div>
                        ${adviceHtml}
                        <div class="text-right mt-3 border-t border-app pt-2 flex justify-end items-center gap-4">
                             <button onclick="window.setTastingReminder('${item.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold">Set Reminder</button>
                             <button onclick="window.deleteCellarItem('${item.id}', '${item.recipeName}')" class="text-red-600 hover:text-red-800 text-xs font-semibold">Delete Batch</button>
                             </div>
                    </div>
                    `}).join('');
            }

            // --- NIEUW: Kalender Herinnering Functies ---
            window.setTastingReminder = function(cellarItemId) {
                const item = cellar.find(c => c.id === cellarItemId);
                if (!item) return;

                const months = prompt(`Set a tasting reminder for "${item.recipeName}".\n\nIn how many months from today?`, "6");
                if (months === null || isNaN(parseInt(months)) || parseInt(months) <= 0) {
                    return; // Gebruiker annuleert of geeft ongeldige invoer
                }

                const reminderDate = new Date();
                reminderDate.setMonth(reminderDate.getMonth() + parseInt(months));
                
                generateAndDownloadIcs(item, reminderDate);
            }

            function generateAndDownloadIcs(item, date) {
                // Formatteer de datum naar UTC (vereist voor .ics bestanden)
                const toICSFormat = (d) => {
                    return d.getUTCFullYear() + 
                           ('0' + (d.getUTCMonth() + 1)).slice(-2) + 
                           ('0' + d.getUTCDate()).slice(-2) + 'T' +
                           ('0' + d.getUTCHours()).slice(-2) +
                           ('0' + d.getUTCMinutes()).slice(-2) +
                           ('0' + d.getUTCSeconds()).slice(-2) + 'Z';
                }

                const eventStart = toICSFormat(date);
                const eventStamp = toICSFormat(new Date());

                // Bouw de inhoud van het .ics bestand
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'BEGIN:VEVENT',
                    `UID:${Date.now()}@meandery.app`,
                    `DTSTAMP:${eventStamp}`,
                    `DTSTART;VALUE=DATE:${eventStart.substring(0,8)}`, // We maken er een "hele dag" evenement van
                    `SUMMARY:Tasting Reminder: ${item.recipeName}`,
                    'DESCRIPTION:Time to taste your aged mead from the MEA(N)DERY app! Notes: How is the aroma, clarity, and flavor? Has it mellowed out?',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                // Maak en download het bestand
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Tasting_Reminder_${item.recipeName.replace(/\s/g, '_')}.ics`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // --- NIEUW: Barcode Scanner Functies ---
            function startScanner() {
                document.getElementById('barcode-scanner-container').classList.remove('hidden');

                html5QrcodeScanner = new Html5Qrcode("barcode-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 150 } };

                html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
                     .catch(err => {
                         console.error("Unable to start scanning.", err);
                         alert("Could not start camera. Please grant camera permissions.");
                     });
            }

            function stopScanner() {
                if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                    html5QrcodeScanner.stop().then(() => {
                        document.getElementById('barcode-scanner-container').classList.add('hidden');
                    }).catch(err => console.error("Error stopping scanner:", err));
                } else {
                     document.getElementById('barcode-scanner-container').classList.add('hidden');
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                // Stop de scanner onmiddellijk na een succesvolle scan
                stopScanner();

                // Vraag de productinformatie op
                fetchProductInfo(decodedText);
            }

            async function fetchProductInfo(barcode) {
                const itemNameInput = document.getElementById('itemName');
                const originalPlaceholder = itemNameInput.placeholder;
                itemNameInput.value = '';
                itemNameInput.placeholder = 'Looking up barcode...';

                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                    if (!response.ok) throw new Error("Product not found in the database.");

                    const data = await response.json();

                    if (data.status === 1 && data.product && data.product.product_name) {
                        itemNameInput.value = data.product.product_name;
                    } else {
                        throw new Error("Product not found in the database.");
                    }
               } catch (error) {
                   console.error("Barcode lookup failed:", error);
                   alert(error.message);
               } finally {
                   itemNameInput.placeholder = originalPlaceholder;
               }
            }

            window.consumeBottle = async function(cellarItemId, bottleSize) {
                if (!userId) return;

                const cellarItemRef = doc(db, 'artifacts', 'meandery-aa05e', 'users', userId, 'cellar', cellarItemId);
                
                try {
                    // Haal het huidige document op
                    const docSnap = await getDoc(cellarItemRef);
                    if (!docSnap.exists()) {
                        console.error("Cellar item not found!");
                        return;
                    }

                    const itemData = docSnap.data();
                    const bottles = itemData.bottles;

                    // Vind de juiste flesmaat en verminder de hoeveelheid
                    const bottleIndex = bottles.findIndex(b => b.size == bottleSize);
                    if (bottleIndex > -1 && bottles[bottleIndex].quantity > 0) {
                        bottles[bottleIndex].quantity -= 1;

                        // Optioneel: verwijder de flesmaat als de hoeveelheid 0 is
                        const updatedBottles = bottles.filter(b => b.quantity > 0);
                        
                        // Update het document in Firestore
                        await updateDoc(cellarItemRef, { bottles: updatedBottles });
                    } else {
                        alert("Bottle size not found or quantity is already 0.");
                    }
                } catch (error) {
                    console.error("Error consuming bottle: ", error);
                }
            }

            window.deleteCellarItem = async function(itemId, recipeName) {
                if (!userId) return;
                if (!confirm(`Are you sure you want to delete the entire batch of '${recipeName}' from your cellar? This cannot be undone.`)) return;
                try {
                    const appId = 'meandery-aa05e';
                    const itemDocRef = doc(db, 'artifacts', appId, 'users', userId, 'cellar', itemId);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting cellar item:", error);
                }
            }


            // --- Functies voor het bottel-proces ---

            let currentBrewToBottleId = null; 

            window.showBottlingModal = function(brewId) {
                currentBrewToBottleId = brewId;
                const bottlingForm = document.getElementById('bottling-form');
                bottlingForm.reset();
                document.getElementById('bottlingDate').valueAsDate = new Date();
                document.getElementById('bottling-modal').classList.remove('hidden');
            }

            window.hideBottlingModal = function() {
                document.getElementById('bottling-modal').classList.add('hidden');
                currentBrewToBottleId = null;
            }

            async function bottleBatch(e) {
                e.preventDefault();
                if (!currentBrewToBottleId) return;

                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="loader" style="height:20px; width:20px; border-width: 2px; margin: 0 auto;"></div>';

                try {
                    const originalBrew = brews.find(b => b.id === currentBrewToBottleId);
                    if (!originalBrew) {
                        console.error("Original brew not found!");
                        alert("Error: could not find the original recipe to bottle.");
                        return;
                    }

                    // Data uit formulier halen (blijft hetzelfde)
                    const bottlingDate = new Date(document.getElementById('bottlingDate').value);
                    const qty750 = parseInt(document.getElementById('qty750').value) || 0;
                    const qty500 = parseInt(document.getElementById('qty500').value) || 0;
                    const qty330 = parseInt(document.getElementById('qty330').value) || 0;
                    const qty250 = parseInt(document.getElementById('qty250').value) || 0;
                    const customSize = parseInt(document.getElementById('customSize').value) || 0;
                    const customQty = parseInt(document.getElementById('customQty').value) || 0;

                    const bottles = [];
                    if (qty750 > 0) bottles.push({ size: 750, quantity: qty750 });
                    if (qty500 > 0) bottles.push({ size: 500, quantity: qty500 });
                    if (qty330 > 0) bottles.push({ size: 330, quantity: qty330 });
                    if (qty250 > 0) bottles.push({ size: 250, quantity: qty250 });
                    if (customSize > 0 && customQty > 0) bottles.push({ size: customSize, quantity: customQty });

                    if (bottles.length === 0) {
                        alert("Please enter a quantity for at least one bottle size.");
                        return;
                    }

                    // --- NIEUW: Vraag AI om rijpingsadvies ---
                    const agingPrompt = `You are a mead aging expert. Based on the following mead recipe and a bottling date of ${bottlingDate.toISOString().split('T')[0]}, determine a recommended 'peak flavor' or 'best before' date. High ABV, sweet, or complex meads can age longer. Provide a short justification (1 sentence) and the date in YYYY-MM-DD format. Example: "Best before: 2027-08-06. Justification: This sweet, high ABV mead will develop complex flavors with extended aging." Recipe:\n\n---\n${originalBrew.recipeMarkdown}`;
                    const agingAdvice = await performApiCall(agingPrompt);
                    
                    const dateMatch = agingAdvice.match(/(\d{4}-\d{2}-\d{2})/);
                    const justificationMatch = agingAdvice.match(/Justification:\s*(.*)/i);

                    const cellarData = {
                        userId: userId,
                        brewId: currentBrewToBottleId,
                        recipeName: originalBrew.recipeName,
                        bottlingDate: bottlingDate,
                        bottles: bottles,
                        peakFlavorDate: dateMatch ? dateMatch[1] : null,
                        peakFlavorJustification: justificationMatch ? justificationMatch[1] : agingAdvice,
                        tastingNotes: [] 
                    };

                    const appId = 'meandery-aa05e';
                    const cellarCol = collection(db, 'artifacts', appId, 'users', userId, 'cellar');
                    await addDoc(cellarCol, cellarData);
                    
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', currentBrewToBottleId);
                    await updateDoc(brewDocRef, { isBottled: true });

                    hideBottlingModal();
                    switchMainView('management');
                    switchSubView('cellar', 'management-main-view');

                } catch (error) {
                    console.error("FATAL: Error adding batch to cellar: ", error);
                    alert("Something went wrong while saving to the cellar. Please check the F12 Developer Console for error messages.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            }
            // --- Calculator Functions ---
            function calculateABV() {
                const og = parseFloat(document.getElementById('og').value);
                const fg = parseFloat(document.getElementById('fg').value);
                const resultDiv = document.getElementById('abvResult');
                if (og && fg && og > fg) {
                    const abv = (og - fg) * 131.25;
                    resultDiv.textContent = `ABV: ${abv.toFixed(2)}%`;
                } else {
                    resultDiv.textContent = 'Invalid Input';
                }
            }

            function correctHydrometer() {
                const sg = parseFloat(document.getElementById('sgReading').value);
                const t = parseFloat(document.getElementById('tempReading').value);
                const c = parseFloat(document.getElementById('calTemp').value);
                const resultDiv = document.getElementById('sgResult');

                if (isNaN(sg) || isNaN(t) || isNaN(c)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // Formula for hydrometer correction
                const correctedSg = sg * ((1.00130346 - 0.000134722124 * t + 0.00000204052596 * t**2 - 0.00000000232820948 * t**3) / (1.00130346 - 0.000134722124 * c + 0.00000204052596 * c**2 - 0.00000000232820948 * c**3));
                resultDiv.textContent = `Corrected: ${correctedSg.toFixed(3)}`;
            }

            function calculatePrimingSugar() {
                const vol = parseFloat(document.getElementById('carbVol').value);
                const temp = parseFloat(document.getElementById('carbTemp').value);
                const size = parseFloat(document.getElementById('carbBatchSize').value);
                const resultDiv = document.getElementById('sugarResult');

                if (isNaN(vol) || isNaN(temp) || isNaN(size)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }
                
                // Formula for priming sugar (sucrose)
                const sugarGrams = (vol - (3.0378 - 0.050062 * temp + 0.00026555 * temp**2)) * 4 * size;
                resultDiv.textContent = `${sugarGrams.toFixed(1)} g sugar`;
            }
            
            function calculateBlend() {
                const vol1 = parseFloat(document.getElementById('vol1').value);
                const sg1 = parseFloat(document.getElementById('sg1').value);
                const vol2 = parseFloat(document.getElementById('vol2').value);
                const sg2 = parseFloat(document.getElementById('sg2').value);
                const resultDiv = document.getElementById('blendResult');

                if (isNaN(vol1) || isNaN(sg1) || isNaN(vol2) || isNaN(sg2)) {
                    resultDiv.textContent = 'Invalid Input';
                    return;
                }

                const totalVolume = vol1 + vol2;
                const finalSG = (((vol1 * (sg1 - 1)) + (vol2 * (sg2 - 1))) / totalVolume) + 1;
                
                resultDiv.textContent = `Final: ${totalVolume.toFixed(2)}L at ${finalSG.toFixed(3)} SG`;
            }

            async function getYeastAdvice() {
                const og = document.getElementById('starterOG').value;
                const yeastDate = document.getElementById('yeastDate').value;
                const yeastType = document.getElementById('yeastType').value;
                const adviceOutput = document.getElementById('yeast-advice-output');

                if (!og || !yeastDate) {
                    adviceOutput.innerHTML = `<p class="text-red-500">Please enter both Starting Gravity and Yeast Date.</p>`;
                    return;
                }
                adviceOutput.innerHTML = '<div class="loader"></div>';

                const prompt = `You are a yeast expert. A homebrewer is making a mead with a starting gravity of ${og}. Their ${yeastType} yeast packet has a production date of ${yeastDate}. Today's date is ${new Date().toISOString().split('T')[0]}. Based on this, tell them if a yeast starter is necessary. If it is, provide a simple, step-by-step guide for making an appropriate starter for a 5-liter batch. Format the response in Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    adviceOutput.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting yeast advice:", error);
                    adviceOutput.innerHTML = `<p class="text-center text-red-500">Could not get yeast advice: ${error.message}</p>`;
                }
            }

            // --- Water Chemistry Functions ---
            const waterData = {
                spa: { ca: 5, mg: 2, na: 3, so4: 4, cl: 5, hco3: 17 },
                chaudfontaine: { ca: 65, mg: 18, na: 44, so4: 40, cl: 35, hco3: 305 },
                valvert: { ca: 68, mg: 2, na: 2, so4: 18, cl: 4, hco3: 204 },
                bru: { ca: 23.3, mg: 22.2, na: 8, so4: 5, cl: 4, hco3: 209 },
                villers: { ca: 106.1, mg: 11.1, na: 8, so4: 48.8, cl: 19.9, hco3: 340.4 }
            };

            function handleWaterSourceChange() {
                const isManual = waterSourceSelect.value === 'manual';
                manualWaterProfileDiv.classList.toggle('hidden', !isManual);
                fetchWaterProfileBtn.textContent = isManual ? 'Apply Manual Profile' : 'Fetch Profile';
            }

            function fetchWaterProfile() {
                const source = waterSourceSelect.value;
                if (source === 'manual') {
                    currentWaterProfile = {
                        ca: parseFloat(document.getElementById('manual_ca').value) || 0,
                        mg: parseFloat(document.getElementById('manual_mg').value) || 0,
                        na: parseFloat(document.getElementById('manual_na').value) || 0,
                        so4: parseFloat(document.getElementById('manual_so4').value) || 0,
                        cl: parseFloat(document.getElementById('manual_cl').value) || 0,
                        hco3: parseFloat(document.getElementById('manual_hco3').value) || 0,
                    };
                } else {
                    currentWaterProfile = waterData[source];
                }
                
                document.getElementById('val-ca').textContent = currentWaterProfile.ca;
                document.getElementById('val-mg').textContent = currentWaterProfile.mg;
                document.getElementById('val-na').textContent = currentWaterProfile.na;
                document.getElementById('val-so4').textContent = currentWaterProfile.so4;
                document.getElementById('val-cl').textContent = currentWaterProfile.cl;
                document.getElementById('val-hco3').textContent = currentWaterProfile.hco3;
            }

            async function getWaterAdvice() {
                if (!currentWaterProfile) {
                    document.getElementById('water-advice-output').innerHTML = `<p class="text-center text-red-500">Please fetch or apply a water profile first.</p>`;
                    return;
                }
                
                const adviceOutput = document.getElementById('water-advice-output');
                adviceOutput.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">Analyzing water profile...</p>';
                
                const targetProfile = document.getElementById('meadTargetProfile').selectedOptions[0].text;
                const batchSize = document.getElementById('batchSize').value;

                const prompt = `You are an expert brew chemist. A user has the following starting water profile in mg/L (ppm): Calcium: ${currentWaterProfile.ca}, Magnesium: ${currentWaterProfile.mg}, Sodium: ${currentWaterProfile.na}, Sulfate: ${currentWaterProfile.so4}, Chloride: ${currentWaterProfile.cl}, Bicarbonate: ${currentWaterProfile.hco3}. 
                
                They want to adjust this water for a ${batchSize}-liter batch of mead with a target character of "${targetProfile}". 
                
                Provide specific, actionable advice. Recommend additions of brewing salts (Gypsum, Calcium Chloride, Epsom Salt) in grams. Explain WHY you are recommending these changes (e.g., "add gypsum to accentuate dryness"). Format the response in simple Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    adviceOutput.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting water advice:", error);
                    adviceOutput.innerHTML = `<p class="text-center text-red-500">Could not get water advice: ${error.message}</p>`;
                }
            }


            // --- Utility Functions ---
            function parseIngredientsAndCalculateCost(markdown, inventory, batchSize) {
                let totalCost = 0;
                const tableRegex = /\| Ingredient.*?\|\n\|[-|: ]+\|[-|: ]+\|[-|: ]+\|\n([\s\S]*?)\n\n/gm;
                const tableMatch = tableRegex.exec(markdown);

                if (!tableMatch || !tableMatch[1]) {
                    console.warn("Could not find or parse ingredients table in the recipe.");
                    return 0;
                }

                const rows = tableMatch[1].split('\n').filter(row => row.trim() !== '');

                rows.forEach(row => {
                    const columns = row.split('|').map(c => c.trim()).filter(c => c);
                    if (columns.length !== 3) return;

                    const [name, quantityStr, unit] = columns;
                    const quantity = parseFloat(quantityStr);
                    if (isNaN(quantity)) return;
                    
                    // Find best match in inventory (case-insensitive)
                    const inventoryItem = inventory.find(item => item.name.toLowerCase() === name.toLowerCase());
                    
                    if (inventoryItem) {
                        let costPerUnit = inventoryItem.price / inventoryItem.qty;
                        // Basic unit conversion
                        if (inventoryItem.unit === 'kg' && unit.toLowerCase() === 'g') {
                            costPerUnit /= 1000;
                        } else if (inventoryItem.unit === 'g' && unit.toLowerCase() === 'kg') {
                            costPerUnit *= 1000;
                        } // Can add more conversions here
                        
                        totalCost += quantity * costPerUnit;
                    }
                });

                return totalCost;
            }

            window.printEmptyLog = function() {
                const logHtml = getBrewLogHtml(null, 'empty');
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>Empty Brew Log</title><style>${document.querySelector('style').innerHTML}</style></head><body><div class="container mx-auto p-4">${logHtml}</div></body></html>`);
                printWindow.document.close();
                printWindow.print();
            }

            function getLogDataFromDOM(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return {};
                const logSection = container.querySelector('.brew-log-section');
                if (!logSection) return {};
                const suffix = `-${logSection.dataset.id}`;
                return {
                    recipeName: container.querySelector(`#recipeName${suffix}`)?.value || '',
                    brewDate: container.querySelector(`#brewDate${suffix}`)?.value || '',
                    targetOG: container.querySelector(`#targetOG${suffix}`)?.value || '',
                    actualOG: container.querySelector(`#actualOG${suffix}`)?.value || '',
                    targetFG: container.querySelector(`#targetFG${suffix}`)?.value || '',
                    actualFG: container.querySelector(`#actualFG${suffix}`)?.value || '',
                    targetABV: container.querySelector(`#targetABV${suffix}`)?.value || '',
                    finalABV: container.querySelector(`#finalABV${suffix}`)?.value || '',
                    fermentationLog: Array.from(container.querySelectorAll(`#fermentationTable${suffix} tbody tr`)).map(row => ({
                        date: row.cells[0].querySelector('input').value,
                        temp: row.cells[1].querySelector('input').value,
                        sg: row.cells[2].querySelector('input').value,
                        notes: row.cells[3].querySelector('input').value,
                    })),
                    agingNotes: container.querySelector(`#agingNotes${suffix}`)?.value || '',
                    bottlingNotes: container.querySelector(`#bottlingNotes${suffix}`)?.value || '',
                    tastingNotes: container.querySelector(`#tastingNotes${suffix}`)?.value || '',
                };
            }

            function getBrewLogHtml(logData, idSuffix = 'new') {
                const data = logData || {};
                const fermLog = data.fermentationLog || Array.from({ length: 8 }, () => ({}));
                
                // Variabelen om de laatst bekende waarde bij te houden.
                // We initialiseren ze met de standaardwaarden voor de allereerste rij.
                let lastTempValue = '18';
                let lastSgValue = data.targetOG || '';

                return `
                    <div class="brew-log-section" data-id="${idSuffix}">
                        <h3>Brewmaster's Log</h3>
                        <div class="log-grid">
                            <div class="log-item"><label for="recipeName-${idSuffix}">Recipe Name:</label><input type="text" id="recipeName-${idSuffix}" value="${data.recipeName || ''}"></div>
                            <div class="log-item"><label for="brewDate-${idSuffix}">Brew Date:</label><input type="date" id="brewDate-${idSuffix}" value="${data.brewDate || ''}"></div>
                        </div>
                        <div class="log-grid">
                             <div class="log-item"><label for="targetOG-${idSuffix}">Target OG:</label><input type="text" id="targetOG-${idSuffix}" value="${data.targetOG || ''}"></div>
                             <div class="log-item"><label for="actualOG-${idSuffix}">Actual OG:</label><input type="text" id="actualOG-${idSuffix}" value="${data.actualOG || ''}"></div>
                             <div class="log-item"><label for="targetFG-${idSuffix}">Target FG:</label><input type="text" id="targetFG-${idSuffix}" value="${data.targetFG || ''}"></div>
                            <div class="log-item"><label for="actualFG-${idSuffix}">Actual FG:</label><input type="text" id="actualFG-${idSuffix}" value="${data.actualFG || ''}"></div>
                             <div class="log-item"><label for="targetABV-${idSuffix}">Target ABV:</label><input type="text" id="targetABV-${idSuffix}" value="${data.targetABV || ''}"></div>
                            <div class="log-item"><label for="finalABV-${idSuffix}">Final ABV:</label><input type="text" id="finalABV-${idSuffix}" value="${data.finalABV || ''}"></div>
                        </div>
                        <div class="log-item">
                            <label>Fermentation Log</label>
                            <table class="fermentation-table" id="fermentationTable-${idSuffix}">
                                <thead><tr><th>Date</th><th>Temp (°C)</th><th>S.G.</th><th>Notes</th></tr></thead>
                                <tbody>${fermLog.map((row, index) => {
                                    // Bepaal de te gebruiken waarde: de eigen waarde van de rij, of anders de laatst bekende waarde.
                                    const currentTempValue = row.temp || lastTempValue;
                                    const currentSgValue = row.sg || lastSgValue;
                                    
                                    // Update de 'laatst bekende waarde' voor de VOLGENDE rij in de loop.
                                    lastTempValue = currentTempValue;
                                    lastSgValue = currentSgValue;

                                    return `<tr>
                                        <td><input type="date" value="${row.date || ''}" class="w-full"></td>
                                        <td><input type="number" step="0.5" placeholder="18.5" value="${currentTempValue}" class="w-full text-center"></td>
                                        <td><input type="number" step="0.001" placeholder="1.050" value="${currentSgValue}" class="w-full text-center"></td>
                                        <td><input type="text" value="${row.notes || ''}"></td>
                                    </tr>`;
                                }).join('')}</tbody>
                            </table>
                        </div>
                        <div class="log-item"><label for="agingNotes-${idSuffix}">Aging & Conditioning Notes:</label><textarea id="agingNotes-${idSuffix}" rows="4" placeholder="Secondary additions, clearing, bulk aging time, etc.">${data.agingNotes || ''}</textarea></div>
                        <div class="log-item"><label for="bottlingNotes-${idSuffix}">Bottling / Kegging Notes:</label><textarea id="bottlingNotes-${idSuffix}" rows="3" placeholder="Bottling date, final volume, carbonation method, etc.">${data.bottlingNotes || ''}</textarea></div>
                        <div class="log-item"><label for="tastingNotes-${idSuffix}">Final Tasting Notes:</label><textarea id="tastingNotes-${idSuffix}" rows="6" placeholder="Aroma, appearance, flavor, mouthfeel, overall impression...">${data.tastingNotes || ''}</textarea></div>
                    </div>
                `;
            }

            // --- Functie voor de Actieve Batch Tijdlijn ---
function renderActiveBrewTimeline() {
    const card = document.getElementById('current-brew-card');
    if (!card) return;

    // Zoek de meest recente actieve (niet-gebottelde) brouwsel
    const activeBrew = brews.find(b => b.logData && b.logData.brewDate && b.logData.brewDate !== '' && !b.isBottled);

    if (!activeBrew) {
        card.classList.add('hidden');
        return;
    }

    const now = new Date();
    const brewDate = new Date(activeBrew.logData.brewDate);
    const daysFermenting = (now - brewDate) / (1000 * 60 * 60 * 24);

    // Bepaal de stadia en de voortgang
    const stages = [
        { name: 'Brew Day', day: 0 },
        { name: 'Primary End', day: 21 }, // Gemiddeld einde van primaire gisting
        { name: 'Aging', day: 60 }, // Een ijkpunt voor rijpen
        { name: 'Bottling Ready', day: 90 } // Indicatie dat het klaar zou kunnen zijn
    ];
    
    let statusText = `Day ${Math.round(daysFermenting)}: `;
    if (daysFermenting < stages[1].day) {
        statusText += "Primary Fermentation";
    } else if (daysFermenting < stages[2].day) {
        statusText += "Secondary / Clearing";
    } else {
        statusText += "Aging";
    }

    // Bereken de voortgang in procenten voor de progress bar
    const totalDuration = stages[stages.length - 1].day;
    const progressPercentage = Math.min(100, (daysFermenting / totalDuration) * 100);

    let timelineItemsHtml = '';
    stages.forEach((stage) => {
        const isActive = daysFermenting >= stage.day;
        timelineItemsHtml += `
            <div class="timeline-item ${isActive ? 'active' : ''}">
                <div class="timeline-node"></div>
                <div class="timeline-label">${stage.name}</div>
            </div>
        `;
    });

    card.innerHTML = `
        <h3 class="text-xl font-header font-bold mb-1">${activeBrew.recipeName}</h3>
        <p class="text-app-secondary mb-4">${statusText}</p>
        <div class="timeline-container">
            <div class="timeline-connector">
                <div class="timeline-progress" style="width: ${progressPercentage}%;"></div>
            </div>
            ${timelineItemsHtml}
        </div>
    `;

    card.classList.remove('hidden');
}

            function updateNextActionWidget() {
                const widget = document.getElementById('next-action-widget');
                const list = document.getElementById('next-action-list');
                if (!widget || !list) return;

                // Update the widget title
                const widgetTitle = widget.querySelector('h3');
                if (widgetTitle) widgetTitle.textContent = "What's next?";

                list.innerHTML = ''; // Clear the list
                const suggestions = [];
                const now = new Date();
                const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));

                // Suggestion 1: Recently saved recipe
                if (brews.length > 0) {
                    const newestBrew = brews[0]; // List is already sorted newest first
                    if (newestBrew.createdAt.toDate() > twentyFourHoursAgo && !newestBrew.isBottled) {
                         suggestions.push(`
                            <li>
                                You recently saved the recipe '<strong>${newestBrew.recipeName}</strong>'.
                                <button onclick="window.generateShoppingList('${newestBrew.id}')" class="text-blue-600 hover:underline font-semibold ml-2">Create shopping list</button> or
                                <button onclick="window.startBrewDay('${newestBrew.id}')" class="text-green-600 hover:underline font-semibold ml-1">Start brew day!</button>
                            </li>
                         `);
                    }
                }

                // Suggestion 2: Mead that has been fermenting for a while
                const fermentingBrews = brews.filter(b => b.logData && b.logData.brewDate && !b.isBottled && b.logData.brewDate !== '');
                if (fermentingBrews.length > 0) {
                    fermentingBrews.forEach(brew => {
                        const brewDate = new Date(brew.logData.brewDate);
                        if (!isNaN(brewDate.getTime())) { // Check if the date is valid
                            const daysFermenting = (now - brewDate) / (1000 * 60 * 60 * 24);
                            // Show this message if it's been fermenting for more than 18 days and no FG is entered
                            if (daysFermenting > 18 && !brew.logData.actualFG) {
                                suggestions.push(`
                                    <li>
                                        '<strong>${brew.recipeName}</strong>' has been fermenting for ${Math.round(daysFermenting)} days. Time for an SG reading?
                                        <button onclick="window.showBrewDetail('${brew.id}')" class="text-blue-600 hover:underline font-semibold ml-2">View Log</button>
                                    </li>
                                `);
                            }
                        }
                    });
                }
                
                // Suggestion 3: Batch in the cellar that might be ready to drink
                if (cellar.length > 0) {
                    cellar.forEach(item => {
                        if(item.peakFlavorDate) {
                            const peakDate = new Date(item.peakFlavorDate);
                             if (!isNaN(peakDate.getTime())) { // Check if the date is valid
                                const daysUntilPeak = (peakDate - now) / (1000 * 60 * 60 * 24);
                                if(daysUntilPeak <= 14 && daysUntilPeak > -30) { // Show from 2 weeks before until a month after
                                     suggestions.push(`
                                        <li>
                                            The '<strong>${item.recipeName}</strong>' in your cellar is nearing its peak! Maybe it's time for a tasting?
                                        </li>
                                    `);
                                }
                            }
                        }
                    });
                }

                if (suggestions.length > 0) {
                    list.innerHTML = suggestions.slice(0, 3).join(''); // Show max 3 suggestions
                    widget.classList.remove('hidden');
                } else {
                    widget.classList.add('hidden');
                }
            }
            
            // --- Brew Day Assistant Functions ---
            window.startBrewDay = function(brewId) {
                currentBrewDay = { brewId: brewId, checklist: {} };
                saveUserSettings(); // Save the current brew day
                renderBrewDay(brewId);
                switchMainView('brewing');
                switchSubView('brewing', 'brewing-main-view');
            }

            // DEFINITIEVE, VERBETERDE FUNCTIE VOOR DE BREW DAY CHECKLIST
            function renderBrewDay(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) {
                    brewDayContent.innerHTML = `<p class="text-center text-red-500">Could not find the selected brew. Please start a new one.</p>`;
                    return;
                }

                let checklistHtml = `<h2 class="text-3xl font-header font-bold mb-4 text-center">${brew.recipeName || 'Brew Day'}</h2>`;
                
                // --- INGREDIENTEN CHECKLIST (WERKT AL) ---
                const ingredients = parseIngredientsFromMarkdown(brew.recipeMarkdown);
                if (ingredients.length > 0) {
                    checklistHtml += `<h3 class="text-2xl font-header mt-6 mb-3">Ingredients</h3>`;
                    ingredients.forEach((ing, index) => {
                        const text = `${ing.name} - ${ing.quantity} ${ing.unit}`;
                        const id = `ing-${index}`;
                        const isChecked = currentBrewDay.checklist[id] ? 'checked' : '';
                        checklistHtml += `<div class="flex items-center my-2"><input type="checkbox" id="${id}" data-task="${id}" ${isChecked} onchange="window.updateChecklist(this)"><label for="${id}" class="ml-3">${text}</label></div>`;
                    });
                }

                // --- INSTRUCTIES CHECKLIST (NU VERBETERD) ---
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = marked.parse(brew.recipeMarkdown);
                const instructionsHeader = Array.from(tempDiv.querySelectorAll('h2, h3')).find(h => h.textContent.toLowerCase().includes('instructions'));
                
                if (instructionsHeader) {
                    checklistHtml += `<h3 class="text-2xl font-header mt-6 mb-3">Instructions</h3>`;
                    
                    // --- START VAN DE FIX ---
                    // Zoek naar de EERSTE <ol> of <ul> die NA de header komt
                    let currentElement = instructionsHeader.nextElementSibling;
                    let instructionsList = null;
                    while (currentElement) {
                        if (currentElement.tagName === 'OL' || currentElement.tagName === 'UL') {
                            instructionsList = currentElement;
                            break; // Gevonden! Stop met zoeken.
                        }
                        currentElement = currentElement.nextElementSibling;
                    }
                    // --- EINDE VAN DE FIX ---

                    if (instructionsList) {
                        const items = instructionsList.querySelectorAll('li');
                        items.forEach((item, index) => {
                            const text = item.innerHTML; // Gebruik innerHTML om opmaak zoals <strong> te behouden
                            const id = `inst-${index}`;
                            const isChecked = currentBrewDay.checklist[id] ? 'checked' : '';
                            checklistHtml += `<div class="flex items-start my-2"><input type="checkbox" id="${id}" data-task="${id}" class="mt-1" ${isChecked} onchange="window.updateChecklist(this)"><label for="${id}" class="ml-3">${text}</label></div>`;
                        });
                    }
                }

                // Quick Log Section (blijft ongewijzigd)
                checklistHtml += `
                    <div class="mt-8 pt-6 border-t-2 border-app">
                        <h3 class="text-2xl font-header mb-4 text-center">Quick Log</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="number" id="quickLogSG" placeholder="S.G. (e.g., 1.050)" class="p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            <input type="number" id="quickLogTemp" placeholder="Temp (°C)" class="p-2 border rounded-md bg-app-tertiary border-app text-app-primary">
                            <input type="text" id="quickLogNotes" placeholder="Quick Note" class="p-2 border rounded-md bg-app-tertiary border-app text-app-primary md:col-span-2">
                        </div>
                        <button id="saveQuickLogBtn" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn">Save Log Entry</button>
                        <div id="quickLogMessage" class="text-center h-6 mt-2"></div>
                    </div>
                `;

                brewDayContent.innerHTML = checklistHtml;
                document.getElementById('saveQuickLogBtn').onclick = () => saveQuickLog(brewId);
            }

            window.updateChecklist = function(checkbox) {
                const taskId = checkbox.dataset.task;
                currentBrewDay.checklist[taskId] = checkbox.checked;
                saveUserSettings(); // Persist the checklist state
            }

            async function saveQuickLog(brewId) {
                const sg = document.getElementById('quickLogSG').value;
                const temp = document.getElementById('quickLogTemp').value;
                const notes = document.getElementById('quickLogNotes').value;
                const messageDiv = document.getElementById('quickLogMessage');

                if (!sg && !temp && !notes.trim()) {
                    messageDiv.textContent = 'Please enter at least one value.';
                    messageDiv.style.color = 'var(--danger-color)';
                    return;
                }

                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const newLogEntry = {
                    date: new Date().toLocaleDateString(),
                    sg: sg || '',
                    temp: temp || '',
                    notes: notes.trim() || ''
                };

                const updatedLog = brew.logData.fermentationLog || [];
                // Add to the first empty row or append
                const firstEmptyIndex = updatedLog.findIndex(e => !e.date && !e.sg && !e.temp && !e.notes);
                if(firstEmptyIndex !== -1) {
                    updatedLog[firstEmptyIndex] = newLogEntry;
                } else {
                    updatedLog.push(newLogEntry);
                }

                try {
                    const appId = 'meandery-aa05e';
                    const brewDocRef = doc(db, 'artifacts', appId, 'users', userId, 'brews', brewId);
                    await updateDoc(brewDocRef, { 'logData.fermentationLog': updatedLog });
                    
                    messageDiv.textContent = 'Log entry saved!';
                    messageDiv.style.color = 'var(--success-color)';
                    document.getElementById('quickLogSG').value = '';
                    document.getElementById('quickLogTemp').value = '';
                    document.getElementById('quickLogNotes').value = '';

                } catch (error) {
                    console.error("Error saving quick log:", error);
                    messageDiv.textContent = 'Failed to save.';
                    messageDiv.style.color = 'var(--danger-color)';
                } finally {
                     setTimeout(() => { messageDiv.textContent = ''; }, 3000);
                }
            }
            
            // --- Analysis Functions ---
                window.generateShoppingList = function(brewId) {
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const required = parseIngredientsFromMarkdown(brew.recipeMarkdown);
                const shoppingList = [];

                required.forEach(req => {
                    const invItem = inventory.find(inv => inv.name.toLowerCase() === req.name.toLowerCase());
                    const needed = req.quantity;

                    if (!invItem || invItem.qty < needed) {
                        const toBuy = invItem ? needed - invItem.qty : needed;
                        shoppingList.push({ name: req.name, quantity: toBuy, unit: req.unit });
                    }
                });

                let html = `<h4 class="text-xl font-header mb-2">${brew.recipeName} - Shopping List</h4>`;
                if (shoppingList.length > 0) {
                    html += `<ul class="list-disc pl-5">`;
                    shoppingList.forEach(item => {
                        html += `<li>${item.name}: ${item.quantity.toFixed(2)} ${item.unit}</li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<p style="color: var(--success-color)">You have all the ingredients you need!</p>`;
                }

                document.getElementById('shopping-list-content').innerHTML = html;
                
                switchMainView('management');
                switchSubView('planning', 'management-main-view');
            }

            // --- Social Media Functies (Volledig Vernieuwd) ---

            window.generateSocialContent = async function(brewId) {
                // Deze functie zet de view klaar en doet de EERSTE aanroep.
                const socialView = document.getElementById('social-view');
                socialView.dataset.brewId = brewId; // Sla de brewId op voor later gebruik

                // Navigeer naar de social media view
                switchMainView('tools');
                switchSubView('social', 'tools-main-view');

                // Voer de generator uit met standaardinstellingen
                runSocialMediaGenerator(); 

                // Zorg dat de 'Regenerate' knop de generator opnieuw aanroept
                document.getElementById('regenerate-social-btn').onclick = runSocialMediaGenerator;
            }

            async function runSocialMediaGenerator() {
                const socialView = document.getElementById('social-view');
                const brewId = socialView.dataset.brewId;
                const brew = brews.find(b => b.id === brewId);
                if (!brew) return;

                const socialContainer = document.getElementById('social-content-container');
                socialContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">De Alchemist schrijft een nieuw bericht voor je...</p>';

                const persona = document.getElementById('social-persona').value;
                const platform = document.getElementById('social-platform').value;
                const tweak = document.getElementById('social-tweak').value;

                const negativeConstraint = " CRUCIAL: Do not wrap your response in a markdown code block using triple backticks (```).";

                let personaPrompt = "You are an enthusiastic homebrewer sharing your passion.";
                if (persona === 'pro_brewery') {
                    personaPrompt = "You are a social media expert for a professional craft brewery.";
                } else if (persona === 'sommelier') {
                    personaPrompt = "You are a knowledgeable mead sommelier, focusing on tasting notes and pairings.";
                }

                let platformPrompt = "Generate a short, engaging Instagram post. Use relevant emojis and hashtags." + negativeConstraint;
                if (platform === 'untappd_checkin') {
                    platformPrompt = "Generate a descriptive PERSONAL check-in description for Untappd. Write from a first-person perspective (e.g., 'I get notes of...'). Focus on aroma, appearance, taste, and mouthfeel. Do not use hashtags." + negativeConstraint;
                } else if (platform === 'untappd_description') {
                    platformPrompt = "Generate an official, commercial description for a new mead to be added to Untappd. The description should be objective, informative, and appealing, detailing the style, key ingredients, and expected flavor profile. This is NOT a personal check-in. Do not use hashtags." + negativeConstraint;
                }

                let tweakPrompt = "";
                if (tweak.trim() !== '') {
                    tweakPrompt = `An additional instruction from the user is: "${tweak}". You must follow this instruction.`;
                }

                const finalPrompt = `${personaPrompt} ${platformPrompt} ${tweakPrompt} Base the content on the following mead recipe:\n\n---\n${brew.recipeMarkdown}\n---\nFormat the entire response in Markdown.`;
                
                try {
                    const socialMarkdown = await performApiCall(finalPrompt);

                    // --- DEFINITIEVE FIX: Pak de tekst uit als het een codeblok is ---
                    let processedMarkdown = socialMarkdown.trim();
                    if (processedMarkdown.startsWith("```markdown")) {
                        processedMarkdown = processedMarkdown.substring(10, processedMarkdown.lastIndexOf("```")).trim();
                    } else if (processedMarkdown.startsWith("```")) {
                        processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
                    }
                    
                    const socialHtml = marked.parse(processedMarkdown);
                    socialContainer.innerHTML = `<div>${socialHtml}</div>`;
                } catch (error) {
                    console.error("Error generating social content:", error);
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Kon geen social media post genereren: ${error.message}</p>`;
                }
            }

            async function runManualSocialMediaGenerator() {
                const socialContainer = document.getElementById('social-content-container');
                const manualInput = document.getElementById('manual-social-input').value;

                if (!manualInput.trim()) {
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Voer eerst een onderwerp in om een post te genereren.</p>`;
                    return;
                }

                socialContainer.innerHTML = '<div class="loader"></div><p class="text-center text-app-secondary/80">De Alchemist schrijft een nieuw bericht voor je...</p>';

                // Haal de instellingen op van de UI
                const persona = document.getElementById('social-persona').value;
                const platform = document.getElementById('social-platform').value;
                const tweak = document.getElementById('social-tweak').value;

                const negativeConstraint = " CRUCIAL: Do not wrap your response in a markdown code block using triple backticks (```).";

                let personaPrompt = "You are an enthusiastic homebrewer sharing your passion.";
                if (persona === 'pro_brewery') {
                    personaPrompt = "You are a social media expert for a professional craft brewery.";
                } else if (persona === 'sommelier') {
                    personaPrompt = "You are a knowledgeable mead sommelier, focusing on tasting notes and pairings.";
                }

                let platformPrompt = "Generate a short, engaging Instagram post. Use relevant emojis and hashtags." + negativeConstraint;
                if (platform === 'untappd_checkin') {
                    platformPrompt = "Generate a descriptive PERSONAL check-in description for Untappd. Write from a first-person perspective (e.g., 'I get notes of...'). Focus on aroma, appearance, taste, and mouthfeel. Do not use hashtags." + negativeConstraint;
                } else if (platform === 'untappd_description') {
                    platformPrompt = "Generate an official, commercial description for a new mead to be added to Untappd. The description should be objective, informative, and appealing. This is NOT a personal check-in. Do not use hashtags." + negativeConstraint;
                }

                let tweakPrompt = "";
                if (tweak.trim() !== '') {
                    tweakPrompt = `An additional instruction from the user is: "${tweak}". You must follow this instruction.`;
                }

                // Bouw de prompt op basis van de handmatige invoer
                const finalPrompt = `${personaPrompt} ${platformPrompt} ${tweakPrompt} Base the content on the following topic or description provided by the user:\n\n---\n${manualInput}\n---\nFormat the entire response in Markdown.`;
                
                try {
                    const socialMarkdown = await performApiCall(finalPrompt);
                    
                    // Verwerk de markdown (deze code heb je al)
                    let processedMarkdown = socialMarkdown.trim();
                    if (processedMarkdown.startsWith("```markdown")) {
                        processedMarkdown = processedMarkdown.substring(10, processedMarkdown.lastIndexOf("```")).trim();
                    } else if (processedMarkdown.startsWith("```")) {
                        processedMarkdown = processedMarkdown.substring(3, processedMarkdown.lastIndexOf("```")).trim();
                    }
                    
                    const socialHtml = marked.parse(processedMarkdown);
                    socialContainer.innerHTML = `<div>${socialHtml}</div>`;
                } catch (error) {
                    console.error("Error generating manual social content:", error);
                    socialContainer.innerHTML = `<p class="text-center text-red-500">Kon geen social media post genereren: ${error.message}</p>`;
                }
            }

            // DEFINITIEVE, ROBUUSTE FUNCTIE VOOR INGREDIENTEN PARSEN
            function parseIngredientsFromMarkdown(markdown) {
                const ingredients = [];
                // Deze regex vindt de start van de tabel en pakt alle rijen tot een dubbele witregel of een nieuw subhoofdstuk.
                const tableContentRegex = /\|-+\|.*\n([\s\S]*?)(?:\n\n|##|$)/;
                const match = markdown.match(tableContentRegex);

                if (!match || !match[1]) {
                    console.warn("Definitive parser could not find ingredient table content.");
                    return ingredients;
                }

                const rows = match[1].trim().split('\n').filter(row => row.trim().startsWith('|'));

                rows.forEach(row => {
                    // Pak de waardes uit de cellen, negeer de buitenste pipes.
                    const columns = row.split('|').map(c => c.trim()).slice(1, 4); 
                    
                    if (columns.length === 3) {
                        const [name, quantityStr, unit] = columns;
                        const quantity = parseFloat(quantityStr);
                        // Voeg enkel toe als alle data logisch is.
                        if (name && !isNaN(quantity)) {
                            ingredients.push({ name: name.trim(), quantity: quantity, unit: (unit || '').trim() });
                        }
                    }
                });
                return ingredients;
            }

            function updateCostAnalysis() {
                const currency = userSettings.currencySymbol || '€';
                const totalSpend = inventory.reduce((acc, item) => acc + (item.price || 0), 0);
                const avgCost = brews.length > 0 ? brews.reduce((acc, brew) => acc + (brew.totalCost || 0), 0) / brews.length : 0;

                document.getElementById('total-spend').textContent = `${currency}${totalSpend.toFixed(2)}`;
                document.getElementById('avg-cost').textContent = `${currency}${avgCost.toFixed(2)}`;

                const spendByCategory = inventory.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + (item.price || 0);
                    return acc;
                }, {});

                const ctx = document.getElementById('cost-chart').getContext('2d');
                const chartData = {
                    labels: Object.keys(spendByCategory),
                    datasets: [{
                        label: 'Spend by Category',
                        data: Object.values(spendByCategory),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#7BC225'
                        ],
                    }]
                };

                if (costChart) {
                    costChart.destroy();
                }
                costChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
            }

            function renderFermentationGraph(brewId) {
                const brew = brews.find(b => b.id === brewId);
                // Zorg ervoor dat er logdata is met geldige waarden
                if (!brew || !brew.logData || !brew.logData.fermentationLog) return;

                const logData = brew.logData.fermentationLog
                    .filter(entry => entry.date && entry.sg) // Filter op entries die een datum en SG hebben
                    .sort((a, b) => new Date(a.date) - new Date(b.date)); // Sorteer op datum

                if (logData.length < 2) return; // We hebben minstens 2 punten nodig voor een lijn

                const labels = logData.map(entry => new Date(entry.date).toLocaleDateString());
                const sgData = logData.map(entry => parseFloat(entry.sg));

                const canvasId = `fermChart-${brewId}`;
                const ctx = document.getElementById(canvasId);
                if (!ctx) return; // Stop als de canvas niet gevonden kan worden

                // Verwijder een eventuele oude grafiek voordat we een nieuwe tekenen
                if (window.fermChartInstances && window.fermChartInstances[canvasId]) {
                window.fermChartInstances[canvasId].destroy();
                }
                if (!window.fermChartInstances) {
                window.fermChartInstances = {};
           }

                const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                const brandColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-color');

                window.fermChartInstances[canvasId] = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                        label: 'Specific Gravity (SG)',
                        data: sgData,
                        borderColor: brandColor,
                        backgroundColor: brandColor + '33', // Transparante vulling
                        tension: 0.1,
                        fill: true,
                    }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         title: { display: false },
                         legend: { display: false }
                     },
                     scales: {
                         x: {
                             ticks: { color: textColor },
                             grid: { color: borderColor }
                         },
                         y: {
                            title: {
                                display: true,
                                text: 'Specific Gravity',
                                color: textColor
                     },
                     ticks: { 
                         color: textColor,
                         // Formatteer de y-as labels (bv. 1.050)
                         callback: function(value) { return value.toFixed(3); }
                     },
                     grid: { color: borderColor }
                 }
             }
         }
     });
 }

            function calculateOverhead() {
                const electricityCost = parseFloat(document.getElementById('electricityCost').value) || 0;
                const waterCost = parseFloat(document.getElementById('waterCost').value) || 0;
                const sanitizerCost = parseFloat(document.getElementById('sanitizerCost').value) || 0;
                const resultDiv = document.getElementById('overheadResult');
                const currency = userSettings.currencySymbol || '€';

                // Simple assumptions for calculation
                const hoursBrewing = 4; // Assume 4 hours of active work
                const kwhPerHour = 1.5; // Assume 1.5 kWh per hour for heating/pumps
                const waterUsedM3 = 0.025; // Assume 25 liters (0.025 m³) of water used for a small batch

                const totalElectricity = electricityCost * kwhPerHour * hoursBrewing;
                const totalWater = waterCost * waterUsedM3;
                const totalOverhead = totalElectricity + totalWater + sanitizerCost;

                resultDiv.textContent = `Est. Overhead: ${currency}${totalOverhead.toFixed(2)}`;
            }

            // --- Troubleshooter Functions ---
            async function getTroubleshootingAdvice() {
                const description = document.getElementById('troubleshoot-description').value;
                const outputDiv = document.getElementById('troubleshoot-output');

                if (!description.trim()) {
                    outputDiv.innerHTML = `<p class="text-red-500">Please describe your problem first.</p>`;
                    return;
                }

                outputDiv.innerHTML = '<div class="loader"></div>';
                
                const prompt = `You are an expert mead maker and troubleshooter. A user is having a problem with their mead. Their description of the problem is: "${description}". Provide a step-by-step guide to help them diagnose the issue. Ask clarifying questions they should answer for themselves, suggest potential causes, and offer clear, actionable solutions. Format the response in Markdown.`;

                try {
                    const adviceMarkdown = await performApiCall(prompt);
                    outputDiv.innerHTML = marked.parse(adviceMarkdown);
                } catch (error) {
                    console.error("Error getting troubleshooting advice:", error);
                    outputDiv.innerHTML = `<p class="text-center text-red-500">Could not get advice: ${error.message}</p>`;
                }
            }

// --- NIEUW: Label Generator Functies ---
function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const logoPreview = document.getElementById('label-logo-preview');
            logoPreview.src = e.target.result;
            logoPreview.classList.remove('hidden');
            updateLabelPreview(); // Update om padding etc. aan te passen
        }
        reader.readAsDataURL(file);
    }
}

function updateLabelPreview() {
    // Update tekst
    document.getElementById('label-name-preview').textContent = document.getElementById('labelName').value || 'Mead Name';
    document.getElementById('label-style-preview').textContent = document.getElementById('labelStyle').value || 'Style / Subtitle';
    document.getElementById('label-abv-preview').textContent = document.getElementById('labelAbv').value || 'ABV';
    document.getElementById('label-vol-preview').textContent = document.getElementById('labelVol').value || 'VOL';
    document.getElementById('label-date-preview').textContent = document.getElementById('labelDate').value || 'Bottling Date';
}

function switchLabelStyle(styleName) {
    labelPreview.className = `aspect-[3/4] p-4 flex flex-col justify-between items-center text-center label-${styleName}`;
    document.querySelectorAll('.label-style-btn').forEach(btn => {
        btn.classList.remove('border-2', 'border-app-brand', 'text-app-brand');
        if (btn.dataset.style === styleName) {
            btn.classList.add('border-2', 'border-app-brand', 'text-app-brand');
        }
    });
    updateLabelPreview();
}

            function generatePrintPage() {
                const labelHTML = document.getElementById('label-preview').outerHTML;
                let printContent = '';
                // Herhaal het label 8 keer om een A4-pagina te vullen
                for (let i = 0; i < 8; i++) {
                    printContent += labelHTML.replace('id="label-preview"', `class="print-label ${labelPreview.className}"`);
                }

                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>Print Labels</title>
                            <script src="https://cdn.tailwindcss.com"><\/script> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@300;400;600;700&display=swap">
                            <style>
                                body { margin: 0; }
                                .print-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0; padding: 10mm 5mm; }
                                .print-label { width: 90mm; height: 130mm; outline: 1px dotted #ccc; box-sizing: border-box; }
                                ${document.querySelector('style').innerHTML}
                            </style>
                        </head>
                        <body>
                            <div class="print-container">${printContent}</div>
                        </body>
                    </html>
                `);
                newWindow.document.close();
                newWindow.focus();
                setTimeout(() => { newWindow.print(); }, 500); // Wacht even tot de stijlen geladen zijn
            }
            
            // --- Start the App ---
            initApp();

        })(); // End of IIFE
    </script>
   <div id="bottling-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-app-tertiary p-8 rounded-lg shadow-xl w-full max-w-lg"> <h3 class="text-2xl font-header font-bold mb-6">Bottle Batch</h3>
        <form id="bottling-form">
            <div class="space-y-6">
                <div>
                    <label for="bottlingDate" class="block text-sm font-bold mb-2">Bottling Date</label>
                    <input type="date" id="bottlingDate" required class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Number of Bottles (Standard Sizes)</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="qty750" class="block text-xs text-app-secondary">750ml</label>
                            <input type="number" id="qty750" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        </div>
                        <div>
                            <label for="qty500" class="block text-xs text-app-secondary">500ml</label>
                            <input type="number" id="qty500" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        </div>
                        <div>
                            <label for="qty330" class="block text-xs text-app-secondary">330ml</label>
                            <input type="number" id="qty330" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        </div>
                        <div>
                            <label for="qty250" class="block text-xs text-app-secondary">250ml</label>
                            <input type="number" id="qty250" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        </div>
                    </div>
                </div>
                <div class="border-t border-app pt-4">
                    <label class="block text-sm font-bold mb-2">Custom Size (Optional)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="customSize" class="block text-xs text-app-secondary">Size (ml)</label>
                            <input type="number" id="customSize" min="0" step="1" placeholder="e.g., 1000" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        </div>
                        <div>
                             <label for="customQty" class="block text-xs text-app-secondary">Quantity</label>
                            <input type="number" id="customQty" min="0" step="1" placeholder="0" class="w-full p-2 border rounded-md bg-app-primary border-app focus:ring-2 focus:ring-app-brand text-app-primary">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" onclick="window.hideBottlingModal()" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500 btn">Cancel</button>
                <button type="submit" class="px-6 py-2 rounded-lg bg-app-action text-white font-bold hover:opacity-90 btn">Add to Cellar</button>
            </div>
        </form>
    </div>
</div>
</body>
</html>
